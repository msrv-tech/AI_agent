#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Устанавливаем начальные значения
	ТекущийТипДиалога = Перечисления.ИИА_ТипДиалога.Агент;
	СтрокаСтатуса = "Готов к работе";
	ОркестраторРаботает = Ложь;
	Элементы.Отправить.Заголовок = "Отправить";
	ТекущаяМодель = Перечисления.ИИА_Модели.Авто;
	ЛогСсылка = "Лог";
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Получаем или создаем диалог текущего пользователя
	ТекущийДиалог = ИИА_Клиент.НайтиИлиСоздатьДиалогПользователя();
	
	// Загружаем сообщения
	ОбновитьСообщения();
	
КонецПроцедуры

#КонецОбласти
&НаКлиенте
Процедура ЛогСсылкаНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		Сообщить("Диалог не выбран.");
		Возврат;
	КонецЕсли;
	
	// Принудительно загружаем актуальный лог из справочника
	ТекстЛога = ИИА_ВызовСервера.ПолучитьЛогДиалога(ТекущийДиалог);
	
	// Если лог пустой, проверим, может это новый диалог без лога или ошибка
	Если ПустаяСтрока(ТекстЛога) Тогда
		ОписаниеДиалога = ИИА_ВызовСервера.ПолучитьОписаниеДиалога(ТекущийДиалог);
		Сообщить("Лог диалога пуст. Текущий диалог: " + Строка(ТекущийДиалог.УникальныйИдентификатор()) + " | " + ОписаниеДиалога);
		Возврат;
	КонецЕсли;
	
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.УстановитьТекст(ТекстЛога);
	ТекстовыйДокумент.Показать("Лог диалога: " + Строка(ТекущийДиалог));
	
КонецПроцедуры

&НаКлиенте
Процедура ТекущийДиалогПриИзменении(Элемент)
	
	// Если диалог пустой, очищаем все
	Если ТекущийДиалог.Пустая() Тогда
		СтрокаСтатуса = "Выберите диалог";
		// Обновляем с пустым диалогом (очистит чат)
		ОбновитьСообщения();
		Возврат;
	КонецЕсли;
	
	// Останавливаем оркестратор при смене диалога, чтобы не смешивать контексты
	Если ОркестраторРаботает Тогда
		ОстановитьОркестратор();
	КонецЕсли;
	
	// Обновляем сообщения чата
	ОбновитьСообщения();
	
	СтрокаСтатуса = "Диалог загружен";
	
КонецПроцедуры


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаОтправить(Команда)
	
	// Если оркестратор работает, останавливаем его
	Если ОркестраторРаботает Тогда
		ОстановитьОркестратор();
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ТекущийТекст) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Запускаем оркестратор
	ЗапуститьОркестратор();
	
	ПодключитьОбработчикПланирования();
	
	// Устанавливаем статус "Отправка..."
	СтрокаСтатуса = "Отправка сообщения...";
	
	Попытка
		
		// Логируем запрос пользователя
		ДобавитьВЛог("Запрос пользователя", ТекущийТекст, Новый Структура("ТипСообщения", ТекущийТипДиалога));
		
		// Отправляем сообщение
		Результат = ИИА_Клиент.ОтправитьСообщение(
			ТекущийДиалог,
			ТекущийТипДиалога,
			ТекущийТекст
		);
		
		// Логируем ответ ИИ
		Если Результат <> Неопределено Тогда
			
			// Добавляем промпт в лог, если он есть (до ответа)
			ДобавитьПромптВЛог(Результат);
			
			ДанныеОтвета = Новый Структура;
			Если Результат.Свойство("ТипОтвета") Тогда
				ДанныеОтвета.Вставить("ТипОтвета", Результат.ТипОтвета);
			КонецЕсли;
			
			ТекстОтвета = "";
			Если Результат.Свойство("Текст") Тогда
				ТекстОтвета = Строка(Результат.Текст);
			КонецЕсли;
			
			// Всегда логируем ответ, чтобы видеть, что пришло
			Если ПустаяСтрока(ТекстОтвета) Тогда
				ДобавитьВЛог("Ответ ИИ", "[Пустой текст ответа]", ДанныеОтвета);
			Иначе
				ДобавитьВЛог("Ответ ИИ", ТекстОтвета, ДанныеОтвета);
			КонецЕсли;
				
				Если НЕ ПустаяСтрока(ТекстОтвета) Тогда
					
					// Если тип ответа "Текст", пытаемся извлечь DSL из текста
					Если Результат.ТипОтвета = "Текст" И (НЕ Результат.Свойство("DSL") ИЛИ ПустаяСтрока(Результат.DSL)) Тогда
						ИзвлеченныйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ТекстОтвета);
						Если НЕ ПустаяСтрока(ИзвлеченныйDSL) Тогда
							ДобавитьВЛог("Система", "Извлечен DSL из текстового ответа ИИ", Новый Структура("DSL", ИзвлеченныйDSL));
							Результат.Вставить("DSL", ИзвлеченныйDSL);
							Результат.Вставить("ТипОтвета", "DSL");
							// Выполняем извлеченный DSL
							РезультатDSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, ИзвлеченныйDSL);
							Если РезультатDSL <> Неопределено Тогда
								Результат.Вставить("РезультатDSL", РезультатDSL);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				
				Если Результат.Свойство("DSL") И НЕ ПустаяСтрока(Результат.DSL) Тогда
					ДобавитьВЛог("DSL-сценарий от ИИ", Результат.DSL, ДанныеОтвета);
				КонецЕсли;
			Если Результат.Свойство("Usage") И Результат.Usage <> Неопределено Тогда
				ДанныеUsage = Новый Структура;
				Если Результат.Usage.Свойство("TotalTokens") Тогда
					ДанныеUsage.Вставить("TotalTokens", Результат.Usage.TotalTokens);
				КонецЕсли;
				Если Результат.Usage.Свойство("ОстатокКредитов") Тогда
					ДанныеUsage.Вставить("ОстатокКредитов", Результат.Usage.ОстатокКредитов);
				КонецЕсли;
				ДобавитьВЛог("Использование токенов", "", ДанныеUsage);
			КонецЕсли;
			
			// Логируем результат DSL, если он есть
			Если Результат.Свойство("РезультатDSL") И Результат.РезультатDSL <> Неопределено Тогда
				РезультатDSL = Результат.РезультатDSL;
				ДанныеDSL = Новый Структура;
				ДанныеDSL.Вставить("Успех", РезультатDSL.Успех);
				Если НЕ РезультатDSL.Успех Тогда
					ДанныеDSL.Вставить("Ошибка", РезультатDSL.Сообщение);
				КонецЕсли;
				Если РезультатDSL.Свойство("СсылкиОбъектов") И РезультатDSL.СсылкиОбъектов.Количество() > 0 Тогда
					ДанныеDSL.Вставить("КоличествоОбъектов", РезультатDSL.СсылкиОбъектов.Количество());
				КонецЕсли;
				ДобавитьВЛог("Результат выполнения DSL", РезультатDSL.Сообщение, ДанныеDSL);
				
				// Если есть данные запроса для создания табличного документа, создаем и открываем его
				// Проверяем наличие данных запроса (может быть установлено RunQuery или ShowInfo)
				ДанныеДляТаблицы = Неопределено;
				ОткрытьТабличныйДокумент = Ложь;
				
				Если РезультатDSL.Свойство("ОткрытьТабличныйДокумент") И РезультатDSL.ОткрытьТабличныйДокумент Тогда
					ОткрытьТабличныйДокумент = Истина;
				КонецЕсли;
				
				// Пробуем получить данные из разных мест
				Если РезультатDSL.Свойство("ДанныеЗапроса") И РезультатDSL.ДанныеЗапроса <> Неопределено Тогда
					ДанныеДляТаблицы = РезультатDSL.ДанныеЗапроса;
					ОткрытьТабличныйДокумент = Истина;
				ИначеЕсли РезультатDSL.Свойство("ДанныеЗапросаДляТаблицы") И РезультатDSL.ДанныеЗапросаДляТаблицы <> Неопределено Тогда
					ДанныеДляТаблицы = РезультатDSL.ДанныеЗапросаДляТаблицы;
					ОткрытьТабличныйДокумент = Истина;
				КонецЕсли;
				
				Если ОткрытьТабличныйДокумент И ДанныеДляТаблицы <> Неопределено Тогда
					ДобавитьВЛог("Отладка", "Открываю табличный документ", Новый Структура("КоличествоСтрок", ?(ТипЗнч(ДанныеДляТаблицы) = Тип("Массив"), ДанныеДляТаблицы.Количество(), 0)));
					СоздатьИОткрытьТабличныйДокумент(ДанныеДляТаблицы);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Обновляем список сообщений
		ОбновитьСообщения();
		
		// Обработка результата DSL и итерации до выполнения задачи будут выполнены через обработчик ожидания СпланироватьСледующиеШаги
		
		// Обновляем статус по usage
		Если Результат <> Неопределено Тогда
			Если Результат.Свойство("Usage") И Результат.Usage <> Неопределено Тогда
				Если Результат.Usage.Свойство("ОстатокКредитов") И Результат.Usage.ОстатокКредитов > 0 Тогда
					СтрокаСтатуса = "Осталось " + Формат(Результат.Usage.ОстатокКредитов, "ЧН=0; ЧГ=") + " credits";
				ИначеЕсли Результат.Usage.Свойство("TotalTokens") Тогда
					СтрокаСтатуса = "Токенов использовано: " + Формат(Результат.Usage.TotalTokens, "ЧН=0; ЧГ=");
				Иначе
					СтрокаСтатуса = "Сообщение отправлено";
				КонецЕсли;
			Иначе
				СтрокаСтатуса = "Сообщение отправлено";
			КонецЕсли;
		Иначе
			СтрокаСтатуса = "Ошибка: Сервер вернул Неопределено";
			ДобавитьВЛог("Ошибка", "Сервер вернул пустой результат (Неопределено) после отправки сообщения.");
		КонецЕсли;
		
		// Очищаем поле ввода
		ТекущийТекст = "";
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		ДобавитьВЛог("Ошибка", "Исключение при отправке сообщения: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьЗапрос(Команда)
	
	// Функционал временно недоступен из-за смены интерфейса
	Сообщить("Функция проверки запроса временно недоступна в новом интерфейсе.");
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСкопировать(Команда)
	
	// Функционал временно недоступен из-за смены интерфейса
	Сообщить("Функция копирования временно недоступна в новом интерфейсе.");
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаНастройки(Команда)
	
	// Открываем форму настроек пользователя
	// TODO: Реализовать открытие формы настроек
	Сообщить("Настройки (в разработке)");
	
КонецПроцедуры


&НаКлиенте
Процедура ТестDSL(Команда)
	
	Если ПустаяСтрока(ТестDSL) Тогда
		Сообщить("Введите DSL-сценарий в поле 'Тест DSL'");
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Устанавливаем статус
	СтрокаСтатуса = "Выполнение DSL-сценария...";
	
	Попытка
		
		// Выполняем DSL на сервере (сообщения добавляются автоматически на сервере)
		Результат = ИИА_Клиент.ВыполнитьDSLСценарий(ТекущийДиалог, ТестDSL);
		
		// Обновляем статус в зависимости от результата
		Если Результат.Успех Тогда
			СтрокаСтатуса = "DSL-сценарий выполнен успешно";
		Иначе
			СтрокаСтатуса = "Ошибка выполнения DSL: " + Результат.Сообщение;
		КонецЕсли;
		
		// Обновляем список сообщений (чтобы увидеть системные сообщения, добавленные на сервере)
		ОбновитьСообщения();
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		Сообщить("Ошибка при выполнении DSL: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура НовыйДиалог(Команда)
	
	// Деактивируем текущий диалог (если есть)
	Если ТекущийДиалог <> Неопределено Тогда
		ИИА_ВызовСервера.ДеактивироватьДиалог(ТекущийДиалог);
	КонецЕсли;
	
	// Создаем новый диалог
	ТекущийДиалог = ИИА_Клиент.СоздатьНовыйДиалог();
	
	// Очищаем форму
	ТекущийТекст = "";
	
	// Обновляем сообщения
	ОбновитьСообщения();
	
	// Устанавливаем начальные значения
	СтрокаСтатуса = "Создан новый диалог. Готов к работе";
	ОркестраторРаботает = Ложь;
	Элементы.Отправить.Заголовок = "Отправить";
	
	ДобавитьВЛог("Система", "Создан новый диалог");
	
КонецПроцедуры
#КонецОбласти

#Область ПроцедурыИФункцииКлиентскогоМодуля

&НаКлиенте
// Запускает оркестратор и обновляет интерфейс
Процедура ЗапуститьОркестратор()
	
	ОркестраторРаботает = Истина;
	Элементы.Отправить.Заголовок = "Остановить";
	Элементы.Отправить.Доступность = Истина;
	
КонецПроцедуры

&НаКлиенте
// Останавливает оркестратор и обновляет интерфейс
Процедура ОстановитьОркестратор()
	
	ОркестраторРаботает = Ложь;
	ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
	Элементы.Отправить.Заголовок = "Отправить";
	СтрокаСтатуса = "Оркестратор остановлен пользователем";
	ДобавитьВЛог("Система", "Оркестратор остановлен пользователем");
	
КонецПроцедуры

&НаКлиенте
// Подключает обработчик ожидания для планирования следующих шагов
Процедура ПодключитьОбработчикПланирования()
	ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 2);
КонецПроцедуры

&НаКлиенте
// Оркестратор процесса выполнения задачи
// Проверяет состояние диалога и планирует следующие шаги до выполнения задачи
// Использует лимит токенов вместо лимита попыток
Процедура СпланироватьСледующиеШаги()
	
	Если ТекущийДиалог = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	РезультатПроверкиСохранён = ИИА_ВызовСервера.ПолучитьРезультатПроверки(ТекущийДиалог);
	Если РезультатПроверкиСохранён <> Неопределено И РезультатПроверкиСохранён.ПроверкаВыполнена Тогда
		СтрокаСтатуса = "Результат проверки уже сохранён (" + ?(ПустаяСтрока(РезультатПроверкиСохранён.СтатусПроверкиЗадачи), "нет описания", РезультатПроверкиСохранён.СтатусПроверкиЗадачи) + ")";
		ДобавитьВЛог("Система", "Пропускаем повторную проверку: результат уже получен", РезультатПроверкиСохранён);
		Возврат;
	КонецЕсли;
	
	// Лимит токенов на одну обработку задачи (можно вынести в настройки)
	МаксимальноеКоличествоТокенов = 10000;
	
	// Проверяем лимит токенов
	ОбщееКоличествоТокенов = ИИА_ВызовСервера.ПолучитьОбщееКоличествоТокенов(ТекущийДиалог);
	Если ОбщееКоличествоТокенов >= МаксимальноеКоличествоТокенов Тогда
		ОстановитьОркестратор();
		СтрокаСтатуса = "Достигнут лимит токенов (" + Формат(МаксимальноеКоличествоТокенов, "ЧН=0") + "). Задача может быть выполнена не полностью.";
		ДобавитьВЛог("Система", "Достигнут лимит токенов. Остановка обработки.", Новый Структура("Токенов", ОбщееКоличествоТокенов, "Лимит", МаксимальноеКоличествоТокенов));
		ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
			ТекущийДиалог,
			"Достигнут лимит токенов (" + Формат(МаксимальноеКоличествоТокенов, "ЧН=0") + "). Задача может быть выполнена не полностью.",
			ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
		);
		ОбновитьСообщения();
		Возврат;
	КонецЕсли;
	
	// Получаем первое сообщение пользователя (исходную задачу)
	ПервоеСообщениеПользователя = ИИА_ВызовСервера.ПолучитьПервоеСообщениеПользователя(ТекущийДиалог);
	
	Если НЕ ПервоеСообщениеПользователя.Найдено Тогда
		// Нет сообщений пользователя - завершаем
		Возврат;
	КонецЕсли;
	
	// Получаем последнее сообщение пользователя для проверки ЗадачаВыполнена
	ПоследнееСообщениеПользователя = ИИА_ВызовСервера.ПолучитьПоследнееСообщениеПользователя(ТекущийДиалог);
	
	// Проверяем, остановлен ли оркестратор
	Если НЕ ОркестраторРаботает Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем, выполнена ли задача
	Если ПоследнееСообщениеПользователя.Найдено И ПоследнееСообщениеПользователя.ЗадачаВыполнена Тогда
		// Задача выполнена - завершаем
		ОркестраторРаботает = Ложь;
		ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
		Элементы.Отправить.Заголовок = "Отправить";
		СтрокаСтатуса = "Задача выполнена";
		ОбновитьСообщения();
		Возврат;
	КонецЕсли;
	
	// Получаем последнее DSL сообщение
	ПоследнееDSLСообщение = ИИА_ВызовСервера.ПолучитьПоследнееDSLСообщение(ТекущийДиалог);
	
	Если НЕ ПоследнееDSLСообщение.Найдено Тогда
		// Нет DSL сообщений. 
		// Проверяем, может быть последнее сообщение от ИИ - это текст (ответ на вопрос или отказ)?
		ПоследниеСообщения = ИИА_ВызовСервера.ПолучитьСообщенияДиалога(ТекущийДиалог, 1);
		Если ПоследниеСообщения.Количество() > 0 Тогда
			ПоследнееСообщение = ПоследниеСообщения[0];
			Если (ПоследнееСообщение.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.ИИ") 
				ИЛИ ПоследнееСообщение.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система"))
				И ПоследнееСообщение.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Код") Тогда
				
				// ИИ ответил текстом, и это не распознано как DSL. 
				// Считаем шаг завершенным (ожидание пользователя).
				ОркестраторРаботает = Ложь;
				ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
				Элементы.Отправить.Заголовок = "Отправить";
				СтрокаСтатуса = "ИИ ответил. Ожидание пользователя.";
				
				// Пробуем "спасти" ситуацию: если текст похож на JSON, но не был распознан
				ТекстСообщения = СокрЛП(ПоследнееСообщение.Текст);
				Если Лев(ТекстСообщения, 1) = "{" И СтрНайти(ТекстСообщения, "dsl_version") > 0 Тогда
					ДобавитьВЛог("Внимание", "Последнее сообщение похоже на DSL, но не было распознано. Возможно, ошибка формата JSON.");
				КонецЕсли;
				
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		// Если мы здесь, значит DSL нет, и последнее сообщение не от ИИ (или мы ждем ответа).
		// Но так как вызов синхронный, ожидание не должно затягиваться.
		// На всякий случай ждем (вдруг асинхронность), но проверяем тайм-аут?
		// Пока просто ждем следующей итерации
		ПодключитьОбработчикПланирования();
		Возврат;
	КонецЕсли;
	
	// Проверяем статус DSL
	СтатусDSL = ПоследнееDSLСообщение.СтатусDSL;
	
	Если СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ВОчереди") Тогда
		// DSL в очереди - ждем выполнения
		ПодключитьОбработчикПланирования();
		Возврат;
	ИначеЕсли СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.Исправляется") Тогда
		// DSL исправляется - ждем
		ПодключитьОбработчикПланирования();
		Возврат;
	ИначеЕсли СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанСОшибкой") Тогда
		// DSL выполнен с ошибкой - планируем исправление
		
		// Подсчитываем количество попыток исправления для этого DSL по истории сообщений
		// Ищем все сообщения с ошибками для этого DSL
		КоличествоПопытокИсправления = 0;
		Попытка
			СообщенияДиалога = ИИА_ВызовСервера.ПолучитьСообщенияДиалога(ТекущийДиалог, 100);
			Для Каждого Сообщение Из СообщенияДиалога Цикл
				// Если это системное сообщение об ошибке DSL и оно относится к тому же DSL
				Если Сообщение.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система") 
					И Сообщение.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
					И СтрНайти(Сообщение.Текст, "Ошибка выполнения DSL") > 0 Тогда
					КоличествоПопытокИсправления = КоличествоПопытокИсправления + 1;
				КонецЕсли;
			КонецЦикла;
		Исключение
			КоличествоПопытокИсправления = 0;
		КонецПопытки;
		
		МаксимальноеКоличествоПопытокИсправления = 3;
		
		Если КоличествоПопытокИсправления >= МаксимальноеКоличествоПопытокИсправления Тогда
			// Превышен лимит попыток исправления - генерируем новый DSL
			ДобавитьВЛог("Система", "Превышен лимит попыток исправления DSL (" + Формат(МаксимальноеКоличествоПопытокИсправления, "ЧН=0") + "). Генерирую новый DSL-сценарий...");
			
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Превышен лимит попыток исправления DSL. Генерирую новый DSL-сценарий...",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
			);
			
			// Получаем все невыполненные задачи
			НевыполненныеЗадачи = ИИА_ВызовСервера.ПолучитьНевыполненныеЗадачиПользователя(ТекущийДиалог);
			Если НевыполненныеЗадачи.Найдено Тогда
				ТекстЗадач = НевыполненныеЗадачи.ТекстЗадач;
			Иначе
				ТекстЗадач = ПервоеСообщениеПользователя.Текст;
			КонецЕсли;
			
			ПромптПродолжения = "Задача пользователя еще не выполнена полностью. " + Символы.ПС +
				"Задачи пользователя: " + ТекстЗадач + Символы.ПС +
				"Предыдущие попытки выполнения DSL завершились с ошибками. " +
				"Сгенерируй новый DSL-сценарий для выполнения задачи. " +
				"Учти результаты предыдущих попыток из истории диалога.";
			
			ДобавитьВЛог("Система", "Отправляю запрос на генерацию нового DSL", Новый Структура("Промпт", ПромптПродолжения));
			
			ОтветИИ = ИИА_ВызовСервера.ВызватьИИССистемнымСообщением(ТекущийДиалог, "Чат", ПромптПродолжения);
			
			Если ОтветИИ <> Неопределено Тогда
				ДобавитьПромптВЛог(ОтветИИ);
				
				// Логируем ответ ИИ
				Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
					ДобавитьВЛог("Ответ ИИ (новый DSL)", "Получен новый DSL-сценарий", Новый Структура("DSL", ОтветИИ.DSL));
				ИначеЕсли ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
					ДобавитьВЛог("Ответ ИИ (новый DSL)", ОтветИИ.Текст);
				КонецЕсли;
				
				// Извлекаем DSL из ответа
				НовыйDSL = "";
				Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
					НовыйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.DSL);
				КонецЕсли;
				Если ПустаяСтрока(НовыйDSL) И ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
					НовыйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.Текст);
				КонецЕсли;
				
				Если НЕ ПустаяСтрока(НовыйDSL) Тогда
					ДобавитьВЛог("Система", "Выполняю новый DSL-сценарий", Новый Структура("DSL", НовыйDSL));
					
					// Выполняем новый DSL
					РезультатНовогоДSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, НовыйDSL);
					
					// Логируем результат выполнения нового DSL
					Если РезультатНовогоДSL <> Неопределено Тогда
						ДанныеРезультата = Новый Структура;
						ДанныеРезультата.Вставить("Успех", РезультатНовогоДSL.Успех);
						Если НЕ РезультатНовогоДSL.Успех Тогда
							ДанныеРезультата.Вставить("Ошибка", РезультатНовогоДSL.Сообщение);
						КонецЕсли;
						ДобавитьВЛог("Результат выполнения нового DSL", РезультатНовогоДSL.Сообщение, ДанныеРезультата);
					КонецЕсли;
					
					ОбновитьСообщения();
					ПодключитьОбработчикПланирования();
				Иначе
					ДобавитьВЛог("Ошибка", "Не удалось извлечь DSL из ответа ИИ.");
					ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
						ТекущийДиалог,
						"Не удалось извлечь DSL из ответа ИИ.",
						ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
					);
					ОбновитьСообщения();
				КонецЕсли;
			Иначе
				ДобавитьВЛог("Ошибка", "Не удалось получить новый DSL от ИИ.");
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Не удалось получить новый DSL от ИИ.",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
				);
				ОбновитьСообщения();
			КонецЕсли;
			
			Возврат;
		КонецЕсли;
		
		ДобавитьВЛог("Система", "Обнаружена ошибка выполнения DSL. Начинаю исправление (попытка " + Формат(КоличествоПопытокИсправления + 1, "ЧН=0") + " из " + Формат(МаксимальноеКоличествоПопытокИсправления, "ЧН=0") + ")...", Новый Структура("DSL", ПоследнееDSLСообщение.ТекстКода));
		
		// Проверяем лимит токенов перед исправлением
		ОбщееКоличествоТокенов = ИИА_ВызовСервера.ПолучитьОбщееКоличествоТокенов(ТекущийДиалог);
		Если ОбщееКоличествоТокенов >= МаксимальноеКоличествоТокенов Тогда
			СтрокаСтатуса = "Достигнут лимит токенов. Остановка исправления.";
			ДобавитьВЛог("Система", "Достигнут лимит токенов. Исправление DSL остановлено.", Новый Структура("Токенов", ОбщееКоличествоТокенов, "Лимит", МаксимальноеКоличествоТокенов));
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Достигнут лимит токенов (" + Формат(МаксимальноеКоличествоТокенов, "ЧН=0") + "). Исправление DSL остановлено.",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
			);
			ОбновитьСообщения();
			Возврат;
		КонецЕсли;
		
		СтрокаСтатуса = "Исправляю DSL-сценарий...";
		
		// Получаем текст последней ошибки из системных сообщений
		ТекстОшибки = "";
		Попытка
			СообщенияДиалога = ИИА_ВызовСервера.ПолучитьСообщенияДиалога(ТекущийДиалог, 20);
			КоличествоСообщений = СообщенияДиалога.Количество();
			Если КоличествоСообщений > 0 Тогда
				Для Индекс = 0 По КоличествоСообщений - 1 Цикл
					ОбратныйИндекс = КоличествоСообщений - 1 - Индекс;
					Сообщение = СообщенияДиалога[ОбратныйИндекс];
					Если Сообщение.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система") 
						И Сообщение.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
						И СтрНайти(Сообщение.Текст, "Ошибка выполнения DSL") > 0 Тогда
						ТекстОшибки = Сообщение.Текст;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Исключение
			ТекстОшибки = "Ошибка выполнения DSL";
		КонецПопытки;
		
		ДобавитьВЛог("Система", "Отправляю запрос на исправление DSL в ИИ");
		
		ОтветИИ = ИИА_ВызовСервера.ИсправитьDSLЧерезИИ(ТекущийДиалог, ТекстОшибки, ПоследнееDSLСообщение.ТекстКода);
		
		Если ОтветИИ <> Неопределено Тогда
			ДобавитьПромптВЛог(ОтветИИ);
			
			// Логируем ответ ИИ на исправление
			Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
				ДобавитьВЛог("Ответ ИИ (исправление)", "Получен исправленный DSL-сценарий", Новый Структура("DSL", ОтветИИ.DSL));
			ИначеЕсли ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
				ДобавитьВЛог("Ответ ИИ (исправление)", ОтветИИ.Текст);
			КонецЕсли;
			
			// Извлекаем DSL из ответа
			ИсправленныйDSL = "";
			Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
				ИсправленныйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.DSL);
			КонецЕсли;
			Если ПустаяСтрока(ИсправленныйDSL) И ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
				ИсправленныйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.Текст);
			КонецЕсли;
			
			Если НЕ ПустаяСтрока(ИсправленныйDSL) Тогда
				// Увеличиваем счетчик попыток исправления
				// (в будущем можно сохранять это в сообщении)
				
				ИИА_ВызовСервера.ОбновитьСтатусDSLВПоследнемСообщении(ТекущийДиалог, ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.Исправляется"));
				
				ДобавитьВЛог("Система", "Получен исправленный DSL-сценарий. Выполняю повторно...", Новый Структура("DSL", ИсправленныйDSL));
				
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Получен исправленный DSL-сценарий от ИИ. Выполняю повторно...",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
				);
				
				// Выполняем исправленный DSL
				РезультатИсправленногоDSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, ИсправленныйDSL);
				
				// Логируем результат выполнения исправленного DSL
				Если РезультатИсправленногоDSL <> Неопределено Тогда
					ДанныеРезультата = Новый Структура;
					ДанныеРезультата.Вставить("Успех", РезультатИсправленногоDSL.Успех);
					Если НЕ РезультатИсправленногоDSL.Успех Тогда
						ДанныеРезультата.Вставить("Ошибка", РезультатИсправленногоDSL.Сообщение);
						ДобавитьВЛог("Система", "Исправленный DSL выполнен с ошибкой. Продолжаю цикл исправления...", ДанныеРезультата);
						
						// Обновляем статус DSL на "ОбработанСОшибкой", чтобы оркестратор продолжил исправление
						ИИА_ВызовСервера.ОбновитьСтатусDSLВПоследнемСообщении(ТекущийДиалог, ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанСОшибкой"));
					Иначе
						ДобавитьВЛог("Система", "Исправленный DSL выполнен успешно. Обновляю статус и продолжаю проверку задачи...", ДанныеРезультата);
						
						// Обновляем статус DSL на "ОбработанУспешно", чтобы оркестратор продолжил проверку задачи
						ИИА_ВызовСервера.ОбновитьСтатусDSLВПоследнемСообщении(ТекущийДиалог, ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанУспешно"));
					КонецЕсли;
					ДобавитьВЛог("Результат выполнения исправленного DSL", РезультатИсправленногоDSL.Сообщение, ДанныеРезультата);
				КонецЕсли;
				
				ОбновитьСообщения();
				ДобавитьВЛог("Система", "Подключаю обработчик ожидания для продолжения планирования...");
				ПодключитьОбработчикПланирования();
			Иначе
				ДобавитьВЛог("Ошибка", "Не удалось извлечь исправленный DSL из ответа ИИ.");
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Не удалось извлечь исправленный DSL из ответа ИИ.",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
				);
				ОбновитьСообщения();
			КонецЕсли;
		Иначе
			ДобавитьВЛог("Ошибка", "Не удалось получить исправленный DSL от ИИ.");
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Не удалось получить исправленный DSL от ИИ.",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
			);
			ОбновитьСообщения();
		КонецЕсли;
		
		Возврат;
	ИначеЕсли СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанУспешно") Тогда
		// DSL выполнен успешно - проверяем задачу
		СтрокаСтатуса = "Проверяю выполнение задачи...";
		
		ДобавитьВЛог("Система", "DSL выполнен успешно. Начинаю проверку выполнения задачи...");
		
		// Получаем результат DSL без добавления сообщений (сообщения уже были добавлены при первом выполнении)
		// (в будущем можно сохранять результат DSL в диалоге)
		РезультатDSL = ИИА_ВызовСервера.ВыполнитьDSLСценарийБезСообщений(ПоследнееDSLСообщение.ТекстКода, ТекущийДиалог);
		
		// Если выполнение прошло успешно, проверяем задачу
	Если РезультатDSL.Успех Тогда
			// Получаем все невыполненные задачи и уточнения пользователя
			НевыполненныеЗадачи = ИИА_ВызовСервера.ПолучитьНевыполненныеЗадачиПользователя(ТекущийДиалог);
			
			Если НевыполненныеЗадачи.Найдено Тогда
				ТекстЗадачиДляПроверки = НевыполненныеЗадачи.ТекстЗадач;
				ДобавитьВЛог("Система", "Вызываю ИИ для проверки результата выполнения задачи", Новый Структура("Задача", ТекстЗадачиДляПроверки, "КоличествоЗадач", НевыполненныеЗадачи.КоличествоЗадач));
			Иначе
				// Если нет невыполненных задач, используем последнее сообщение как fallback
				ТекстЗадачиДляПроверки = ПоследнееСообщениеПользователя.Текст;
				Если ПустаяСтрока(ТекстЗадачиДляПроверки) Тогда
					ТекстЗадачиДляПроверки = ПервоеСообщениеПользователя.Текст;
				КонецЕсли;
				ДобавитьВЛог("Система", "Вызываю ИИ для проверки результата выполнения задачи", Новый Структура("Задача", ТекстЗадачиДляПроверки));
			КонецЕсли;
			
			РезультатПроверки = ИИА_ВызовСервера.ПроверитьРезультатВыполненияЗадачи(
				ТекущийДиалог,
				ТекстЗадачиДляПроверки,
				РезультатDSL
			);
			
			ЗадачаВыполнена = РезультатПроверки.ЗадачаВыполнена;
			ДобавитьВЛог("Система", "Результат проверки задачи", Новый Структура(
				"ЗадачаВыполнена, Причина", 
				ЗадачаВыполнена, 
				РезультатПроверки.Причина
			));
			ОбновитьСообщения();
			
			ПричинаПроверки = СокрЛП(РезультатПроверки.Причина);
			ИИА_ВызовСервера.УстановитьРезультатПроверки(ТекущийДиалог, ЗадачаВыполнена, ПричинаПроверки);
			СгенерироватьИДобавитьSummary(ТекущийДиалог, ЗадачаВыполнена, ПричинаПроверки);
			
			Если ЗадачаВыполнена Тогда
				СтрокаСтатуса = "Задача выполнена";
				ДобавитьВЛог("Система", "Задача выполнена успешно. Завершаю обработку и сохраняю summary.");
				ОркестраторРаботает = Ложь;
				ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
				Элементы.Отправить.Заголовок = "Отправить";
				Возврат;
			Иначе
				СтрокаСтатуса = "Проверка завершена: задача не подтверждена.";
				ДобавитьВЛог("Система", "Проверка задачи не подтвердила выполнение", Новый Структура("Причина", ПричинаПроверки));
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Проверка не подтвердила выполнение задачи. " + ?(ПустаяСтрока(ПричинаПроверки), "", ПричинаПроверки),
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
				);
				ОркестраторРаботает = Ложь;
				ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
				Элементы.Отправить.Заголовок = "Отправить";
				ОбновитьСообщения();
				Возврат;
			КонецЕсли;
		КонецЕсли;
		
		Возврат;
	КонецЕсли;
	
	// Если статус не определен или другой - ждем
	ПодключитьОбработчикПланирования();
	
КонецПроцедуры

&НаКлиенте
// Обновляет список сообщений на форме
//
Процедура ОбновитьСообщения()
	
	НовыеСообщения = ИИА_Клиент.ЗагрузитьСообщенияДиалога(ТекущийДиалог);
	
	// Обновляем визуальный интерфейс чата (программно создаем элементы)
	ОбновитьИнтерфейсЧатаНаСервере(НовыеСообщения);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьИнтерфейсЧатаНаСервере(Сообщения)
	
	ИмяГруппыЧата = "ГруппаИсторияЧата";
	
	// 1. Очистка старых элементов и реквизитов
	ОчиститьЧат(ИмяГруппыЧата);
	
	// 2. Подготовка новых реквизитов
	МассивДобавляемыхРеквизитов = Новый Массив;
	МассивТипаСтрока = Новый Массив;
	МассивТипаСтрока.Добавить(Тип("Строка"));
	ОписаниеТипаСтрока = Новый ОписаниеТипов(МассивТипаСтрока);
	
	Для Индекс = 0 По Сообщения.Количество() - 1 Цикл
		СтрокаСообщения = Сообщения[Индекс];
		Префикс = "дин_msg_" + Формат(Индекс, "ЧГ=0");
		
		// Реквизит для текста сообщения
		МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Text", ОписаниеТипаСтрока, "", "Текст сообщения"));
		
		// Если есть код, реквизит для кода
		Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Code", ОписаниеТипаСтрока, "", "Код сообщения"));
		КонецЕсли;
		
		// Реквизит для статуса/заголовка
		МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Header", ОписаниеТипаСтрока, "", "Заголовок"));
	КонецЦикла;
	
	// Изменяем реквизиты формы
	ИзменитьРеквизиты(МассивДобавляемыхРеквизитов);
	
	// 3. Создание элементов и заполнение данными
	ГруппаЧат = Элементы.Найти(ИмяГруппыЧата);
	Если ГруппаЧат = Неопределено Тогда
		// Создаем группу, если её нет
		ГруппаЧат = Элементы.Добавить(ИмяГруппыЧата, Тип("ГруппаФормы"), ЭтотОбъект);
		ГруппаЧат.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаЧат.Заголовок = "История чата";
	КонецЕсли;
	
	// Настраиваем отображение группы (даже если она создана в конфигураторе)
	ГруппаЧат.Отображение = ОтображениеОбычнойГруппы.Нет;
	ГруппаЧат.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	
	// Выводим сообщения в обратном порядке (последние вверху)
	Для Индекс = 0 По Сообщения.Количество() - 1 Цикл
		// Используем обратный индекс для получения данных сообщения
		ОбратныйИндекс = Сообщения.Количество() - 1 - Индекс;
		СтрокаСообщения = Сообщения[ОбратныйИндекс];
		
		// Но имя элемента формируем на основе исходного индекса, чтобы сохранить уникальность и логику
		// Или лучше использовать ОбратныйИндекс в имени, чтобы din_msg_0 всегда был внизу?
		// Если мы хотим чтобы "Вверх" (Top) шло к последнему сообщению, 
		// то элемент наверху должен иметь известный ID.
		
		// Пусть ID будет соответствовать позиции в массиве Сообщения.
		// То есть din_msg_N (Newest) будет первым добавлен в форму и будет наверху.
		// din_msg_0 (Oldest) будет последним добавлен и будет внизу.
		
		Префикс = "дин_msg_" + Формат(ОбратныйИндекс, "ЧГ=0");
		ИмяГруппыСообщения = Префикс + "_Group";
		
		// Данные для реквизитов
		ЭтотОбъект[Префикс + "_Text"] = СтрокаСообщения.Текст;
		Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			ЭтотОбъект[Префикс + "_Code"] = СтрокаСообщения.ТекстКода;
		КонецЕсли;
		ЭтотОбъект[Префикс + "_Header"] = ПолучитьЗаголовокСообщения(СтрокаСообщения);
		
		// --- Контейнер для выравнивания (строка чата) ---
		ГруппаКонтейнер = Элементы.Добавить(ИмяГруппыСообщения + "_Cont", Тип("ГруппаФормы"), ГруппаЧат);
		ГруппаКонтейнер.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаКонтейнер.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Горизонтальная;
		ГруппаКонтейнер.Отображение = ОтображениеОбычнойГруппы.Нет;
		// ГруппаКонтейнер.Шов = Ложь; // Свойство Шов недоступно для группы формы
		
		ЭтоПользователь = (СтрокаСообщения.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Пользователь"));
		
		// --- Распорка слева (для сообщений пользователя) ---
		Если ЭтоПользователь Тогда
			РаспоркаЛ = Элементы.Добавить(ИмяГруппыСообщения + "_SpaceL", Тип("ДекорацияФормы"), ГруппаКонтейнер);
			РаспоркаЛ.Вид = ВидДекорацииФормы.Надпись;
			РаспоркаЛ.РастягиватьПоГоризонтали = Истина;
		КонецЕсли;
		
		// --- Группа самого сообщения (пузырь) ---
		ГруппаПузырь = Элементы.Добавить(ИмяГруппыСообщения, Тип("ГруппаФормы"), ГруппаКонтейнер);
		ГруппаПузырь.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаПузырь.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		// ГруппаПузырь.Шов = Ложь; // Свойство Шов недоступно для группы формы
		
		// Оформление пузыря
		ГруппаПузырь.Отображение = ОтображениеОбычнойГруппы.СлабоеВыделение; // Рамка
		
		// --- Заголовок (Автор, Время) ---
		ЗаголовокЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Header", Тип("ПолеФормы"), ГруппаПузырь);
		ЗаголовокЭлемент.Вид = ВидПоляФормы.ПолеНадписи;
		ЗаголовокЭлемент.ПутьКДанным = Префикс + "_Header";
		ЗаголовокЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
		ЗаголовокЭлемент.Шрифт = Новый Шрифт(,, Истина); // Жирный
		ЗаголовокЭлемент.ЦветТекста = WebЦвета.Серый;
		
		// --- Текст сообщения ---
		ТекстЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Text", Тип("ПолеФормы"), ГруппаПузырь);
		ТекстЭлемент.Вид = ВидПоляФормы.ПолеВвода; // Используем ПолеВвода для гарантированного переноса
		ТекстЭлемент.ПутьКДанным = Префикс + "_Text";
		ТекстЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
		ТекстЭлемент.МногострочныйРежим = Истина;
		ТекстЭлемент.ТолькоПросмотр = Истина;
		ТекстЭлемент.РастягиватьПоГоризонтали = Истина; // Расширяем на всю доступную ширину
		ТекстЭлемент.АвтоМаксимальнаяВысота = 0; // Нет ограничения по высоте
		ТекстЭлемент.Высота = 0; // Автовысота
		ТекстЭлемент.ЦветРамки = WebЦвета.Белый; // Скрываем рамку
		ТекстЭлемент.ЦветФона = WebЦвета.Белый; // Фон под цвет формы
		
		// --- Блок кода (если есть) ---
		Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			КодЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Code", Тип("ПолеФормы"), ГруппаПузырь);
			КодЭлемент.Вид = ВидПоляФормы.ПолеВвода;
			КодЭлемент.ПутьКДанным = Префикс + "_Code";
			КодЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
			КодЭлемент.МногострочныйРежим = Истина;
			КодЭлемент.ТолькоПросмотр = Истина;
			КодЭлемент.Шрифт = Новый Шрифт("Courier New", 10);
			КодЭлемент.ЦветФона = Новый Цвет(245, 245, 245);
			КодЭлемент.РастягиватьПоГоризонтали = Истина;
		КонецЕсли;
		
		// --- Распорка справа (для сообщений ИИ) ---
		Если НЕ ЭтоПользователь Тогда
			РаспоркаП = Элементы.Добавить(ИмяГруппыСообщения + "_SpaceR", Тип("ДекорацияФормы"), ГруппаКонтейнер);
			РаспоркаП.Вид = ВидДекорацииФормы.Надпись;
			РаспоркаП.РастягиватьПоГоризонтали = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	// Прокручиваем к последнему сообщению (которое теперь вверху)
	Количество = Сообщения.Количество();
	Если Количество > 0 Тогда
		ПоследнийИндекс = Количество - 1;
		ИмяЭлемента = "дин_msg_" + Формат(ПоследнийИндекс, "ЧГ=0") + "_Group";
		Элемент = Элементы.Найти(ИмяЭлемента);
		Если Элемент <> Неопределено Тогда
			ТекущийЭлемент = Элемент;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьЧат(ИмяГруппыЧата)
	
	// 1. Удаление элементов
	ГруппаЧат = Элементы.Найти(ИмяГруппыЧата);
	Если ГруппаЧат <> Неопределено Тогда
		// Собираем элементы для удаления
		МассивДляУдаления = Новый Массив;
		Для Каждого ПодчиненныйЭлемент Из ГруппаЧат.ПодчиненныеЭлементы Цикл
			// Удаляем только динамически созданные элементы (по префиксу)
			Если СтрНачинаетсяС(ПодчиненныйЭлемент.Имя, "дин_") Тогда
				МассивДляУдаления.Добавить(ПодчиненныйЭлемент);
			КонецЕсли;
		КонецЦикла;
		
		// Удаляем
		Для Каждого ЭлементУдаления Из МассивДляУдаления Цикл
			Элементы.Удалить(ЭлементУдаления);
		КонецЦикла;
	КонецЕсли;
	
	// 2. Удаление динамических реквизитов (дин_...)
	МассивУдаляемыхРеквизитов = Новый Массив;
	ВсеРеквизиты = ПолучитьРеквизиты();
	
	Для Каждого Реквизит Из ВсеРеквизиты Цикл
		Если Лев(Реквизит.Имя, 4) = "дин_" Тогда
			МассивУдаляемыхРеквизитов.Добавить(Реквизит.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Если МассивУдаляемыхРеквизитов.Количество() > 0 Тогда
		ИзменитьРеквизиты(, МассивУдаляемыхРеквизитов);
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ПолучитьЗаголовокСообщения(СтрокаСообщения)
	
	Заголовок = Строка(СтрокаСообщения.Автор);
	
	Если ЗначениеЗаполнено(СтрокаСообщения.Время) Тогда
		Заголовок = Заголовок + " [" + Формат(СтрокаСообщения.Время, "ДФ=HH:mm") + "]";
	КонецЕсли;
	
	Если СтрокаСообщения.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка") Тогда
		Заголовок = Заголовок + " (Ошибка)";
	КонецЕсли;
	
	Возврат Заголовок;
	
КонецФункции

&НаКлиенте
// Добавляет системное сообщение в диалог
//
// Параметры:
//  Текст - Строка - текст сообщения
//  ТипСообщения - ПеречислениеСсылка.ИИА_ТипСообщения - тип сообщения
//
Процедура ДобавитьСистемноеСообщение(Текст, ТипСообщения)
	
	ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(ТекущийДиалог, Текст, ТипСообщения);
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаВверх(Команда)
	
	// Прокрутка к ВЕРХУ формы.
	// Так как сообщения перевернуты (новые вверху), ВЕРХ формы = последнее (новое) сообщение.
	// Последнее сообщение имеет индекс N-1.
	
	Количество = 0;
	Попытка
		Количество = ЭтотОбъект.Сообщения.Количество();
	Исключение
	КонецПопытки;

	Если Количество > 0 Тогда
		Индекс = Количество - 1;
		ИмяЭлемента = "дин_msg_" + Формат(Индекс, "ЧГ=0") + "_Group";
		Элемент = Элементы.Найти(ИмяЭлемента);
		Если Элемент <> Неопределено Тогда
			ТекущийЭлемент = Элемент;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаВниз(Команда)
	
	// Прокрутка к НИЗУ формы.
	// Так как сообщения перевернуты (новые вверху), НИЗ формы = первое (старое) сообщение.
	// Первое сообщение имеет индекс 0.
	
	Элемент = Элементы.Найти("дин_msg_0_Group");
	Если Элемент <> Неопределено Тогда
		ТекущийЭлемент = Элемент;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
// Добавляет запись в лог с временной меткой
//
// Параметры:
//  ТипСобытия - Строка - тип события ("Запрос пользователя", "Ответ ИИ", "Система", "DSL выполнение", "Ошибка" и т.д.)
//  Текст - Строка - текст записи
//  ДополнительныеДанные - Структура - дополнительные данные (опционально)
//
Процедура ДобавитьВЛог(ТипСобытия, Текст, ДополнительныеДанные = Неопределено)
	
	ВремяСобытия = ТекущаяДата();
	ВремяСтрока = Формат(ВремяСобытия, "ДФ=dd.MM.yyyy HH:mm:ss");
	
	ЗаписьЛога = "[" + ВремяСтрока + "] [" + ТипСобытия + "]" + Символы.ПС + Текст;
	
	// Добавляем дополнительные данные, если они есть
	Если ДополнительныеДанные <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеДанные Цикл
			ЗаписьЛога = ЗаписьЛога + Символы.ПС + "  " + КлючЗначение.Ключ + ": " + Строка(КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	
	// Добавляем разделитель
	ЗаписьЛога = ЗаписьЛога + Символы.ПС + Строка(Символы.ПС) + "---" + Строка(Символы.ПС);
	
	// Сохраняем лог в справочник (добавляя к существующему)
	Если ТекущийДиалог <> Неопределено Тогда
		ИИА_ВызовСервера.ДобавитьЗаписьВЛогДиалога(ТекущийДиалог, ЗаписьЛога);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
// Добавляет промпт в лог, не затирая историю
//
// Параметры:
//  Результат - Структура - результат от сервера, может содержать поле Промпт
//
Процедура ДобавитьПромптВЛог(Результат)
	
	Если Результат <> Неопределено И Результат.Свойство("Промпт") И НЕ ПустаяСтрока(Результат.Промпт) Тогда
		ДобавитьВЛог("Промпт ИИ", Результат.Промпт);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
// Генерирует и сохраняет summary с отметкой результата проверки
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ЗадачаВыполнена - Булево - результат проверки
//  Причина - Строка - причина (если есть)
//
Процедура СгенерироватьИДобавитьSummary(СсылкаДиалога, ЗадачаВыполнена, Причина)

	Попытка
		
		ТекстSummary = ИИА_ВызовСервера.СгенерироватьSummary(СсылкаДиалога);
		
		Если ПустаяСтрока(ТекстSummary) Тогда
			ДобавитьВЛог("Ошибка", "Не удалось сгенерировать резюме");
			Возврат;
		КонецЕсли;
		
		Дополнение = Символы.ПС + Символы.ПС + "Проверка: " + ?(ЗадачаВыполнена, "подтвердила выполнение задачи.", "не подтвердила выполнение задачи.");
		Если НЕ ПустаяСтрока(Причина) Тогда
			Дополнение = Дополнение + Символы.ПС + "Причина: " + Причина;
		КонецЕсли;
		
		ТекстSummary = ТекстSummary + Дополнение;
		
		ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
			СсылкаДиалога,
			"=== РЕЗЮМЕ ВЫПОЛНЕННОЙ РАБОТЫ ===" + Символы.ПС + Символы.ПС + ТекстSummary,
			ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
		);
		
		ДобавитьВЛог("Система", "Резюме сгенерировано и сохранено в диалог", Новый Структура(
			"Проверка", ?(ЗадачаВыполнена, "успешна", "не успешна"),
			"Причина", ?(ПустаяСтрока(Причина), "не указана", Причина)
		));
		
	Исключение
		ДобавитьВЛог("Ошибка", "Ошибка при генерации резюме: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
// Создает и открывает табличный документ для просмотра результатов запроса
//
// Параметры:
//  ДанныеЗапроса - Массив - массив структур с данными запроса
//
Процедура СоздатьИОткрытьТабличныйДокумент(ДанныеЗапроса)
	
	Если ДанныеЗапроса = Неопределено Или ТипЗнч(ДанныеЗапроса) <> Тип("Массив") Или ДанныеЗапроса.Количество() = 0 Тогда
		ДобавитьВЛог("Ошибка", "Данные запроса пусты или неверного типа", Новый Структура(
			"ТипДанных", ?(ДанныеЗапроса = Неопределено, "Неопределено", Строка(ТипЗнч(ДанныеЗапроса))),
			"Количество", ?(ДанныеЗапроса = Неопределено, 0, ДанныеЗапроса.Количество())
		));
		Возврат;
	КонецЕсли;
	
	Попытка
		ДобавитьВЛог("Отладка", "Создаю табличный документ на сервере", Новый Структура(
			"КоличествоСтрок", ДанныеЗапроса.Количество()
		));
		
		// Создаем табличный документ на сервере
		ТабличныйДокумент = ИИА_ВызовСервера.СоздатьТабличныйДокументИзДанных(ДанныеЗапроса);
		
		Если ТабличныйДокумент = Неопределено Тогда
			ДобавитьВЛог("Ошибка", "Табличный документ не создан (вернул Неопределено)");
			Сообщить("Ошибка при создании табличного документа");
			Возврат;
		КонецЕсли;
		
		ДобавитьВЛог("Отладка", "Табличный документ создан, открываю", Новый Структура(
			"ТипОбъекта", Строка(ТипЗнч(ТабличныйДокумент))
		));
		
		// Открываем табличный документ
		ТабличныйДокумент.Показать();
		
		ДобавитьВЛог("Отладка", "Табличный документ открыт");
		
	Исключение
		ТекстОшибки = ОписаниеОшибки();
		ДобавитьВЛог("Ошибка", "Ошибка при создании табличного документа: " + ТекстОшибки);
		Сообщить("Ошибка при создании табличного документа: " + ТекстОшибки);
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти
