#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Получаем или создаем диалог текущего пользователя
	ТекущийДиалог = ИИА_Клиент.НайтиИлиСоздатьДиалогПользователя();
	
	// Загружаем сообщения
	ОбновитьСообщения();
	
	// Устанавливаем начальные значения
	ТекущийТипСообщения = "Чат";
	СтрокаСтатуса = "Готов к работе";
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаОтправить(Команда)
	
	Если ПустаяСтрока(ТекущийТекст) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Устанавливаем статус "Отправка..."
	СтрокаСтатуса = "Отправка сообщения...";
	
	Попытка
		
		// Отправляем сообщение
		Результат = ИИА_Клиент.ОтправитьСообщение(
			ТекущийДиалог,
			ТекущийТипСообщения,
			ТекущийТекст
		);
		
		// Выводим промпт в лог, если он есть
		Если Результат <> Неопределено И Результат.Свойство("Промпт") И НЕ ПустаяСтрока(Результат.Промпт) Тогда
			Лог = Результат.Промпт;
		КонецЕсли;
		
		// Обновляем список сообщений
		ОбновитьСообщения();
		
		// Обрабатываем результат DSL, если есть (попытки исправления на клиенте)
		Если Результат <> Неопределено 
			И Результат.Свойство("РезультатDSL") 
			И Результат.РезультатDSL <> Неопределено 
			И НЕ Результат.РезультатDSL.Успех
			И Результат.Свойство("DSLJSON") Тогда
			
			// Запускаем обработку результата DSL с попытками исправления на клиенте
			ИИА_Клиент.ОбработатьРезультатDSL(
				ТекущийДиалог,
				Результат.РезультатDSL,
				Результат.DSLJSON,
				ТекущийТекст,
				0,
				5
			);
			
			// Обновляем список сообщений после попыток исправления
			ОбновитьСообщения();
		КонецЕсли;
		
		// Обновляем статус по usage
		Если Результат <> Неопределено Тогда
			Если Результат.Свойство("Usage") И Результат.Usage <> Неопределено Тогда
				Если Результат.Usage.Свойство("ОстатокКредитов") И Результат.Usage.ОстатокКредитов > 0 Тогда
					СтрокаСтатуса = "Осталось " + Формат(Результат.Usage.ОстатокКредитов, "ЧН=0; ЧГ=") + " credits";
				ИначеЕсли Результат.Usage.Свойство("TotalTokens") Тогда
					СтрокаСтатуса = "Токенов использовано: " + Формат(Результат.Usage.TotalTokens, "ЧН=0; ЧГ=");
				Иначе
					СтрокаСтатуса = "Сообщение отправлено";
				КонецЕсли;
			Иначе
				СтрокаСтатуса = "Сообщение отправлено";
			КонецЕсли;
		Иначе
			СтрокаСтатуса = "Готов к работе";
		КонецЕсли;
		
		// Очищаем поле ввода
		ТекущийТекст = "";
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		Сообщить("Ошибка при отправке сообщения: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьЗапрос(Команда)
	
	ВыбраннаяСтрока = СообщенияФормы.ТекущаяСтрока;
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ВыбраннаяСтрока.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Запрос") Тогда
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ВыбраннаяСтрока.ТекстКода) Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем запрос
	Результат = ИИА_Клиент.ПроверитьЗапрос(ВыбраннаяСтрока.ТекстКода);
	
	// Формируем сообщение о результате
	Если Результат.Успех Тогда
		ТекстОшибки = "Запрос выполнен успешно";
		ТипСообщенияОшибки = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст");
	Иначе
		ТекстОшибки = "Ошибка: " + Результат.Сообщение;
		ТипСообщенияОшибки = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка");
	КонецЕсли;
	
	// Добавляем системное сообщение в диалог через сервер
	ДобавитьСистемноеСообщение(ТекстОшибки, ТипСообщенияОшибки);
	
	// Обновляем список сообщений
	ОбновитьСообщения();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСкопировать(Команда)
	
	ВыбраннаяСтрока = СообщенияФормы.ТекущаяСтрока;
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ВыбраннаяСтрока.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Запрос") 
		И ВыбраннаяСтрока.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Код") Тогда
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ВыбраннаяСтрока.ТекстКода) Тогда
		Возврат;
	КонецЕсли;
	
	// Копируем в буфер обмена
	Попытка
	//	ПомещениеВБуферОбмена(ВыбраннаяСтрока.ТекстКода);
		Сообщить("Скопировано в буфер обмена");
	Исключение
		Сообщить("Ошибка копирования в буфер обмена: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаНастройки(Команда)
	
	// Открываем форму настроек пользователя
	// TODO: Реализовать открытие формы настроек
	Сообщить("Настройки (в разработке)");
	
КонецПроцедуры


&НаКлиенте
Процедура ТестDSL(Команда)
	
	Если ПустаяСтрока(ТестDSL) Тогда
		Сообщить("Введите DSL-сценарий в поле 'Тест DSL'");
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Устанавливаем статус
	СтрокаСтатуса = "Выполнение DSL-сценария...";
	
	Попытка
		
		// Выполняем DSL на сервере (сообщения добавляются автоматически на сервере)
		Результат = ИИА_Клиент.ВыполнитьDSLСценарий(ТекущийДиалог, ТестDSL);
		
		// Обновляем статус в зависимости от результата
		Если Результат.Успех Тогда
			СтрокаСтатуса = "DSL-сценарий выполнен успешно";
		Иначе
			СтрокаСтатуса = "Ошибка выполнения DSL: " + Результат.Сообщение;
		КонецЕсли;
		
		// Обновляем список сообщений (чтобы увидеть системные сообщения, добавленные на сервере)
		ОбновитьСообщения();
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		Сообщить("Ошибка при выполнении DSL: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры
#КонецОбласти

#Область ПроцедурыИФункцииКлиентскогоМодуля

&НаКлиенте
// Обновляет список сообщений на форме
//
Процедура ОбновитьСообщения()
	
	НовыеСообщения = ИИА_Клиент.ЗагрузитьСообщенияДиалога(ТекущийДиалог);
	
	// Очищаем существующую таблицу и заполняем новыми данными
	СообщенияФормы.Очистить();
	
	Для Каждого Строка Из НовыеСообщения Цикл
		
		НоваяСтрока = СообщенияФормы.Добавить();
		НоваяСтрока.Время = Строка.Время;
		НоваяСтрока.Автор = Строка.Автор;
		НоваяСтрока.ТипСообщения = Строка.ТипСообщения;
		НоваяСтрока.Текст = Строка.Текст;
		НоваяСтрока.ТекстКода = Строка.ТекстКода;
		НоваяСтрока.Статус = Строка.Статус;
		НоваяСтрока.UsageTokens = Строка.UsageTokens;
		
		// Заполняем СтатусDSL, если он есть в структуре
		Если Строка.Свойство("СтатусDSL") Тогда
			НоваяСтрока.СтатусDSL = Строка.СтатусDSL;
		КонецЕсли;
		
	КонецЦикла;
	
	// Прокручиваем к последнему сообщению
	Если СообщенияФормы.Количество() > 0 Тогда
		//СообщенияФормы.ТекущаяСтрока = СообщенияФормы[СообщенияФормы.Количество() - 1];
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
// Добавляет системное сообщение в диалог
//
// Параметры:
//  Текст - Строка - текст сообщения
//  ТипСообщения - ПеречислениеСсылка.ИИА_ТипСообщения - тип сообщения
//
Процедура ДобавитьСистемноеСообщение(Текст, ТипСообщения)
	
	ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(ТекущийДиалог, Текст, ТипСообщения);
	
КонецПроцедуры

#КонецОбласти
