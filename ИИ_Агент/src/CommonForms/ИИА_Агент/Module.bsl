#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Получаем или создаем диалог текущего пользователя
	ТекущийДиалог = ИИА_Клиент.НайтиИлиСоздатьДиалогПользователя();
	
	// Загружаем сообщения
	ОбновитьСообщения();
	
	// Загружаем лог из справочника
	Если ТекущийДиалог <> Неопределено Тогда
		ЛогИзСправочника = ИИА_ВызовСервера.ПолучитьЛогДиалога(ТекущийДиалог);
		Если НЕ ПустаяСтрока(ЛогИзСправочника) Тогда
			Лог = ЛогИзСправочника;
		КонецЕсли;
	КонецЕсли;
	
	// Устанавливаем начальные значения
	ТекущийТипСообщения = "Чат";
	СтрокаСтатуса = "Готов к работе";
	ОркестраторРаботает = Ложь;
	Элементы.Отправить.Заголовок = "Отправить";
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаОтправить(Команда)
	
	// Если оркестратор работает, останавливаем его
	Если ОркестраторРаботает Тогда
		ОстановитьОркестратор();
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ТекущийТекст) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Запускаем оркестратор
	ЗапуститьОркестратор();
	
	ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
	
	// Устанавливаем статус "Отправка..."
	СтрокаСтатуса = "Отправка сообщения...";
	
	Попытка
		
		// Логируем запрос пользователя
		ДобавитьВЛог("Запрос пользователя", ТекущийТекст, Новый Структура("ТипСообщения", ТекущийТипСообщения));
		
		// Отправляем сообщение
		Результат = ИИА_Клиент.ОтправитьСообщение(
			ТекущийДиалог,
			ТекущийТипСообщения,
			ТекущийТекст
		);
		
			// Логируем ответ ИИ
			Если Результат <> Неопределено Тогда
				ДанныеОтвета = Новый Структура;
				Если Результат.Свойство("ТипОтвета") Тогда
					ДанныеОтвета.Вставить("ТипОтвета", Результат.ТипОтвета);
				КонецЕсли;
				Если Результат.Свойство("Текст") И НЕ ПустаяСтрока(Результат.Текст) Тогда
					ДобавитьВЛог("Ответ ИИ", Результат.Текст, ДанныеОтвета);
					
					// Если тип ответа "Текст", пытаемся извлечь DSL из текста
					Если Результат.ТипОтвета = "Текст" И (НЕ Результат.Свойство("DSL") ИЛИ ПустаяСтрока(Результат.DSL)) Тогда
						ИзвлеченныйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(Результат.Текст);
						Если НЕ ПустаяСтрока(ИзвлеченныйDSL) Тогда
							ДобавитьВЛог("Система", "Извлечен DSL из текстового ответа ИИ", Новый Структура("DSL", ИзвлеченныйDSL));
							Результат.Вставить("DSL", ИзвлеченныйDSL);
							Результат.Вставить("ТипОтвета", "DSL");
							// Выполняем извлеченный DSL
							РезультатDSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, ИзвлеченныйDSL);
							Если РезультатDSL <> Неопределено Тогда
								Результат.Вставить("РезультатDSL", РезультатDSL);
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
				Если Результат.Свойство("DSL") И НЕ ПустаяСтрока(Результат.DSL) Тогда
					ДобавитьВЛог("DSL-сценарий от ИИ", Результат.DSL, ДанныеОтвета);
				КонецЕсли;
			Если Результат.Свойство("Usage") И Результат.Usage <> Неопределено Тогда
				ДанныеUsage = Новый Структура;
				Если Результат.Usage.Свойство("TotalTokens") Тогда
					ДанныеUsage.Вставить("TotalTokens", Результат.Usage.TotalTokens);
				КонецЕсли;
				Если Результат.Usage.Свойство("ОстатокКредитов") Тогда
					ДанныеUsage.Вставить("ОстатокКредитов", Результат.Usage.ОстатокКредитов);
				КонецЕсли;
				ДобавитьВЛог("Использование токенов", "", ДанныеUsage);
			КонецЕсли;
			
			// Добавляем промпт в лог, если он есть
			ДобавитьПромптВЛог(Результат);
			
			// Логируем результат DSL, если он есть
			Если Результат.Свойство("РезультатDSL") И Результат.РезультатDSL <> Неопределено Тогда
				РезультатDSL = Результат.РезультатDSL;
				ДанныеDSL = Новый Структура;
				ДанныеDSL.Вставить("Успех", РезультатDSL.Успех);
				Если НЕ РезультатDSL.Успех Тогда
					ДанныеDSL.Вставить("Ошибка", РезультатDSL.Сообщение);
				КонецЕсли;
				Если РезультатDSL.Свойство("СсылкиОбъектов") И РезультатDSL.СсылкиОбъектов.Количество() > 0 Тогда
					ДанныеDSL.Вставить("КоличествоОбъектов", РезультатDSL.СсылкиОбъектов.Количество());
				КонецЕсли;
				ДобавитьВЛог("Результат выполнения DSL", РезультатDSL.Сообщение, ДанныеDSL);
				
				// Если есть данные запроса для создания табличного документа, создаем и открываем его
				// Проверяем наличие данных запроса (может быть установлено RunQuery или ShowInfo)
				ДанныеДляТаблицы = Неопределено;
				ОткрытьТабличныйДокумент = Ложь;
				
				Если РезультатDSL.Свойство("ОткрытьТабличныйДокумент") И РезультатDSL.ОткрытьТабличныйДокумент Тогда
					ОткрытьТабличныйДокумент = Истина;
				КонецЕсли;
				
				// Пробуем получить данные из разных мест
				Если РезультатDSL.Свойство("ДанныеЗапроса") И РезультатDSL.ДанныеЗапроса <> Неопределено Тогда
					ДанныеДляТаблицы = РезультатDSL.ДанныеЗапроса;
					ОткрытьТабличныйДокумент = Истина;
				ИначеЕсли РезультатDSL.Свойство("ДанныеЗапросаДляТаблицы") И РезультатDSL.ДанныеЗапросаДляТаблицы <> Неопределено Тогда
					ДанныеДляТаблицы = РезультатDSL.ДанныеЗапросаДляТаблицы;
					ОткрытьТабличныйДокумент = Истина;
				КонецЕсли;
				
				Если ОткрытьТабличныйДокумент И ДанныеДляТаблицы <> Неопределено Тогда
					ДобавитьВЛог("Отладка", "Открываю табличный документ", Новый Структура("КоличествоСтрок", ?(ТипЗнч(ДанныеДляТаблицы) = Тип("Массив"), ДанныеДляТаблицы.Количество(), 0)));
					СоздатьИОткрытьТабличныйДокумент(ДанныеДляТаблицы);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Обновляем список сообщений
		ОбновитьСообщения();
		
		// Обработка результата DSL и итерации до выполнения задачи будут выполнены через обработчик ожидания СпланироватьСледующиеШаги
		
		// Обновляем статус по usage
		Если Результат <> Неопределено Тогда
			Если Результат.Свойство("Usage") И Результат.Usage <> Неопределено Тогда
				Если Результат.Usage.Свойство("ОстатокКредитов") И Результат.Usage.ОстатокКредитов > 0 Тогда
					СтрокаСтатуса = "Осталось " + Формат(Результат.Usage.ОстатокКредитов, "ЧН=0; ЧГ=") + " credits";
				ИначеЕсли Результат.Usage.Свойство("TotalTokens") Тогда
					СтрокаСтатуса = "Токенов использовано: " + Формат(Результат.Usage.TotalTokens, "ЧН=0; ЧГ=");
				Иначе
					СтрокаСтатуса = "Сообщение отправлено";
				КонецЕсли;
			Иначе
				СтрокаСтатуса = "Сообщение отправлено";
			КонецЕсли;
		Иначе
			СтрокаСтатуса = "Готов к работе";
		КонецЕсли;
		
		// Очищаем поле ввода
		ТекущийТекст = "";
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		Сообщить("Ошибка при отправке сообщения: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаПроверитьЗапрос(Команда)
	
	ВыбраннаяСтрока = СообщенияФормы.ТекущаяСтрока;
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ВыбраннаяСтрока.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Запрос") Тогда
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ВыбраннаяСтрока.ТекстКода) Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем запрос
	Результат = ИИА_Клиент.ПроверитьЗапрос(ВыбраннаяСтрока.ТекстКода);
	
	// Формируем сообщение о результате
	Если Результат.Успех Тогда
		ТекстОшибки = "Запрос выполнен успешно";
		ТипСообщенияОшибки = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст");
	Иначе
		ТекстОшибки = "Ошибка: " + Результат.Сообщение;
		ТипСообщенияОшибки = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка");
	КонецЕсли;
	
	// Добавляем системное сообщение в диалог через сервер
	ДобавитьСистемноеСообщение(ТекстОшибки, ТипСообщенияОшибки);
	
	// Обновляем список сообщений
	ОбновитьСообщения();
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаСкопировать(Команда)
	
	ВыбраннаяСтрока = СообщенияФормы.ТекущаяСтрока;
	
	Если ВыбраннаяСтрока = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	Если ВыбраннаяСтрока.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Запрос") 
		И ВыбраннаяСтрока.ТипСообщения <> ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Код") Тогда
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ВыбраннаяСтрока.ТекстКода) Тогда
		Возврат;
	КонецЕсли;
	
	// Копируем в буфер обмена
	Попытка
	//	ПомещениеВБуферОбмена(ВыбраннаяСтрока.ТекстКода);
		Сообщить("Скопировано в буфер обмена");
	Исключение
		Сообщить("Ошибка копирования в буфер обмена: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаНастройки(Команда)
	
	// Открываем форму настроек пользователя
	// TODO: Реализовать открытие формы настроек
	Сообщить("Настройки (в разработке)");
	
КонецПроцедуры


&НаКлиенте
Процедура ТестDSL(Команда)
	
	Если ПустаяСтрока(ТестDSL) Тогда
		Сообщить("Введите DSL-сценарий в поле 'Тест DSL'");
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Устанавливаем статус
	СтрокаСтатуса = "Выполнение DSL-сценария...";
	
	Попытка
		
		// Выполняем DSL на сервере (сообщения добавляются автоматически на сервере)
		Результат = ИИА_Клиент.ВыполнитьDSLСценарий(ТекущийДиалог, ТестDSL);
		
		// Обновляем статус в зависимости от результата
		Если Результат.Успех Тогда
			СтрокаСтатуса = "DSL-сценарий выполнен успешно";
		Иначе
			СтрокаСтатуса = "Ошибка выполнения DSL: " + Результат.Сообщение;
		КонецЕсли;
		
		// Обновляем список сообщений (чтобы увидеть системные сообщения, добавленные на сервере)
		ОбновитьСообщения();
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		Сообщить("Ошибка при выполнении DSL: " + ОписаниеОшибки());
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура НовыйДиалог(Команда)
	
	// Деактивируем текущий диалог (если есть)
	Если ТекущийДиалог <> Неопределено Тогда
		ИИА_ВызовСервера.ДеактивироватьДиалог(ТекущийДиалог);
	КонецЕсли;
	
	// Создаем новый диалог
	ТекущийДиалог = ИИА_Клиент.СоздатьНовыйДиалог();
	
	// Очищаем форму
	ТекущийТекст = "";
	Лог = "";
	СообщенияФормы.Очистить();
	
	// Обновляем сообщения
	ОбновитьСообщения();
	
	// Устанавливаем начальные значения
	СтрокаСтатуса = "Создан новый диалог. Готов к работе";
	ОркестраторРаботает = Ложь;
	Элементы.Отправить.Заголовок = "Отправить";
	
	ДобавитьВЛог("Система", "Создан новый диалог");
	
КонецПроцедуры
#КонецОбласти

#Область ПроцедурыИФункцииКлиентскогоМодуля

&НаКлиенте
// Запускает оркестратор и обновляет интерфейс
Процедура ЗапуститьОркестратор()
	
	ОркестраторРаботает = Истина;
	Элементы.Отправить.Заголовок = "Остановить";
	Элементы.Отправить.Доступность = Истина;
	
КонецПроцедуры

&НаКлиенте
// Останавливает оркестратор и обновляет интерфейс
Процедура ОстановитьОркестратор()
	
	ОркестраторРаботает = Ложь;
	ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
	Элементы.Отправить.Заголовок = "Отправить";
	СтрокаСтатуса = "Оркестратор остановлен пользователем";
	ДобавитьВЛог("Система", "Оркестратор остановлен пользователем");
	
КонецПроцедуры

&НаКлиенте
// Оркестратор процесса выполнения задачи
// Проверяет состояние диалога и планирует следующие шаги до выполнения задачи
// Использует лимит токенов вместо лимита попыток
Процедура СпланироватьСледующиеШаги()
	
	Если ТекущийДиалог = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	// Лимит токенов на одну обработку задачи (можно вынести в настройки)
	МаксимальноеКоличествоТокенов = 10000;
	
	// Проверяем лимит токенов
	ОбщееКоличествоТокенов = ИИА_ВызовСервера.ПолучитьОбщееКоличествоТокенов(ТекущийДиалог);
	Если ОбщееКоличествоТокенов >= МаксимальноеКоличествоТокенов Тогда
		ОстановитьОркестратор();
		СтрокаСтатуса = "Достигнут лимит токенов (" + Формат(МаксимальноеКоличествоТокенов, "ЧН=0") + "). Задача может быть выполнена не полностью.";
		ДобавитьВЛог("Система", "Достигнут лимит токенов. Остановка обработки.", Новый Структура("Токенов", ОбщееКоличествоТокенов, "Лимит", МаксимальноеКоличествоТокенов));
		ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
			ТекущийДиалог,
			"Достигнут лимит токенов (" + Формат(МаксимальноеКоличествоТокенов, "ЧН=0") + "). Задача может быть выполнена не полностью.",
			ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
		);
		ОбновитьСообщения();
		Возврат;
	КонецЕсли;
	
	// Получаем первое сообщение пользователя (исходную задачу)
	ПервоеСообщениеПользователя = ИИА_ВызовСервера.ПолучитьПервоеСообщениеПользователя(ТекущийДиалог);
	
	Если НЕ ПервоеСообщениеПользователя.Найдено Тогда
		// Нет сообщений пользователя - завершаем
		Возврат;
	КонецЕсли;
	
	// Получаем последнее сообщение пользователя для проверки ЗадачаВыполнена
	ПоследнееСообщениеПользователя = ИИА_ВызовСервера.ПолучитьПоследнееСообщениеПользователя(ТекущийДиалог);
	
	// Проверяем, остановлен ли оркестратор
	Если НЕ ОркестраторРаботает Тогда
		Возврат;
	КонецЕсли;
	
	// Проверяем, выполнена ли задача
	Если ПоследнееСообщениеПользователя.Найдено И ПоследнееСообщениеПользователя.ЗадачаВыполнена Тогда
		// Задача выполнена - завершаем
		ОркестраторРаботает = Ложь;
		Элементы.Отправить.Заголовок = "Отправить";
		СтрокаСтатуса = "Задача выполнена";
		ОбновитьСообщения();
		Возврат;
	КонецЕсли;
	
	// Получаем последнее DSL сообщение
	ПоследнееDSLСообщение = ИИА_ВызовСервера.ПолучитьПоследнееDSLСообщение(ТекущийДиалог);
	
	Если НЕ ПоследнееDSLСообщение.Найдено Тогда
		// Нет DSL сообщений - возможно, еще не сгенерирован, ждем
		ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
		Возврат;
	КонецЕсли;
	
	// Проверяем статус DSL
	СтатусDSL = ПоследнееDSLСообщение.СтатусDSL;
	
	Если СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ВОчереди") Тогда
		// DSL в очереди - ждем выполнения
		ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
		Возврат;
	ИначеЕсли СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.Исправляется") Тогда
		// DSL исправляется - ждем
		ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
		Возврат;
	ИначеЕсли СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанСОшибкой") Тогда
		// DSL выполнен с ошибкой - планируем исправление
		
		// Подсчитываем количество попыток исправления для этого DSL по истории сообщений
		// Ищем все сообщения с ошибками для этого DSL
		КоличествоПопытокИсправления = 0;
		Попытка
			СообщенияДиалога = ИИА_ВызовСервера.ПолучитьСообщенияДиалога(ТекущийДиалог, 100);
			Для Каждого Сообщение Из СообщенияДиалога Цикл
				// Если это системное сообщение об ошибке DSL и оно относится к тому же DSL
				Если Сообщение.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система") 
					И Сообщение.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
					И СтрНайти(Сообщение.Текст, "Ошибка выполнения DSL") > 0 Тогда
					КоличествоПопытокИсправления = КоличествоПопытокИсправления + 1;
				КонецЕсли;
			КонецЦикла;
		Исключение
			КоличествоПопытокИсправления = 0;
		КонецПопытки;
		
		МаксимальноеКоличествоПопытокИсправления = 3;
		
		Если КоличествоПопытокИсправления >= МаксимальноеКоличествоПопытокИсправления Тогда
			// Превышен лимит попыток исправления - генерируем новый DSL
			ДобавитьВЛог("Система", "Превышен лимит попыток исправления DSL (" + Формат(МаксимальноеКоличествоПопытокИсправления, "ЧН=0") + "). Генерирую новый DSL-сценарий...");
			
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Превышен лимит попыток исправления DSL. Генерирую новый DSL-сценарий...",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
			);
			
			// Получаем все невыполненные задачи
			НевыполненныеЗадачи = ИИА_ВызовСервера.ПолучитьНевыполненныеЗадачиПользователя(ТекущийДиалог);
			Если НевыполненныеЗадачи.Найдено Тогда
				ТекстЗадач = НевыполненныеЗадачи.ТекстЗадач;
			Иначе
				ТекстЗадач = ПервоеСообщениеПользователя.Текст;
			КонецЕсли;
			
			ПромптПродолжения = "Задача пользователя еще не выполнена полностью. " + Символы.ПС +
				"Задачи пользователя: " + ТекстЗадач + Символы.ПС +
				"Предыдущие попытки выполнения DSL завершились с ошибками. " +
				"Сгенерируй новый DSL-сценарий для выполнения задачи. " +
				"Учти результаты предыдущих попыток из истории диалога.";
			
			ДобавитьВЛог("Система", "Отправляю запрос на генерацию нового DSL", Новый Структура("Промпт", ПромптПродолжения));
			
			ОтветИИ = ИИА_ВызовСервера.ВызватьИИССистемнымСообщением(ТекущийДиалог, "Чат", ПромптПродолжения);
			
			Если ОтветИИ <> Неопределено Тогда
				ДобавитьПромптВЛог(ОтветИИ);
				
				// Логируем ответ ИИ
				Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
					ДобавитьВЛог("Ответ ИИ (новый DSL)", "Получен новый DSL-сценарий", Новый Структура("DSL", ОтветИИ.DSL));
				ИначеЕсли ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
					ДобавитьВЛог("Ответ ИИ (новый DSL)", ОтветИИ.Текст);
				КонецЕсли;
				
				// Извлекаем DSL из ответа
				НовыйDSL = "";
				Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
					НовыйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.DSL);
				КонецЕсли;
				Если ПустаяСтрока(НовыйDSL) И ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
					НовыйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.Текст);
				КонецЕсли;
				
				Если НЕ ПустаяСтрока(НовыйDSL) Тогда
					ДобавитьВЛог("Система", "Выполняю новый DSL-сценарий", Новый Структура("DSL", НовыйDSL));
					
					// Выполняем новый DSL
					РезультатНовогоДSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, НовыйDSL);
					
					// Логируем результат выполнения нового DSL
					Если РезультатНовогоДSL <> Неопределено Тогда
						ДанныеРезультата = Новый Структура;
						ДанныеРезультата.Вставить("Успех", РезультатНовогоДSL.Успех);
						Если НЕ РезультатНовогоДSL.Успех Тогда
							ДанныеРезультата.Вставить("Ошибка", РезультатНовогоДSL.Сообщение);
						КонецЕсли;
						ДобавитьВЛог("Результат выполнения нового DSL", РезультатНовогоДSL.Сообщение, ДанныеРезультата);
					КонецЕсли;
					
					ОбновитьСообщения();
					ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
				Иначе
					ДобавитьВЛог("Ошибка", "Не удалось извлечь DSL из ответа ИИ.");
					ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
						ТекущийДиалог,
						"Не удалось извлечь DSL из ответа ИИ.",
						ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
					);
					ОбновитьСообщения();
				КонецЕсли;
			Иначе
				ДобавитьВЛог("Ошибка", "Не удалось получить новый DSL от ИИ.");
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Не удалось получить новый DSL от ИИ.",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
				);
				ОбновитьСообщения();
			КонецЕсли;
			
			Возврат;
		КонецЕсли;
		
		ДобавитьВЛог("Система", "Обнаружена ошибка выполнения DSL. Начинаю исправление (попытка " + Формат(КоличествоПопытокИсправления + 1, "ЧН=0") + " из " + Формат(МаксимальноеКоличествоПопытокИсправления, "ЧН=0") + ")...", Новый Структура("DSL", ПоследнееDSLСообщение.ТекстКода));
		
		// Проверяем лимит токенов перед исправлением
		ОбщееКоличествоТокенов = ИИА_ВызовСервера.ПолучитьОбщееКоличествоТокенов(ТекущийДиалог);
		Если ОбщееКоличествоТокенов >= МаксимальноеКоличествоТокенов Тогда
			СтрокаСтатуса = "Достигнут лимит токенов. Остановка исправления.";
			ДобавитьВЛог("Система", "Достигнут лимит токенов. Исправление DSL остановлено.", Новый Структура("Токенов", ОбщееКоличествоТокенов, "Лимит", МаксимальноеКоличествоТокенов));
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Достигнут лимит токенов (" + Формат(МаксимальноеКоличествоТокенов, "ЧН=0") + "). Исправление DSL остановлено.",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
			);
			ОбновитьСообщения();
			Возврат;
		КонецЕсли;
		
		СтрокаСтатуса = "Исправляю DSL-сценарий...";
		
		// Получаем текст последней ошибки из системных сообщений
		ТекстОшибки = "";
		Попытка
			СообщенияДиалога = ИИА_ВызовСервера.ПолучитьСообщенияДиалога(ТекущийДиалог, 20);
			Для Индекс = СообщенияДиалога.ВГраница() По 0 Шаг -1 Цикл
				Сообщение = СообщенияДиалога[Индекс];
				Если Сообщение.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система") 
					И Сообщение.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
					И СтрНайти(Сообщение.Текст, "Ошибка выполнения DSL") > 0 Тогда
					ТекстОшибки = Сообщение.Текст;
					Прервать;
				КонецЕсли;
			КонецЦикла;
		Исключение
			ТекстОшибки = "Ошибка выполнения DSL";
		КонецПопытки;
		
		ПромптИсправления = "Исправь следующий DSL-сценарий, который вызвал ошибку:" + Символы.ПС +
			"Ошибка: " + ТекстОшибки + Символы.ПС +
			"Исходный DSL-сценарий:" + Символы.ПС +
			ПоследнееDSLСообщение.ТекстКода + Символы.ПС +
			Символы.ПС +
			"ВАЖНО о правильных параметрах:" + Символы.ПС +
			"- GetObjectFields требует: {""action"": ""GetObjectFields"", ""object_name"": ""Имя"", ""object_type"": ""Справочник""} (НЕ ""objectClass"", ""class"", ""params""!)" + Символы.ПС +
			"- SetField требует: {""action"": ""SetField"", ""field_name"": ""Имя"", ""value"": значение} (НЕ ""field"", ""fieldName""!)" + Символы.ПС +
			"- SaveToStorage требует: {""action"": ""SaveToStorage"", ""key"": ""ключ"", ""data"": значение} (НЕ ""value"", ""params""!)" + Символы.ПС +
			"- НЕ используй несуществующие действия: While, For, ForEach, If, Increment и т.д.!" + Символы.ПС +
			"- Верни ТОЛЬКО исправленный JSON без дополнительных комментариев, объяснений или markdown блоков!";
		
		ДобавитьВЛог("Система", "Отправляю запрос на исправление DSL в ИИ", Новый Структура("Промпт", ПромптИсправления));
		
		ОтветИИ = ИИА_ВызовСервера.ИсправитьDSLЧерезИИ(ТекущийДиалог, ПромптИсправления);
		
		Если ОтветИИ <> Неопределено Тогда
			ДобавитьПромптВЛог(ОтветИИ);
			
			// Логируем ответ ИИ на исправление
			Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
				ДобавитьВЛог("Ответ ИИ (исправление)", "Получен исправленный DSL-сценарий", Новый Структура("DSL", ОтветИИ.DSL));
			ИначеЕсли ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
				ДобавитьВЛог("Ответ ИИ (исправление)", ОтветИИ.Текст);
			КонецЕсли;
			
			// Извлекаем DSL из ответа
			ИсправленныйDSL = "";
			Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
				ИсправленныйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.DSL);
			КонецЕсли;
			Если ПустаяСтрока(ИсправленныйDSL) И ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
				ИсправленныйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.Текст);
			КонецЕсли;
			
			Если НЕ ПустаяСтрока(ИсправленныйDSL) Тогда
				// Увеличиваем счетчик попыток исправления
				// (в будущем можно сохранять это в сообщении)
				
				ИИА_ВызовСервера.ОбновитьСтатусDSLВПоследнемСообщении(ТекущийДиалог, ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.Исправляется"));
				
				ДобавитьВЛог("Система", "Получен исправленный DSL-сценарий. Выполняю повторно...", Новый Структура("DSL", ИсправленныйDSL));
				
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Получен исправленный DSL-сценарий от ИИ. Выполняю повторно...",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
				);
				
				// Выполняем исправленный DSL
				РезультатИсправленногоDSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, ИсправленныйDSL);
				
				// Логируем результат выполнения исправленного DSL
				Если РезультатИсправленногоDSL <> Неопределено Тогда
					ДанныеРезультата = Новый Структура;
					ДанныеРезультата.Вставить("Успех", РезультатИсправленногоDSL.Успех);
					Если НЕ РезультатИсправленногоDSL.Успех Тогда
						ДанныеРезультата.Вставить("Ошибка", РезультатИсправленногоDSL.Сообщение);
						ДобавитьВЛог("Система", "Исправленный DSL выполнен с ошибкой. Продолжаю цикл исправления...", ДанныеРезультата);
						
						// Обновляем статус DSL на "ОбработанСОшибкой", чтобы оркестратор продолжил исправление
						ИИА_ВызовСервера.ОбновитьСтатусDSLВПоследнемСообщении(ТекущийДиалог, ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанСОшибкой"));
					Иначе
						ДобавитьВЛог("Система", "Исправленный DSL выполнен успешно. Обновляю статус и продолжаю проверку задачи...", ДанныеРезультата);
						
						// Обновляем статус DSL на "ОбработанУспешно", чтобы оркестратор продолжил проверку задачи
						ИИА_ВызовСервера.ОбновитьСтатусDSLВПоследнемСообщении(ТекущийДиалог, ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанУспешно"));
					КонецЕсли;
					ДобавитьВЛог("Результат выполнения исправленного DSL", РезультатИсправленногоDSL.Сообщение, ДанныеРезультата);
				КонецЕсли;
				
				ОбновитьСообщения();
				ДобавитьВЛог("Система", "Подключаю обработчик ожидания для продолжения планирования...");
				ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
			Иначе
				ДобавитьВЛог("Ошибка", "Не удалось извлечь исправленный DSL из ответа ИИ.");
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Не удалось извлечь исправленный DSL из ответа ИИ.",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
				);
				ОбновитьСообщения();
			КонецЕсли;
		Иначе
			ДобавитьВЛог("Ошибка", "Не удалось получить исправленный DSL от ИИ.");
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Не удалось получить исправленный DSL от ИИ.",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
			);
			ОбновитьСообщения();
		КонецЕсли;
		
		Возврат;
	ИначеЕсли СтатусDSL = ПредопределенноеЗначение("Перечисление.ИИА_СтатусDSL.ОбработанУспешно") Тогда
		// DSL выполнен успешно - проверяем задачу
		СтрокаСтатуса = "Проверяю выполнение задачи...";
		
		ДобавитьВЛог("Система", "DSL выполнен успешно. Начинаю проверку выполнения задачи...");
		
		// Получаем результат DSL без добавления сообщений (сообщения уже были добавлены при первом выполнении)
		// (в будущем можно сохранять результат DSL в диалоге)
		РезультатDSL = ИИА_ВызовСервера.ВыполнитьDSLСценарийБезСообщений(ПоследнееDSLСообщение.ТекстКода, ТекущийДиалог);
		
		// Если выполнение прошло успешно, проверяем задачу
		Если РезультатDSL.Успех Тогда
			// Получаем все невыполненные задачи и уточнения пользователя
			НевыполненныеЗадачи = ИИА_ВызовСервера.ПолучитьНевыполненныеЗадачиПользователя(ТекущийДиалог);
			
			Если НевыполненныеЗадачи.Найдено Тогда
				ТекстЗадачиДляПроверки = НевыполненныеЗадачи.ТекстЗадач;
				ДобавитьВЛог("Система", "Вызываю ИИ для проверки результата выполнения задачи", Новый Структура("Задача", ТекстЗадачиДляПроверки, "КоличествоЗадач", НевыполненныеЗадачи.КоличествоЗадач));
			Иначе
				// Если нет невыполненных задач, используем последнее сообщение как fallback
				ТекстЗадачиДляПроверки = ПоследнееСообщениеПользователя.Текст;
				Если ПустаяСтрока(ТекстЗадачиДляПроверки) Тогда
					ТекстЗадачиДляПроверки = ПервоеСообщениеПользователя.Текст;
				КонецЕсли;
				ДобавитьВЛог("Система", "Вызываю ИИ для проверки результата выполнения задачи", Новый Структура("Задача", ТекстЗадачиДляПроверки));
			КонецЕсли;
			
			ЗадачаВыполнена = ИИА_ВызовСервера.ПроверитьРезультатВыполненияЗадачи(
				ТекущийДиалог,
				ТекстЗадачиДляПроверки,
				РезультатDSL
			);
			
			ДобавитьВЛог("Система", "Результат проверки задачи", Новый Структура("ЗадачаВыполнена", ЗадачаВыполнена));
		Иначе
			// Если DSL не выполнился при повторной проверке, считаем задачу не выполненной
			ЗадачаВыполнена = Ложь;
			ДобавитьВЛог("Ошибка", "DSL не выполнился при повторной проверке", Новый Структура("Ошибка", РезультатDSL.Сообщение));
		КонецЕсли;
		
		ОбновитьСообщения();
		
		Если ЗадачаВыполнена Тогда
			// Задача выполнена - генерируем summary и завершаем
			СтрокаСтатуса = "Генерирую резюме...";
			ДобавитьВЛог("Система", "Задача выполнена успешно. Генерирую резюме выполненной работы...");
			
			Попытка
				ТекстSummary = ИИА_ВызовСервера.СгенерироватьSummary(ТекущийДиалог);
				
				Если НЕ ПустаяСтрока(ТекстSummary) Тогда
					// Сохраняем summary в диалог как системное сообщение
					ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
						ТекущийДиалог,
						"=== РЕЗЮМЕ ВЫПОЛНЕННОЙ РАБОТЫ ===" + Символы.ПС + Символы.ПС + ТекстSummary,
						ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
					);
					
					ДобавитьВЛог("Система", "Резюме сгенерировано и сохранено в диалог");
					ДобавитьВЛог("Резюме", ТекстSummary);
				Иначе
					ДобавитьВЛог("Ошибка", "Не удалось сгенерировать резюме");
				КонецЕсли;
				
			Исключение
				ДобавитьВЛог("Ошибка", "Ошибка при генерации резюме: " + ОписаниеОшибки());
			КонецПопытки;
			
			ОбновитьСообщения();
			СтрокаСтатуса = "Задача выполнена";
			ДобавитьВЛог("Система", "Завершаю обработку.");
			Возврат;
		Иначе
			// Задача не выполнена - генерируем новый DSL
			СтрокаСтатуса = "Генерирую дополнительный DSL-сценарий...";
			
			ДобавитьВЛог("Система", "Задача не выполнена полностью. Генерирую дополнительный DSL-сценарий...");
			
			ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
				ТекущийДиалог,
				"Задача не выполнена полностью. Генерирую дополнительный DSL-сценарий...",
				ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Текст")
			);
			
			// Получаем все невыполненные задачи
			НевыполненныеЗадачи = ИИА_ВызовСервера.ПолучитьНевыполненныеЗадачиПользователя(ТекущийДиалог);
			Если НевыполненныеЗадачи.Найдено Тогда
				ТекстЗадач = НевыполненныеЗадачи.ТекстЗадач;
			Иначе
				ТекстЗадач = ПервоеСообщениеПользователя.Текст;
			КонецЕсли;
			
			// Получаем информацию о хранилище для передачи в промпт
			ИнформацияОХранилище = "";
			Попытка
				КлючиХранилища = ИИА_ВызовСервера.ПолучитьКлючиХранилища(ТекущийДиалог);
				Если КлючиХранилища.Количество() > 0 Тогда
					ИнформацияОХранилище = "В хранилище уже сохранены следующие ключи: " + СтрСоединить(КлючиХранилища, ", ") + "." + Символы.ПС +
						"Используй LoadFromStorage для загрузки данных из хранилища и продолжения обработки с того места, где остановился предыдущий сценарий." + Символы.ПС;
				Иначе
					ИнформацияОХранилище = "Хранилище пусто. Если задача требует обработки большого количества объектов, начни с первого сценария: получи список объектов и сохрани его в хранилище." + Символы.ПС;
				КонецЕсли;
			Исключение
				ИнформацияОХранилище = "";
			КонецПопытки;
			
			ПромптПродолжения = "Задача пользователя еще не выполнена полностью. " + Символы.ПС +
				"Задачи пользователя: " + ТекстЗадач + Символы.ПС +
				Символы.ПС +
				"Информация о хранилище значений:" + Символы.ПС +
				ИнформацияОХранилище + Символы.ПС +
				"КРИТИЧЕСКИ ВАЖНО о продолжении выполнения задачи:" + Символы.ПС +
				"- НЕ используй LoadFromStorage для получения УИД напрямую!" + Символы.ПС +
				"- Вместо этого используй RunQuery с ПЕРВЫЕ N для получения конкретных УИД из базы данных!" + Символы.ПС +
				"- LoadFromStorage используй ТОЛЬКО для получения счетчика обработанных объектов (например, ""обработано_контрагентов"")" + Символы.ПС +
				"- Затем используй RunQuery с ПЕРВЫЕ 10 для получения следующих 10 объектов с их УИД" + Символы.ПС +
				"- Для каждого УИД из результата RunQuery явно перечисли шаги: FindReferenceByGUID -> SetField -> Write" + Символы.ПС +
				"- Используй РЕАЛЬНЫЕ УИД из результата RunQuery, а НЕ плейсхолдеры типа <уид1>, <уид2>, #УД# и т.д.!" + Символы.ПС +
				"- RunQuery возвращает массив структур, где каждая структура содержит поле УИД (строка)" + Символы.ПС +
				"- Обнови счетчик обработанных объектов в хранилище (увеличь на количество обработанных объектов)" + Символы.ПС +
				"- DSL НЕ поддерживает циклы (ForEach, While, For и т.д.) - нужно явно перечислить все шаги!" + Символы.ПС +
				"- Если в хранилище уже есть данные - это значит, что первый сценарий выполнен, продолжай обработку следующего пакета" + Символы.ПС +
				"- Если хранилище пусто - создай первый сценарий для подготовки данных" + Символы.ПС +
				Символы.ПС +
				"Сгенерируй DSL-сценарий для продолжения выполнения задачи. " +
				"Учти результаты предыдущих попыток из истории диалога и данные в хранилище.";
			
			ДобавитьВЛог("Система", "Отправляю запрос на генерацию дополнительного DSL", Новый Структура("Промпт", ПромптПродолжения));
			
			ОтветИИ = ИИА_ВызовСервера.ВызватьИИССистемнымСообщением(ТекущийДиалог, "Чат", ПромптПродолжения);
			
			Если ОтветИИ <> Неопределено Тогда
				ДобавитьПромптВЛог(ОтветИИ);
				
				// Логируем ответ ИИ
				Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
					ДобавитьВЛог("Ответ ИИ (продолжение)", "Получен новый DSL-сценарий", Новый Структура("DSL", ОтветИИ.DSL));
				ИначеЕсли ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
					ДобавитьВЛог("Ответ ИИ (продолжение)", ОтветИИ.Текст);
				КонецЕсли;
				
				// Извлекаем DSL из ответа
				НовыйDSL = "";
				Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
					НовыйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.DSL);
				КонецЕсли;
				Если ПустаяСтрока(НовыйDSL) И ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
					НовыйDSL = ИИА_ВызовСервера.ИзвлечьDSLИзОтвета(ОтветИИ.Текст);
				КонецЕсли;
				
				Если НЕ ПустаяСтрока(НовыйDSL) Тогда
					ДобавитьВЛог("Система", "Выполняю новый DSL-сценарий для продолжения задачи", Новый Структура("DSL", НовыйDSL));
					
					// Выполняем новый DSL
					РезультатНовогоДSL = ИИА_ВызовСервера.ВыполнитьDSLСценарий(ТекущийДиалог, НовыйDSL);
					
					// Логируем результат выполнения нового DSL
					Если РезультатНовогоДSL <> Неопределено Тогда
						ДанныеРезультата = Новый Структура;
						ДанныеРезультата.Вставить("Успех", РезультатНовогоДSL.Успех);
						Если НЕ РезультатНовогоДSL.Успех Тогда
							ДанныеРезультата.Вставить("Ошибка", РезультатНовогоДSL.Сообщение);
						КонецЕсли;
						ДобавитьВЛог("Результат выполнения нового DSL", РезультатНовогоДSL.Сообщение, ДанныеРезультата);
					КонецЕсли;
					
					ОбновитьСообщения();
					ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
				Иначе
					ДобавитьВЛог("Ошибка", "Не удалось извлечь DSL из ответа ИИ.");
					ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
						ТекущийДиалог,
						"Не удалось извлечь DSL из ответа ИИ.",
						ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
					);
					ОбновитьСообщения();
				КонецЕсли;
			Иначе
				ДобавитьВЛог("Ошибка", "Не удалось получить DSL от ИИ.");
				ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(
					ТекущийДиалог,
					"Не удалось получить DSL от ИИ.",
					ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка")
				);
				ОбновитьСообщения();
			КонецЕсли;
		КонецЕсли;
		
		Возврат;
	КонецЕсли;
	
	// Если статус не определен или другой - ждем
	ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 1);
	
КонецПроцедуры

&НаКлиенте
// Обновляет список сообщений на форме
//
Процедура ОбновитьСообщения()
	
	НовыеСообщения = ИИА_Клиент.ЗагрузитьСообщенияДиалога(ТекущийДиалог);
	
	// Очищаем существующую таблицу и заполняем новыми данными
	СообщенияФормы.Очистить();
	
	Для Каждого Строка Из НовыеСообщения Цикл
		
		НоваяСтрока = СообщенияФормы.Добавить();
		НоваяСтрока.Время = Строка.Время;
		НоваяСтрока.Автор = Строка.Автор;
		НоваяСтрока.ТипСообщения = Строка.ТипСообщения;
		НоваяСтрока.Текст = Строка.Текст;
		НоваяСтрока.ТекстКода = Строка.ТекстКода;
		НоваяСтрока.Статус = Строка.Статус;
		НоваяСтрока.UsageTokens = Строка.UsageTokens;
		
		// Заполняем СтатусDSL, если он есть в структуре
		Если Строка.Свойство("СтатусDSL") Тогда
			НоваяСтрока.СтатусDSL = Строка.СтатусDSL;
		КонецЕсли;
		
		// Заполняем ЗадачаВыполнена, если он есть в структуре
		Если Строка.Свойство("ЗадачаВыполнена") Тогда
			НоваяСтрока.ЗадачаВыполнена = Строка.ЗадачаВыполнена;
		Иначе
			НоваяСтрока.ЗадачаВыполнена = Ложь;
		КонецЕсли;
		
	КонецЦикла;
	
	// Прокручиваем к последнему сообщению
	Если СообщенияФормы.Количество() > 0 Тогда
		//СообщенияФормы.ТекущаяСтрока = СообщенияФормы[СообщенияФормы.Количество() - 1];
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
// Добавляет системное сообщение в диалог
//
// Параметры:
//  Текст - Строка - текст сообщения
//  ТипСообщения - ПеречислениеСсылка.ИИА_ТипСообщения - тип сообщения
//
Процедура ДобавитьСистемноеСообщение(Текст, ТипСообщения)
	
	ИИА_ВызовСервера.ДобавитьСистемноеСообщениеНаСервере(ТекущийДиалог, Текст, ТипСообщения);
	
КонецПроцедуры

&НаКлиенте
// Добавляет запись в лог с временной меткой
//
// Параметры:
//  ТипСобытия - Строка - тип события ("Запрос пользователя", "Ответ ИИ", "Система", "DSL выполнение", "Ошибка" и т.д.)
//  Текст - Строка - текст записи
//  ДополнительныеДанные - Структура - дополнительные данные (опционально)
//
Процедура ДобавитьВЛог(ТипСобытия, Текст, ДополнительныеДанные = Неопределено)
	
	ВремяСобытия = ТекущаяДата();
	ВремяСтрока = Формат(ВремяСобытия, "ДФ=dd.MM.yyyy HH:mm:ss");
	
	ЗаписьЛога = "[" + ВремяСтрока + "] [" + ТипСобытия + "]" + Символы.ПС + Текст;
	
	// Добавляем дополнительные данные, если они есть
	Если ДополнительныеДанные <> Неопределено Тогда
		Для Каждого КлючЗначение Из ДополнительныеДанные Цикл
			ЗаписьЛога = ЗаписьЛога + Символы.ПС + "  " + КлючЗначение.Ключ + ": " + Строка(КлючЗначение.Значение);
		КонецЦикла;
	КонецЕсли;
	
	// Добавляем разделитель
	ЗаписьЛога = ЗаписьЛога + Символы.ПС + Строка(Символы.ПС) + "---" + Строка(Символы.ПС);
	
	// Добавляем в лог
	Если ПустаяСтрока(Лог) Тогда
		Лог = ЗаписьЛога;
	Иначе
		Лог = Лог + Символы.ПС + ЗаписьЛога;
	КонецЕсли;
	
	// Сохраняем лог в справочник
	Если ТекущийДиалог <> Неопределено Тогда
		ИИА_ВызовСервера.СохранитьЛогДиалога(ТекущийДиалог, Лог);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
// Добавляет промпт в лог, не затирая историю
//
// Параметры:
//  Результат - Структура - результат от сервера, может содержать поле Промпт
//
Процедура ДобавитьПромптВЛог(Результат)
	
	Если Результат <> Неопределено И Результат.Свойство("Промпт") И НЕ ПустаяСтрока(Результат.Промпт) Тогда
		ДобавитьВЛог("Промпт ИИ", Результат.Промпт);
	КонецЕсли;

КонецПроцедуры

&НаКлиенте
// Создает и открывает табличный документ для просмотра результатов запроса
//
// Параметры:
//  ДанныеЗапроса - Массив - массив структур с данными запроса
//
Процедура СоздатьИОткрытьТабличныйДокумент(ДанныеЗапроса)
	
	Если ДанныеЗапроса = Неопределено Или ТипЗнч(ДанныеЗапроса) <> Тип("Массив") Или ДанныеЗапроса.Количество() = 0 Тогда
		ДобавитьВЛог("Ошибка", "Данные запроса пусты или неверного типа", Новый Структура(
			"ТипДанных", ?(ДанныеЗапроса = Неопределено, "Неопределено", Строка(ТипЗнч(ДанныеЗапроса))),
			"Количество", ?(ДанныеЗапроса = Неопределено, 0, ДанныеЗапроса.Количество())
		));
		Возврат;
	КонецЕсли;
	
	Попытка
		ДобавитьВЛог("Отладка", "Создаю табличный документ на сервере", Новый Структура(
			"КоличествоСтрок", ДанныеЗапроса.Количество()
		));
		
		// Создаем табличный документ на сервере
		ТабличныйДокумент = ИИА_ВызовСервера.СоздатьТабличныйДокументИзДанных(ДанныеЗапроса);
		
		Если ТабличныйДокумент = Неопределено Тогда
			ДобавитьВЛог("Ошибка", "Табличный документ не создан (вернул Неопределено)");
			Сообщить("Ошибка при создании табличного документа");
			Возврат;
		КонецЕсли;
		
		ДобавитьВЛог("Отладка", "Табличный документ создан, открываю", Новый Структура(
			"ТипОбъекта", Строка(ТипЗнч(ТабличныйДокумент))
		));
		
		// Открываем табличный документ
		ТабличныйДокумент.Показать();
		
		ДобавитьВЛог("Отладка", "Табличный документ открыт");
		
	Исключение
		ТекстОшибки = ОписаниеОшибки();
		ДобавитьВЛог("Ошибка", "Ошибка при создании табличного документа: " + ТекстОшибки);
		Сообщить("Ошибка при создании табличного документа: " + ТекстОшибки);
	КонецПопытки;
	
КонецПроцедуры

#КонецОбласти
