#Область ПрограммныйИнтерфейс

// Проверяет DSL JSON
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево - успешность проверки
//   * Сообщение - Строка - описание ошибки или пусто
//   * Сценарий - Структура - распарсенный сценарий (если успешно)
//
Функция ПроверитьDSL(DSLJSON) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Сценарий", Неопределено);
	
	// Проверяем, что JSON не пустой
	Если ПустаяСтрока(DSLJSON) Тогда
		Результат.Сообщение = "DSL JSON пуст";
		Возврат Результат;
	КонецЕсли;
	
	// Парсим JSON
	Попытка
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(DSLJSON);
		Сценарий = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
	Исключение
		
		Результат.Сообщение = "Ошибка парсинга JSON: " + ОписаниеОшибки();
		Возврат Результат;
		
	КонецПопытки;
	
	// Проверяем структуру сценария
	Если ТипЗнч(Сценарий) <> Тип("Структура") Тогда
		Результат.Сообщение = "Сценарий должен быть объектом JSON";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем версию DSL
	Если НЕ Сценарий.Свойство("dsl_version") Тогда
		Результат.Сообщение = "Отсутствует поле dsl_version";
		Возврат Результат;
	КонецЕсли;
	
	Если ТипЗнч(Сценарий.dsl_version) <> Тип("Число") Тогда
		Результат.Сообщение = "dsl_version должен быть числом";
		Возврат Результат;
	КонецЕсли;
	
	Если Сценарий.dsl_version <> 1 Тогда
		Результат.Сообщение = "Неподдерживаемая версия DSL: " + Формат(Сценарий.dsl_version, "ЧН=0");
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем наличие steps
	Если НЕ Сценарий.Свойство("steps") Тогда
		Результат.Сообщение = "Отсутствует поле steps";
		Возврат Результат;
	КонецЕсли;
	
	Если ТипЗнч(Сценарий.steps) <> Тип("Массив") Тогда
		Результат.Сообщение = "steps должен быть массивом";
		Возврат Результат;
	КонецЕсли;
	
	Если Сценарий.steps.Количество() = 0 Тогда
		Результат.Сообщение = "Массив steps пуст";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем каждый шаг
	Для Индекс = 0 По Сценарий.steps.Количество() - 1 Цикл
		
		Шаг = Сценарий.steps[Индекс];
		
		Если ТипЗнч(Шаг) <> Тип("Структура") Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + " должен быть объектом";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("action") Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + ": отсутствует поле action";
			Возврат Результат;
		КонецЕсли;
		
		Если ТипЗнч(Шаг.action) <> Тип("Строка") Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + ": action должен быть строкой";
			Возврат Результат;
		КонецЕсли;
		
		// Проверяем, что action в белом списке
		Если НЕ РазрешенныеДействия().Найти(Шаг.action) <> Неопределено Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + ": неизвестное действие '" + Шаг.action + "'";
			Возврат Результат;
		КонецЕсли;
		
		// Валидация конкретных действий
		РезультатВалидации = ВалидироватьШаг(Шаг, Индекс + 1);
		Если НЕ РезультатВалидации.Успех Тогда
			Результат.Сообщение = РезультатВалидации.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
	КонецЦикла;
	
	// Все проверки пройдены
	Результат.Успех = Истина;
	Результат.Сценарий = Сценарий;
	
	Возврат Результат;
	
КонецФункции

// Выполняет DSL команды
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог (опционально, для доступа к табличной части)
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево - успешность выполнения
//   * Сообщение - Строка - описание ошибки или пусто
//   * Результаты - Массив - массив результатов выполнения шагов
//
Функция ВыполнитьDSL(DSLJSON, СсылкаДиалога = Неопределено) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Результаты", Новый Массив);
	Результат.Вставить("СсылкиОбъектов", Новый Массив);
	
	// Сначала проверяем DSL
	РезультатПроверки = ПроверитьDSL(DSLJSON);
	
	Если НЕ РезультатПроверки.Успех Тогда
		Результат.Сообщение = РезультатПроверки.Сообщение;
		Возврат Результат;
	КонецЕсли;
	
	Сценарий = РезультатПроверки.Сценарий;
	
	// Создаем контекст выполнения
	КонтекстВыполнения = Новый Структура;
	
	// Добавляем ссылку на диалог в контекст, если она передана
	Если ЗначениеЗаполнено(СсылкаДиалога) Тогда
		КонтекстВыполнения.Вставить("СсылкаДиалога", СсылкаДиалога);
	КонецЕсли;
	
	// Флаг для отслеживания, был ли выполнен шаг Write
	БылВыполненWrite = Ложь;
	
	// Выполняем шаги
	Для Каждого Шаг Из Сценарий.steps Цикл
		
		//@skip-check query-in-loop
		РезультатШага = ВыполнитьШаг(Шаг, КонтекстВыполнения);
		Результат.Результаты.Добавить(РезультатШага);
		
		// Если это RunQuery, сохраняем данные запроса в результат DSL для создания табличного документа на клиенте
		Если Шаг.action = "RunQuery" И РезультатШага.Свойство("ДанныеЗапросаДляТаблицы") Тогда
			Результат.Вставить("ДанныеЗапросаДляТаблицы", РезультатШага.ДанныеЗапросаДляТаблицы);
			// Также устанавливаем флаг для автоматического открытия табличного документа
			Результат.Вставить("ОткрытьТабличныйДокумент", Истина);
		КонецЕсли;
		
		// Отслеживаем выполнение Write
		Если Шаг.action = "Write" Тогда
			БылВыполненWrite = Истина;
		КонецЕсли;
		
		// Если шаг завершился с ошибкой, останавливаем выполнение
		Если НЕ РезультатШага.Успех Тогда
			Результат.Сообщение = "Ошибка выполнения шага '" + Шаг.action + "': " + РезультатШага.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
	КонецЦикла;
	
	// Если был создан объект, но не был выполнен Write, записываем автоматически
	Если НЕ БылВыполненWrite И КонтекстВыполнения.Свойство("ТекущийОбъект") Тогда
		
		ТекущийОбъект = КонтекстВыполнения.ТекущийОбъект;
		ТипОбъекта = "";
		Если КонтекстВыполнения.Свойство("ТипОбъекта") Тогда
			ТипОбъекта = КонтекстВыполнения.ТипОбъекта;
		КонецЕсли;
		
		// Записываем объект, если это справочник или документ
		Если ТипОбъекта = "Справочник" Или ТипОбъекта = "Документ" Тогда
			
			Попытка
				
				// Пытаемся записать объект
				// Если объект уже записан, метод Записать() просто обновит его
				Если ТипОбъекта = "Справочник" Тогда
					ТекущийОбъект.Записать();
				Иначе
					// Для документов можно указать режим записи
					ТекущийОбъект.Записать();
				КонецЕсли;
				
				РезультатАвтозаписи = Новый Структура;
				РезультатАвтозаписи.Вставить("Успех", Истина);
				РезультатАвтозаписи.Вставить("Сообщение", "Объект автоматически записан");
				
				// Получаем ссылку после записи
				Попытка
					СсылкаОбъекта = ТекущийОбъект.Ссылка;
					РезультатАвтозаписи.Вставить("Данные", СсылкаОбъекта);
					// Сохраняем ссылку в массив всех ссылок (если она валидна)
					Если ЗначениеЗаполнено(СсылкаОбъекта) Тогда
						Попытка
							// Проверяем тип ссылки
							ТипСсылки = ТипЗнч(СсылкаОбъекта);
							СтрокаТипа = Строка(ТипСсылки);
							// Проверяем, является ли это ссылкой на справочник или документ
							Если СтрНайти(СтрокаТипа, "СправочникСсылка") > 0 Или СтрНайти(СтрокаТипа, "ДокументСсылка") > 0 Тогда
								// Проверяем, что такой ссылки еще нет в массиве
								Найдено = Ложь;
								Для Каждого СуществующаяСсылка Из Результат.СсылкиОбъектов Цикл
									Попытка
										Если СуществующаяСсылка = СсылкаОбъекта Тогда
											Найдено = Истина;
											Прервать;
										КонецЕсли;
									Исключение
										// Игнорируем ошибки сравнения
									КонецПопытки;
								КонецЦикла;
								Если НЕ Найдено Тогда
									Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
								КонецЕсли;
							Иначе
								// Если тип не распознан, все равно пытаемся добавить (на случай нестандартных типов)
								Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
							КонецЕсли;
						Исключение
							// Если не удалось проверить тип, все равно пытаемся добавить
							Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
						КонецПопытки;
					КонецЕсли;
				Исключение
					РезультатАвтозаписи.Вставить("Данные", Неопределено);
				КонецПопытки;
				
				Результат.Результаты.Добавить(РезультатАвтозаписи);
				
			Исключение
				
				// Если не удалось записать автоматически, добавляем информацию об ошибке
				РезультатОшибки = Новый Структура;
				РезультатОшибки.Вставить("Успех", Ложь);
				РезультатОшибки.Вставить("Сообщение", "Ошибка автоматической записи объекта: " + ОписаниеОшибки());
				РезультатОшибки.Вставить("Данные", Неопределено);
				Результат.Результаты.Добавить(РезультатОшибки);
				
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Собираем все ссылки на объекты из результатов шагов
	Для Каждого РезультатШага Из Результат.Результаты Цикл
		Если РезультатШага.Свойство("Данные") И ЗначениеЗаполнено(РезультатШага.Данные) Тогда
			ТипДанных = ТипЗнч(РезультатШага.Данные);
			СтрокаТипа = Строка(ТипДанных);
			// Проверяем, является ли это ссылкой на справочник или документ
			Если СтрНайти(СтрокаТипа, "СправочникСсылка") > 0 Или СтрНайти(СтрокаТипа, "ДокументСсылка") > 0 Тогда
				// Проверяем, что такой ссылки еще нет в массиве
				Найдено = Ложь;
				Для Каждого СуществующаяСсылка Из Результат.СсылкиОбъектов Цикл
					Если СуществующаяСсылка = РезультатШага.Данные Тогда
						Найдено = Истина;
						Прервать;
					КонецЕсли;
				КонецЦикла;
				Если НЕ Найдено Тогда
					Результат.СсылкиОбъектов.Добавить(РезультатШага.Данные);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Результат.Успех = Истина;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Возвращает массив разрешенных действий
//
// Возвращаемое значение:
//  Массив - массив строк с именами разрешенных действий
//
Функция РазрешенныеДействия()
	
	Действия = Новый Массив;
	Действия.Добавить("CreateDocument");
	Действия.Добавить("CreateReference");
	Действия.Добавить("FindReferenceByName");
	Действия.Добавить("SetField");
	Действия.Добавить("Write");
	Действия.Добавить("RunQuery");
	Действия.Добавить("ShowInfo");
	Действия.Добавить("GetChangedObjects");
	
	Возврат Действия;
	
КонецФункции

// Валидирует шаг сценария
//
// Параметры:
//  Шаг - Структура - структура шага
//  НомерШага - Число - номер шага (для сообщений об ошибках)
//
// Возвращаемое значение:
//  Структура - структура результата валидации:
//   * Успех - Булево
//   * Сообщение - Строка
//
Функция ВалидироватьШаг(Шаг, НомерШага)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Сообщение", "");
	
	Действие = Шаг.action;
	
	Если Действие = "CreateReference" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CreateReference требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ИИА_Метаданные.СуществуетСправочник(Шаг.object_name) Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": справочник '" + Шаг.object_name + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "CreateDocument" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CreateDocument требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ИИА_Метаданные.СуществуетДокумент(Шаг.object_name) Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": документ '" + Шаг.object_name + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "FindReferenceByName" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": FindReferenceByName требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		// Поддерживаем как name, так и value для обратной совместимости
		Если НЕ Шаг.Свойство("name") И НЕ Шаг.Свойство("value") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": FindReferenceByName требует поле name или value";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ИИА_Метаданные.СуществуетСправочник(Шаг.object_name) Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": справочник '" + Шаг.object_name + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "SetField" Тогда
		
		// Поддерживаем как field, так и field_name для обратной совместимости
		Если НЕ Шаг.Свойство("field") И НЕ Шаг.Свойство("field_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SetField требует поле field или field_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("value") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SetField требует поле value";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "RunQuery" Тогда
		
		Если НЕ Шаг.Свойство("query") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": RunQuery требует поле query";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "ShowInfo" Тогда
		
		Если НЕ Шаг.Свойство("message") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": ShowInfo требует поле message";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "GetChangedObjects" Тогда
		
		// GetChangedObjects не требует дополнительных параметров
		// Получает ссылки из табличной части ИзмененныеОбъекты диалога
		// Валидация успешна, если действие указано
		
	Иначе
		
		Результат.Успех = Ложь;
		Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": неизвестное действие '" + Действие + "'";
		Возврат Результат;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Выполняет один шаг сценария
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата выполнения:
//   * Успех - Булево
//   * Сообщение - Строка
//   * Данные - Произвольный - дополнительные данные результата
//
Функция ВыполнитьШаг(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Действие = Шаг.action;
	
	Попытка
		
		Если Действие = "CreateReference" Тогда
			
			Результат = ВыполнитьCreateReference(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "CreateDocument" Тогда
			
			Результат = ВыполнитьCreateDocument(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "FindReferenceByName" Тогда
			
			Результат = ВыполнитьFindReferenceByName(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "SetField" Тогда
			
			Результат = ВыполнитьSetField(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "Write" Тогда
			
			Результат = ВыполнитьWrite(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "RunQuery" Тогда
			
			Результат = ВыполнитьRunQuery(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "ShowInfo" Тогда
			
			Результат = ВыполнитьShowInfo(Шаг, КонтекстВыполнения);
			
		ИначеЕсли Действие = "GetChangedObjects" Тогда
			
			Результат = ВыполнитьGetChangedObjects(Шаг, КонтекстВыполнения);
			
		Иначе
			
			Результат.Сообщение = "Неизвестное действие: " + Действие;
			
		КонецЕсли;
		
	Исключение
		
		Результат.Сообщение = "Ошибка выполнения шага '" + Действие + "': " + ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие CreateReference
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьCreateReference(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяСправочника = Шаг.object_name;
	
	// Получаем менеджер справочника
	МенеджерСправочника = Справочники[ИмяСправочника];
	
	Если МенеджерСправочника = Неопределено Тогда
		Результат.Сообщение = "Не удалось получить менеджер справочника '" + ИмяСправочника + "'";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем, не указано ли наименование в data - если да, проверяем существование объекта в табличной части диалога
	НаименованиеДляПоиска = "";
	Если Шаг.Свойство("data") И ТипЗнч(Шаг.data) = Тип("Структура") И Шаг.data.Свойство("Наименование") Тогда
		НаименованиеДляПоиска = СокрЛП(Строка(Шаг.data.Наименование));
	КонецЕсли;
	
	// Если указано наименование и есть ссылка на диалог, проверяем наличие объекта в табличной части ИзмененныеОбъекты
	Если НЕ ПустаяСтрока(НаименованиеДляПоиска) И КонтекстВыполнения.Свойство("СсылкаДиалога") Тогда
		Попытка
			СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
			Диалог = СсылкаДиалога.ПолучитьОбъект();
			
			// Ищем объект в табличной части ИзмененныеОбъекты с таким наименованием
			НайденОбъект = Ложь;
			Для Каждого СтрокаИзмененных Из Диалог.ИзмененныеОбъекты Цикл
				Попытка
					СсылкаОбъекта = СтрокаИзмененных.СсылкаНаОбъект;
					Если ТипЗнч(СсылкаОбъекта) = Тип("СправочникСсылка") Тогда
						МетаданныеОбъекта = СсылкаОбъекта.Метаданные();
						Если МетаданныеОбъекта.Имя = ИмяСправочника Тогда
							ОбъектДляПроверки = СсылкаОбъекта.ПолучитьОбъект();
							Если ОбъектДляПроверки <> Неопределено Тогда
								НаименованиеОбъекта = СокрЛП(Строка(ОбъектДляПроверки.Наименование));
								Если НаименованиеОбъекта = НаименованиеДляПоиска Тогда
									// Найден существующий элемент в диалоге
									НовыйЭлемент = ОбъектДляПроверки;
									Результат.Сообщение = "Найден существующий элемент справочника '" + ИмяСправочника + "' с наименованием '" + НаименованиеДляПоиска + "' в диалоге";
									НайденОбъект = Истина;
									Прервать;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				Исключение
					// Игнорируем ошибки при проверке
				КонецПопытки;
			КонецЦикла;
			
			Если НЕ НайденОбъект Тогда
				// Создаем новый элемент
				НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
				Результат.Сообщение = "Создан элемент справочника '" + ИмяСправочника + "'";
			КонецЕсли;
		Исключение
			// Если не удалось проверить существование, создаем новый элемент
			НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
			Результат.Сообщение = "Создан элемент справочника '" + ИмяСправочника + "'";
		КонецПопытки;
	Иначе
		// Создаем новый элемент
		НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
		Результат.Сообщение = "Создан элемент справочника '" + ИмяСправочника + "'";
	КонецЕсли;
	
	// Если в шаге есть поле data, устанавливаем значения полей
	Если Шаг.Свойство("data") И ТипЗнч(Шаг.data) = Тип("Структура") Тогда
		
		Для Каждого ПараКлючЗначение Из Шаг.data Цикл
			
			ИмяПоля = ПараКлючЗначение.Ключ;
			ЗначениеПоля = ПараКлючЗначение.Значение;
			
			Попытка
				УстановитьЗначениеРеквизита(НовыйЭлемент, ИмяПоля, ЗначениеПоля);
			Исключение
				Результат.Сообщение = "Ошибка установки поля '" + ИмяПоля + "': " + ОписаниеОшибки();
				Возврат Результат;
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Сохраняем ссылку на созданный элемент в контексте выполнения
	// (для последующих шагов SetField)
	КонтекстВыполнения.Вставить("ТекущийОбъект", НовыйЭлемент);
	КонтекстВыполнения.Вставить("ТипОбъекта", "Справочник");
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяСправочника);
	
	Результат.Успех = Истина;
	// Сообщение уже установлено выше
	СсылкаОбъекта = НовыйЭлемент.Ссылка;
	Результат.Данные = СсылкаОбъекта;
	// Сохраняем ссылку в контексте выполнения для последующего использования
	КонтекстВыполнения.Вставить("СсылкаОбъекта", СсылкаОбъекта);
	// Добавляем ссылку в массив всех ссылок (будет добавлено в общий результат позже)
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие CreateDocument
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьCreateDocument(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяДокумента = Шаг.object_name;
	
	// Получаем менеджер документа
	МенеджерДокумента = Документы[ИмяДокумента];
	
	Если МенеджерДокумента = Неопределено Тогда
		Результат.Сообщение = "Не удалось получить менеджер документа '" + ИмяДокумента + "'";
		Возврат Результат;
	КонецЕсли;
	
	// Создаем новый документ
	НовыйДокумент = МенеджерДокумента.СоздатьДокумент();
	
	// Если в шаге есть поле data, устанавливаем значения полей
	Если Шаг.Свойство("data") И ТипЗнч(Шаг.data) = Тип("Структура") Тогда
		
		Для Каждого ПараКлючЗначение Из Шаг.data Цикл
			
			ИмяПоля = ПараКлючЗначение.Ключ;
			ЗначениеПоля = ПараКлючЗначение.Значение;
			
			Попытка
				УстановитьЗначениеРеквизита(НовыйДокумент, ИмяПоля, ЗначениеПоля);
			Исключение
				Результат.Сообщение = "Ошибка установки поля '" + ИмяПоля + "': " + ОписаниеОшибки();
				Возврат Результат;
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Сохраняем ссылку на созданный документ в контексте выполнения
	КонтекстВыполнения.Вставить("ТекущийОбъект", НовыйДокумент);
	КонтекстВыполнения.Вставить("ТипОбъекта", "Документ");
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяДокумента);
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Создан документ '" + ИмяДокумента + "'";
	СсылкаОбъекта = НовыйДокумент.Ссылка;
	Результат.Данные = СсылкаОбъекта;
	// Сохраняем ссылку в контексте выполнения для последующего использования
	КонтекстВыполнения.Вставить("СсылкаОбъекта", СсылкаОбъекта);
	// Добавляем ссылку в массив всех ссылок (будет добавлено в общий результат позже)
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие FindReferenceByName
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьFindReferenceByName(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяСправочника = Шаг.object_name;
	
	// Поддерживаем как name, так и value для обратной совместимости
	Если Шаг.Свойство("name") Тогда
		ИмяДляПоиска = Шаг.name;
	ИначеЕсли Шаг.Свойство("value") Тогда
		ИмяДляПоиска = Шаг.value;
	Иначе
		Результат.Сообщение = "Поле name или value не указано";
		Возврат Результат;
	КонецЕсли;
	
	// Получаем менеджер справочника
	МенеджерСправочника = Справочники[ИмяСправочника];
	
	Если МенеджерСправочника = Неопределено Тогда
		Результат.Сообщение = "Не удалось получить менеджер справочника '" + ИмяСправочника + "'";
		Возврат Результат;
	КонецЕсли;
	
	// Ищем по наименованию
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Элементы.Ссылка
	|ИЗ
	|	Справочник." + ИмяСправочника + " КАК Элементы
	|ГДЕ
	|	Элементы.Наименование = &Наименование";
	
	Запрос.УстановитьПараметр("Наименование", ИмяДляПоиска);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Результат.Сообщение = "Элемент справочника '" + ИмяСправочника + "' с наименованием '" + ИмяДляПоиска + "' не найден";
		Возврат Результат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	
	НайденнаяСсылка = Выборка.Ссылка;
	
	// Сохраняем найденный элемент в контексте выполнения
	КонтекстВыполнения.Вставить("ТекущийОбъект", НайденнаяСсылка.ПолучитьОбъект());
	КонтекстВыполнения.Вставить("ТипОбъекта", "Справочник");
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяСправочника);
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Найден элемент справочника '" + ИмяСправочника + "' с наименованием '" + ИмяДляПоиска + "'";
	Результат.Данные = НайденнаяСсылка;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие SetField
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьSetField(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	// Проверяем наличие текущего объекта в контексте
	Если НЕ КонтекстВыполнения.Свойство("ТекущийОбъект") Тогда
		Результат.Сообщение = "Нет текущего объекта для установки поля. Используйте CreateReference, CreateDocument или FindReferenceByName перед SetField";
		Возврат Результат;
	КонецЕсли;
	
	ТекущийОбъект = КонтекстВыполнения.ТекущийОбъект;
	ТипОбъекта = КонтекстВыполнения.ТипОбъекта;
	ИмяОбъекта = КонтекстВыполнения.ИмяОбъекта;
	
	// Поддерживаем как field, так и field_name для обратной совместимости
	Если Шаг.Свойство("field") Тогда
		ИмяПоля = Шаг.field;
	ИначеЕсли Шаг.Свойство("field_name") Тогда
		ИмяПоля = Шаг.field_name;
	Иначе
		Результат.Сообщение = "Поле field или field_name не указано";
		Возврат Результат;
	КонецЕсли;
	
	Значение = Шаг.value;
	
	// Проверяем существование реквизита
	Если ТипОбъекта = "Справочник" Тогда
		
		Если НЕ ИИА_Метаданные.СуществуетРеквизитСправочника(ИмяОбъекта, ИмяПоля) Тогда
			Результат.Сообщение = "Реквизит '" + ИмяПоля + "' не найден в справочнике '" + ИмяОбъекта + "'";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли ТипОбъекта = "Документ" Тогда
		
		Если НЕ ИИА_Метаданные.СуществуетРеквизитДокумента(ИмяОбъекта, ИмяПоля) Тогда
			Результат.Сообщение = "Реквизит '" + ИмяПоля + "' не найден в документе '" + ИмяОбъекта + "'";
			Возврат Результат;
		КонецЕсли;
		
	КонецЕсли;
	
	// Устанавливаем значение поля
	Попытка
		
		УстановитьЗначениеРеквизита(ТекущийОбъект, ИмяПоля, Значение);
		
	Исключение
		
		Результат.Сообщение = "Ошибка установки значения поля '" + ИмяПоля + "': " + ОписаниеОшибки();
		Возврат Результат;
		
	КонецПопытки;
	
	// Если устанавливается Наименование и объект еще не записан (новый), проверяем наличие в табличной части диалога
	Если ИмяПоля = "Наименование" И ТипОбъекта = "Справочник" И КонтекстВыполнения.Свойство("СсылкаДиалога") Тогда
		Попытка
			// Проверяем, записан ли объект (если ссылка пустая - объект новый)
			СсылкаТекущегоОбъекта = ТекущийОбъект.Ссылка;
			Если НЕ ЗначениеЗаполнено(СсылкаТекущегоОбъекта) Тогда
				// Объект еще не записан - проверяем наличие в табличной части диалога
				СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
				Диалог = СсылкаДиалога.ПолучитьОбъект();
				
				НаименованиеДляПоиска = СокрЛП(Строка(Значение));
				
				// Ищем объект в табличной части ИзмененныеОбъекты с таким наименованием
				Для Каждого СтрокаИзмененных Из Диалог.ИзмененныеОбъекты Цикл
					Попытка
						СсылкаОбъекта = СтрокаИзмененных.СсылкаНаОбъект;
						Если ТипЗнч(СсылкаОбъекта) = Тип("СправочникСсылка") Тогда
							МетаданныеОбъекта = СсылкаОбъекта.Метаданные();
							Если МетаданныеОбъекта.Имя = ИмяОбъекта Тогда
								ОбъектДляПроверки = СсылкаОбъекта.ПолучитьОбъект();
								Если ОбъектДляПроверки <> Неопределено Тогда
									НаименованиеОбъекта = СокрЛП(Строка(ОбъектДляПроверки.Наименование));
									Если НаименованиеОбъекта = НаименованиеДляПоиска Тогда
										// Найден существующий элемент в диалоге - используем его
										КонтекстВыполнения.Вставить("ТекущийОбъект", ОбъектДляПроверки);
										Результат.Сообщение = "Найден существующий элемент справочника '" + ИмяОбъекта + "' с наименованием '" + НаименованиеДляПоиска + "' в диалоге. Используется существующий объект.";
										Прервать;
									КонецЕсли;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
					Исключение
						// Игнорируем ошибки при проверке
					КонецПопытки;
				КонецЦикла;
			КонецЕсли;
		Исключение
			// Если не удалось проверить, продолжаем с текущим объектом
		КонецПопытки;
	КонецЕсли;
	
	Результат.Успех = Истина;
	Если ПустаяСтрока(Результат.Сообщение) Тогда
		Результат.Сообщение = "Установлено значение поля '" + ИмяПоля + "'";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие Write
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьWrite(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	// Проверяем наличие текущего объекта в контексте
	Если НЕ КонтекстВыполнения.Свойство("ТекущийОбъект") Тогда
		Результат.Сообщение = "Нет текущего объекта для записи. Используйте CreateReference, CreateDocument или FindReferenceByName перед Write";
		Возврат Результат;
	КонецЕсли;
	
	ТекущийОбъект = КонтекстВыполнения.ТекущийОбъект;
	
	// Записываем объект
	Попытка
		
		ТекущийОбъект.Записать();
		
	Исключение
		
		Результат.Сообщение = "Ошибка записи объекта: " + ОписаниеОшибки();
		Возврат Результат;
		
	КонецПопытки;
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Объект успешно записан";
	СсылкаОбъекта = ТекущийОбъект.Ссылка;
	Результат.Данные = СсылкаОбъекта;
	// Сохраняем ссылку в контексте выполнения для последующего использования
	КонтекстВыполнения.Вставить("СсылкаОбъекта", СсылкаОбъекта);
	// Добавляем ссылку в массив всех ссылок (будет добавлено в общий результат позже)
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие RunQuery
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьRunQuery(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ТекстЗапроса = Шаг.query;
	
	// Проверяем, что запрос не содержит опасных операций
	// (только SELECT разрешен)
	ТекстЗапросаВерхний = ВРег(ТекстЗапроса);
	
	Если СтрНайти(ТекстЗапросаВерхний, "ИЗМЕНИТЬ") > 0 
		ИЛИ СтрНайти(ТекстЗапросаВерхний, "УДАЛИТЬ") > 0 
		ИЛИ СтрНайти(ТекстЗапросаВерхний, "ВСТАВИТЬ") > 0 
		ИЛИ СтрНайти(ТекстЗапросаВерхний, "ОБНОВИТЬ") > 0 Тогда
		
		Результат.Сообщение = "Запрос содержит операции модификации данных. Разрешены только SELECT запросы";
		Возврат Результат;
		
	КонецЕсли;
	
	// Выполняем запрос
	Попытка
		
		Запрос = Новый Запрос(ТекстЗапроса);
		РезультатЗапроса = Запрос.Выполнить();
		
		// Сохраняем результат запроса для создания табличного документа на клиенте
		// (табличный документ нельзя передать между клиентом и сервером)
		КонтекстВыполнения.Вставить("РезультатЗапросаДляТаблицы", РезультатЗапроса);
		
		// Преобразуем результат в таблицу значений для совместимости
		ТаблицаРезультатов = РезультатЗапроса.Выгрузить();
		
		// Преобразуем таблицу значений в массив структур для передачи между клиентом и сервером
		МассивРезультатов = Новый Массив;
		Для Каждого СтрокаТаблицы Из ТаблицаРезультатов Цикл
			СтруктураСтроки = Новый Структура;
			Для Каждого Колонка Из ТаблицаРезультатов.Колонки Цикл
				ЗначениеКолонки = СтрокаТаблицы[Колонка.Имя];
				// Преобразуем значения в сериализуемые типы
				Если ТипЗнч(ЗначениеКолонки) = Тип("Строка") Или 
				   ТипЗнч(ЗначениеКолонки) = Тип("Число") Или 
				   ТипЗнч(ЗначениеКолонки) = Тип("Булево") Или 
				   ТипЗнч(ЗначениеКолонки) = Тип("Дата") Или
				   ЗначениеКолонки = Неопределено Тогда
					СтруктураСтроки.Вставить(Колонка.Имя, ЗначениеКолонки);
				Иначе
					// Для других типов преобразуем в строку
					Попытка
						СтруктураСтроки.Вставить(Колонка.Имя, Строка(ЗначениеКолонки));
					Исключение
						СтруктураСтроки.Вставить(Колонка.Имя, "");
					КонецПопытки;
				КонецЕсли;
			КонецЦикла;
			МассивРезультатов.Добавить(СтруктураСтроки);
		КонецЦикла;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Запрос выполнен успешно. Получено строк: " + Формат(ТаблицаРезультатов.Количество(), "ЧН=0");
		Результат.Данные = МассивРезультатов;
		
		// Сохраняем результат запроса в контексте выполнения для использования в последующих шагах
		КонтекстВыполнения.Вставить("РезультатЗапроса", МассивРезультатов);
		КонтекстВыполнения.Вставить("РезультатЗапросаДляТаблицы", МассивРезультатов);
		
		// Сохраняем данные запроса в результате для создания табличного документа на клиенте
		Результат.Вставить("ДанныеЗапросаДляТаблицы", МассивРезультатов);
		Результат.Вставить("ТипДействия", "RunQuery"); // Маркер для идентификации RunQuery
		Результат.Вставить("ЕстьРезультатЗапроса", Истина); // Флаг, что есть данные для табличного документа
		
		// Если результат простой (одна строка с одним значением), формируем удобное сообщение
		Если МассивРезультатов.Количество() = 1 Тогда
			ПерваяСтрока = МассивРезультатов[0];
			Если ПерваяСтрока.Количество() = 1 Тогда
				// Одно значение - формируем сообщение
				Для Каждого ПараКлючЗначение Из ПерваяСтрока Цикл
					ИмяКолонки = ПараКлючЗначение.Ключ;
					ЗначениеКолонки = ПараКлючЗначение.Значение;
					Результат.Сообщение = "Запрос выполнен. Результат: " + Строка(ЗначениеКолонки);
					// Сохраняем значение для использования в ShowInfo
					КонтекстВыполнения.Вставить(ИмяКолонки, ЗначениеКолонки);
					Прервать;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
	Исключение
		
		Результат.Сообщение = "Ошибка выполнения запроса: " + ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие ShowInfo
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (для подстановки значений из предыдущих шагов)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьShowInfo(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	
	Сообщение = Шаг.message;
	
	// Проверяем, есть ли результат запроса для создания табличного документа
	// Проверяем наличие результата запроса в контексте
	ЕстьРезультатЗапроса = Ложь;
	Если КонтекстВыполнения.Свойство("РезультатЗапроса") И КонтекстВыполнения.РезультатЗапроса <> Неопределено Тогда
		РезультатЗапроса = КонтекстВыполнения.РезультатЗапроса;
		Если ТипЗнч(РезультатЗапроса) = Тип("Массив") И РезультатЗапроса.Количество() > 0 Тогда
			ЕстьРезультатЗапроса = Истина;
		КонецЕсли;
	КонецЕсли;
	
	// Подставляем значения из контекста выполнения (результаты запросов)
	Если КонтекстВыполнения.Свойство("РезультатЗапроса") И КонтекстВыполнения.РезультатЗапроса <> Неопределено Тогда
		РезультатЗапроса = КонтекстВыполнения.РезультатЗапроса;
		Если ТипЗнч(РезультатЗапроса) = Тип("Массив") И РезультатЗапроса.Количество() > 0 Тогда
			ПерваяСтрока = РезультатЗапроса[0];
			Если ТипЗнч(ПерваяСтрока) = Тип("Структура") Тогда
				// Подставляем значения из результата запроса в сообщение
				Для Каждого ПараКлючЗначение Из ПерваяСтрока Цикл
					ИмяКолонки = ПараКлючЗначение.Ключ;
					ЗначениеКолонки = ПараКлючЗначение.Значение;
					Плейсхолдер = "{" + ИмяКолонки + "}";
					Если СтрНайти(Сообщение, Плейсхолдер) > 0 Тогда
						Сообщение = СтрЗаменить(Сообщение, Плейсхолдер, Строка(ЗначениеКолонки));
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Также подставляем значения, сохраненные напрямую в контексте
	Для Каждого ПараКлючЗначение Из КонтекстВыполнения Цикл
		ИмяПараметра = ПараКлючЗначение.Ключ;
		ЗначениеПараметра = ПараКлючЗначение.Значение;
		// Пропускаем служебные параметры
		Если ИмяПараметра = "ТекущийОбъект" Или 
		   ИмяПараметра = "ТипОбъекта" Или 
		   ИмяПараметра = "ИмяОбъекта" Или
		ИмяПараметра = "СсылкаДиалога" Или
		   ИмяПараметра = "РезультатЗапроса" Или
		   ИмяПараметра = "РезультатЗапросаДляТаблицы" Тогда
			Продолжить;
		КонецЕсли;
		Плейсхолдер = "{" + ИмяПараметра + "}";
		Если СтрНайти(Сообщение, Плейсхолдер) > 0 Тогда
			Сообщение = СтрЗаменить(Сообщение, Плейсхолдер, Строка(ЗначениеПараметра));
		КонецЕсли;
	КонецЦикла;
	
	Результат.Вставить("Сообщение", Сообщение);
	Результат.Вставить("Данные", Сообщение); // Сохраняем сообщение в Данные для идентификации ShowInfo
	Результат.Вставить("ТипДействия", "ShowInfo"); // Маркер для идентификации ShowInfo
	
	// Сохраняем флаг наличия результата запроса для создания табличного документа на клиенте
	Результат.Вставить("ЕстьРезультатЗапроса", ЕстьРезультатЗапроса);
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие GetChangedObjects
// Получает ссылки на объекты из табличной части ИзмененныеОбъекты диалога
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (должен содержать СсылкаДиалога)
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево
//   * Сообщение - Строка
//   * Данные - Массив - массив ссылок на объекты
//
Функция ВыполнитьGetChangedObjects(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Попытка
		
		// Проверяем наличие ссылки на диалог в контексте
		Если НЕ КонтекстВыполнения.Свойство("СсылкаДиалога") ИЛИ НЕ ЗначениеЗаполнено(КонтекстВыполнения.СсылкаДиалога) Тогда
			Результат.Сообщение = "Ссылка на диалог не передана в контекст выполнения";
			Возврат Результат;
		КонецЕсли;
		
		СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Получаем ссылки из табличной части ИзмененныеОбъекты
		МассивСсылок = Новый Массив;
		
		Для Каждого СтрокаИзмененныхОбъектов Из Диалог.ИзмененныеОбъекты Цикл
			Если ЗначениеЗаполнено(СтрокаИзмененныхОбъектов.СсылкаНаОбъект) Тогда
				МассивСсылок.Добавить(СтрокаИзмененныхОбъектов.СсылкаНаОбъект);
			КонецЕсли;
		КонецЦикла;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Получено объектов из табличной части: " + Формат(МассивСсылок.Количество(), "ЧН=0");
		Результат.Данные = МассивСсылок;
		
	Исключение
		Результат.Сообщение = "Ошибка получения объектов из табличной части: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Устанавливает значение реквизита объекта
//
// Параметры:
//  Объект - Произвольный - объект справочника или документа
//  ИмяРеквизита - Строка - имя реквизита
//  Значение - Произвольный - значение для установки
//
Процедура УстановитьЗначениеРеквизита(Объект, ИмяРеквизита, Значение)
	
	// В 1С объекты справочников и документов имеют типы вида СправочникОбъект.ИмяСправочника или ДокументОбъект.ИмяДокумента
	// Проверяем тип через строковое представление
	ТипОбъекта = ТипЗнч(Объект);
	СтрокаТипа = Строка(ТипОбъекта);
	
	// Проверяем, является ли объект справочником или документом
	Если СтрНайти(СтрокаТипа, "Справочник объект") > 0 
		ИЛИ СтрНайти(СтрокаТипа, "Документ объект") > 0 Тогда
		
		// Устанавливаем значение через индексатор
		Объект[ИмяРеквизита] = Значение;
		
	Иначе
		
		ВызватьИсключение "Неподдерживаемый тип объекта для установки реквизита: " + СтрокаТипа;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
