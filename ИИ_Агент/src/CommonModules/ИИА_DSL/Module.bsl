#Область ПрограммныйИнтерфейс

// Проверяет DSL JSON
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево - успешность проверки
//   * Сообщение - Строка - описание ошибки или пусто
//   * Сценарий - Структура - распарсенный сценарий (если успешно)
//
Функция ПроверитьDSL(DSLJSON) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Сценарий", Неопределено);
	
	// Проверяем, что JSON не пустой
	Если ПустаяСтрока(DSLJSON) Тогда
		Результат.Сообщение = "DSL JSON пуст";
		Возврат Результат;
	КонецЕсли;
	
	// Парсим JSON
	Попытка
		
		// ОЧИСТКА JSON от возможных галлюцинаций ИИ (markdown блоки, лишний текст)
		ЧистыйJSON = DSLJSON;
		
		// Убираем блоки ```json ... ```
		Если СтрНайти(ЧистыйJSON, "```json") > 0 Тогда
			ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "```json", "");
			Если СтрНайти(ЧистыйJSON, "```") > 0 Тогда
				ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "```", "");
			КонецЕсли;
		ИначеЕсли СтрНайти(ЧистыйJSON, "```") > 0 Тогда
			ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "```", "");
		КонецЕсли;
		
		// Удаляем возможные комментарии перед и после JSON, если ИИ их добавил
		// Ищем первый { и последний }
		ПозНачала = СтрНайти(ЧистыйJSON, "{");
		ПозКонца = СтрНайти(ЧистыйJSON, "}", НаправлениеПоиска.СКонца);
		
		Если ПозНачала > 0 И ПозКонца > ПозНачала Тогда
			ЧистыйJSON = Сред(ЧистыйJSON, ПозНачала, ПозКонца - ПозНачала + 1);
		КонецЕсли;
		
		// Заменяем все виды "умных" кавычек на стандартные
		ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "«", """");
		ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "»", """");
		ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "“", """");
		ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "”", """");
		ЧистыйJSON = СтрЗаменить(ЧистыйJSON, "„", """");
		
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ЧистыйJSON);
		Сценарий = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
	Исключение
		
		ТекстОшибки = ОписаниеОшибки();
		// Проверяем на наличие признаков использования кода в JSON
		Если СтрНайти(DSLJSON, " + ") > 0 ИЛИ СтрНайти(DSLJSON, "(") > 0 И СтрНайти(DSLJSON, ")") > 0 Тогда
			ТекстОшибки = ТекстОшибки + Символы.ПС + "ВЕРОЯТНАЯ ПРИЧИНА: Вы использовали конкатенацию строк или вызовы функций внутри JSON. Это ЗАПРЕЩЕНО. Используйте валидный JSON. Если нужны данные из предыдущего шага, сначала выполните его, дождитесь ответа системы, а затем используйте результат во втором шаге.";
		КонецЕсли;
		
		Результат.Сообщение = "Ошибка парсинга JSON: " + ТекстОшибки;
		Возврат Результат;
		
	КонецПопытки;
	
	// Проверяем структуру сценария
	Если ТипЗнч(Сценарий) <> Тип("Структура") Тогда
		Результат.Сообщение = "Сценарий должен быть объектом JSON";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем версию DSL
	Если НЕ Сценарий.Свойство("dsl_version") Тогда
		Результат.Сообщение = "Отсутствует поле dsl_version";
		Возврат Результат;
	КонецЕсли;
	
	Если ТипЗнч(Сценарий.dsl_version) <> Тип("Число") Тогда
		Результат.Сообщение = "dsl_version должен быть числом";
		Возврат Результат;
	КонецЕсли;
	
	Если Сценарий.dsl_version <> 1 Тогда
		Результат.Сообщение = "Неподдерживаемая версия DSL: " + Формат(Сценарий.dsl_version, "ЧН=0");
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем наличие steps
	Если НЕ Сценарий.Свойство("steps") Тогда
		Результат.Сообщение = "Отсутствует поле steps";
		Возврат Результат;
	КонецЕсли;
	
	Если ТипЗнч(Сценарий.steps) <> Тип("Массив") Тогда
		Результат.Сообщение = "steps должен быть массивом";
		Возврат Результат;
	КонецЕсли;
	
	Если Сценарий.steps.Количество() = 0 Тогда
		Результат.Сообщение = "Массив steps пуст";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем каждый шаг
	Для Индекс = 0 По Сценарий.steps.Количество() - 1 Цикл
		
		Шаг = Сценарий.steps[Индекс];
		
		Если ТипЗнч(Шаг) <> Тип("Структура") Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + " должен быть объектом";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("action") Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + ": отсутствует поле action";
			Возврат Результат;
		КонецЕсли;
		
		Если ТипЗнч(Шаг.action) <> Тип("Строка") Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + ": action должен быть строкой";
			Возврат Результат;
		КонецЕсли;
		
		// Проверяем, что action в белом списке
		Если НЕ РазрешенныеДействия().Найти(Шаг.action) <> Неопределено Тогда
			Результат.Сообщение = "Шаг " + Формат(Индекс + 1, "ЧН=0") + ": неизвестное действие '" + Шаг.action + "'";
			Возврат Результат;
		КонецЕсли;
		
		// Валидация конкретных действий
		РезультатВалидации = ВалидироватьШаг(Шаг, Индекс + 1);
		Если НЕ РезультатВалидации.Успех Тогда
			Результат.Сообщение = РезультатВалидации.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
	КонецЦикла;
	
	// Все проверки пройдены
	Результат.Успех = Истина;
	Результат.Сценарий = Сценарий;
	
	Возврат Результат;
	
КонецФункции

// Выполняет DSL команды
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог (опционально, для доступа к табличной части)
//  ТолькоЧтение - Булево - если Истина, запрещены действия изменения данных
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево - успешность выполнения
//   * Сообщение - Строка - описание ошибки или пусто
//   * Результаты - Массив - массив результатов выполнения шагов
//
Функция ВыполнитьDSL(DSLJSON, СсылкаДиалога = Неопределено, ТолькоЧтение = Ложь) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Результаты", Новый Массив);
	Результат.Вставить("СсылкиОбъектов", Новый Массив);
	
	// Сначала проверяем DSL
	РезультатПроверки = ПроверитьDSL(DSLJSON);
	
	Если НЕ РезультатПроверки.Успех Тогда
		Результат.Сообщение = РезультатПроверки.Сообщение;
		Возврат Результат;
	КонецЕсли;
	
	Сценарий = РезультатПроверки.Сценарий;
	
	// Если включен режим только чтение, проверяем наличие запрещенных действий
	Если ТолькоЧтение Тогда
		ДействияИзменения = ПолучитьДействияИзменения();
		Для Каждого Шаг Из Сценарий.steps Цикл
			Если ДействияИзменения.Найти(Шаг.action) <> Неопределено Тогда
				Результат.Сообщение = "Ошибка: Действие '" + Шаг.action + "' запрещено в режиме 'Только чтение' (диалог типа 'Запрос1С').";
				Возврат Результат;
			КонецЕсли;
			
			// Также проверяем вложенные шаги для ForEach
			Если Шаг.action = "ForEach" И Шаг.Свойство("steps") Тогда
				Для Каждого ВложенныйШаг Из Шаг.steps Цикл
					Если ДействияИзменения.Найти(ВложенныйШаг.action) <> Неопределено Тогда
						Результат.Сообщение = "Ошибка: Действие '" + ВложенныйШаг.action + "' во вложенном цикле запрещено в режиме 'Только чтение'.";
						Возврат Результат;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
	// Создаем контекст выполнения
	КонтекстВыполнения = Новый Структура;
	
	// Добавляем ссылку на диалог в контекст, если она передана
	Если ЗначениеЗаполнено(СсылкаДиалога) Тогда
		КонтекстВыполнения.Вставить("СсылкаДиалога", СсылкаДиалога);
	КонецЕсли;
	
	// Флаг для отслеживания, был ли выполнен шаг Write
	БылВыполненWrite = Ложь;
	
	// Выполняем шаги
	Для Каждого Шаг Из Сценарий.steps Цикл
		
		//@skip-check query-in-loop
		РезультатШага = ВыполнитьШаг(Шаг, КонтекстВыполнения);
		Результат.Результаты.Добавить(РезультатШага);
		
		// Если это RunQuery, сохраняем данные запроса в результат DSL для создания табличного документа на клиенте
		Если Шаг.action = "RunQuery" И РезультатШага.Свойство("ДанныеЗапросаДляТаблицы") Тогда
			Результат.Вставить("ДанныеЗапросаДляТаблицы", РезультатШага.ДанныеЗапросаДляТаблицы);
			// Также устанавливаем флаг для автоматического открытия табличного документа
			Результат.Вставить("ОткрытьТабличныйДокумент", Истина);
		КонецЕсли;
		
		// Отслеживаем выполнение Write
		Если Шаг.action = "Write" Тогда
			БылВыполненWrite = Истина;
		КонецЕсли;
		
		// Если шаг завершился с ошибкой, останавливаем выполнение
		Если НЕ РезультатШага.Успех Тогда
			Результат.Сообщение = "Ошибка выполнения шага '" + Шаг.action + "': " + РезультатШага.Сообщение;
			Возврат Результат;
		КонецЕсли;

		// Сохраняем ссылку в массиве всех ссылок (для возврата на клиент)
		Если КонтекстВыполнения.Свойство("СсылкаОбъекта") И ЗначениеЗаполнено(КонтекстВыполнения.СсылкаОбъекта) Тогда
			СсылкаОбъекта = КонтекстВыполнения.СсылкаОбъекта;
			
			// Проверяем, что такой ссылки еще нет в массиве
			Найдено = Ложь;
			Для Каждого СуществующаяСсылка Из Результат.СсылкиОбъектов Цикл
				Если СуществующаяСсылка = СсылкаОбъекта Тогда
					Найдено = Истина;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Если НЕ Найдено Тогда
				Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	// Если был создан объект, но не был выполнен Write, записываем автоматически
	Если НЕ БылВыполненWrite И КонтекстВыполнения.Свойство("ТекущийОбъект") Тогда
		
		ТекущийОбъект = КонтекстВыполнения.ТекущийОбъект;
		ТипОбъекта = "";
		Если КонтекстВыполнения.Свойство("ТипОбъекта") Тогда
			ТипОбъекта = КонтекстВыполнения.ТипОбъекта;
		КонецЕсли;
		
		// Записываем объект, если это справочник или документ
		Если ТипОбъекта = "Справочник" Или ТипОбъекта = "Документ" Тогда
			
			Попытка
				
				// Пытаемся записать объект
				// Если объект уже записан, метод Записать() просто обновит его
				Если ТипОбъекта = "Справочник" Тогда
					ТекущийОбъект.Записать();
				Иначе
					// Для документов можно указать режим записи
					ТекущийОбъект.Записать();
				КонецЕсли;
				
				РезультатАвтозаписи = Новый Структура;
				РезультатАвтозаписи.Вставить("Успех", Истина);
				РезультатАвтозаписи.Вставить("Сообщение", "Объект автоматически записан");
				
				// Получаем ссылку после записи
				Попытка
					СсылкаОбъекта = ТекущийОбъект.Ссылка;
					РезультатАвтозаписи.Вставить("Данные", СсылкаОбъекта);
					// Сохраняем ссылку в массив всех ссылок (если она валидна)
					Если ЗначениеЗаполнено(СсылкаОбъекта) Тогда
						Попытка
							// Проверяем тип ссылки
							ТипСсылки = ТипЗнч(СсылкаОбъекта);
							СтрокаТипа = Строка(ТипСсылки);
							// Проверяем, является ли это ссылкой на справочник или документ
							Если СтрНайти(СтрокаТипа, "СправочникСсылка") > 0 Или СтрНайти(СтрокаТипа, "ДокументСсылка") > 0 Тогда
								// Проверяем, что такой ссылки еще нет в массиве
								Найдено = Ложь;
								Для Каждого СуществующаяСсылка Из Результат.СсылкиОбъектов Цикл
									Попытка
										Если СуществующаяСсылка = СсылкаОбъекта Тогда
											Найдено = Истина;
											Прервать;
										КонецЕсли;
									Исключение
										// Игнорируем ошибки сравнения
									КонецПопытки;
								КонецЦикла;
								Если НЕ Найдено Тогда
									Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
								КонецЕсли;
							Иначе
								// Если тип не распознан, все равно пытаемся добавить (на случай нестандартных типов)
								Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
							КонецЕсли;
						Исключение
							// Если не удалось проверить тип, все равно пытаемся добавить
							Результат.СсылкиОбъектов.Добавить(СсылкаОбъекта);
						КонецПопытки;
					КонецЕсли;
				Исключение
					РезультатАвтозаписи.Вставить("Данные", Неопределено);
				КонецПопытки;
				
				Результат.Результаты.Добавить(РезультатАвтозаписи);
				
			Исключение
				
				// Если не удалось записать автоматически, добавляем информацию об ошибке
				РезультатОшибки = Новый Структура;
				РезультатОшибки.Вставить("Успех", Ложь);
				РезультатОшибки.Вставить("Сообщение", "Ошибка автоматической записи объекта: " + ОписаниеОшибки());
				РезультатОшибки.Вставить("Данные", Неопределено);
				Результат.Результаты.Добавить(РезультатОшибки);
				
			КонецПопытки;
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Собираем все ссылки на объекты из результатов шагов
	Для Каждого РезультатШага Из Результат.Результаты Цикл
		Если РезультатШага.Свойство("Данные") И ЗначениеЗаполнено(РезультатШага.Данные) Тогда
			
			ДанныеШага = РезультатШага.Данные;
			МассивДанных = Новый Массив;
			
			Если ТипЗнч(ДанныеШага) = Тип("Массив") Тогда
				МассивДанных = ДанныеШага;
			Иначе
				МассивДанных.Добавить(ДанныеШага);
			КонецЕсли;
			
			Для Каждого ЭлементДанных Из МассивДанных Цикл
				
				Если НЕ ЗначениеЗаполнено(ЭлементДанных) Тогда
					Продолжить;
				КонецЕсли;
				
				ТипДанных = ТипЗнч(ЭлементДанных);
				СтрокаТипа = Строка(ТипДанных);
				// Проверяем, является ли это ссылкой на справочник или документ
				Если СтрНайти(СтрокаТипа, "СправочникСсылка") > 0 Или СтрНайти(СтрокаТипа, "ДокументСсылка") > 0 Тогда
					// Проверяем, что такой ссылки еще нет в массиве
					Найдено = Ложь;
					Для Каждого СуществующаяСсылка Из Результат.СсылкиОбъектов Цикл
						Если СуществующаяСсылка = ЭлементДанных Тогда
							Найдено = Истина;
							Прервать;
						КонецЕсли;
					КонецЦикла;
					Если НЕ Найдено Тогда
						Результат.СсылкиОбъектов.Добавить(ЭлементДанных);
					КонецЕсли;
				КонецЕсли;
				
			КонецЦикла;
			
		КонецЕсли;
	КонецЦикла;
	
	Результат.Успех = Истина;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Возвращает массив действий, которые только читают данные
//
// Возвращаемое значение:
//  Массив - массив строк с именами действий
//
Функция ПолучитьДействияЧтения() Экспорт
	
	Действия = Новый Массив;
	Действия.Добавить("FindReferenceByName");
	Действия.Добавить("FindReferenceByGUID");
	Действия.Добавить("FindReferenceByURL");
	Действия.Добавить("RunQuery");
	Действия.Добавить("ShowInfo");
	Действия.Добавить("GetChangedObjects");
	Действия.Добавить("GetMetadata");
	Действия.Добавить("GetObjectFields");
	Действия.Добавить("CheckObjectExists");
	Действия.Добавить("SaveToStorage"); // Перенесено в чтение, так как это внутреннее хранилище
	Действия.Добавить("LoadFromStorage");
	Действия.Добавить("ForEach"); // Управляющая конструкция, сама по себе не меняет данные
	Действия.Добавить("SelectObject");
	
	Возврат Действия;
	
КонецФункции

// Возвращает массив действий, которые изменяют данные
//
// Возвращаемое значение:
//  Массив - массив строк с именами действий
//
Функция ПолучитьДействияИзменения() Экспорт
	
	Действия = Новый Массив;
	Действия.Добавить("CreateDocument");
	Действия.Добавить("CreateReference");
	Действия.Добавить("SetField");
	Действия.Добавить("Write");
	
	Возврат Действия;
	
КонецФункции

// Возвращает массив разрешенных действий
//
// Возвращаемое значение:
//  Массив - массив строк с именами разрешенных действий
//
Функция РазрешенныеДействия()
	
	Действия = ПолучитьДействияЧтения();
	ДействияИзменения = ПолучитьДействияИзменения();
	
	Для Каждого Действие Из ДействияИзменения Цикл
		Действия.Добавить(Действие);
	КонецЦикла;
	
	Возврат Действия;
	
КонецФункции

// Валидирует шаг сценария
//
// Параметры:
//  Шаг - Структура - структура шага
//  НомерШага - Число - номер шага (для сообщений об ошибках)
//
// Возвращаемое значение:
//  Структура - структура результата валидации:
//   * Успех - Булево
//   * Сообщение - Строка
//
Функция ВалидироватьШаг(Шаг, НомерШага)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	Результат.Вставить("Сообщение", "");
	
	Действие = Шаг.action;
	
	Если Действие = "CreateReference" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CreateReference требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ИИА_Метаданные.СуществуетСправочник(Шаг.object_name) Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": справочник '" + Шаг.object_name + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "CreateDocument" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CreateDocument требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ИИА_Метаданные.СуществуетДокумент(Шаг.object_name) Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": документ '" + Шаг.object_name + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "FindReferenceByName" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": FindReferenceByName требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		// Поддерживаем как name, так и value для обратной совместимости
		Если НЕ Шаг.Свойство("name") И НЕ Шаг.Свойство("value") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": FindReferenceByName требует поле name или value";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ИИА_Метаданные.СуществуетСправочник(Шаг.object_name) Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": справочник '" + Шаг.object_name + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "FindReferenceByGUID" Тогда
		
		Если НЕ Шаг.Свойство("guid") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": FindReferenceByGUID требует поле guid";
			Возврат Результат;
		КонецЕсли;
		
		// object_name не обязателен, так как функция НайтиСсылкуПоУИД сама определяет тип объекта
		
	ИначеЕсли Действие = "FindReferenceByURL" Тогда
		
		Если НЕ Шаг.Свойство("url") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": FindReferenceByURL требует поле url";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "SetField" Тогда
		
		// Поддерживаем как field, так и field_name для обратной совместимости
		Если НЕ Шаг.Свойство("field") И НЕ Шаг.Свойство("field_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SetField требует поле field или field_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("value") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SetField требует поле value";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "Write" Тогда
		
		// Write не требует дополнительных параметров
		// Записывает текущий объект, установленный через CreateReference, CreateDocument, FindReferenceByName, FindReferenceByGUID или FindReferenceByURL
		// Валидация успешна, если действие указано
		
	ИначеЕсли Действие = "RunQuery" Тогда
		
		Если НЕ Шаг.Свойство("query") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": RunQuery требует поле query";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "ShowInfo" Тогда
		
		Если НЕ Шаг.Свойство("message") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": ShowInfo требует поле message";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "GetChangedObjects" Тогда
		
		// GetChangedObjects не требует дополнительных параметров
		// Получает ссылки из табличной части ИзмененныеОбъекты диалога
		// Валидация успешна, если действие указано
		
	ИначеЕсли Действие = "GetMetadata" Тогда
		
		// GetMetadata не требует дополнительных параметров
		// Получает списки всех объектов метаданных (справочники, документы, регистры)
		// Валидация успешна, если действие указано
		
	ИначеЕсли Действие = "GetObjectFields" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": GetObjectFields требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("object_type") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": GetObjectFields требует поле object_type (Справочник или Документ)";
			Возврат Результат;
		КонецЕсли;
		
		Если Шаг.object_type <> "Справочник" И Шаг.object_type <> "Документ" Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": GetObjectFields.object_type должен быть 'Справочник' или 'Документ'";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "CheckObjectExists" Тогда
		
		Если НЕ Шаг.Свойство("object_name") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CheckObjectExists требует поле object_name";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("object_type") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CheckObjectExists требует поле object_type (Справочник или Документ)";
			Возврат Результат;
		КонецЕсли;
		
		Если Шаг.object_type <> "Справочник" И Шаг.object_type <> "Документ" Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": CheckObjectExists.object_type должен быть 'Справочник' или 'Документ'";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "SaveToStorage" Тогда
		
		Если НЕ Шаг.Свойство("key") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SaveToStorage требует поле key";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("data") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SaveToStorage требует поле data";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "LoadFromStorage" Тогда
		
		Если НЕ Шаг.Свойство("key") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": LoadFromStorage требует поле key";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли Действие = "ForEach" Тогда
		
		Если НЕ Шаг.Свойство("collection") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": ForEach требует поле collection";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Шаг.Свойство("steps") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": ForEach требует поле steps (массив действий)";
			Возврат Результат;
		КонецЕсли;
		
		Если ТипЗнч(Шаг.steps) <> Тип("Массив") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": поле steps в ForEach должно быть массивом";
			Возврат Результат;
		КонецЕсли;
		
		// Валидация вложенных шагов
		Для Индекс = 0 По Шаг.steps.Количество() - 1 Цикл
			ВнутреннийШаг = Шаг.steps[Индекс];
			ВнутреннийНомер = Строка(НомерШага) + "." + Формат(Индекс + 1, "ЧН=0");
			
			// Рекурсивная валидация, но с проверкой наличия поля action
			Если ТипЗнч(ВнутреннийШаг) <> Тип("Структура") Тогда
				Результат.Успех = Ложь;
				Результат.Сообщение = "Вложенный шаг " + ВнутреннийНомер + " должен быть объектом";
				Возврат Результат;
			КонецЕсли;
			
			Если НЕ ВнутреннийШаг.Свойство("action") Тогда
				Результат.Успех = Ложь;
				Результат.Сообщение = "Вложенный шаг " + ВнутреннийНомер + ": отсутствует поле action";
				Возврат Результат;
			КонецЕсли;
			
			РезультатВалидации = ВалидироватьШаг(ВнутреннийШаг, ВнутреннийНомер);
			Если НЕ РезультатВалидации.Успех Тогда
				Результат = РезультатВалидации;
				Возврат Результат;
			КонецЕсли;
		КонецЦикла;
		
	ИначеЕсли Действие = "SelectObject" Тогда
		
		// Поддержка как reference, так и object (для совместимости)
		Если НЕ Шаг.Свойство("reference") И НЕ Шаг.Свойство("object") Тогда
			Результат.Успех = Ложь;
			Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": SelectObject требует поле reference или object";
			Возврат Результат;
		КонецЕсли;
		
	Иначе
		
		Результат.Успех = Ложь;
		Результат.Сообщение = "Шаг " + Формат(НомерШага, "ЧН=0") + ": неизвестное действие '" + Действие + "'";
		Возврат Результат;
		
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Разрешает строковые параметры шага, содержащие шаблоны #(...)
//
// Параметры:
//  Шаг - Структура - исходный шаг
//  КонтекстВыполнения - Структура - контекст выполнения
//
// Возвращаемое значение:
//  Структура - шаг с разрешенными параметрами
//
Функция РазрешитьПараметрыШага(Шаг, КонтекстВыполнения)
	
	НовыйШаг = Новый Структура;
	
	Для Каждого КлючЗначение Из Шаг Цикл
		
		ИмяПараметра = КлючЗначение.Ключ;
		ЗначениеПараметра = КлючЗначение.Значение;
		
		// Пропускаем служебные поля и сложные структуры, которые обрабатываются отдельно
		Если ИмяПараметра = "action" 
			Или ИмяПараметра = "steps" // Для ForEach обрабатываем рекурсивно внутри ВыполнитьForEach
			Или ИмяПараметра = "parameters" // Для RunQuery обрабатывается внутри
			Или ИмяПараметра = "data" // Обрабатываем структуру data отдельно ниже
			Тогда
			
			НовыйШаг.Вставить(ИмяПараметра, ЗначениеПараметра);
			
		ИначеЕсли ИмяПараметра = "data" И ТипЗнч(ЗначениеПараметра) = Тип("Структура") Тогда
			
			// Рекурсивно обрабатываем структуру data
			НоваяData = Новый Структура;
			Для Каждого КлючЗначениеData Из ЗначениеПараметра Цикл
				НоваяData.Вставить(КлючЗначениеData.Ключ, ОбработатьЗначениеПараметра(КлючЗначениеData.Значение, КонтекстВыполнения));
			КонецЦикла;
			НовыйШаг.Вставить("data", НоваяData);
			
		Иначе
			
			// Обрабатываем значение
			НовыйШаг.Вставить(ИмяПараметра, ОбработатьЗначениеПараметра(ЗначениеПараметра, КонтекстВыполнения));
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат НовыйШаг;
	
КонецФункции

// Выполняет один шаг сценария
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата выполнения:
//   * Успех - Булево
//   * Сообщение - Строка
//   * Данные - Произвольный - дополнительные данные результата
//
Функция ВыполнитьШаг(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	// Разрешаем параметры перед выполнением (подстановка переменных контекста)
	ШагСПараметрами = РазрешитьПараметрыШага(Шаг, КонтекстВыполнения);
	Действие = ШагСПараметрами.action;
	
	Попытка
		
		Если Действие = "CreateReference" Тогда
			
			Результат = ВыполнитьCreateReference(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "CreateDocument" Тогда
			
			Результат = ВыполнитьCreateDocument(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "FindReferenceByName" Тогда
			
			Результат = ВыполнитьFindReferenceByName(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "FindReferenceByGUID" Тогда
			
			Результат = ВыполнитьFindReferenceByGUID(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "FindReferenceByURL" Тогда
			
			Результат = ВыполнитьFindReferenceByURL(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "SetField" Тогда
			
			Результат = ВыполнитьSetField(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "Write" Тогда
			
			Результат = ВыполнитьWrite(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "RunQuery" Тогда
			
			Результат = ВыполнитьRunQuery(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "ShowInfo" Тогда
			
			Результат = ВыполнитьShowInfo(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "GetChangedObjects" Тогда
			
			Результат = ВыполнитьGetChangedObjects(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "GetMetadata" Тогда
			
			Результат = ВыполнитьGetMetadata(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "GetObjectFields" Тогда
			
			Результат = ВыполнитьGetObjectFields(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "CheckObjectExists" Тогда
			
			Результат = ВыполнитьCheckObjectExists(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "SaveToStorage" Тогда
			
			Результат = ВыполнитьSaveToStorage(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "LoadFromStorage" Тогда
			
			Результат = ВыполнитьLoadFromStorage(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "ForEach" Тогда
			
			Результат = ВыполнитьForEach(ШагСПараметрами, КонтекстВыполнения);
			
		ИначеЕсли Действие = "SelectObject" Тогда
			
			Результат = ВыполнитьSelectObject(ШагСПараметрами, КонтекстВыполнения);
			
		Иначе
			
			Результат.Сообщение = "Неизвестное действие: " + Действие;
			
		КонецЕсли;
		
	Исключение
		
		Результат.Сообщение = "Ошибка выполнения шага '" + Действие + "': " + ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие CreateReference
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьCreateReference(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяСправочника = Шаг.object_name;
	
	// Получаем менеджер справочника
	МенеджерСправочника = Справочники[ИмяСправочника];
	
	Если МенеджерСправочника = Неопределено Тогда
		Результат.Сообщение = "Не удалось получить менеджер справочника '" + ИмяСправочника + "'";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем, не указано ли наименование в data - если да, проверяем существование объекта в табличной части диалога
	НаименованиеДляПоиска = "";
	Если Шаг.Свойство("data") И ТипЗнч(Шаг.data) = Тип("Структура") И Шаг.data.Свойство("Наименование") Тогда
		НаименованиеДляПоиска = СокрЛП(Строка(Шаг.data.Наименование));
	КонецЕсли;
	
	// Если указано наименование и есть ссылка на диалог, проверяем наличие объекта в табличной части ИзмененныеОбъекты
	Если НЕ ПустаяСтрока(НаименованиеДляПоиска) И КонтекстВыполнения.Свойство("СсылкаДиалога") Тогда
		Попытка
			СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
			Диалог = СсылкаДиалога.ПолучитьОбъект();
			
			// Ищем объект в табличной части ИзмененныеОбъекты с таким наименованием
			НайденОбъект = Ложь;
			Для Каждого СтрокаИзмененных Из Диалог.ИзмененныеОбъекты Цикл
				Попытка
					СсылкаОбъекта = СтрокаИзмененных.СсылкаНаОбъект;
					Если Справочники.ТипВсеСсылки().СодержитТип(ТипЗнч(СсылкаОбъекта)) Тогда
						МетаданныеОбъекта = СсылкаОбъекта.Метаданные();
						Если МетаданныеОбъекта.Имя = ИмяСправочника Тогда
							ОбъектДляПроверки = СсылкаОбъекта.ПолучитьОбъект();
							Если ОбъектДляПроверки <> Неопределено Тогда
								НаименованиеОбъекта = СокрЛП(Строка(ОбъектДляПроверки.Наименование));
								Если НаименованиеОбъекта = НаименованиеДляПоиска Тогда
									// Найден существующий элемент в диалоге
									НовыйЭлемент = ОбъектДляПроверки;
									Результат.Сообщение = "Найден существующий элемент справочника '" + ИмяСправочника + "' с наименованием '" + НаименованиеДляПоиска + "' в диалоге";
									НайденОбъект = Истина;
									Прервать;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				Исключение
					// Игнорируем ошибки при проверке
				КонецПопытки;
			КонецЦикла;
			
			Если НЕ НайденОбъект Тогда
				// Создаем новый элемент
				НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
				Результат.Сообщение = "Создан элемент справочника '" + ИмяСправочника + "'";
			КонецЕсли;
		Исключение
			// Если не удалось проверить существование, создаем новый элемент
			НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
			Результат.Сообщение = "Создан элемент справочника '" + ИмяСправочника + "'";
		КонецПопытки;
	Иначе
		// Создаем новый элемент
		НовыйЭлемент = МенеджерСправочника.СоздатьЭлемент();
		Результат.Сообщение = "Создан элемент справочника '" + ИмяСправочника + "'";
	КонецЕсли;
	
	// Если в шаге есть поле data, устанавливаем значения полей
	Если Шаг.Свойство("data") И ТипЗнч(Шаг.data) = Тип("Структура") Тогда
		
		Для Каждого ПараКлючЗначение Из Шаг.data Цикл
			
			ИмяПоля = ПараКлючЗначение.Ключ;
			ЗначениеПоля = ПараКлючЗначение.Значение;
			
			Попытка
				УстановитьЗначениеРеквизита(НовыйЭлемент, ИмяПоля, ЗначениеПоля);
			Исключение
				Результат.Сообщение = "Ошибка установки поля '" + ИмяПоля + "': " + ОписаниеОшибки();
				Возврат Результат;
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Сохраняем ссылку на созданный элемент в контексте выполнения
	// (для последующих шагов SetField)
	КонтекстВыполнения.Вставить("ТекущийОбъект", НовыйЭлемент);
	КонтекстВыполнения.Вставить("ТипОбъекта", "Справочник");
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяСправочника);
	
	Результат.Успех = Истина;
	// Сообщение уже установлено выше
	СсылкаОбъекта = НовыйЭлемент.Ссылка;
	Результат.Данные = СсылкаОбъекта;
	// Сохраняем ссылку в контексте выполнения для последующего использования
	КонтекстВыполнения.Вставить("СсылкаОбъекта", СсылкаОбъекта);
	// Добавляем ссылку в массив всех ссылок (будет добавлено в общий результат позже)
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие CreateDocument
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьCreateDocument(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяДокумента = Шаг.object_name;
	
	// Получаем менеджер документа
	МенеджерДокумента = Документы[ИмяДокумента];
	
	Если МенеджерДокумента = Неопределено Тогда
		Результат.Сообщение = "Не удалось получить менеджер документа '" + ИмяДокумента + "'";
		Возврат Результат;
	КонецЕсли;
	
	// Создаем новый документ
	НовыйДокумент = МенеджерДокумента.СоздатьДокумент();
	
	// Если в шаге есть поле data, устанавливаем значения полей
	Если Шаг.Свойство("data") И ТипЗнч(Шаг.data) = Тип("Структура") Тогда
		
		Для Каждого ПараКлючЗначение Из Шаг.data Цикл
			
			ИмяПоля = ПараКлючЗначение.Ключ;
			ЗначениеПоля = ПараКлючЗначение.Значение;
			
			Попытка
				УстановитьЗначениеРеквизита(НовыйДокумент, ИмяПоля, ЗначениеПоля);
			Исключение
				Результат.Сообщение = "Ошибка установки поля '" + ИмяПоля + "': " + ОписаниеОшибки();
				Возврат Результат;
			КонецПопытки;
			
		КонецЦикла;
		
	КонецЕсли;
	
	// Сохраняем ссылку на созданный документ в контексте выполнения
	КонтекстВыполнения.Вставить("ТекущийОбъект", НовыйДокумент);
	КонтекстВыполнения.Вставить("ТипОбъекта", "Документ");
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяДокумента);
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Создан документ '" + ИмяДокумента + "'";
	СсылкаОбъекта = НовыйДокумент.Ссылка;
	Результат.Данные = СсылкаОбъекта;
	// Сохраняем ссылку в контексте выполнения для последующего использования
	КонтекстВыполнения.Вставить("СсылкаОбъекта", СсылкаОбъекта);
	// Добавляем ссылку в массив всех ссылок (будет добавлено в общий результат позже)
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие FindReferenceByName
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьFindReferenceByName(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяСправочника = Шаг.object_name;
	
	// Поддерживаем как name, так и value для обратной совместимости
	Если Шаг.Свойство("name") Тогда
		ИмяДляПоиска = Шаг.name;
	ИначеЕсли Шаг.Свойство("value") Тогда
		ИмяДляПоиска = Шаг.value;
	Иначе
		Результат.Сообщение = "Поле name или value не указано";
		Возврат Результат;
	КонецЕсли;
	
	// Получаем менеджер справочника
	МенеджерСправочника = Справочники[ИмяСправочника];
	
	Если МенеджерСправочника = Неопределено Тогда
		Результат.Сообщение = "Не удалось получить менеджер справочника '" + ИмяСправочника + "'";
		Возврат Результат;
	КонецЕсли;
	
	// Ищем по наименованию
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Элементы.Ссылка
	|ИЗ
	|	Справочник." + ИмяСправочника + " КАК Элементы
	|ГДЕ
	|	Элементы.Наименование = &Наименование";
	
	Запрос.УстановитьПараметр("Наименование", ИмяДляПоиска);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Результат.Сообщение = "Элемент справочника '" + ИмяСправочника + "' с наименованием '" + ИмяДляПоиска + "' не найден";
		Возврат Результат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	
	НайденнаяСсылка = Выборка.Ссылка;
	
	// Сохраняем найденный элемент в контексте выполнения
	КонтекстВыполнения.Вставить("ТекущийОбъект", НайденнаяСсылка.ПолучитьОбъект());
	КонтекстВыполнения.Вставить("ТипОбъекта", "Справочник");
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяСправочника);
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Найден элемент справочника '" + ИмяСправочника + "' с наименованием '" + ИмяДляПоиска + "'";
	Результат.Данные = НайденнаяСсылка;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие FindReferenceByGUID
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьFindReferenceByGUID(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	УИДДляПоиска = Шаг.guid;
	
	// Используем функцию НайтиСсылкуПоУИД для поиска объекта
	НайденнаяСсылка = НайтиСсылкуПоУИД(УИДДляПоиска);
	
	Если НайденнаяСсылка = Неопределено Тогда
		Результат.Сообщение = "Объект с УИД '" + УИДДляПоиска + "' не найден";
		Возврат Результат;
	КонецЕсли;
	
	// Определяем тип объекта и его имя
	ТипОбъекта = "";
	ИмяОбъекта = "";
	
	Если Справочники.ТипВсеСсылки().СодержитТип(ТипЗнч(НайденнаяСсылка)) Тогда
		ТипОбъекта = "Справочник";
		ИмяОбъекта = НайденнаяСсылка.Метаданные().Имя;
	ИначеЕсли Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(НайденнаяСсылка)) Тогда
		ТипОбъекта = "Документ";
		ИмяОбъекта = НайденнаяСсылка.Метаданные().Имя;
	Иначе
		Результат.Сообщение = "Найден объект с УИД '" + УИДДляПоиска + "', но его тип не поддерживается";
		Возврат Результат;
	КонецЕсли;
	
	// Сохраняем найденный элемент в контексте выполнения
	КонтекстВыполнения.Вставить("ТекущийОбъект", НайденнаяСсылка.ПолучитьОбъект());
	КонтекстВыполнения.Вставить("ТипОбъекта", ТипОбъекта);
	КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяОбъекта);
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Найден объект '" + ИмяОбъекта + "' (тип: " + ТипОбъекта + ") с УИД '" + УИДДляПоиска + "'";
	Результат.Данные = НайденнаяСсылка;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие FindReferenceByURL
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьFindReferenceByURL(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	URLДляПоиска = Шаг.url;
	
	Попытка
		// Парсим навигационную ссылку
		// Формат: "e1cib/data/Справочник.Контрагенты?ref=УИД" или "e1cib/data/Документ.ЗаказКлиента?ref=УИД"
		
		ИмяОбъекта = "";
		ТипОбъекта = "";
		УИДОбъекта = "";
		
		// Определяем тип объекта (Справочник или Документ)
		Если СтрНайти(URLДляПоиска, "Справочник.") > 0 Тогда
			ТипОбъекта = "Справочник";
			НачалоИмени = СтрНайти(URLДляПоиска, "Справочник.") + 12;
			КонецИмени = СтрНайти(URLДляПоиска, "?", НачалоИмени);
			Если КонецИмени = 0 Тогда
				КонецИмени = СтрДлина(URLДляПоиска) + 1;
			КонецЕсли;
			ИмяОбъекта = Сред(URLДляПоиска, НачалоИмени, КонецИмени - НачалоИмени);
		ИначеЕсли СтрНайти(URLДляПоиска, "Документ.") > 0 Тогда
			ТипОбъекта = "Документ";
			НачалоИмени = СтрНайти(URLДляПоиска, "Документ.") + 9;
			КонецИмени = СтрНайти(URLДляПоиска, "?", НачалоИмени);
			Если КонецИмени = 0 Тогда
				КонецИмени = СтрДлина(URLДляПоиска) + 1;
			КонецЕсли;
			ИмяОбъекта = Сред(URLДляПоиска, НачалоИмени, КонецИмени - НачалоИмени);
		Иначе
			Результат.Сообщение = "Не удалось определить тип объекта из URL (ожидается Справочник. или Документ.)";
			Возврат Результат;
		КонецЕсли;
		
		// Извлекаем УИД из параметра ref=
		ПозицияRef = СтрНайти(URLДляПоиска, "ref=");
		Если ПозицияRef > 0 Тогда
			УИДОбъекта = Сред(URLДляПоиска, ПозицияRef + 4);
			// Убираем параметры после &
			ПозицияАмперсанда = СтрНайти(УИДОбъекта, "&");
			Если ПозицияАмперсанда > 0 Тогда
				УИДОбъекта = Лев(УИДОбъекта, ПозицияАмперсанда - 1);
			КонецЕсли;
			// Декодируем URL-кодирование
			УИДОбъекта = СтрЗаменить(УИДОбъекта, "%20", " ");
			УИДОбъекта = СтрЗаменить(УИДОбъекта, "%3D", "=");
		Иначе
			Результат.Сообщение = "Не найден параметр ref= в навигационной ссылке";
			Возврат Результат;
		КонецЕсли;
		
		// Ищем объект по УИД используя функцию НайтиСсылкуПоУИД
		НайденнаяСсылка = НайтиСсылкуПоУИД(УИДОбъекта);
		
		Если НайденнаяСсылка = Неопределено Тогда
			Результат.Сообщение = "Объект с УИД '" + УИДОбъекта + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
		// Определяем тип объекта и его имя из найденной ссылки
		Если Справочники.ТипВсеСсылки().СодержитТип(ТипЗнч(НайденнаяСсылка)) Тогда
			ТипОбъекта = "Справочник";
			ИмяОбъекта = НайденнаяСсылка.Метаданные().Имя;
		ИначеЕсли Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(НайденнаяСсылка)) Тогда
			ТипОбъекта = "Документ";
			ИмяОбъекта = НайденнаяСсылка.Метаданные().Имя;
		Иначе
			Результат.Сообщение = "Найден объект с УИД '" + УИДОбъекта + "', но его тип не поддерживается";
			Возврат Результат;
		КонецЕсли;
		
		// Сохраняем найденный элемент в контексте выполнения
		КонтекстВыполнения.Вставить("ТекущийОбъект", НайденнаяСсылка.ПолучитьОбъект());
		КонтекстВыполнения.Вставить("ТипОбъекта", ТипОбъекта);
		КонтекстВыполнения.Вставить("ИмяОбъекта", ИмяОбъекта);
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Найден объект '" + ИмяОбъекта + "' по навигационной ссылке (УИД: " + УИДОбъекта + ")";
		Результат.Данные = НайденнаяСсылка;
		
	Исключение
		Результат.Сообщение = "Ошибка при поиске объекта по URL: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие SetField
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьSetField(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	// Проверяем наличие текущего объекта в контексте
	Если НЕ КонтекстВыполнения.Свойство("ТекущийОбъект") Тогда
		Результат.Сообщение = "Нет текущего объекта для установки поля. Используйте CreateReference, CreateDocument или FindReferenceByName перед SetField";
		Возврат Результат;
	КонецЕсли;
	
	ТекущийОбъект = КонтекстВыполнения.ТекущийОбъект;
	ТипОбъекта = КонтекстВыполнения.ТипОбъекта;
	ИмяОбъекта = КонтекстВыполнения.ИмяОбъекта;
	
	// Поддерживаем как field, так и field_name для обратной совместимости
	Если Шаг.Свойство("field") Тогда
		ИмяПоля = Шаг.field;
	ИначеЕсли Шаг.Свойство("field_name") Тогда
		ИмяПоля = Шаг.field_name;
	Иначе
		Результат.Сообщение = "Поле field или field_name не указано";
		Возврат Результат;
	КонецЕсли;
	
	// Автоматическое исправление распространенных ошибок в именах реквизитов
	Если ИмяПоля = "ПометкаНаУдаление" Тогда
		ИмяПоля = "ПометкаУдаления";
	КонецЕсли;
	
	Значение = Шаг.value;
	
	// Проверяем существование реквизита
	Если ТипОбъекта = "Справочник" Тогда
		
		Если НЕ ИИА_Метаданные.СуществуетРеквизитСправочника(ИмяОбъекта, ИмяПоля) Тогда
			Результат.Сообщение = "Реквизит '" + ИмяПоля + "' не найден в справочнике '" + ИмяОбъекта + "'";
			Возврат Результат;
		КонецЕсли;
		
	ИначеЕсли ТипОбъекта = "Документ" Тогда
		
		Если НЕ ИИА_Метаданные.СуществуетРеквизитДокумента(ИмяОбъекта, ИмяПоля) Тогда
			Результат.Сообщение = "Реквизит '" + ИмяПоля + "' не найден в документе '" + ИмяОбъекта + "'";
			Возврат Результат;
		КонецЕсли;
		
	КонецЕсли;
	
	// Устанавливаем значение поля
	Попытка
		
		УстановитьЗначениеРеквизита(ТекущийОбъект, ИмяПоля, Значение);
		
	Исключение
		
		Результат.Сообщение = "Ошибка установки значения поля '" + ИмяПоля + "': " + ОписаниеОшибки();
		Возврат Результат;
		
	КонецПопытки;
	
	// Если устанавливается Наименование и объект еще не записан (новый), проверяем наличие в табличной части диалога
	Если ИмяПоля = "Наименование" И ТипОбъекта = "Справочник" И КонтекстВыполнения.Свойство("СсылкаДиалога") Тогда
		Попытка
			// Проверяем, записан ли объект (если ссылка пустая - объект новый)
			СсылкаТекущегоОбъекта = ТекущийОбъект.Ссылка;
			Если НЕ ЗначениеЗаполнено(СсылкаТекущегоОбъекта) Тогда
				// Объект еще не записан - проверяем наличие в табличной части диалога
				СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
				Диалог = СсылкаДиалога.ПолучитьОбъект();
				
				НаименованиеДляПоиска = СокрЛП(Строка(Значение));
				
				// Ищем объект в табличной части ИзмененныеОбъекты с таким наименованием
				Для Каждого СтрокаИзмененных Из Диалог.ИзмененныеОбъекты Цикл
					Попытка
						СсылкаОбъекта = СтрокаИзмененных.СсылкаНаОбъект;
						Если Справочники.ТипВсеСсылки().СодержитТип(ТипЗнч(СсылкаОбъекта)) Тогда
							МетаданныеОбъекта = СсылкаОбъекта.Метаданные();
							Если МетаданныеОбъекта.Имя = ИмяОбъекта Тогда
								ОбъектДляПроверки = СсылкаОбъекта.ПолучитьОбъект();
								Если ОбъектДляПроверки <> Неопределено Тогда
									НаименованиеОбъекта = СокрЛП(Строка(ОбъектДляПроверки.Наименование));
									Если НаименованиеОбъекта = НаименованиеДляПоиска Тогда
										// Найден существующий элемент в диалоге - используем его
										КонтекстВыполнения.Вставить("ТекущийОбъект", ОбъектДляПроверки);
										Результат.Сообщение = "Найден существующий элемент справочника '" + ИмяОбъекта + "' с наименованием '" + НаименованиеДляПоиска + "' в диалоге. Используется существующий объект.";
										Прервать;
									КонецЕсли;
								КонецЕсли;
							КонецЕсли;
						КонецЕсли;
					Исключение
						// Игнорируем ошибки при проверке
					КонецПопытки;
				КонецЦикла;
			КонецЕсли;
		Исключение
			// Если не удалось проверить, продолжаем с текущим объектом
		КонецПопытки;
	КонецЕсли;
	
	Результат.Успех = Истина;
	Если ПустаяСтрока(Результат.Сообщение) Тогда
		Результат.Сообщение = "Установлено значение поля '" + ИмяПоля + "'";
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие Write
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьWrite(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	// Проверяем наличие текущего объекта в контексте
	Если НЕ КонтекстВыполнения.Свойство("ТекущийОбъект") Тогда
		Результат.Сообщение = "Нет текущего объекта для записи. Используйте CreateReference, CreateDocument или FindReferenceByName перед Write";
		Возврат Результат;
	КонецЕсли;
	
	ТекущийОбъект = КонтекстВыполнения.ТекущийОбъект;
	
	// Записываем объект
	Попытка
		
		ТекущийОбъект.Записать();
		
	Исключение
		
		Результат.Сообщение = "Ошибка записи объекта: " + ОписаниеОшибки();
		Возврат Результат;
		
	КонецПопытки;
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Объект успешно записан";
	СсылкаОбъекта = ТекущийОбъект.Ссылка;
	Результат.Данные = СсылкаОбъекта;
	// Сохраняем ссылку в контексте выполнения для последующего использования
	КонтекстВыполнения.Вставить("СсылкаОбъекта", СсылкаОбъекта);
	// Добавляем ссылку в массив всех ссылок (будет добавлено в общий результат позже)
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие RunQuery
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьRunQuery(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ТекстЗапроса = Шаг.query;
	
	// --- АВТОКОРРЕКЦИЯ И ВАЛИДАЦИЯ ЗАПРОСА ---
	
	// 1. Исправляем распространенную ошибку ИИ: использование &"Литерал" или &«Литерал»
	// Также нормализуем кавычки, превращая их в стандартные двойные
	
	// Заменяем все нестандартные кавычки на стандартные двойные
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "«", """");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "»", """");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "“", """");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "”", """");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, Символ(171), """"); // «
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, Символ(187), """"); // »
	
	// Удаляем амперсанд перед кавычками (теперь все кавычки стандартные)
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "&""", """");
	ТекстЗапроса = СтрЗаменить(ТекстЗапроса, "& """, """");
	
	// 1.1. Исправляем попытки использования #(Value) для констант (галлюцинация ИИ)
	// Если внутри #(...) только цифры, заменяем на эти цифры
	ПозНачала = СтрНайти(ТекстЗапроса, "#(");
	Пока ПозНачала > 0 Цикл
		ПозКонца = СтрНайти(ТекстЗапроса, ")", НаправлениеПоиска.СВлевоНаправо, ПозНачала);
		Если ПозКонца > ПозНачала Тогда
			Содержимое = Сред(ТекстЗапроса, ПозНачала + 2, ПозКонца - ПозНачала - 2);
			// Проверяем, является ли содержимое числом
			ЯвляетсяЧислом = Истина;
			Для ИндексСимвола = 1 По СтрДлина(Содержимое) Цикл
				Символ = Сред(Содержимое, ИндексСимвола, 1);
				Если СтрНайти("0123456789.,", Символ) = 0 Тогда
					ЯвляетсяЧислом = Ложь;
					Прервать;
				КонецЕсли;
			КонецЦикла;
			
			Если ЯвляетсяЧислом Тогда
				ТекстЗапроса = Лев(ТекстЗапроса, ПозНачала - 1) + Содержимое + Сред(ТекстЗапроса, ПозКонца + 1);
				// Ищем следующее с новой позиции
				ПозНачала = СтрНайти(ТекстЗапроса, "#(", НаправлениеПоиска.СВлевоНаправо, ПозНачала);
			Иначе
				// Пропускаем, это может быть переменная
				ПозНачала = СтрНайти(ТекстЗапроса, "#(", НаправлениеПоиска.СВлевоНаправо, ПозКонца);
			КонецЕсли;
		Иначе
			Прервать;
		КонецЕсли;
	КонецЦикла;

	ТекстЗапросаВерхний = ВРег(ТекстЗапроса);
	ТекстБезПробелов = СтрЗаменить(ТекстЗапросаВерхний, " ", ""); // Для проверки функций без учета пробелов
	
	// 2. Проверка на использование недопустимых функций в запросе
	// Проверяем наличие скобки после имени функции, чтобы не реагировать на имена полей
	Если СтрНайти(ТекстБезПробелов, "СТРНАЙТИ(") > 0 
		ИЛИ СтрНайти(ТекстБезПробелов, "STRFIND(") > 0 
		ИЛИ СтрНайти(ТекстБезПробелов, "СТРНАЧИНАЕТСЯС(") > 0 
		ИЛИ СтрНайти(ТекстБезПробелов, "STRSTARTSWITH(") > 0 
		ИЛИ СтрНайти(ТекстБезПробелов, "ПОДОБИЕ(") > 0 
		ИЛИ СтрНайти(ТекстБезПробелов, "SIMILARITY(") > 0 
		ИЛИ СтрНайти(ТекстБезПробелов, "НАЙТИ(") > 0 Тогда 
		
		Результат.Сообщение = "Ошибка: Использована недопустимая функция в запросе (СтрНайти, СтрНачинаетсяС, Подобие и др.). В языке запросов 1С для поиска строк используйте ТОЛЬКО оператор ПОДОБНО (LIKE). Пример: ГДЕ Наименование ПОДОБНО ""%Сидоров%""";
		Возврат Результат;
	КонецЕсли;
	
	// Проверяем, что запрос не содержит опасных операций
	// (только SELECT разрешен)
	ТекстЗапросаВерхний = ВРег(ТекстЗапроса);
	
	Если СтрНайти(ТекстЗапросаВерхний, "ИЗМЕНИТЬ") > 0 
		ИЛИ СтрНайти(ТекстЗапросаВерхний, "УДАЛИТЬ") > 0 
		ИЛИ СтрНайти(ТекстЗапросаВерхний, "ВСТАВИТЬ") > 0 
		ИЛИ СтрНайти(ТекстЗапросаВерхний, "ОБНОВИТЬ") > 0 Тогда
		
		Результат.Сообщение = "Запрос содержит операции модификации данных. Разрешены только SELECT запросы";
		Возврат Результат;
		
	КонецЕсли;
	
	// Выполняем запрос
	Попытка
		
		Запрос = Новый Запрос(ТекстЗапроса);
		
		// Установка параметров запроса
		Если Шаг.Свойство("parameters") И Шаг.parameters <> Неопределено Тогда
			
			// Если parameters - массив (обычно массив структур с одним ключом), преобразуем его в одну структуру
			Если ТипЗнч(Шаг.parameters) = Тип("Массив") Тогда
				Для Каждого ПараметрСтруктура Из Шаг.parameters Цикл
					Если ТипЗнч(ПараметрСтруктура) = Тип("Структура") Тогда
						Для Каждого КлючЗначение Из ПараметрСтруктура Цикл
							// Проверяем, не является ли значение ссылкой на другой шаг
							ЗначениеПараметра = ОбработатьЗначениеПараметра(КлючЗначение.Значение, КонтекстВыполнения);
							Запрос.УстановитьПараметр(КлючЗначение.Ключ, ЗначениеПараметра);
						КонецЦикла;
					КонецЕсли;
				КонецЦикла;
			// Если parameters - структура
			ИначеЕсли ТипЗнч(Шаг.parameters) = Тип("Структура") Тогда
				Для Каждого КлючЗначение Из Шаг.parameters Цикл
					// Проверяем, не является ли значение ссылкой на другой шаг
					ЗначениеПараметра = ОбработатьЗначениеПараметра(КлючЗначение.Значение, КонтекстВыполнения);
					Запрос.УстановитьПараметр(КлючЗначение.Ключ, ЗначениеПараметра);
				КонецЦикла;
			КонецЕсли;
			
		КонецЕсли;

		РезультатЗапроса = Запрос.Выполнить();
		
		// Сохраняем результат запроса для создания табличного документа на клиенте
		// (табличный документ нельзя передать между клиентом и сервером)
		КонтекстВыполнения.Вставить("РезультатЗапросаДляТаблицы", РезультатЗапроса);
		
		// Преобразуем результат в таблицу значений для совместимости
		ТаблицаРезультатов = РезультатЗапроса.Выгрузить();
		
		// Преобразуем таблицу значений в массив структур для передачи между клиентом и сервером
		МассивРезультатов = Новый Массив;
		Для Каждого СтрокаТаблицы Из ТаблицаРезультатов Цикл
			СтруктураСтроки = Новый Структура;
			НайденаСсылка = Ложь;
			УИДИзСсылки = "";
			Для Каждого Колонка Из ТаблицаРезультатов.Колонки Цикл
				Попытка
					ЗначениеКолонки = СтрокаТаблицы[Колонка.Имя];
					
					// Преобразуем значения в сериализуемые типы
					Если ЗначениеКолонки = Неопределено Тогда
						СтруктураСтроки.Вставить(Колонка.Имя, Неопределено);
					ИначеЕсли ТипЗнч(ЗначениеКолонки) = Тип("Строка") Или 
					   ТипЗнч(ЗначениеКолонки) = Тип("Число") Или 
					   ТипЗнч(ЗначениеКолонки) = Тип("Булево") Или 
					   ТипЗнч(ЗначениеКолонки) = Тип("Дата") Тогда
						СтруктураСтроки.Вставить(Колонка.Имя, ЗначениеКолонки);
					Иначе
						// Проверяем, является ли значение ссылкой
					ТипЗначения = ТипЗнч(ЗначениеКолонки);
					ЭтоСсылка = Ложь;
					
					// Явная проверка на основные ссылочные типы
					Если Справочники.ТипВсеСсылки().СодержитТип(ТипЗначения)
						ИЛИ Документы.ТипВсеСсылки().СодержитТип(ТипЗначения)
						ИЛИ ПланыВидовХарактеристик.ТипВсеСсылки().СодержитТип(ТипЗначения) Тогда
						ЭтоСсылка = Истина;
					КонецЕсли;
					
					// Если не определили явно, проверяем по строковому представлению (fallback)
					Если НЕ ЭтоСсылка Тогда
						СтрокаТипа = НРег(Строка(ТипЗначения));
						// Ищем "ссылка" (ref) регистронезависимо
						Если СтрНайти(СтрокаТипа, "ссылка") > 0 ИЛИ СтрНайти(СтрокаТипа, "ref") > 0 Тогда
							ЭтоСсылка = Истина;
						КонецЕсли;
					КонецЕсли;

					Если ЭтоСсылка Тогда
						// Сохраняем ссылку как есть (для возможности использования в ForEach -> SelectObject)
						СсылкаОбъекта = ЗначениеКолонки;
						СтруктураСтроки.Вставить(Колонка.Имя, СсылкаОбъекта);
							
							Попытка
								УИДИзСсылки = Строка(СсылкаОбъекта.УникальныйИдентификатор());
								НайденаСсылка = Истина;
							Исключение
								// Если не удалось получить УИД, продолжаем
							КонецПопытки;
						Иначе
							// Для других типов преобразуем в строку
							Попытка
								СтруктураСтроки.Вставить(Колонка.Имя, Строка(ЗначениеКолонки));
							Исключение
								СтруктураСтроки.Вставить(Колонка.Имя, "");
							КонецПопытки;
						КонецЕсли;
					КонецЕсли;
				Исключение
					// Если возникла ошибка при обработке колонки, пропускаем её
					СтруктураСтроки.Вставить(Колонка.Имя, "");
				КонецПопытки;
			КонецЦикла;
			// Автоматически добавляем поле УИД, если в строке была найдена ссылка
			Если НайденаСсылка И НЕ ПустаяСтрока(УИДИзСсылки) И НЕ СтруктураСтроки.Свойство("УИД") Тогда
				СтруктураСтроки.Вставить("УИД", УИДИзСсылки);
			КонецЕсли;
			МассивРезультатов.Добавить(СтруктураСтроки);
		КонецЦикла;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Запрос выполнен успешно. Получено строк: " + Формат(ТаблицаРезультатов.Количество(), "ЧН=0");
		Результат.Данные = МассивРезультатов;
		
		// Сохраняем результат запроса в контексте выполнения для использования в последующих шагах
		КонтекстВыполнения.Вставить("РезультатЗапроса", МассивРезультатов);
		КонтекстВыполнения.Вставить("QueryResult", МассивРезультатов); // Английский алиас для ИИ
		КонтекстВыполнения.Вставить("РезультатЗапросаДляТаблицы", МассивРезультатов);
		
		// Сохраняем данные запроса в результате для создания табличного документа на клиенте
		Результат.Вставить("ДанныеЗапросаДляТаблицы", МассивРезультатов);
		Результат.Вставить("ТипДействия", "RunQuery"); // Маркер для идентификации RunQuery
		Результат.Вставить("ЕстьРезультатЗапроса", Истина); // Флаг, что есть данные для табличного документа
		
		// Если результат простой (одна строка с одним значением), формируем удобное сообщение
		Если МассивРезультатов.Количество() = 1 Тогда
			ПерваяСтрока = МассивРезультатов[0];
			Если ПерваяСтрока.Количество() = 1 Тогда
				// Одно значение - формируем сообщение
				Для Каждого ПараКлючЗначение Из ПерваяСтрока Цикл
					ИмяКолонки = ПараКлючЗначение.Ключ;
					ЗначениеКолонки = ПараКлючЗначение.Значение;
					Результат.Сообщение = "Запрос выполнен. Результат: " + Строка(ЗначениеКолонки);
					// Сохраняем значение для использования в ShowInfo
					КонтекстВыполнения.Вставить(ИмяКолонки, ЗначениеКолонки);
					Прервать;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
	Исключение
		
		Результат.Сообщение = "Ошибка выполнения запроса: " + ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие ShowInfo
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (для подстановки значений из предыдущих шагов)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьShowInfo(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Истина);
	
	Сообщение = Шаг.message;
	
	// Проверяем, есть ли результат запроса для создания табличного документа
	// Проверяем наличие результата запроса в контексте
	ЕстьРезультатЗапроса = Ложь;
	Если КонтекстВыполнения.Свойство("РезультатЗапроса") И КонтекстВыполнения.РезультатЗапроса <> Неопределено Тогда
		РезультатЗапроса = КонтекстВыполнения.РезультатЗапроса;
		Если ТипЗнч(РезультатЗапроса) = Тип("Массив") И РезультатЗапроса.Количество() > 0 Тогда
			ЕстьРезультатЗапроса = Истина;
		КонецЕсли;
	КонецЕсли;
	
	// Подставляем значения из контекста выполнения (результаты запросов)
	Если КонтекстВыполнения.Свойство("РезультатЗапроса") И КонтекстВыполнения.РезультатЗапроса <> Неопределено Тогда
		РезультатЗапроса = КонтекстВыполнения.РезультатЗапроса;
		Если ТипЗнч(РезультатЗапроса) = Тип("Массив") И РезультатЗапроса.Количество() > 0 Тогда
			ПерваяСтрока = РезультатЗапроса[0];
			Если ТипЗнч(ПерваяСтрока) = Тип("Структура") Тогда
				// Подставляем значения из результата запроса в сообщение
				Для Каждого ПараКлючЗначение Из ПерваяСтрока Цикл
					ИмяКолонки = ПараКлючЗначение.Ключ;
					ЗначениеКолонки = ПараКлючЗначение.Значение;
					Плейсхолдер = "{" + ИмяКолонки + "}";
					Если СтрНайти(Сообщение, Плейсхолдер) > 0 Тогда
						Сообщение = СтрЗаменить(Сообщение, Плейсхолдер, Строка(ЗначениеКолонки));
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;
	
	// Также подставляем значения, сохраненные напрямую в контексте
	Для Каждого ПараКлючЗначение Из КонтекстВыполнения Цикл
		ИмяПараметра = ПараКлючЗначение.Ключ;
		ЗначениеПараметра = ПараКлючЗначение.Значение;
		// Пропускаем служебные параметры
		Если ИмяПараметра = "ТекущийОбъект" Или 
		   ИмяПараметра = "ТипОбъекта" Или 
		   ИмяПараметра = "ИмяОбъекта" Или
		ИмяПараметра = "СсылкаДиалога" Или
		   ИмяПараметра = "РезультатЗапроса" Или
		   ИмяПараметра = "РезультатЗапросаДляТаблицы" Тогда
			Продолжить;
		КонецЕсли;
		Плейсхолдер = "{" + ИмяПараметра + "}";
		Если СтрНайти(Сообщение, Плейсхолдер) > 0 Тогда
			Сообщение = СтрЗаменить(Сообщение, Плейсхолдер, Строка(ЗначениеПараметра));
		КонецЕсли;
	КонецЦикла;
	
	Результат.Вставить("Сообщение", Сообщение);
	Результат.Вставить("Данные", Сообщение); // Сохраняем сообщение в Данные для идентификации ShowInfo
	Результат.Вставить("ТипДействия", "ShowInfo"); // Маркер для идентификации ShowInfo
	
	// Сохраняем флаг наличия результата запроса для создания табличного документа на клиенте
	Результат.Вставить("ЕстьРезультатЗапроса", ЕстьРезультатЗапроса);
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие GetChangedObjects
// Получает ссылки на объекты из табличной части ИзмененныеОбъекты диалога
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (должен содержать СсылкаДиалога)
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево
//   * Сообщение - Строка
//   * Данные - Массив - массив ссылок на объекты
//
Функция ВыполнитьGetChangedObjects(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Попытка
		
		// Проверяем наличие ссылки на диалог в контексте
		Если НЕ КонтекстВыполнения.Свойство("СсылкаДиалога") ИЛИ НЕ ЗначениеЗаполнено(КонтекстВыполнения.СсылкаДиалога) Тогда
			Результат.Сообщение = "Ссылка на диалог не передана в контекст выполнения";
			Возврат Результат;
		КонецЕсли;
		
		СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Получаем ссылки из табличной части ИзмененныеОбъекты
		МассивСсылок = Новый Массив;
		
		Для Каждого СтрокаИзмененныхОбъектов Из Диалог.ИзмененныеОбъекты Цикл
			Если ЗначениеЗаполнено(СтрокаИзмененныхОбъектов.СсылкаНаОбъект) Тогда
				МассивСсылок.Добавить(СтрокаИзмененныхОбъектов.СсылкаНаОбъект);
			КонецЕсли;
		КонецЦикла;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Получено объектов из табличной части: " + Формат(МассивСсылок.Количество(), "ЧН=0");
		Результат.Данные = МассивСсылок;
		
	Исключение
		Результат.Сообщение = "Ошибка получения объектов из табличной части: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Устанавливает значение реквизита объекта
//
// Параметры:
//  Объект - Произвольный - объект справочника или документа
//  ИмяРеквизита - Строка - имя реквизита
//  Значение - Произвольный - значение для установки
//
Процедура УстановитьЗначениеРеквизита(Объект, ИмяРеквизита, Значение)
	
	// В 1С объекты справочников и документов имеют типы вида СправочникОбъект.ИмяСправочника или ДокументОбъект.ИмяДокумента
	// Проверяем тип через строковое представление
	ТипОбъекта = ТипЗнч(Объект);
	СтрокаТипа = Строка(ТипОбъекта);
	
	// Проверяем, является ли объект справочником или документом
	Если СтрНайти(СтрокаТипа, "Справочник объект") > 0 
		ИЛИ СтрНайти(СтрокаТипа, "Документ объект") > 0 Тогда
		
		// Устанавливаем значение через индексатор
		Объект[ИмяРеквизита] = Значение;
		
	Иначе
		
		ВызватьИсключение "Неподдерживаемый тип объекта для установки реквизита: " + СтрокаТипа;
		
	КонецЕсли;
	
КонецПроцедуры

// Выполняет действие GetMetadata
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьGetMetadata(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Попытка
		
		// Получаем метаданные через модуль ИИА_Метаданные
		// Используем другое имя переменной, чтобы избежать конфликта с глобальным объектом Метаданные
		РезультатМетаданных = Новый Структура;
		РезультатМетаданных.Вставить("Справочники", ИИА_Метаданные.ПолучитьСписокСправочников());
		РезультатМетаданных.Вставить("Документы", ИИА_Метаданные.ПолучитьСписокДокументов());
		РезультатМетаданных.Вставить("РегистрыСведений", ИИА_Метаданные.ПолучитьСписокРегистровСведений());
		РезультатМетаданных.Вставить("РегистрыНакопления", ИИА_Метаданные.ПолучитьСписокРегистровНакопления());
		РезультатМетаданных.Вставить("РегистрыБухгалтерии", ИИА_Метаданные.ПолучитьСписокРегистровБухгалтерии());
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Получены метаданные конфигурации";
		Результат.Данные = РезультатМетаданных;
		
	Исключение
		Результат.Сообщение = "Ошибка при получении метаданных: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие GetObjectFields
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьGetObjectFields(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяОбъекта = Шаг.object_name;
	ТипОбъекта = Шаг.object_type;
	
	// Очищаем имя объекта от префиксов типа "Справочник." или "Документ."
	Если ТипОбъекта = "Справочник" И СтрНайти(ИмяОбъекта, "Справочник.") = 1 Тогда
		ИмяОбъекта = Сред(ИмяОбъекта, 12);
	ИначеЕсли ТипОбъекта = "Документ" И СтрНайти(ИмяОбъекта, "Документ.") = 1 Тогда
		ИмяОбъекта = Сред(ИмяОбъекта, 10);
	КонецЕсли;
	
	Попытка
		
		Если ТипОбъекта = "Справочник" Тогда
			
			ИнформацияОбОбъекте = ИИА_Метаданные.ПолучитьРеквизитыСправочника(ИмяОбъекта);
			
			Если НЕ ИнформацияОбОбъекте.Найден Тогда
				Результат.Сообщение = "Справочник '" + ИмяОбъекта + "' не найден";
				Возврат Результат;
			КонецЕсли;
			
		ИначеЕсли ТипОбъекта = "Документ" Тогда
			
			ИнформацияОбОбъекте = ИИА_Метаданные.ПолучитьРеквизитыДокумента(ИмяОбъекта);
			
			Если НЕ ИнформацияОбОбъекте.Найден Тогда
				Результат.Сообщение = "Документ '" + ИмяОбъекта + "' не найден";
				Возврат Результат;
			КонецЕсли;
			
		Иначе
			Результат.Сообщение = "Неподдерживаемый тип объекта: " + ТипОбъекта;
			Возврат Результат;
		КонецЕсли;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Получены реквизиты " + НРег(Строка(ТипОбъекта)) + "а '" + ИмяОбъекта + "'";
		Результат.Данные = ИнформацияОбОбъекте;
		Результат.Вставить("ТипДействия", "GetObjectFields");
		
	Исключение
		Результат.Сообщение = "Ошибка при получении реквизитов: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие CheckObjectExists
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьCheckObjectExists(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	ИмяОбъекта = Шаг.object_name;
	ТипОбъекта = Шаг.object_type;
	
	// Очищаем имя объекта от префиксов типа "Справочник." или "Документ."
	Если ТипОбъекта = "Справочник" И СтрНайти(ИмяОбъекта, "Справочник.") = 1 Тогда
		ИмяОбъекта = Сред(ИмяОбъекта, 12);
	ИначеЕсли ТипОбъекта = "Документ" И СтрНайти(ИмяОбъекта, "Документ.") = 1 Тогда
		ИмяОбъекта = Сред(ИмяОбъекта, 10);
	КонецЕсли;
	
	Попытка
		
		Существует = Ложь;
		
		Если ТипОбъекта = "Справочник" Тогда
			Существует = ИИА_Метаданные.СуществуетСправочник(ИмяОбъекта);
		ИначеЕсли ТипОбъекта = "Документ" Тогда
			Существует = ИИА_Метаданные.СуществуетДокумент(ИмяОбъекта);
		Иначе
			Результат.Сообщение = "Неподдерживаемый тип объекта: " + ТипОбъекта;
			Возврат Результат;
		КонецЕсли;
		
		РезультатИнформации = Новый Структура;
		РезультатИнформации.Вставить("Существует", Существует);
		РезультатИнформации.Вставить("Имя", ИмяОбъекта);
		РезультатИнформации.Вставить("Тип", ТипОбъекта);
		
		Результат.Успех = Истина;
		Если Существует Тогда
			Результат.Сообщение = НРег(Строка(ТипОбъекта)) + " '" + ИмяОбъекта + "' существует";
		Иначе
			Результат.Сообщение = НРег(Строка(ТипОбъекта)) + " '" + ИмяОбъекта + "' не существует";
		КонецЕсли;
		Результат.Данные = РезультатИнформации;
		
	Исключение
		Результат.Сообщение = "Ошибка при проверке существования объекта: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие SaveToStorage
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьSaveToStorage(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Ключ = Шаг.key;
	ДанныеДляСохранения = Шаг.data;
	
	Попытка
		
		// Проверяем наличие ссылки на диалог
		Если НЕ КонтекстВыполнения.Свойство("СсылкаДиалога") Или НЕ ЗначениеЗаполнено(КонтекстВыполнения.СсылкаДиалога) Тогда
			Результат.Сообщение = "Для работы с хранилищем требуется ссылка на диалог";
			Возврат Результат;
		КонецЕсли;
		
		СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Получаем текущую структуру из хранилища или создаем новую
		// ХранилищеЗначения не имеет метода Вставить - всегда создаем новое хранилище
		СтруктураДанных = Новый Структура;
		
		Если ЗначениеЗаполнено(Диалог.ХранилищеЗначения) Тогда
			// Получаем существующую структуру из хранилища
			СуществующаяСтруктура = Диалог.ХранилищеЗначения.Получить();
			Если ТипЗнч(СуществующаяСтруктура) = Тип("Структура") Тогда
				// Копируем все существующие ключи
				Для Каждого КлючЗначение Из СуществующаяСтруктура Цикл
					СтруктураДанных.Вставить(КлючЗначение.Ключ, КлючЗначение.Значение);
				КонецЦикла;
			КонецЕсли;
		КонецЕсли;
		
		// Добавляем или обновляем ключ
		СтруктураДанных.Вставить(Ключ, ДанныеДляСохранения);
		
		// Создаем новое хранилище с обновленной структурой
		Диалог.ХранилищеЗначения = Новый ХранилищеЗначения(СтруктураДанных);
		
		// Сохраняем диалог
		Диалог.Записать();
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Данные сохранены в хранилище с ключом '" + Ключ + "'";
		Результат.Данные = Истина;
		
	Исключение
		Результат.Сообщение = "Ошибка при сохранении в хранилище: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие LoadFromStorage
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения (входной/выходной)
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьLoadFromStorage(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Ключ = Шаг.key;
	
	Попытка
		
		// Проверяем наличие ссылки на диалог
		Если НЕ КонтекстВыполнения.Свойство("СсылкаДиалога") Или НЕ ЗначениеЗаполнено(КонтекстВыполнения.СсылкаДиалога) Тогда
			Результат.Сообщение = "Для работы с хранилищем требуется ссылка на диалог";
			Возврат Результат;
		КонецЕсли;
		
		СсылкаДиалога = КонтекстВыполнения.СсылкаДиалога;
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Проверяем наличие хранилища
		Если НЕ ЗначениеЗаполнено(Диалог.ХранилищеЗначения) Тогда
			Результат.Сообщение = "Хранилище пусто. Ключ '" + Ключ + "' не найден";
			Возврат Результат;
		КонецЕсли;
		
		Хранилище = Диалог.ХранилищеЗначения;
		
		// Получаем структуру из хранилища
		СтруктураДанных = Хранилище.Получить();
		Если ТипЗнч(СтруктураДанных) <> Тип("Структура") Тогда
			Результат.Сообщение = "Хранилище содержит данные неверного типа";
			Возврат Результат;
		КонецЕсли;
		
		// Проверяем наличие ключа в структуре
		Если НЕ СтруктураДанных.Свойство(Ключ) Тогда
			Результат.Сообщение = "Ключ '" + Ключ + "' не найден в хранилище";
			Возврат Результат;
		КонецЕсли;
		
		// Загружаем данные из структуры
		ЗагруженныеДанные = СтруктураДанных[Ключ];
		
		// Сохраняем загруженные данные в контекст выполнения для использования в последующих шагах
		// Используем ключ как имя переменной в контексте
		КонтекстВыполнения.Вставить("Хранилище_" + Ключ, ЗагруженныеДанные);
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Данные загружены из хранилища по ключу '" + Ключ + "'";
		Результат.Данные = ЗагруженныеДанные;
		
	Исключение
		Результат.Сообщение = "Ошибка при загрузке из хранилища: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие ForEach
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьForEach(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Новый Массив);
	
	// Получаем коллекцию
	// Параметр collection уже был обработан в РазрешитьПараметрыШага, если он был строкой #(...)
	// Но если это была просто строка-ключ (без #()), она осталась строкой.
	// Поэтому нужно проверить, есть ли такой ключ в контексте.
	
	Коллекция = Неопределено;
	Если ТипЗнч(Шаг.collection) = Тип("Строка") Тогда
		Если КонтекстВыполнения.Свойство(Шаг.collection) Тогда
			Коллекция = КонтекстВыполнения[Шаг.collection];
		Иначе
			// Возможно, это переменная из хранилища (с префиксом Хранилище_)
			Если КонтекстВыполнения.Свойство("Хранилище_" + Шаг.collection) Тогда
				Коллекция = КонтекстВыполнения["Хранилище_" + Шаг.collection];
			Иначе
				Результат.Сообщение = "Коллекция '" + Шаг.collection + "' не найдена в контексте выполнения";
				Возврат Результат;
			КонецЕсли;
		КонецЕсли;
	Иначе
		Коллекция = Шаг.collection;
	КонецЕсли;
	
	Если ТипЗнч(Коллекция) <> Тип("Массив") Тогда
		Результат.Сообщение = "Значение параметра collection должно быть массивом. Получено: " + Строка(ТипЗнч(Коллекция));
		Возврат Результат;
	КонецЕсли;
	
	ШагиЦикла = Шаг.steps;
	КоличествоОбработанных = 0;
	
	Для Каждого Элемент Из Коллекция Цикл
		
		// Помещаем текущий элемент в контекст
		КонтекстВыполнения.Вставить("CurrentItem", Элемент);
		
		// Выполняем шаги цикла
		Для Каждого ВнутреннийШаг Из ШагиЦикла Цикл
			
			// Выполняем шаг (он сам разрешит параметры, используя CurrentItem)
			РезультатВнутреннего = ВыполнитьШаг(ВнутреннийШаг, КонтекстВыполнения);
			
			// Собираем данные (ссылки) из внутренних шагов
			Если РезультатВнутреннего.Свойство("Данные") И ЗначениеЗаполнено(РезультатВнутреннего.Данные) Тогда
				Результат.Данные.Добавить(РезультатВнутреннего.Данные);
			КонецЕсли;
			
			Если НЕ РезультатВнутреннего.Успех Тогда
				Результат.Сообщение = "Ошибка в цикле ForEach на элементе " + Формат(КоличествоОбработанных + 1, "ЧН=0") + ", шаг '" + ВнутреннийШаг.action + "': " + РезультатВнутреннего.Сообщение;
				Возврат Результат;
			КонецЕсли;
			
		КонецЦикла;
		
		КоличествоОбработанных = КоличествоОбработанных + 1;
		
	КонецЦикла;
	
	// Очищаем CurrentItem из контекста
	КонтекстВыполнения.Удалить("CurrentItem");
	
	Результат.Успех = Истина;
	Результат.Сообщение = "Цикл ForEach выполнен успешно. Обработано элементов: " + Формат(КоличествоОбработанных, "ЧН=0");
	
	Возврат Результат;
	
КонецФункции

// Выполняет действие SelectObject
//
// Параметры:
//  Шаг - Структура - структура шага
//  КонтекстВыполнения - Структура - контекст выполнения
//
// Возвращаемое значение:
//  Структура - структура результата
//
Функция ВыполнитьSelectObject(Шаг, КонтекстВыполнения)
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Данные", Неопределено);
	
	Ссылка = Неопределено;
	Если Шаг.Свойство("reference") Тогда
		Ссылка = Шаг.reference;
	Иначе
		Ссылка = Шаг.object;
	КонецЕсли;
	
	// Проверка типа (хотя 1С сама выбросит исключение при попытке ПолучитьОбъект(), если это не ссылочный тип)
	ТипЗнчСсылки = ТипЗнч(Ссылка);
	
	Попытка
		
		// Проверяем, что это ссылочный тип, поддерживающий ПолучитьОбъект
		Если НЕ (Справочники.ТипВсеСсылки().СодержитТип(ТипЗнчСсылки) 
			ИЛИ Документы.ТипВсеСсылки().СодержитТип(ТипЗнчСсылки)
			ИЛИ ПланыВидовХарактеристик.ТипВсеСсылки().СодержитТип(ТипЗнчСсылки)) Тогда
			
			Результат.Сообщение = "Ошибка выбора объекта: Значение типа '" + Строка(ТипЗнчСсылки) + "' не является ссылкой на объект. Значение: " + Строка(Ссылка);
			Возврат Результат;
		КонецЕсли;
		
		// Пытаемся получить объект. Это работает для СправочникСсылка и ДокументСсылка
		Объект = Ссылка.ПолучитьОбъект();
		
		Если Объект = Неопределено Тогда
			Результат.Сообщение = "Не удалось получить объект по ссылке (объект не найден)";
			Возврат Результат;
		КонецЕсли;
		
		КонтекстВыполнения.Вставить("ТекущийОбъект", Объект);
		КонтекстВыполнения.Вставить("СсылкаОбъекта", Ссылка);
		
		// Определяем тип для логики Write и ИмяОбъекта для SetField
		Если Справочники.ТипВсеСсылки().СодержитТип(ТипЗнчСсылки) Тогда
			КонтекстВыполнения.Вставить("ТипОбъекта", "Справочник");
			КонтекстВыполнения.Вставить("ИмяОбъекта", Ссылка.Метаданные().Имя);
		ИначеЕсли Документы.ТипВсеСсылки().СодержитТип(ТипЗнчСсылки) Тогда
			КонтекстВыполнения.Вставить("ТипОбъекта", "Документ");
			КонтекстВыполнения.Вставить("ИмяОбъекта", Ссылка.Метаданные().Имя);
		Иначе
			КонтекстВыполнения.Вставить("ТипОбъекта", "Неизвестно");
			// Попытка получить имя метаданных для неизвестного типа
			Попытка
				КонтекстВыполнения.Вставить("ИмяОбъекта", Ссылка.Метаданные().Имя);
			Исключение
				КонтекстВыполнения.Вставить("ИмяОбъекта", "Неизвестно");
			КонецПопытки;
		КонецЕсли;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Выбран объект: " + String(Ссылка);
		Результат.Данные = Ссылка;
		
	Исключение
		Результат.Сообщение = "Ошибка выбора объекта (неверный тип ссылки?): " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Осуществляет поиск ссылки по УИД(GUID) или массиву УИДов(GUID)
//
// Параметры:
//   УИД - Строка - Идентификатор строкой.
//       - Массив - Массив идентификаторов строкой.
//
//Возвращаемое значение:
//	- Неопределено - Если не удалось определить ни одну ссылку по параметру УИД.
//	- ЛюбаяСсылка - Если в параметр "УИД" была передана строка.
//	- ТаблицаЗначений  - Если в параметр "УИД" был передан массив строк.
//		* УИД - Строка - Содержит идентифкатор строкой по которому удалось определить ссылку.
//		* Ссылка - ЛюбаяСсылка - Содержит ссылку на объект.
//
// Пример:
// РезультатПоиска = НайтиСсылкуПоУИД("31f35109-f60a-4777-a555-f8a46c5a165d") ...
//
Функция НайтиСсылкуПоУИД(знач УИД)
    
    ЭтоМассив = ТипЗнч(УИД) = Тип("Массив");
    
    МассивУидов = Новый Массив;
    Если ЭтоМассив Тогда
        МассивУидов = УИД;
    Иначе
        МассивУидов.Добавить(УИД);
    КонецЕсли;
    
	Результат = Неопределено;
    
    МассивМетаданных = Новый Массив;    
	МассивМетаданных.Добавить(Справочники);
	МассивМетаданных.Добавить(Документы);
	МассивМетаданных.Добавить(ПланыВидовХарактеристик);
	МассивМетаданных.Добавить(ПланыСчетов);
	МассивМетаданных.Добавить(ПланыВидовРасчета);
	МассивМетаданных.Добавить(ПланыОбмена);
	МассивМетаданных.Добавить(БизнесПроцессы);
	МассивМетаданных.Добавить(Задачи);
    
    МассивТипов = Новый Массив; 
    
    Для Каждого СтрМетаданное Из МассивМетаданных Цикл
        Для Каждого Стр Из СтрМетаданное.ТипВсеСсылки().Типы() Цикл
            МассивТипов.Добавить(Стр);
        КонецЦикла;
    КонецЦикла;
        
    ТаблицаСсылок = Новый ТаблицаЗначений;
    ТаблицаСсылок.Колонки.Добавить("УИД"    , Новый ОписаниеТипов("Строка",,,,Новый КвалификаторыСтроки(36)));
    ТаблицаСсылок.Колонки.Добавить("Ссылка" , Новый ОписаниеТипов(МассивТипов));
    
    Для Каждого СтрМетаданное Из МассивМетаданных Цикл
        Для Каждого Менеджер Из СтрМетаданное Цикл   
            Для Каждого СтрУИД Из МассивУидов Цикл
                Попытка
                    НовСтр = ТаблицаСсылок.Добавить();
                    НовСтр.Ссылка = Менеджер.ПолучитьСсылку(Новый УникальныйИдентификатор(СтрУИД));
                    НовСтр.УИД    = СтрУИД;
                Исключение
                КонецПопытки;
            КонецЦикла;
        КонецЦикла;
    КонецЦикла;
            
    Запрос = Новый Запрос;
    Запрос.Текст = 
        "ВЫБРАТЬ
        |   ТаблицаСсылок.Ссылка КАК Ссылка,
        |   ТаблицаСсылок.УИД КАК УИД
        |ПОМЕСТИТЬ ВТ
        |ИЗ
        |   &ТаблицаСсылок КАК ТаблицаСсылок
        |;
        |
        |////////////////////////////////////////////////////////////////////////////////
        |ВЫБРАТЬ
        |   ВТ.Ссылка КАК Ссылка,
        |   ВТ.УИД КАК УИД
        |ИЗ
        |   ВТ КАК ВТ
        |ГДЕ
        |   НЕ ВТ.Ссылка.ПометкаУдаления ЕСТЬ NULL";
    
    Запрос.УстановитьПараметр("ТаблицаСсылок",ТаблицаСсылок);
    РезультатЗапроса = Запрос.Выполнить();
    
    Если Не РезультатЗапроса.Пустой() Тогда
        Если ЭтоМассив Тогда
            Результат = РезультатЗапроса.Выгрузить(); 
        Иначе
            ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
            ВыборкаДетальныеЗаписи.Следующий();
            
            Результат = ВыборкаДетальныеЗаписи.Ссылка;
        КонецЕсли;
    КонецЕсли;
    
	Возврат Результат;
		
КонецФункции // НайтиСсылкуПоУИД

#КонецОбласти

// Проверяет, является ли строка допустимым именем свойства
Функция ЭтоДопустимоеИмяСвойства(Имя)
	
	Если ПустаяСтрока(Имя) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Здесь можно добавить более сложную проверку, если нужно
	// Пока просто проверяем, что это не пустая строка
	
	Возврат Истина;
	
КонецФункции

// Обрабатывает значение параметра, поддерживая ссылки на другие шаги
//
// Параметры:
//  Значение - Произвольный - исходное значение параметра
//  КонтекстВыполнения - Структура - контекст выполнения
//
// Возвращаемое значение:
//  Произвольный - обработанное значение
//
Функция ОбработатьЗначениеПараметра(Значение, КонтекстВыполнения)
	
	Если ТипЗнч(Значение) <> Тип("Строка") Тогда
		Возврат Значение;
	КонецЕсли;
	
	// Проверяем наличие синтаксиса #(...)
	Если СтрНайти(Значение, "#(") = 1 И Прав(Значение, 1) = ")" Тогда
		
		ПутьКЗначению = Сред(Значение, 3, СтрДлина(Значение) - 3);
		
		// Если это прямая ссылка на переменную контекста (например, #(Хранилище_Ключ) или #(CurrentItem))
		// Проверяем наличие только если имя не составное (без точек)
		Если СтрНайти(ПутьКЗначению, ".") = 0 И КонтекстВыполнения.Свойство(ПутьКЗначению) Тогда
			Возврат КонтекстВыполнения[ПутьКЗначению];
		КонецЕсли;
		
		// Разбираем путь (например, ШАГ1.Данные.Поле или CurrentItem.Ссылка.Наименование)
		Части = СтрРазделить(ПутьКЗначению, ".");
		
		Если Части.Количество() >= 1 Тогда
			
			ИмяПеременной = Части[0]; // Например, ШАГ1 или CurrentItem
			
			Если КонтекстВыполнения.Свойство(ИмяПеременной) Тогда
				
				ТекущееЗначение = КонтекстВыполнения[ИмяПеременной];
				
				// Проходим по остальным частям пути
				Для Индекс = 1 По Части.Количество() - 1 Цикл
					
					ИмяСвойства = Части[Индекс];
					
					// Проверка валидности имени свойства
					Если ПустаяСтрока(ИмяСвойства) Или Не ЭтоДопустимоеИмяСвойства(ИмяСвойства) Тогда
						// Если имя свойства некорректное, считаем это ошибкой доступа к свойству
						// и возвращаем исходное значение
						Возврат Значение;
					КонецЕсли;
					
					Если ТипЗнч(ТекущееЗначение) = Тип("Структура") Тогда
						Если ТекущееЗначение.Свойство(ИмяСвойства) Тогда
							ТекущееЗначение = ТекущееЗначение[ИмяСвойства];
						Иначе
							Возврат Значение;
						КонецЕсли;
					ИначеЕсли (Справочники.ТипВсеСсылки().СодержитТип(ТипЗнч(ТекущееЗначение)) Или Документы.ТипВсеСсылки().СодержитТип(ТипЗнч(ТекущееЗначение))) Тогда
						Попытка
							ТекущееЗначение = ТекущееЗначение[ИмяСвойства];
						Исключение
							// Если не удалось получить свойство, прерываем и возвращаем исходную строку
							Возврат Значение;
						КонецПопытки;
					ИначеЕсли ТипЗнч(ТекущееЗначение) = Тип("СправочникОбъект") Или ТипЗнч(ТекущееЗначение) = Тип("ДокументОбъект") Тогда
						Попытка
							ТекущееЗначение = ТекущееЗначение[ИмяСвойства];
						Исключение
							Возврат Значение;
						КонецПопытки;
					Иначе
						// Невозможно получить свойство от этого типа, возвращаем исходное значение (или можно вернуть Неопределено)
						Возврат Значение;
					КонецЕсли;
					
				КонецЦикла;
				
				Возврат ТекущееЗначение;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат Значение;
	
КонецФункции
