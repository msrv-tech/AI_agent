#Область ПрограммныйИнтерфейс

// Получает настройки пользователя из регистра сведений
//
// Параметры:
//  Пользователь - СправочникСсылка.Пользователи - пользователь, для которого получить настройки
//
// Возвращаемое значение:
//  Структура - структура с настройками:
//   * РежимПодключения - ПеречислениеСсылка.ИИА_РежимПодключения
//   * Gitsell_Endpoint - Строка
//   * Gitsell_AccessToken - Строка
//   * Provider_BaseURL - Строка
//   * Provider_ApiKey - Строка
//   * ProviderType - Строка
//
Функция ПолучитьНастройкиПользователя(Пользователь) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("РежимПодключения", Неопределено);
	Результат.Вставить("Gitsell_Endpoint", "");
	Результат.Вставить("Gitsell_AccessToken", "");
	Результат.Вставить("Provider_BaseUrl", "");
	Результат.Вставить("Provider_ApiKey", "");
	Результат.Вставить("Provider_Type", "");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НастройкиПользователя.РежимПодключения,
	|	НастройкиПользователя.Gitsell_Endpoint,
	|	НастройкиПользователя.Gitsell_AccessToken,
	|	НастройкиПользователя.Provider_BaseUrl,
	|	НастройкиПользователя.Provider_ApiKey,
	|	НастройкиПользователя.Provider_Type,
	|	НастройкиПользователя.Токен,
	|	НастройкиПользователя.ОкончаниеТокена,
	|	НастройкиПользователя.АвторизационныеДанные,
	|	НастройкиПользователя.Scope
	|ИЗ
	|	РегистрСведений.ИИА_НастройкиПользователей КАК НастройкиПользователя
	|ГДЕ
	|	НастройкиПользователя.Пользователь = &Пользователь";
	
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Результат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	
	Результат.РежимПодключения = Выборка.РежимПодключения;
	Результат.Gitsell_Endpoint = Выборка.Gitsell_Endpoint;
	Результат.Gitsell_AccessToken = Выборка.Gitsell_AccessToken;
	Результат.Вставить("Provider_BaseUrl", Выборка.Provider_BaseUrl);
	Результат.Вставить("Provider_ApiKey", Выборка.Provider_ApiKey);
	Результат.Вставить("Provider_Type", Выборка.Provider_Type);
	Результат.Вставить("Токен", Выборка.Токен);
	Результат.Вставить("ОкончаниеТокена", Выборка.ОкончаниеТокена);
	Результат.Вставить("АвторизационныеДанные", Выборка.АвторизационныеДанные);
	Результат.Вставить("Scope", Выборка.Scope);
	
	Возврат Результат;
	
КонецФункции

// Функции для работы с Гигачат перенесены в модуль ИИА_Гигачат

// Находит активный диалог пользователя или создает новый
//
// Параметры:
//  Пользователь - СправочникСсылка.Пользователи - пользователь
//
// Возвращаемое значение:
//  СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Функция НайтиИлиСоздатьДиалогПользователя(Пользователь) Экспорт
	
	// Ищем активный диалог
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Диалоги.Ссылка
	|ИЗ
	|	Справочник.ИИА_Диалоги КАК Диалоги
	|ГДЕ
	|	Диалоги.Пользователь = &Пользователь
	|	И Диалоги.Активный = ИСТИНА
	|УПОРЯДОЧИТЬ ПО
	|	Диалоги.ДатаСоздания УБЫВ";
	
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	// Создаем новый диалог
	НовыйДиалог = Справочники.ИИА_Диалоги.СоздатьЭлемент();
	НовыйДиалог.Пользователь = Пользователь;
	НовыйДиалог.Имя = "Диалог ИИ от " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy HH:mm:ss");
	НовыйДиалог.ДатаСоздания = ТекущаяДата();
	НовыйДиалог.Активный = Истина;
	НовыйДиалог.ТипДиалога = Перечисления.ИИА_ТипДиалога.Агент;
	НовыйДиалог.Записать();
	
	Возврат НовыйДиалог.Ссылка;
	
КонецФункции

// Деактивирует диалог
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Процедура ДеактивироватьДиалог(СсылкаДиалога) Экспорт
	
	Попытка
		ДиалогОбъект = СсылкаДиалога.ПолучитьОбъект();
		ДиалогОбъект.Активный = Ложь;
		ДиалогОбъект.Записать();
	Исключение
		// Игнорируем ошибки деактивации
	КонецПопытки;
	
КонецПроцедуры

// Создает новый диалог для текущего пользователя
//
// Возвращаемое значение:
//  СправочникСсылка.ИИА_Диалоги - ссылка на новый диалог
//
Функция СоздатьНовыйДиалог(Пользователь, ТипДиалога = Неопределено) Экспорт
	
	// Деактивируем все активные диалоги пользователя
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	Диалоги.Ссылка
	|ИЗ
	|	Справочник.ИИА_Диалоги КАК Диалоги
	|ГДЕ
	|	Диалоги.Пользователь = &Пользователь
	|	И Диалоги.Активный = ИСТИНА";
	
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Пока Выборка.Следующий() Цикл
			ДеактивироватьДиалог(Выборка.Ссылка);
		КонецЦикла;
	КонецЕсли;
	
	// Создаем новый диалог
	НовыйДиалог = Справочники.ИИА_Диалоги.СоздатьЭлемент();
	НовыйДиалог.Пользователь = Пользователь;
	НовыйДиалог.Имя = "Диалог ИИ от " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy HH:mm:ss");
	НовыйДиалог.ДатаСоздания = ТекущаяДата();
	НовыйДиалог.Активный = Истина;
	
	// Устанавливаем тип диалога
	Если ТипДиалога <> Неопределено Тогда
		НовыйДиалог.ТипДиалога = ТипДиалога;
	Иначе
		// По умолчанию - Агент
		НовыйДиалог.ТипДиалога = Перечисления.ИИА_ТипДиалога.Агент;
	КонецЕсли;
	
	НовыйДиалог.Записать();
	
	Возврат НовыйДиалог.Ссылка;
	
КонецФункции

// Получает сообщения диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Количество - Число - количество последних сообщений
//
// Возвращаемое значение:
//  Массив - массив структур с сообщениями
//
Функция ПолучитьСообщенияДиалога(СсылкаДиалога, Количество = 50) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	МассивСообщений = Новый Массив;
	
	ИндексНачала = Макс(0, Диалог.Сообщения.Количество() - Количество);
	
	Для Индекс = ИндексНачала По Диалог.Сообщения.Количество() - 1 Цикл
		
		Строка = Диалог.Сообщения[Индекс];
		
		СтруктураСообщения = Новый Структура;
		СтруктураСообщения.Вставить("Время", Строка.Время);
		СтруктураСообщения.Вставить("Автор", Строка.Автор);
		СтруктураСообщения.Вставить("ТипСообщения", Строка.ТипСообщения);
		СтруктураСообщения.Вставить("Текст", Строка.Текст);
		СтруктураСообщения.Вставить("ТекстКода", Строка.ТекстКода);
		СтруктураСообщения.Вставить("Статус", Строка.Статус);
		СтруктураСообщения.Вставить("UsageTokens", Строка.UsageTokens);
		СтруктураСообщения.Вставить("СтатусDSL", Строка.СтатусDSL);
		СтруктураСообщения.Вставить("ЗадачаВыполнена", Строка.ЗадачаВыполнена);
		
		МассивСообщений.Добавить(СтруктураСообщения);
		
	КонецЦикла;
	
	Возврат МассивСообщений;
	
КонецФункции

// Получает первое сообщение пользователя из диалога (исходную задачу)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Структура - структура с информацией о первом сообщении пользователя:
//   * Найдено - Булево - найдено ли сообщение
//   * ЗадачаВыполнена - Булево - выполнена ли задача
//   * Текст - Строка - текст сообщения
//
Функция ПолучитьПервоеСообщениеПользователя(СсылкаДиалога) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Найдено", Ложь);
	Результат.Вставить("ЗадачаВыполнена", Ложь);
	Результат.Вставить("Текст", "");
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Ищем первое сообщение пользователя (исходную задачу)
	Для Индекс = 0 По Диалог.Сообщения.Количество() - 1 Цикл
		
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
			Результат.Найдено = Истина;
			Результат.Текст = СтрокаСообщения.Текст;
			Результат.ЗадачаВыполнена = СтрокаСообщения.ЗадачаВыполнена;
			Возврат Результат;
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Получает последнее сообщение пользователя из диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Структура - структура с информацией о последнем сообщении пользователя:
//   * Найдено - Булево - найдено ли сообщение
//   * ЗадачаВыполнена - Булево - выполнена ли задача
//   * Текст - Строка - текст сообщения
//
Функция ПолучитьПоследнееСообщениеПользователя(СсылкаДиалога) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Найдено", Ложь);
	Результат.Вставить("ЗадачаВыполнена", Ложь);
	Результат.Вставить("Текст", "");
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Ищем последнее сообщение пользователя
	Индекс = Диалог.Сообщения.Количество() - 1;
	Пока Индекс >= 0 Цикл
		
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
			Результат.Найдено = Истина;
			Результат.Текст = СтрокаСообщения.Текст;
			Результат.ЗадачаВыполнена = СтрокаСообщения.ЗадачаВыполнена;
			Возврат Результат;
		КонецЕсли;
		
		Индекс = Индекс - 1;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Получает все невыполненные задачи и уточнения пользователя из диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Структура - структура с информацией о невыполненных задачах:
//   * Найдено - Булево - найдены ли невыполненные задачи
//   * ТекстЗадач - Строка - объединенный текст всех невыполненных задач
//   * КоличествоЗадач - Число - количество невыполненных задач
//
Функция ПолучитьНевыполненныеЗадачиПользователя(СсылкаДиалога) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Найдено", Ложь);
	Результат.Вставить("ТекстЗадач", "");
	Результат.Вставить("КоличествоЗадач", 0);
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	МассивЗадач = Новый Массив;
	
	// Проходим по всем сообщениям и собираем невыполненные задачи пользователя
	Для Каждого СтрокаСообщения Из Диалог.Сообщения Цикл
		
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
			// Проверяем, выполнена ли задача
			// Задача считается невыполненной, если ЗадачаВыполнена = Ложь или Неопределено
			ЗадачаВыполнена = СтрокаСообщения.ЗадачаВыполнена;
			Если НЕ (ЗадачаВыполнена = Истина) Тогда
				// Добавляем задачу в список
				ТекстЗадачи = СокрЛП(СтрокаСообщения.Текст);
				Если НЕ ПустаяСтрока(ТекстЗадачи) Тогда
					МассивЗадач.Добавить(ТекстЗадачи);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	Если МассивЗадач.Количество() > 0 Тогда
		Результат.Найдено = Истина;
		Результат.КоличествоЗадач = МассивЗадач.Количество();
		
		// Объединяем все задачи в один текст
		ТекстЗадач = "";
		Для Индекс = 0 По МассивЗадач.Количество() - 1 Цикл
			Если Индекс > 0 Тогда
				ТекстЗадач = ТекстЗадач + Символы.ПС;
			КонецЕсли;
			ТекстЗадач = ТекстЗадач + МассивЗадач[Индекс];
		КонецЦикла;
		
		Результат.ТекстЗадач = ТекстЗадач;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Получает последнее DSL сообщение и его статус
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Структура - структура с информацией о последнем DSL сообщении:
//   * Найдено - Булево - найдено ли сообщение
//   * СтатусDSL - ПеречислениеСсылка.ИИА_СтатусDSL - статус DSL
//   * ТекстКода - Строка - текст DSL
//
Функция ПолучитьПоследнееDSLСообщение(СсылкаДиалога) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Найдено", Ложь);
	Результат.Вставить("СтатусDSL", Неопределено);
	Результат.Вставить("ТекстКода", "");
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	// Ищем последнее сообщение с DSL (тип Код)
	Индекс = Диалог.Сообщения.Количество() - 1;
	Пока Индекс >= 0 Цикл
		
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		
		Если СтрокаСообщения.ТипСообщения = Перечисления.ИИА_ТипСообщения.Код 
			И НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			Результат.Найдено = Истина;
			Результат.СтатусDSL = СтрокаСообщения.СтатусDSL;
			Результат.ТекстКода = СтрокаСообщения.ТекстКода;
			Возврат Результат;
		КонецЕсли;
		
		Индекс = Индекс - 1;
		
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

// Получает общее количество использованных токенов в диалоге
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Число - общее количество использованных токенов
//
Функция ПолучитьОбщееКоличествоТокенов(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	ОбщееКоличествоТокенов = 0;
	
	Для Каждого СтрокаСообщения Из Диалог.Сообщения Цикл
		Если ЗначениеЗаполнено(СтрокаСообщения.UsageTokens) Тогда
			ОбщееКоличествоТокенов = ОбщееКоличествоТокенов + СтрокаСообщения.UsageTokens;
		КонецЕсли;
	КонецЦикла;
	
	Возврат ОбщееКоличествоТокенов;
	
КонецФункции

// Получает список ключей из хранилища значений диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Массив - массив строк с ключами хранилища
//
Функция ПолучитьКлючиХранилища(СсылкаДиалога) Экспорт
	
	Результат = Новый Массив;
	
	Попытка
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Проверяем наличие хранилища
		Если НЕ ЗначениеЗаполнено(Диалог.ХранилищеЗначения) Тогда
			Возврат Результат;
		КонецЕсли;
		
		Хранилище = Диалог.ХранилищеЗначения;
		
		// Получаем структуру из хранилища
		СтруктураДанных = Хранилище.Получить();
		Если ТипЗнч(СтруктураДанных) <> Тип("Структура") Тогда
			Возврат Результат;
		КонецЕсли;
		
		// Получаем все ключи из структуры
		Для Каждого КлючЗначение Из СтруктураДанных Цикл
			Результат.Добавить(КлючЗначение.Ключ);
		КонецЦикла;
		
	Исключение
		// В случае ошибки возвращаем пустой массив
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Сохраняет результат проверки задачи в хранилище диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Успех - Булево - результат проверки
//  Причина - Строка - пояснение
//
Процедура УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, Успех, Причина = "") Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	СтруктураПроверки = Новый Структура;
	
	Если ЗначениеЗаполнено(Диалог.ХранилищеЗначения) Тогда
		Попытка
			СтруктураПроверки = Диалог.ХранилищеЗначения.Получить();
		Исключение
			СтруктураПроверки = Новый Структура;
		КонецПопытки;
		Если ТипЗнч(СтруктураПроверки) <> Тип("Структура") Тогда
			СтруктураПроверки = Новый Структура;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПроверки.Вставить("ПроверкаВыполнена", Истина);
	СтруктураПроверки.Вставить("СтатусПроверкиЗадачи", ?(Успех, "Успешно", "Неудачно"));
	СтруктураПроверки.Вставить("ПричинаПроверки", ?(ПустаяСтрока(Причина), "", Причина));
	
	ХранилищеЗначения = Новый ХранилищеЗначения(СтруктураПроверки);
	Диалог.ХранилищеЗначения = ХранилищеЗначения;
	Диалог.Записать();
	
КонецПроцедуры

// Возвращает структуру с результатом проверки из хранилища диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Структура с полями ПроверкаВыполнена, СтатусПроверкиЗадачи, ПричинаПроверки
//
Функция ПолучитьРезультатПроверкиИзХранилища(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если НЕ ЗначениеЗаполнено(Диалог.ХранилищеЗначения) Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Результат = Диалог.ХранилищеЗначения.Получить();
	Если ТипЗнч(Результат) <> Тип("Структура") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Если НЕ Результат.Свойство("ПроверкаВыполнена") Тогда
		Возврат Неопределено;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

// Добавляет ссылки на объекты в табличную часть ИзмененныеОбъекты диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  МассивСсылок - Массив - массив ссылок на объекты
//
Процедура ДобавитьИзмененныеОбъекты(СсылкаДиалога, МассивСсылок) Экспорт
	
	Если МассивСсылок = Неопределено ИЛИ МассивСсылок.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	// Добавляем каждую ссылку, если её еще нет в табличной части
	Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
		
		Если НЕ ЗначениеЗаполнено(СсылкаОбъекта) Тогда
			Продолжить;
		КонецЕсли;
		
		// Проверяем, есть ли уже такая ссылка в табличной части
		Найдено = Ложь;
		Для Каждого СтрокаИзмененныхОбъектов Из Диалог.ИзмененныеОбъекты Цикл
			Если ЗначениеЗаполнено(СтрокаИзмененныхОбъектов.СсылкаНаОбъект) Тогда
				Попытка
					Если СтрокаИзмененныхОбъектов.СсылкаНаОбъект = СсылкаОбъекта Тогда
						Найдено = Истина;
						Прервать;
					КонецЕсли;
				Исключение
					// Игнорируем ошибки сравнения
				КонецПопытки;
			КонецЕсли;
		КонецЦикла;
		
		// Если ссылки еще нет, добавляем её
		Если НЕ Найдено Тогда
			НоваяСтрока = Диалог.ИзмененныеОбъекты.Добавить();
			НоваяСтрока.СсылкаНаОбъект = СсылкаОбъекта;
		КонецЕсли;
		
	КонецЦикла;
	
	Диалог.Записать();
	
КонецПроцедуры

// Преобразует массив сообщений в таблицу значений для передачи в ИИ
//
// Параметры:
//  МассивСообщений - Массив - массив структур с сообщениями
//
// Возвращаемое значение:
//  ТаблицаЗначений - таблица значений с историей сообщений
//
Функция ПреобразоватьМассивСообщенийВТаблицу(МассивСообщений)
	
	История = Новый ТаблицаЗначений;
	История.Колонки.Добавить("Время", Новый ОписаниеТипов("Дата"));
	История.Колонки.Добавить("Автор", Новый ОписаниеТипов("ПеречислениеСсылка.ИИА_АвторСообщения"));
	История.Колонки.Добавить("ТипСообщения", Новый ОписаниеТипов("ПеречислениеСсылка.ИИА_ТипСообщения"));
	История.Колонки.Добавить("Текст", Новый ОписаниеТипов("Строка"));
	История.Колонки.Добавить("ТекстКода", Новый ОписаниеТипов("Строка"));
	
	Для Каждого СтруктураСообщения Из МассивСообщений Цикл
		
		НоваяСтрока = История.Добавить();
		НоваяСтрока.Время = СтруктураСообщения.Время;
		НоваяСтрока.Автор = СтруктураСообщения.Автор;
		НоваяСтрока.ТипСообщения = СтруктураСообщения.ТипСообщения;
		НоваяСтрока.Текст = СтруктураСообщения.Текст;
		
	КонецЦикла;
	
	Возврат История;
	
КонецФункции

// Добавляет сообщение в диалог
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Автор - ПеречислениеСсылка.ИИА_АвторСообщения - автор сообщения
//  ТипСообщения - ПеречислениеСсылка.ИИА_ТипСообщения - тип сообщения
//  Текст - Строка - текст сообщения
//  ТекстКода - Строка - текст кода (для запросов)
//  Статус - Строка - статус сообщения
//  UsageTokens - Число - количество использованных токенов
//  СтатусDSL - ПеречислениеСсылка.ИИА_СтатусDSL - статус DSL
//  ЗадачаВыполнена - Булево - признак выполнения задачи
//
Процедура ДобавитьСообщениеВДиалог(СсылкаДиалога, Автор, ТипСообщения, Текст, ТекстКода = "", Статус = "", UsageTokens = 0, СтатусDSL = Неопределено, ЗадачаВыполнена = Неопределено) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	НоваяСтрока = Диалог.Сообщения.Добавить();
	НоваяСтрока.Время = ТекущаяДата();
	НоваяСтрока.Автор = Автор;
	НоваяСтрока.ТипСообщения = ТипСообщения;
	НоваяСтрока.Текст = Текст;
	НоваяСтрока.ТекстКода = ТекстКода;
	НоваяСтрока.Статус = Статус;
	НоваяСтрока.UsageTokens = UsageTokens;
	
	// Устанавливаем статус DSL
	Если СтатусDSL = Неопределено Тогда
		// Если есть ТекстКода и это DSL, устанавливаем "ВОчереди", иначе оставляем пустым
		Если НЕ ПустаяСтрока(ТекстКода) И ТипСообщения = Перечисления.ИИА_ТипСообщения.Код Тогда
			НоваяСтрока.СтатусDSL = Перечисления.ИИА_СтатусDSL.ВОчереди;
		Иначе
			// Для не-DSL сообщений статус не устанавливаем (остается пустым)
			НоваяСтрока.СтатусDSL = Неопределено;
		КонецЕсли;
	Иначе
		НоваяСтрока.СтатусDSL = СтатусDSL;
	КонецЕсли;
	
	// Устанавливаем признак выполнения задачи
	Если ЗадачаВыполнена <> Неопределено Тогда
		НоваяСтрока.ЗадачаВыполнена = ЗадачаВыполнена;
	Иначе
		НоваяСтрока.ЗадачаВыполнена = Ложь;
	КонецЕсли;
	
	Диалог.Записать();
	
КонецПроцедуры

// Функции для вызова ИИ перенесены в модуль ИИА_Провайдеры
// Функции для работы с Гигачат перенесены в модуль ИИА_Гигачат

// Функции СформироватьПромптДляИИ и РаспознатьОтветИИ перенесены в модуль ИИА_Провайдеры

// Исправляет DSL-сценарий через ИИ при ошибке выполнения (использует обычную функцию ВызватьИИ)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ТекстОшибки - Строка - текст ошибки
//  ИсходныйDSL - Строка - исходный DSL-сценарий
//
// Возвращаемое значение:
//  Структура - структура ответа от ВызватьИИ (содержит DSL в поле DSL или Текст)
//
Функция ИсправитьDSLЧерезИИ(СсылкаДиалога, ТекстОшибки, ИсходныйDSL) Экспорт
	
	// Формируем промпт для исправления
	ПромптИсправления = ИИА_Промты.СформироватьПромптИсправленияDSL(ТекстОшибки, ИсходныйDSL);
	
	// Вызываем ИИ с системным сообщением (не от пользователя)
	Возврат ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптИсправления);
	
КонецФункции

// Вызывает ИИ с системным сообщением (не от пользователя)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ТипСообщения - Строка - тип сообщения ("Чат" или "Запрос")
//  ТекстСистемногоСообщения - Строка - текст системного сообщения
//
// Возвращаемое значение:
//  Структура - структура ответа от ВызватьИИ
//
Функция ВызватьИИССистемнымСообщением(СсылкаДиалога, ТипСообщения, ТекстСистемногоСообщения) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Пользователь = Диалог.Пользователь;
	
	// Получаем настройки пользователя
	Настройки = ПолучитьНастройкиПользователя(Пользователь);
	Настройки.Вставить("Пользователь", Пользователь);
	Настройки.Вставить("ТипДиалога", Диалог.ТипДиалога);
	
	// Загружаем историю диалога
	МассивИстории = ПолучитьСообщенияДиалога(СсылкаДиалога, 10);
	
	// Преобразуем массив в таблицу значений для функции ВызватьИИ
	История = ПреобразоватьМассивСообщенийВТаблицу(МассивИстории);
	
	// Добавляем системное сообщение (не от пользователя)
	ДобавитьСообщениеВДиалог(
		СсылкаДиалога,
		Перечисления.ИИА_АвторСообщения.Система,
		Перечисления.ИИА_ТипСообщения.Текст,
		ТекстСистемногоСообщения
	);
	
	// Вызываем ИИ (передаем системное сообщение как текст пользователя для ИИ, но в диалоге оно сохранено как системное)
	ОтветИИ = ИИА_Провайдеры.ВызватьИИ(ТипСообщения, ТекстСистемногоСообщения, История, Настройки);
	
	// Добавляем промпт в ответ для вывода в лог на клиенте
	Если ОтветИИ.Свойство("Промпт") Тогда
		// Промпт уже добавлен в ответ от ИИ
	Иначе
		ОтветИИ.Вставить("Промпт", "");
	КонецЕсли;
	
	// Определяем тип ответа для хранения
	Если ОтветИИ.ТипОтвета = "Запрос" Тогда
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Запрос;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = ОтветИИ.Запрос;
	ИначеЕсли ОтветИИ.ТипОтвета = "DSL" Тогда
		// Обрабатываем DSL-сценарий
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Код;
		ТекстОтвета = ОтветИИ.Текст;
		// Получаем DSL из ответа
		Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
			ТекстКодаОтвета = ОтветИИ.DSL;
		Иначе
			ТекстКодаОтвета = "";
		КонецЕсли;
		
	Иначе
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Текст;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = "";
	КонецЕсли;
	
	// Получаем UsageTokens
	UsageTokens = 0;
	Если ОтветИИ.Свойство("Usage") И ОтветИИ.Usage <> Неопределено Тогда
		Если ТипЗнч(ОтветИИ.Usage) = Тип("Структура") И ОтветИИ.Usage.Свойство("TotalTokens") Тогда
			UsageTokens = ОтветИИ.Usage.TotalTokens;
		КонецЕсли;
	КонецЕсли;
	
	// Определяем статус DSL для сообщения (пока ставим "ВОчереди", потом обновим после выполнения)
	СтатусDSLСообщения = Неопределено;
	Если ОтветИИ.ТипОтвета = "DSL" И (НЕ ПустаяСтрока(ТекстКодаОтвета) ИЛИ НЕ ПустаяСтрока(ОтветИИ.DSL)) Тогда
		СтатусDSLСообщения = Перечисления.ИИА_СтатусDSL.ВОчереди;
	КонецЕсли;
	
	// Добавляем ответ ИИ
	ДобавитьСообщениеВДиалог(
		СсылкаДиалога,
		Перечисления.ИИА_АвторСообщения.ИИ,
		ТипСообщенияОтвета,
		ТекстОтвета,
		ТекстКодаОтвета,
		"",
		UsageTokens,
		СтатусDSLСообщения
	);
	
	// Обрабатываем DSL-сценарий (если это DSL)
	Если ОтветИИ.ТипОтвета = "DSL" И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
		
		// Выполняем DSL (сообщения уже добавлены в диалог)
		РезультатDSL = ИИА_DSL.ВыполнитьDSL(ОтветИИ.DSL, СсылкаДиалога);
		
		Если РезультатDSL.Успех Тогда
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанУспешно);
			
			ТекстСистемногоСообщения = "DSL-сценарий выполнен успешно.";
			Если РезультатDSL.Результаты.Количество() > 0 Тогда
				Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
					ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "- " + РезультатШага.Сообщение;
				КонецЦикла;
			КонецЕсли;
			
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Текст,
				ТекстСистемногоСообщения,
				"",
				"",
				0
			);
			
			// Добавляем ссылки на объекты
			Если РезультатDSL.Свойство("СсылкиОбъектов") И РезультатDSL.СсылкиОбъектов.Количество() > 0 Тогда
				МассивСсылок = РезультатDSL.СсылкиОбъектов;
				
				// Сохраняем ссылки в табличную часть ИзмененныеОбъекты
				ДобавитьИзмененныеОбъекты(СсылкаДиалога, МассивСсылок);
				
				ТекстСсылок = "";
				Если МассивСсылок.Количество() = 1 Тогда
					ТекстСсылок = "Объект: " + МассивСсылок[0];
				Иначе
					ТекстСсылок = "Создано/изменено объектов: " + Формат(МассивСсылок.Количество(), "ЧН=0");
					Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
						ТекстСсылок = ТекстСсылок + Символы.ПС + "- " + СсылкаОбъекта;
					КонецЦикла;
				КонецЕсли;
				
				ДобавитьСообщениеВДиалог(
					СсылкаДиалога,
					Перечисления.ИИА_АвторСообщения.Система,
					Перечисления.ИИА_ТипСообщения.Текст,
					ТекстСсылок,
					"",
					"",
					0
				);
			КонецЕсли;
			
		Иначе
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанСОшибкой);
			
			ТекстОшибки = "Ошибка выполнения DSL: " + РезультатDSL.Сообщение;
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Ошибка,
				ТекстОшибки,
				"",
				"",
				0
			);
		КонецЕсли;
		
	КонецЕсли;
	
	Возврат ОтветИИ;
	
КонецФункции

// Получает пример DSL-сценария (заглушка для демонстрации)
//
// Параметры:
//  ТекстПользователя - Строка - текст команды пользователя
//
// Возвращаемое значение:
//  Строка - JSON с DSL-сценарием
//
Функция ПолучитьПримерDSLСценария(ТекстПользователя)
	
	// Это заглушка - в реальной реализации ИИ должен генерировать DSL на основе команды пользователя
	// и метаданных конфигурации
	
	ПримерСценария = Новый Структура;
	ПримерСценария.Вставить("dsl_version", 1);
	
	Шаги = Новый Массив;
	
	// Пример: создание элемента справочника
	Если СтрНайти(ВРег(ТекстПользователя), "КОНТРАГЕНТ") > 0 Тогда
		
		Шаг1 = Новый Структура;
		Шаг1.Вставить("action", "CreateReference");
		Шаг1.Вставить("object_name", "Контрагенты");
		Шаги.Добавить(Шаг1);
		
		Шаг2 = Новый Структура;
		Шаг2.Вставить("action", "SetField");
		Шаг2.Вставить("field", "Наименование");
		Шаг2.Вставить("value", "Новый контрагент");
		Шаги.Добавить(Шаг2);
		
		Шаг3 = Новый Структура;
		Шаг3.Вставить("action", "Write");
		Шаги.Добавить(Шаг3);
		
	Иначе
		
		// Общий пример
		Шаг1 = Новый Структура;
		Шаг1.Вставить("action", "ShowInfo");
		Шаг1.Вставить("message", "Пример DSL-сценария. Настройте ИИ для генерации реальных сценариев.");
		Шаги.Добавить(Шаг1);
		
	КонецЕсли;
	
	ПримерСценария.Вставить("steps", Шаги);
	
	// Преобразуем в JSON
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ПримерСценария);
	JSONСтрока = ЗаписьJSON.Закрыть();
	
	Возврат JSONСтрока;
	
КонецФункции

// Отправляет сообщение и получает ответ от ИИ
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ТипСообщения - Строка - тип сообщения ("Чат" или "Запрос")
//  ТекстПользователя - Строка - текст от пользователя
//
// Возвращаемое значение:
//  Структура - структура ответа от ВызватьИИ
//
Функция ОтправитьСообщениеСервера(СсылкаДиалога, ТипСообщения, ТекстПользователя) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Пользователь = Диалог.Пользователь;
	
	// Обновляем наименование диалога по первому сообщению пользователя (если имя стандартное)
	СтандартноеИмя = "Диалог ИИ от ";
	Если Лев(Диалог.Имя, СтрДлина(СтандартноеИмя)) = СтандартноеИмя И НЕ ПустаяСтрока(ТекстПользователя) Тогда
		// Формируем новое имя из текста пользователя
		НовоеИмя = СокрЛП(ТекстПользователя);
		// Заменяем переносы строк на пробелы
		НовоеИмя = СтрЗаменить(НовоеИмя, Символы.ПС, " ");
		НовоеИмя = СтрЗаменить(НовоеИмя, Символы.ВТаб, " ");
		
		// Ограничиваем длину (безопасно берем 50 символов, чтобы не превысить типичные ограничения)
		Если СтрДлина(НовоеИмя) > 50 Тогда
			НовоеИмя = Лев(НовоеИмя, 47) + "...";
		КонецЕсли;
		
		Диалог.Имя = НовоеИмя;
		Диалог.Записать();
	КонецЕсли;
	
	// Если передан ТипДиалога (перечисление), обновляем его в диалоге и используем
	Если ТипЗнч(ТипСообщения) = Тип("ПеречислениеСсылка.ИИА_ТипДиалога") Тогда
		Если Диалог.ТипДиалога <> ТипСообщения Тогда
			Диалог.ТипДиалога = ТипСообщения;
			Диалог.Записать();
		КонецЕсли;
	КонецЕсли;
	
	// Получаем настройки пользователя
	Настройки = ПолучитьНастройкиПользователя(Пользователь);
	Настройки.Вставить("Пользователь", Пользователь);
	Настройки.Вставить("ТипДиалога", Диалог.ТипДиалога);
	
	// Загружаем историю диалога
	МассивИстории = ПолучитьСообщенияДиалога(СсылкаДиалога, 10);
	
	// Преобразуем массив в таблицу значений для функции ВызватьИИ
	История = ПреобразоватьМассивСообщенийВТаблицу(МассивИстории);
	
	// Определяем тип сообщения для хранения
	Если ТипСообщения = "Запрос" Тогда
		ТипСообщенияДляХранения = Перечисления.ИИА_ТипСообщения.Запрос;
	Иначе
		ТипСообщенияДляХранения = Перечисления.ИИА_ТипСообщения.Текст;
	КонецЕсли;
	
	// Добавляем сообщение пользователя
	ДобавитьСообщениеВДиалог(
		СсылкаДиалога,
		Перечисления.ИИА_АвторСообщения.Пользователь,
		ТипСообщенияДляХранения,
		ТекстПользователя
	);

	// Очищаем результат проверки задачи, так как пользователь прислал новое сообщение
	СброситьРезультатПроверкиВХранилище(СсылкаДиалога); // Сбрасываем флаг проверки
	
	// Вызываем ИИ
	ОтветИИ = ИИА_Провайдеры.ВызватьИИ(ТипСообщения, ТекстПользователя, История, Настройки);
	
	// Добавляем промпт в ответ для вывода в лог на клиенте
	Если ОтветИИ.Свойство("Промпт") Тогда
		// Промпт уже добавлен в ответ от ИИ
	Иначе
		ОтветИИ.Вставить("Промпт", "");
	КонецЕсли;
	
	// Определяем тип ответа для хранения
	Если ОтветИИ.ТипОтвета = "Запрос" Тогда
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Запрос;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = ОтветИИ.Запрос;
	ИначеЕсли ОтветИИ.ТипОтвета = "DSL" Тогда
		// Обрабатываем DSL-сценарий
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Код;
		ТекстОтвета = ОтветИИ.Текст;
		// Получаем DSL из ответа
		Если ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
			ТекстКодаОтвета = ОтветИИ.DSL;
		Иначе
			ТекстКодаОтвета = "";
		КонецЕсли;
		
	Иначе
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Текст;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = "";
	КонецЕсли;
	
	// Получаем UsageTokens
	UsageTokens = 0;
	Если ОтветИИ.Свойство("Usage") И ОтветИИ.Usage <> Неопределено Тогда
		Если ТипЗнч(ОтветИИ.Usage) = Тип("Структура") И ОтветИИ.Usage.Свойство("TotalTokens") Тогда
			UsageTokens = ОтветИИ.Usage.TotalTokens;
		КонецЕсли;
	КонецЕсли;
	
	// Определяем статус DSL для сообщения (пока ставим "ВОчереди", потом обновим после выполнения)
	СтатусDSLСообщения = Неопределено;
	Если ОтветИИ.ТипОтвета = "DSL" И (НЕ ПустаяСтрока(ТекстКодаОтвета) ИЛИ НЕ ПустаяСтрока(ОтветИИ.DSL)) Тогда
		СтатусDSLСообщения = Перечисления.ИИА_СтатусDSL.ВОчереди;
	КонецЕсли;
	
	// Сначала добавляем ответ ИИ
	ДобавитьСообщениеВДиалог(
		СсылкаДиалога,
		Перечисления.ИИА_АвторСообщения.ИИ,
		ТипСообщенияОтвета,
		ТекстОтвета,
		ТекстКодаОтвета,
		"",
		UsageTokens,
		СтатусDSLСообщения
	);
	
		// Теперь обрабатываем DSL-сценарий (если это DSL)
		Если ОтветИИ.ТипОтвета = "DSL" И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
			
			// Выполняем DSL
			РезультатDSL = ВыполнитьDSLСценарий(ОтветИИ.DSL, СсылкаДиалога);
		
		// Добавляем информацию о результате DSL в ответ для клиента
		ОтветИИ.Вставить("РезультатDSL", РезультатDSL);
		ОтветИИ.Вставить("DSLJSON", ОтветИИ.DSL);
		
		// Базовая обработка результата (статус и сообщения об успехе/ошибке)
		Если РезультатDSL.Успех Тогда
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанУспешно);
			
			ТекстСистемногоСообщения = "DSL-сценарий выполнен успешно.";
			Если РезультатDSL.Результаты.Количество() > 0 Тогда
				Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
					ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "- " + РезультатШага.Сообщение;
				КонецЦикла;
			КонецЕсли;
			
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Текст,
				ТекстСистемногоСообщения,
				"",
				"",
				0
			);
			
			// Добавляем ссылки на объекты
			Если РезультатDSL.Свойство("СсылкиОбъектов") И РезультатDSL.СсылкиОбъектов.Количество() > 0 Тогда
				МассивСсылок = РезультатDSL.СсылкиОбъектов;
				
				// Сохраняем ссылки в табличную часть ИзмененныеОбъекты
				ДобавитьИзмененныеОбъекты(СсылкаДиалога, МассивСсылок);
				
				ТекстСсылок = "";
				Если МассивСсылок.Количество() = 1 Тогда
					ТекстСсылок = "Объект: " + МассивСсылок[0];
				Иначе
					ТекстСсылок = "Создано/изменено объектов: " + Формат(МассивСсылок.Количество(), "ЧН=0");
					Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
						ТекстСсылок = ТекстСсылок + Символы.ПС + "- " + СсылкаОбъекта;
					КонецЦикла;
				КонецЕсли;
				
				ДобавитьСообщениеВДиалог(
					СсылкаДиалога,
					Перечисления.ИИА_АвторСообщения.Система,
					Перечисления.ИИА_ТипСообщения.Текст,
					ТекстСсылок,
					"",
					"",
					0
				);
			КонецЕсли;
			
			// Проверка результата выполнения задачи будет выполнена на клиенте
			// Результат DSL передается клиенту для обработки итераций
			
		Иначе
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанСОшибкой);
			
			ТекстОшибки = "Ошибка выполнения DSL: " + РезультатDSL.Сообщение;
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Ошибка,
				ТекстОшибки,
				"",
				"",
				0
			);
		КонецЕсли;
		
	КонецЕсли;
	
	// Если есть ТекстКода, добавляем системное сообщение о получении кода (только для не-DSL типов)
	Если НЕ ПустаяСтрока(ТекстКодаОтвета) И ОтветИИ.ТипОтвета <> "DSL" Тогда
		
		// Определяем текст системного сообщения в зависимости от типа
		Если ОтветИИ.ТипОтвета = "Запрос" Тогда
			ТекстСистемногоСообщения = "Запрос сгенерирован.";
		Иначе
			ТекстСистемногоСообщения = "ИИ сгенерировал код.";
		КонецЕсли;
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			ТекстСистемногоСообщения,
			"",
			"",
			0
		);
		
	КонецЕсли;
	
	Возврат ОтветИИ;
	
КонецФункции

// Проверяет запрос 1С на выполнимость
//
// Параметры:
//  ТекстЗапроса - Строка - текст запроса
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево - успешность выполнения
//   * Сообщение - Строка - текст ошибки или пусто
//
Функция ПроверитьЗапрос(ТекстЗапроса) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	
	Попытка
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.Выполнить();
		
		Результат.Успех = Истина;
		
	Исключение
		
		Результат.Сообщение = ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет DSL сценарий
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата выполнения DSL
//
Функция ВыполнитьDSLСценарий(DSLJSON, СсылкаДиалога = Неопределено) Экспорт
	
	РезультатDSL = ИИА_DSL.ВыполнитьDSL(DSLJSON, СсылкаДиалога);
	
	// Обрабатываем результаты для установки флагов открытия табличного документа
	Если РезультатDSL.Успех Тогда
		// Проверяем, есть ли данные запроса в результате DSL (устанавливается при RunQuery)
		Если РезультатDSL.Свойство("ДанныеЗапросаДляТаблицы") И РезультатDSL.ДанныеЗапросаДляТаблицы <> Неопределено Тогда
			РезультатDSL.Вставить("ОткрытьТабличныйДокумент", Истина);
			РезультатDSL.Вставить("ДанныеЗапроса", РезультатDSL.ДанныеЗапросаДляТаблицы);
		ИначеЕсли РезультатDSL.Результаты.Количество() > 0 Тогда
			// Проверяем результаты шагов для ShowInfo с результатом запроса
			Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
				// Если это результат ShowInfo с результатом запроса, устанавливаем флаги
				Если РезультатШага.Свойство("ТипДействия") И РезультатШага.ТипДействия = "ShowInfo" И
				   РезультатШага.Свойство("ЕстьРезультатЗапроса") И РезультатШага.ЕстьРезультатЗапроса Тогда
					РезультатDSL.Вставить("ОткрытьТабличныйДокумент", Истина);
					// Копируем данные запроса в результат DSL
					Если РезультатDSL.Свойство("ДанныеЗапросаДляТаблицы") Тогда
						РезультатDSL.Вставить("ДанныеЗапроса", РезультатDSL.ДанныеЗапросаДляТаблицы);
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
	КонецЕсли;
	
	Возврат РезультатDSL;
	
КонецФункции

// Выполняет DSL-сценарий и добавляет системные сообщения в диалог
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата выполнения DSL
//
// Выполняет DSL-сценарий без добавления сообщений в диалог
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата выполнения DSL
//
Функция ВыполнитьDSLСценарийБезСообщений(DSLJSON, СсылкаДиалога = Неопределено) Экспорт
	
	// Выполняем DSL без добавления сообщений
	РезультатDSL = ИИА_DSL.ВыполнитьDSL(DSLJSON, СсылкаДиалога);
	
	Возврат РезультатDSL;
	
КонецФункции

Функция ВыполнитьDSLСценарийССообщениями(СсылкаДиалога, DSLJSON) Экспорт
	
	// Выполняем DSL
	РезультатDSL = ИИА_DSL.ВыполнитьDSL(DSLJSON, СсылкаДиалога);
	
	Если РезультатDSL.Успех Тогда
		
		// Добавляем системное сообщение об успешном выполнении
		ТекстСистемногоСообщения = "DSL-сценарий выполнен успешно.";
		
		// Обрабатываем результаты шагов
		Если РезультатDSL.Результаты.Количество() > 0 Тогда
			Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
				// Если это результат ShowInfo, выводим его как отдельное сообщение от ИИ
				Если РезультатШага.Свойство("ТипДействия") И РезультатШага.ТипДействия = "ShowInfo" И 
				   НЕ ПустаяСтрока(РезультатШага.Сообщение) Тогда
					ДобавитьСообщениеВДиалог(
						СсылкаДиалога,
						Перечисления.ИИА_АвторСообщения.ИИ,
						Перечисления.ИИА_ТипСообщения.Текст,
						РезультатШага.Сообщение,
						"",
						"",
						0
					);
					// Если есть результат запроса, сохраняем данные для создания табличного документа на клиенте
					Если РезультатШага.Свойство("ЕстьРезультатЗапроса") И РезультатШага.ЕстьРезультатЗапроса Тогда
						РезультатDSL.Вставить("ОткрытьТабличныйДокумент", Истина);
						// Ищем данные запроса в результате DSL (они сохраняются при выполнении RunQuery)
						Если РезультатDSL.Свойство("ДанныеЗапросаДляТаблицы") Тогда
							РезультатDSL.Вставить("ДанныеЗапроса", РезультатDSL.ДанныеЗапросаДляТаблицы);
						КонецЕсли;
					КонецЕсли;
				ИначеЕсли РезультатШага.Свойство("ТипДействия") И РезультатШага.ТипДействия = "RunQuery" И
				   РезультатШага.Свойство("ЕстьРезультатЗапроса") И РезультатШага.ЕстьРезультатЗапроса Тогда
					// Если это RunQuery с данными, устанавливаем флаги для открытия табличного документа
					РезультатDSL.Вставить("ОткрытьТабличныйДокумент", Истина);
					Если РезультатDSL.Свойство("ДанныеЗапросаДляТаблицы") Тогда
						РезультатDSL.Вставить("ДанныеЗапроса", РезультатDSL.ДанныеЗапросаДляТаблицы);
					КонецЕсли;
				Иначе
					// Обычный результат шага - добавляем в системное сообщение
					ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "- " + РезультатШага.Сообщение;
					
					// Если это GetObjectFields, добавляем детальную информацию о реквизитах
					Если РезультатШага.Свойство("ТипДействия") И РезультатШага.ТипДействия = "GetObjectFields" 
						И РезультатШага.Свойство("Данные") И РезультатШага.Данные <> Неопределено Тогда
						
						ДанныеОбъекта = РезультатШага.Данные;
						Если ТипЗнч(ДанныеОбъекта) = Тип("Структура") И ДанныеОбъекта.Свойство("Реквизиты") Тогда
							МассивРеквизитов = ДанныеОбъекта.Реквизиты;
							Если ТипЗнч(МассивРеквизитов) = Тип("Массив") И МассивРеквизитов.Количество() > 0 Тогда
								ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "Реквизиты:";
								Для Каждого Реквизит Из МассивРеквизитов Цикл
									Если ТипЗнч(Реквизит) = Тип("Структура") И Реквизит.Свойство("Имя") Тогда
										ИмяРеквизита = Реквизит.Имя;
										Если Реквизит.Свойство("Синоним") И НЕ ПустаяСтрока(Реквизит.Синоним) Тогда
											ИмяРеквизита = ИмяРеквизита + " (" + Реквизит.Синоним + ")";
										КонецЕсли;
										ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "  - " + ИмяРеквизита;
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
		КонецЕсли;
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			ТекстСистемногоСообщения,
			"",
			"",
			0
		);
		
		// Добавляем системное сообщение со ссылками на созданные/измененные объекты
		Если РезультатDSL.Свойство("СсылкиОбъектов") Тогда
			МассивСсылок = РезультатDSL.СсылкиОбъектов;
			Если МассивСсылок.Количество() > 0 Тогда
				Попытка
					
					// Сохраняем ссылки в табличную часть ИзмененныеОбъекты
					ДобавитьИзмененныеОбъекты(СсылкаДиалога, МассивСсылок);
					
					ТекстСсылок = "";
					
					// Формируем текст с гиперссылками
					Если МассивСсылок.Количество() = 1 Тогда
						СсылкаОбъекта = МассивСсылок[0];
						ТекстСсылок = "Объект: " + СсылкаОбъекта;
					Иначе
						ТекстСсылок = "Создано/изменено объектов: " + Формат(МассивСсылок.Количество(), "ЧН=0");
						Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
							ТекстСсылок = ТекстСсылок + Символы.ПС + "- " + СсылкаОбъекта;
						КонецЦикла;
					КонецЕсли;
					
					ДобавитьСообщениеВДиалог(
						СсылкаДиалога,
						Перечисления.ИИА_АвторСообщения.Система,
						Перечисления.ИИА_ТипСообщения.Текст,
						ТекстСсылок,
						"",
						"",
						0
					);
					
				Исключение
					// Если не удалось добавить ссылки, добавляем сообщение об ошибке для отладки
					ДобавитьСообщениеВДиалог(
						СсылкаДиалога,
						Перечисления.ИИА_АвторСообщения.Система,
						Перечисления.ИИА_ТипСообщения.Ошибка,
						"Ошибка при формировании сообщения со ссылками: " + ОписаниеОшибки(),
						"",
						"",
						0
					);
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
		
	Иначе
		
		// Добавляем системное сообщение об ошибке
		ТекстОшибки = "Ошибка выполнения DSL: " + РезультатDSL.Сообщение;
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Ошибка,
			ТекстОшибки,
			"",
			"",
			0
		);
		
	КонецЕсли;
	
	Возврат РезультатDSL;
	
КонецФункции

// Проверяет DSL сценарий
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата проверки DSL
//
Функция ПроверитьDSLСценарий(DSLJSON) Экспорт
	
	Возврат ИИА_DSL.ПроверитьDSL(DSLJSON);
	
КонецФункции

// Обновляет статус DSL в последнем сообщении диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  НовыйСтатус - ПеречислениеСсылка.ИИА_СтатусDSL - новый статус DSL
//
Процедура ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, НовыйСтатус) Экспорт
	
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Находим последнее сообщение с DSL (тип Код)
		Если Диалог.Сообщения.Количество() > 0 Тогда
			
			// Ищем последнее сообщение с типом "Код" (DSL), начиная с конца
			Индекс = Диалог.Сообщения.Количество() - 1;
			Пока Индекс >= 0 Цикл
				
				СтрокаСообщения = Диалог.Сообщения[Индекс];
				
				Если СтрокаСообщения.ТипСообщения = Перечисления.ИИА_ТипСообщения.Код И НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
					
					СтрокаСообщения.СтатусDSL = НовыйСтатус;
					Диалог.Записать();
					
					Прервать;
					
				КонецЕсли;
				
				Индекс = Индекс - 1;
				
			КонецЦикла;
			
		КонецЕсли;
		
	Исключение
		// Игнорируем ошибки обновления статуса
	КонецПопытки;
	
КонецПроцедуры

// Получает данные созданных объектов (реквизиты)
//
// Параметры:
//  МассивСсылок - Массив - массив ссылок на созданные объекты
//
// Возвращаемое значение:
//  Строка - текстовое описание реквизитов объектов
//
Функция ПолучитьДанныеСозданныхОбъектов(МассивСсылок)
	
	ТекстДанных = "";
	
	Если МассивСсылок.Количество() = 0 Тогда
		Возврат ТекстДанных;
	КонецЕсли;
	
	Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
		
		Попытка
			
			// Получаем объект по ссылке
			Объект = СсылкаОбъекта.ПолучитьОбъект();
			
			Если Объект = Неопределено Тогда
				Продолжить;
			КонецЕсли;
			
			// Определяем тип объекта
			ТипСсылки = ТипЗнч(СсылкаОбъекта);
			ИмяТипа = Строка(ТипСсылки);
			
			ТекстДанных = ТекстДанных + "Объект: " + СсылкаОбъекта + Символы.ПС;
			ТекстДанных = ТекстДанных + "Тип: " + ИмяТипа + Символы.ПС;
			
			// Получаем метаданные объекта
			Если Справочники.ТипВсеСсылки().СодержитТип(ТипСсылки) Тогда
				
				МетаданныеОбъекта = СсылкаОбъекта.Метаданные();
				ТекстДанных = ТекстДанных + "Справочник: " + МетаданныеОбъекта.Имя + " (" + МетаданныеОбъекта.Синоним + ")" + Символы.ПС;
				
				// Получаем реквизиты справочника
				Для Каждого Реквизит Из МетаданныеОбъекта.Реквизиты Цикл
					
					Попытка
						ЗначениеРеквизита = Объект[Реквизит.Имя];
						ТекстЗначения = "";
						
						Если ЗначениеЗаполнено(ЗначениеРеквизита) Тогда
							Если ТипЗнч(ЗначениеРеквизита) = Тип("Строка") Тогда
								ТекстЗначения = ЗначениеРеквизита;
							ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Число") Тогда
								ТекстЗначения = Формат(ЗначениеРеквизита, "ЧГ=");
							ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Дата") Тогда
								ТекстЗначения = Формат(ЗначениеРеквизита, "ДФ=dd.MM.yyyy HH:mm:ss");
							ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Булево") Тогда
								Если ЗначениеРеквизита Тогда
									ТекстЗначения = "Истина";
								Иначе
									ТекстЗначения = "Ложь";
								КонецЕсли;
							Иначе
								ТекстЗначения = Строка(ЗначениеРеквизита);
							КонецЕсли;
							
							ТекстДанных = ТекстДанных + "  " + Реквизит.Синоним + " (" + Реквизит.Имя + "): " + ТекстЗначения + Символы.ПС;
						КонецЕсли;
						
					Исключение
						// Игнорируем ошибки получения реквизита
					КонецПопытки;
					
				КонецЦикла;
				
			ИначеЕсли Документы.ТипВсеСсылки().СодержитТип(ТипСсылки) Тогда
				
				МетаданныеОбъекта = СсылкаОбъекта.Метаданные();
				ТекстДанных = ТекстДанных + "Документ: " + МетаданныеОбъекта.Имя + " (" + МетаданныеОбъекта.Синоним + ")" + Символы.ПС;
				
				// Получаем реквизиты документа
				Для Каждого Реквизит Из МетаданныеОбъекта.Реквизиты Цикл
					
					Попытка
						ЗначениеРеквизита = Объект[Реквизит.Имя];
						ТекстЗначения = "";
						
						Если ЗначениеЗаполнено(ЗначениеРеквизита) Тогда
							Если ТипЗнч(ЗначениеРеквизита) = Тип("Строка") Тогда
								ТекстЗначения = ЗначениеРеквизита;
							ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Число") Тогда
								ТекстЗначения = Формат(ЗначениеРеквизита, "ЧГ=");
							ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Дата") Тогда
								ТекстЗначения = Формат(ЗначениеРеквизита, "ДФ=dd.MM.yyyy HH:mm:ss");
							ИначеЕсли ТипЗнч(ЗначениеРеквизита) = Тип("Булево") Тогда
								Если ЗначениеРеквизита Тогда
									ТекстЗначения = "Истина";
								Иначе
									ТекстЗначения = "Ложь";
								КонецЕсли;
							Иначе
								ТекстЗначения = Строка(ЗначениеРеквизита);
							КонецЕсли;
							
							ТекстДанных = ТекстДанных + "  " + Реквизит.Синоним + " (" + Реквизит.Имя + "): " + ТекстЗначения + Символы.ПС;
						КонецЕсли;
						
					Исключение
						// Игнорируем ошибки получения реквизита
					КонецПопытки;
					
				КонецЦикла;
				
			КонецЕсли;
			
			ТекстДанных = ТекстДанных + Символы.ПС;
			
		Исключение
			// Если не удалось получить данные объекта, просто добавляем ссылку
			ТекстДанных = ТекстДанных + "Объект: " + СсылкаОбъекта + " (не удалось получить данные)" + Символы.ПС + Символы.ПС;
		КонецПопытки;
		
	КонецЦикла;
	
	Возврат ТекстДанных;
	
КонецФункции

// Проверяет результат выполнения задачи через ИИ
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ТекстЗадачиПользователя - Строка - исходный текст задачи пользователя
//  РезультатDSL - Структура - результат выполнения DSL-сценария
//  Настройки - Структура - настройки пользователя (если Неопределено, получаются из диалога)
//
// Возвращаемое значение:
//  Булево - Истина, если задача выполнена, Ложь - если нет
//
Функция ПроверитьРезультатВыполненияЗадачи(СсылкаДиалога, ТекстЗадачиПользователя, РезультатDSL, Настройки = Неопределено) Экспорт
	
	ТекстОтвета = "";
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Получаем настройки, если они не переданы
		Если Настройки = Неопределено Тогда
			Пользователь = Диалог.Пользователь;
			Настройки = ПолучитьНастройкиПользователя(Пользователь);
			Настройки.Вставить("Пользователь", Пользователь);
		КонецЕсли;
		
		// Формируем информацию о результатах выполнения
		ТекстРезультатов = "DSL-сценарий выполнен успешно." + Символы.ПС;
		
		Если РезультатDSL.Результаты.Количество() > 0 Тогда
			Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
				ТекстРезультатов = ТекстРезультатов + "- " + РезультатШага.Сообщение + Символы.ПС;
			КонецЦикла;
		КонецЕсли;
		
		// Получаем детальную информацию о созданных объектах
		ТекстДанныхОбъектов = "";
		Если РезультатDSL.Свойство("СсылкиОбъектов") И РезультатDSL.СсылкиОбъектов.Количество() > 0 Тогда
			ТекстРезультатов = ТекстРезультатов + "Создано/изменено объектов: " + Формат(РезультатDSL.СсылкиОбъектов.Количество(), "ЧН=0") + Символы.ПС;
			ТекстДанныхОбъектов = ПолучитьДанныеСозданныхОбъектов(РезультатDSL.СсылкиОбъектов);
		КонецЕсли;
		
		// Формируем промпт для проверки через DSL-сценарий
		ПромптПроверки = ИИА_Промты.СформироватьПромптПроверкиЗадачи(ТекстЗадачиПользователя, ТекстРезультатов);
		
		// Загружаем историю диалога для контекста
		МассивИстории = ПолучитьСообщенияДиалога(СсылкаДиалога, 10);
		История = ПреобразоватьМассивСообщенийВТаблицу(МассивИстории);
		
		// Вызываем ИИ для генерации DSL-сценария проверки
		ОтветПроверки = ИИА_Провайдеры.ВызватьИИ("Чат", ПромптПроверки, История, Настройки);
		
		// Проверяем, получен ли DSL-сценарий
		ЗадачаВыполнена = Ложь;
		Если ОтветПроверки.ТипОтвета = "DSL" И НЕ ПустаяСтрока(ОтветПроверки.DSL) Тогда
			
			// Выполняем DSL-сценарий проверки
			РезультатПроверкиDSL = ВыполнитьDSLСценарийБезСообщений(ОтветПроверки.DSL, СсылкаДиалога);
			
			Если РезультатПроверкиDSL.Успех Тогда
				// Ищем сообщение ShowInfo в результатах
				Для Каждого РезультатШага Из РезультатПроверкиDSL.Результаты Цикл
					Если РезультатШага.Свойство("Данные") И ТипЗнч(РезультатШага.Данные) = Тип("Строка") Тогда
						ТекстОтвета = ВРег(СокрЛП(РезультатШага.Данные));
					ИначеЕсли НЕ ПустаяСтрока(РезультатШага.Сообщение) Тогда
						ТекстОтвета = ВРег(СокрЛП(РезультатШага.Сообщение));
					КонецЕсли;
					
					Если Найти(ТекстОтвета, "ДА") > 0 Тогда
						ЗадачаВыполнена = Истина;
						Прервать;
					ИначеЕсли Найти(ТекстОтвета, "НЕТ") > 0 Тогда
						ЗадачаВыполнена = Ложь;
						Прервать;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
		ИначеЕсли НЕ ПустаяСтрока(ОтветПроверки.Текст) Тогда
			// Если не получен DSL, анализируем текстовый ответ
			ТекстОтвета = ВРег(СокрЛП(ОтветПроверки.Текст));
			// Проверяем, содержит ли ответ подтверждение
			Если СтрНайти(ТекстОтвета, "ДА") > 0 
				ИЛИ СтрНайти(ТекстОтвета, "YES") > 0
				ИЛИ СтрНайти(ТекстОтвета, "ВЫПОЛНЕНА") > 0
				ИЛИ СтрНайти(ТекстОтвета, "ВЫПОЛНЕНО") > 0 Тогда
				ЗадачаВыполнена = Истина;
			КонецЕсли;
		КонецЕсли;
		
		// Обновляем признак выполнения задачи во всех невыполненных сообщениях пользователя
		// Если задача выполнена, обновляем все невыполненные задачи
		Если Диалог.Сообщения.Количество() > 0 Тогда
			
			Если ЗадачаВыполнена Тогда
				// Если задача выполнена, обновляем все невыполненные задачи пользователя
				Для Каждого СтрокаСообщения Из Диалог.Сообщения Цикл
					Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
						Если НЕ (СтрокаСообщения.ЗадачаВыполнена = Истина) Тогда
							СтрокаСообщения.ЗадачаВыполнена = Истина;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			Диалог.Записать();
			
			// Добавляем системное сообщение о результате проверки
			Если ЗадачаВыполнена Тогда
				ТекстПроверки = "Задача выполнена успешно.";
			Иначе
				ТекстПроверки = "Задача может быть выполнена не полностью. Проверьте результат.";
			КонецЕсли;
			
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Текст,
				ТекстПроверки,
				"",
				"",
				0
			);
			
		КонецЕсли;
		
	Исключение
		// Игнорируем ошибки проверки, чтобы не прерывать основной процесс
		ЗадачаВыполнена = Ложь;
		ТекстОтвета = "Ошибка проверки: " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Новый Структура("ЗадачаВыполнена, Причина", ЗадачаВыполнена, СокрЛП(ТекстОтвета));
	
КонецФункции

// Генерирует summary (резюме) выполненной работы через ИИ
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Строка - текст summary или пустая строка при ошибке
//
Функция СгенерироватьSummary(СсылкаДиалога) Экспорт
	
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Получаем все сообщения диалога для контекста
		МассивИстории = ПолучитьСообщенияДиалога(СсылкаДиалога, 100);
		История = ПреобразоватьМассивСообщенийВТаблицу(МассивИстории);
		
		// Получаем информацию о созданных/измененных объектах
		ТекстИзмененныхОбъектов = "";
		Если Диалог.ИзмененныеОбъекты.Количество() > 0 Тогда
			ТекстИзмененныхОбъектов = "Созданные/измененные объекты:" + Символы.ПС;
			Для Каждого СтрокаИзмененныхОбъектов Из Диалог.ИзмененныеОбъекты Цикл
				Если ЗначениеЗаполнено(СтрокаИзмененныхОбъектов.СсылкаНаОбъект) Тогда
					ТекстИзмененныхОбъектов = ТекстИзмененныхОбъектов + "- " + СтрокаИзмененныхОбъектов.СсылкаНаОбъект + Символы.ПС;
				КонецЕсли;
			КонецЦикла;
		Иначе
			ТекстИзмененныхОбъектов = "Объекты не создавались и не изменялись.";
		КонецЕсли;
		
		// Получаем все задачи пользователя из истории диалога
		ТекстЗадач = "";
		Для Каждого СтруктураСообщения Из МассивИстории Цикл
			Если СтруктураСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
				ТекстЗадачи = СокрЛП(СтруктураСообщения.Текст);
				Если НЕ ПустаяСтрока(ТекстЗадачи) Тогда
					Если НЕ ПустаяСтрока(ТекстЗадач) Тогда
						ТекстЗадач = ТекстЗадач + Символы.ПС;
					КонецЕсли;
					ТекстЗадач = ТекстЗадач + ТекстЗадачи;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		// Извлекаем результаты выполнения DSL из системных сообщений
		// Ищем сообщения с DSL-сценариями и их результаты
		ТекстРезультатовDSL = "";
		Для Индекс = 0 По МассивИстории.Количество() - 1 Цикл
			СтруктураСообщения = МассивИстории[Индекс];
			
			// Ищем сообщения ИИ с DSL-сценариями
			Если СтруктураСообщения.Автор = Перечисления.ИИА_АвторСообщения.ИИ 
				И НЕ ПустаяСтрока(СтруктураСообщения.ТекстКода) Тогда
				
				// Пытаемся найти следующее системное сообщение с результатами выполнения
				Если Индекс + 1 < МассивИстории.Количество() Тогда
					СледующееСообщение = МассивИстории[Индекс + 1];
					Если СледующееСообщение.Автор = Перечисления.ИИА_АвторСообщения.Система 
						И НЕ ПустаяСтрока(СледующееСообщение.Текст) Тогда
						
						ТекстРезультата = СокрЛП(СледующееСообщение.Текст);
						Если НЕ ПустаяСтрока(ТекстРезультата) Тогда
							Если НЕ ПустаяСтрока(ТекстРезультатовDSL) Тогда
								ТекстРезультатовDSL = ТекстРезультатовDSL + Символы.ПС;
							КонецЕсли;
							ТекстРезультатовDSL = ТекстРезультатовDSL + "DSL-сценарий: " + СокрЛП(СтруктураСообщения.ТекстКода) + Символы.ПС;
							ТекстРезультатовDSL = ТекстРезультатовDSL + "Результат: " + ТекстРезультата;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		// Получаем настройки ИИ для пользователя диалога
		Пользователь = Диалог.Пользователь;
		Настройки = ПолучитьНастройкиПользователя(Пользователь);
		Настройки.Вставить("Пользователь", Пользователь);
		
		// Формируем промпт для генерации summary
		ПромптSummary = ИИА_Промты.СформироватьПромптРезюме(ТекстЗадач, ТекстИзмененныхОбъектов, ТекстРезультатовDSL);
		
		// Вызываем ИИ для генерации summary
		ОтветИИ = ИИА_Провайдеры.ВызватьИИ("Чат", ПромптSummary, История, Настройки);
		
		ТекстSummary = "";
		Если ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
			ТекстSummary = ОтветИИ.Текст;
		ИначеЕсли ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
			// Если получен DSL, извлекаем текст из него
			ТекстSummary = ОтветИИ.DSL;
		КонецЕсли;
		
		Возврат ТекстSummary;
		
	Исключение
		Возврат "Ошибка при генерации summary: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

// Обработка результата DSL перенесена на клиент (ИИА_Клиент.ОбработатьРезультатDSL)
// Эта функция больше не используется

// Создает табличный документ из массива структур с данными запроса
//
// Параметры:
//  ДанныеЗапроса - Массив - массив структур с данными запроса
//
// Возвращаемое значение:
//  ТабличныйДокумент - созданный табличный документ
//
Функция СоздатьТабличныйДокументИзДанных(ДанныеЗапроса) Экспорт
	
	Если ДанныеЗапроса = Неопределено Или ТипЗнч(ДанныеЗапроса) <> Тип("Массив") Или ДанныеЗапроса.Количество() = 0 Тогда
		ВызватьИсключение "ДанныеЗапроса пусты или неверного типа";
	КонецЕсли;
	
	Попытка
		// Получаем структуру первой строки для определения колонок
		ПерваяСтрока = ДанныеЗапроса[0];
		Если ТипЗнч(ПерваяСтрока) <> Тип("Структура") Тогда
			ВызватьИсключение "Первая строка данных должна быть структурой";
		КонецЕсли;
		
		// Создаем таблицу значений для удобной работы с данными
		ТаблицаДанных = Новый ТаблицаЗначений;
		
		// Добавляем колонки на основе первой строки
		Для Каждого ПараКлючЗначение Из ПерваяСтрока Цикл
			ТаблицаДанных.Колонки.Добавить(ПараКлючЗначение.Ключ, Новый ОписаниеТипов("Строка"));
		КонецЦикла;
		
		// Заполняем таблицу значений данными
		Для Каждого СтрокаДанных Из ДанныеЗапроса Цикл
			Если ТипЗнч(СтрокаДанных) = Тип("Структура") Тогда
				НоваяСтрока = ТаблицаДанных.Добавить();
				Для Каждого ПараКлючЗначение Из ПерваяСтрока Цикл
					ИмяКолонки = ПараКлючЗначение.Ключ;
					Если СтрокаДанных.Свойство(ИмяКолонки) Тогда
						Значение = СтрокаДанных[ИмяКолонки];
						НоваяСтрока[ИмяКолонки] = Строка(Значение);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		КонецЦикла;
		
		// Создаем табличный документ
		ТабличныйДокумент = Новый ТабличныйДокумент;
		
		// Используем ПостроительОтчета для вывода таблицы значений
		Построитель = Новый ПостроительОтчета;
		Построитель.ИсточникДанных = Новый ОписаниеИсточникаДанных(ТаблицаДанных);
		Построитель.Вывести(ТабличныйДокумент);
		
		Возврат ТабличныйДокумент;
		
	Исключение
		ВызватьИсключение "Ошибка при создании табличного документа: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

#КонецОбласти

// Сохраняет лог в справочник ИИА_Диалоги
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ТекстЛога - Строка - текст лога для сохранения
//
Процедура СохранитьЛогДиалога(СсылкаДиалога, ТекстЛога) Экспорт
	
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		Диалог.Лог = ТекстЛога;
		Диалог.Записать();
		
	Исключение
		// Игнорируем ошибки сохранения лога
	КонецПопытки;
	
КонецПроцедуры

// Получает лог из справочника ИИА_Диалоги
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Строка - текст лога
//
Функция ПолучитьЛогДиалога(СсылкаДиалога) Экспорт
	
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		Если Диалог.Свойство("Лог") Тогда
			Возврат Строка(Диалог.Лог);
		КонецЕсли;
		
	Исключение
		// Игнорируем ошибки чтения лога
	КонецПопытки;
	
	Возврат "";
	
КонецФункции


// Сбрасывает результат проверки задачи в хранилище диалога (устанавливает ПроверкаВыполнена = Ложь)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Процедура СброситьРезультатПроверкиВХранилище(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	СтруктураПроверки = Новый Структура;
	
	Если ЗначениеЗаполнено(Диалог.ХранилищеЗначения) Тогда
		Попытка
			СтруктураПроверки = Диалог.ХранилищеЗначения.Получить();
		Исключение
			СтруктураПроверки = Новый Структура;
		КонецПопытки;
		Если ТипЗнч(СтруктураПроверки) <> Тип("Структура") Тогда
			СтруктураПроверки = Новый Структура;
		КонецЕсли;
	КонецЕсли;
	
	СтруктураПроверки.Вставить("ПроверкаВыполнена", Ложь);
	СтруктураПроверки.Вставить("СтатусПроверкиЗадачи", "");
	СтруктураПроверки.Вставить("ПричинаПроверки", "");
	
	ХранилищеЗначения = Новый ХранилищеЗначения(СтруктураПроверки);
	Диалог.ХранилищеЗначения = ХранилищеЗначения;
	Диалог.Записать();
	
КонецПроцедуры


