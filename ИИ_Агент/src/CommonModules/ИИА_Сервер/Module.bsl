#Область ПрограммныйИнтерфейс

// Получает настройки пользователя из регистра сведений
//
// Параметры:
//  Пользователь - СправочникСсылка.Пользователи - пользователь, для которого получить настройки
//
// Возвращаемое значение:
//  Структура - структура с настройками:
//   * РежимПодключения - ПеречислениеСсылка.ИИА_РежимПодключения
//   * Gitsell_Endpoint - Строка
//   * Gitsell_AccessToken - Строка
//   * Provider_BaseURL - Строка
//   * Provider_ApiKey - Строка
//   * ProviderType - Строка
//
Функция ПолучитьНастройкиПользователя(Пользователь) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("РежимПодключения", Неопределено);
	Результат.Вставить("Gitsell_Endpoint", "");
	Результат.Вставить("Gitsell_AccessToken", "");
	Результат.Вставить("Provider_BaseUrl", "");
	Результат.Вставить("Provider_ApiKey", "");
	Результат.Вставить("Provider_Type", "");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	НастройкиПользователя.РежимПодключения,
	|	НастройкиПользователя.Gitsell_Endpoint,
	|	НастройкиПользователя.Gitsell_AccessToken,
	|	НастройкиПользователя.Provider_BaseUrl,
	|	НастройкиПользователя.Provider_ApiKey,
	|	НастройкиПользователя.Provider_Type,
	|	НастройкиПользователя.Токен,
	|	НастройкиПользователя.ОкончаниеТокена,
	|	НастройкиПользователя.АвторизационныеДанные,
	|	НастройкиПользователя.Scope
	|ИЗ
	|	РегистрСведений.ИИА_НастройкиПользователей КАК НастройкиПользователя
	|ГДЕ
	|	НастройкиПользователя.Пользователь = &Пользователь";
	
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат Результат;
	КонецЕсли;
	
	Выборка = РезультатЗапроса.Выбрать();
	Выборка.Следующий();
	
	Результат.РежимПодключения = Выборка.РежимПодключения;
	Результат.Gitsell_Endpoint = Выборка.Gitsell_Endpoint;
	Результат.Gitsell_AccessToken = Выборка.Gitsell_AccessToken;
	Результат.Вставить("Provider_BaseUrl", Выборка.Provider_BaseUrl);
	Результат.Вставить("Provider_ApiKey", Выборка.Provider_ApiKey);
	Результат.Вставить("Provider_Type", Выборка.Provider_Type);
	Результат.Вставить("Токен", Выборка.Токен);
	Результат.Вставить("ОкончаниеТокена", Выборка.ОкончаниеТокена);
	Результат.Вставить("АвторизационныеДанные", Выборка.АвторизационныеДанные);
	Результат.Вставить("Scope", Выборка.Scope);
	
	Возврат Результат;
	
КонецФункции

// Функции для работы с Гигачат перенесены в модуль ИИА_Гигачат

// Находит активный диалог пользователя или создает новый
//
// Параметры:
//  Пользователь - СправочникСсылка.Пользователи - пользователь
//
// Возвращаемое значение:
//  СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Функция НайтиИлиСоздатьДиалогПользователя(Пользователь) Экспорт
	
	// Ищем активный диалог
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Диалоги.Ссылка
	|ИЗ
	|	Справочник.ИИА_Диалоги КАК Диалоги
	|ГДЕ
	|	Диалоги.Пользователь = &Пользователь
	|	И Диалоги.Активный = ИСТИНА
	|УПОРЯДОЧИТЬ ПО
	|	Диалоги.ДатаСоздания УБЫВ";
	
	Запрос.УстановитьПараметр("Пользователь", Пользователь);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если НЕ РезультатЗапроса.Пустой() Тогда
		Выборка = РезультатЗапроса.Выбрать();
		Выборка.Следующий();
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
	// Создаем новый диалог
	НовыйДиалог = Справочники.ИИА_Диалоги.СоздатьЭлемент();
	НовыйДиалог.Пользователь = Пользователь;
	НовыйДиалог.Имя = "Диалог ИИ от " + Формат(ТекущаяДата(), "ДФ=dd.MM.yyyy HH:mm:ss");
	НовыйДиалог.ДатаСоздания = ТекущаяДата();
	НовыйДиалог.Активный = Истина;
	НовыйДиалог.Записать();
	
	Возврат НовыйДиалог.Ссылка;
	
КонецФункции

// Получает сообщения диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Количество - Число - количество последних сообщений
//
// Возвращаемое значение:
//  Массив - массив структур с сообщениями
//
Функция ПолучитьСообщенияДиалога(СсылкаДиалога, Количество = 50) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	МассивСообщений = Новый Массив;
	
	ИндексНачала = Макс(0, Диалог.Сообщения.Количество() - Количество);
	
	Для Индекс = ИндексНачала По Диалог.Сообщения.Количество() - 1 Цикл
		
		Строка = Диалог.Сообщения[Индекс];
		
		СтруктураСообщения = Новый Структура;
		СтруктураСообщения.Вставить("Время", Строка.Время);
		СтруктураСообщения.Вставить("Автор", Строка.Автор);
		СтруктураСообщения.Вставить("ТипСообщения", Строка.ТипСообщения);
		СтруктураСообщения.Вставить("Текст", Строка.Текст);
		СтруктураСообщения.Вставить("ТекстКода", Строка.ТекстКода);
		СтруктураСообщения.Вставить("Статус", Строка.Статус);
		СтруктураСообщения.Вставить("UsageTokens", Строка.UsageTokens);
		
		МассивСообщений.Добавить(СтруктураСообщения);
		
	КонецЦикла;
	
	Возврат МассивСообщений;
	
КонецФункции

// Добавляет сообщение в диалог
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Автор - ПеречислениеСсылка.ИИА_АвторСообщения - автор сообщения
//  ТипСообщения - ПеречислениеСсылка.ИИА_ТипСообщения - тип сообщения
//  Текст - Строка - текст сообщения
//  ТекстКода - Строка - текст кода (для запросов)
//  Статус - Строка - статус сообщения
//  UsageTokens - Число - количество использованных токенов
//
Процедура ДобавитьСообщениеВДиалог(СсылкаДиалога, Автор, ТипСообщения, Текст, ТекстКода = "", Статус = "", UsageTokens = 0, СтатусDSL = Неопределено) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	НоваяСтрока = Диалог.Сообщения.Добавить();
	НоваяСтрока.Время = ТекущаяДата();
	НоваяСтрока.Автор = Автор;
	НоваяСтрока.ТипСообщения = ТипСообщения;
	НоваяСтрока.Текст = Текст;
	НоваяСтрока.ТекстКода = ТекстКода;
	НоваяСтрока.Статус = Статус;
	НоваяСтрока.UsageTokens = UsageTokens;
	
	// Устанавливаем статус DSL
	Если СтатусDSL = Неопределено Тогда
		// Если есть ТекстКода и это DSL, устанавливаем "ВОчереди", иначе "НеПрименяется"
		Если НЕ ПустаяСтрока(ТекстКода) И ТипСообщения = Перечисления.ИИА_ТипСообщения.Код Тогда
			НоваяСтрока.СтатусDSL = Перечисления.ИИА_СтатусDSL.ВОчереди;
		Иначе
			НоваяСтрока.СтатусDSL = Перечисления.ИИА_СтатусDSL.НеПрименяется;
		КонецЕсли;
	Иначе
		НоваяСтрока.СтатусDSL = СтатусDSL;
	КонецЕсли;
	
	Диалог.Записать();
	
КонецПроцедуры

// Функции для вызова ИИ перенесены в модуль ИИА_Провайдеры
// Функции для работы с Гигачат перенесены в модуль ИИА_Гигачат

// Функции ПолучитьМетаданныеДляИИ, СформироватьПромптДляИИ, РаспознатьОтветИИ перенесены в модуль ИИА_Провайдеры

// Функция ИсправитьDSLЧерезИИ перенесена в модуль ИИА_Провайдеры

// Получает пример DSL-сценария (заглушка для демонстрации)
//
// Параметры:
//  ТекстПользователя - Строка - текст команды пользователя
//
// Возвращаемое значение:
//  Строка - JSON с DSL-сценарием
//
Функция ПолучитьПримерDSLСценария(ТекстПользователя)
	
	// Это заглушка - в реальной реализации ИИ должен генерировать DSL на основе команды пользователя
	// и метаданных конфигурации
	
	ПримерСценария = Новый Структура;
	ПримерСценария.Вставить("dsl_version", 1);
	
	Шаги = Новый Массив;
	
	// Пример: создание элемента справочника
	Если СтрНайти(ВРег(ТекстПользователя), "КОНТРАГЕНТ") > 0 Тогда
		
		Шаг1 = Новый Структура;
		Шаг1.Вставить("action", "CreateReference");
		Шаг1.Вставить("object_name", "Контрагенты");
		Шаги.Добавить(Шаг1);
		
		Шаг2 = Новый Структура;
		Шаг2.Вставить("action", "SetField");
		Шаг2.Вставить("field", "Наименование");
		Шаг2.Вставить("value", "Новый контрагент");
		Шаги.Добавить(Шаг2);
		
		Шаг3 = Новый Структура;
		Шаг3.Вставить("action", "Write");
		Шаги.Добавить(Шаг3);
		
	Иначе
		
		// Общий пример
		Шаг1 = Новый Структура;
		Шаг1.Вставить("action", "ShowInfo");
		Шаг1.Вставить("message", "Пример DSL-сценария. Настройте ИИ для генерации реальных сценариев.");
		Шаги.Добавить(Шаг1);
		
	КонецЕсли;
	
	ПримерСценария.Вставить("steps", Шаги);
	
	// Преобразуем в JSON
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ПримерСценария);
	JSONСтрока = ЗаписьJSON.Закрыть();
	
	Возврат JSONСтрока;
	
КонецФункции

// Отправляет сообщение и получает ответ от ИИ
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  ТипСообщения - Строка - тип сообщения ("Чат" или "Запрос")
//  ТекстПользователя - Строка - текст от пользователя
//
// Возвращаемое значение:
//  Структура - структура ответа от ВызватьИИ
//
Функция ОтправитьСообщениеСервера(СсылкаДиалога, ТипСообщения, ТекстПользователя) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Пользователь = Диалог.Пользователь;
	
	// Получаем настройки пользователя
	Настройки = ПолучитьНастройкиПользователя(Пользователь);
	Настройки.Вставить("Пользователь", Пользователь);
	
	// Загружаем историю диалога
	МассивИстории = ПолучитьСообщенияДиалога(СсылкаДиалога, 10);
	
	// Преобразуем массив в таблицу значений для функции ВызватьИИ
	История = Новый ТаблицаЗначений;
	История.Колонки.Добавить("Время", Новый ОписаниеТипов("Дата"));
	История.Колонки.Добавить("Автор", Новый ОписаниеТипов("ПеречислениеСсылка.ИИА_АвторСообщения"));
	История.Колонки.Добавить("ТипСообщения", Новый ОписаниеТипов("ПеречислениеСсылка.ИИА_ТипСообщения"));
	История.Колонки.Добавить("Текст", Новый ОписаниеТипов("Строка"));
	История.Колонки.Добавить("ТекстКода", Новый ОписаниеТипов("Строка"));
	
	Для Каждого СтруктураСообщения Из МассивИстории Цикл
		
		НоваяСтрока = История.Добавить();
		НоваяСтрока.Время = СтруктураСообщения.Время;
		НоваяСтрока.Автор = СтруктураСообщения.Автор;
		НоваяСтрока.ТипСообщения = СтруктураСообщения.ТипСообщения;
		НоваяСтрока.Текст = СтруктураСообщения.Текст;
		
	КонецЦикла;
	
	// Определяем тип сообщения для хранения
	Если ТипСообщения = "Запрос" Тогда
		ТипСообщенияДляХранения = Перечисления.ИИА_ТипСообщения.Запрос;
	Иначе
		ТипСообщенияДляХранения = Перечисления.ИИА_ТипСообщения.Текст;
	КонецЕсли;
	
	// Добавляем сообщение пользователя
	ДобавитьСообщениеВДиалог(
		СсылкаДиалога,
		Перечисления.ИИА_АвторСообщения.Пользователь,
		ТипСообщенияДляХранения,
		ТекстПользователя
	);
	
	// Вызываем ИИ
	ОтветИИ = ИИА_Провайдеры.ВызватьИИ(ТипСообщения, ТекстПользователя, История, Настройки);
	
	// Определяем тип ответа для хранения
	Если ОтветИИ.ТипОтвета = "Запрос" Тогда
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Запрос;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = ОтветИИ.Запрос;
	ИначеЕсли ОтветИИ.ТипОтвета = "DSL" Тогда
		// Обрабатываем DSL-сценарий
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Код;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = ОтветИИ.DSL;
		
	Иначе
		ТипСообщенияОтвета = Перечисления.ИИА_ТипСообщения.Текст;
		ТекстОтвета = ОтветИИ.Текст;
		ТекстКодаОтвета = "";
	КонецЕсли;
	
	// Получаем UsageTokens
	UsageTokens = 0;
	Если ОтветИИ.Свойство("Usage") И ОтветИИ.Usage <> Неопределено Тогда
		Если ТипЗнч(ОтветИИ.Usage) = Тип("Структура") И ОтветИИ.Usage.Свойство("TotalTokens") Тогда
			UsageTokens = ОтветИИ.Usage.TotalTokens;
		КонецЕсли;
	КонецЕсли;
	
	// Определяем статус DSL для сообщения (пока ставим "ВОчереди", потом обновим после выполнения)
	СтатусDSLСообщения = Неопределено;
	Если ОтветИИ.ТипОтвета = "DSL" И НЕ ПустаяСтрока(ТекстКодаОтвета) Тогда
		СтатусDSLСообщения = Перечисления.ИИА_СтатусDSL.ВОчереди;
	КонецЕсли;
	
	// Сначала добавляем ответ ИИ
	ДобавитьСообщениеВДиалог(
		СсылкаДиалога,
		Перечисления.ИИА_АвторСообщения.ИИ,
		ТипСообщенияОтвета,
		ТекстОтвета,
		ТекстКодаОтвета,
		"",
		UsageTokens,
		СтатусDSLСообщения
	);
	
	// Теперь обрабатываем DSL-сценарий (если это DSL)
	Если ОтветИИ.ТипОтвета = "DSL" И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
		
		// Выполняем DSL
		РезультатDSL = ВыполнитьDSLСценарий(ОтветИИ.DSL);
		
		// Обновляем статус DSL в сообщении
		Если РезультатDSL.Успех Тогда
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанУспешно);
			
			// Добавляем системное сообщение об успешном выполнении
			ТекстСистемногоСообщения = "DSL-сценарий выполнен успешно.";
			
			// Добавляем информацию о результатах шагов
			Если РезультатDSL.Результаты.Количество() > 0 Тогда
				Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
					ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "- " + РезультатШага.Сообщение;
				КонецЦикла;
			КонецЕсли;
			
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Текст,
				ТекстСистемногоСообщения,
				"",
				"",
				0
			);
			
			// Добавляем системное сообщение со ссылками на созданные/измененные объекты
			Если РезультатDSL.Свойство("СсылкиОбъектов") Тогда
				МассивСсылок = РезультатDSL.СсылкиОбъектов;
				Если МассивСсылок.Количество() > 0 Тогда
					Попытка
						
						ТекстСсылок = "";
						
						// Формируем текст с гиперссылками
						Если МассивСсылок.Количество() = 1 Тогда
							СсылкаОбъекта = МассивСсылок[0];
							ТекстСсылок = "Объект: " + СсылкаОбъекта;
						Иначе
							ТекстСсылок = "Создано/изменено объектов: " + Формат(МассивСсылок.Количество(), "ЧН=0");
							Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
								ТекстСсылок = ТекстСсылок + Символы.ПС + "- " + СсылкаОбъекта;
							КонецЦикла;
						КонецЕсли;
						
						ДобавитьСообщениеВДиалог(
							СсылкаДиалога,
							Перечисления.ИИА_АвторСообщения.Система,
							Перечисления.ИИА_ТипСообщения.Текст,
							ТекстСсылок,
							"",
							"",
							0
						);
						
					Исключение
						// Если не удалось добавить ссылки, добавляем сообщение об ошибке для отладки
						ДобавитьСообщениеВДиалог(
							СсылкаДиалога,
							Перечисления.ИИА_АвторСообщения.Система,
							Перечисления.ИИА_ТипСообщения.Ошибка,
							"Ошибка при формировании сообщения со ссылками: " + ОписаниеОшибки(),
							"",
							"",
							0
						);
					КонецПопытки;
				КонецЕсли;
			КонецЕсли;
			
		Иначе
			// Обновляем статус DSL на "ОбработанСОшибкой"
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанСОшибкой);
			
			// Добавляем системное сообщение об ошибке
			ТекстОшибки = "Ошибка выполнения DSL: " + РезультатDSL.Сообщение;
			
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Ошибка,
				ТекстОшибки,
				"",
				"",
				0
			);
			
			// Пытаемся исправить ошибку через ИИ (максимум 5 попыток)
			ВыполнитьПопыткиИсправленияDSL(ОтветИИ.DSL, РезультатDSL.Сообщение, Настройки, СсылкаДиалога, 1, 5);
			
		КонецЕсли;
		
	КонецЕсли;
	
	// Если есть ТекстКода, добавляем системное сообщение о получении кода (только для не-DSL типов)
	Если НЕ ПустаяСтрока(ТекстКодаОтвета) И ОтветИИ.ТипОтвета <> "DSL" Тогда
		
		// Определяем текст системного сообщения в зависимости от типа
		Если ОтветИИ.ТипОтвета = "Запрос" Тогда
			ТекстСистемногоСообщения = "Запрос сгенерирован.";
		Иначе
			ТекстСистемногоСообщения = "ИИ сгенерировал код.";
		КонецЕсли;
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			ТекстСистемногоСообщения,
			"",
			"",
			0
		);
		
	КонецЕсли;
	
	Возврат ОтветИИ;
	
КонецФункции

// Проверяет запрос 1С на выполнимость
//
// Параметры:
//  ТекстЗапроса - Строка - текст запроса
//
// Возвращаемое значение:
//  Структура - структура результата:
//   * Успех - Булево - успешность выполнения
//   * Сообщение - Строка - текст ошибки или пусто
//
Функция ПроверитьЗапрос(ТекстЗапроса) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	
	Попытка
		
		Запрос = Новый Запрос(ТекстЗапроса);
		Запрос.Выполнить();
		
		Результат.Успех = Истина;
		
	Исключение
		
		Результат.Сообщение = ОписаниеОшибки();
		
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Выполняет DSL сценарий
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата выполнения DSL
//
Функция ВыполнитьDSLСценарий(DSLJSON) Экспорт
	
	Возврат ИИА_DSL.ВыполнитьDSL(DSLJSON);
	
КонецФункции

// Выполняет DSL-сценарий и добавляет системные сообщения в диалог
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата выполнения DSL
//
Функция ВыполнитьDSLСценарийССообщениями(СсылкаДиалога, DSLJSON) Экспорт
	
	// Выполняем DSL
	РезультатDSL = ИИА_DSL.ВыполнитьDSL(DSLJSON);
	
	Если РезультатDSL.Успех Тогда
		
		// Добавляем системное сообщение об успешном выполнении
		ТекстСистемногоСообщения = "DSL-сценарий выполнен успешно.";
		
		// Добавляем информацию о результатах шагов
		Если РезультатDSL.Результаты.Количество() > 0 Тогда
			Для Каждого РезультатШага Из РезультатDSL.Результаты Цикл
				ТекстСистемногоСообщения = ТекстСистемногоСообщения + Символы.ПС + "- " + РезультатШага.Сообщение;
			КонецЦикла;
		КонецЕсли;
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			ТекстСистемногоСообщения,
			"",
			"",
			0
		);
		
		// Добавляем системное сообщение со ссылками на созданные/измененные объекты
		Если РезультатDSL.Свойство("СсылкиОбъектов") Тогда
			МассивСсылок = РезультатDSL.СсылкиОбъектов;
			Если МассивСсылок.Количество() > 0 Тогда
				Попытка
					
					ТекстСсылок = "";
					
					// Формируем текст с гиперссылками
					Если МассивСсылок.Количество() = 1 Тогда
						СсылкаОбъекта = МассивСсылок[0];
						ТекстСсылок = "Объект: " + СсылкаОбъекта;
					Иначе
						ТекстСсылок = "Создано/изменено объектов: " + Формат(МассивСсылок.Количество(), "ЧН=0");
						Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
							ТекстСсылок = ТекстСсылок + Символы.ПС + "- " + СсылкаОбъекта;
						КонецЦикла;
					КонецЕсли;
					
					ДобавитьСообщениеВДиалог(
						СсылкаДиалога,
						Перечисления.ИИА_АвторСообщения.Система,
						Перечисления.ИИА_ТипСообщения.Текст,
						ТекстСсылок,
						"",
						"",
						0
					);
					
				Исключение
					// Если не удалось добавить ссылки, добавляем сообщение об ошибке для отладки
					ДобавитьСообщениеВДиалог(
						СсылкаДиалога,
						Перечисления.ИИА_АвторСообщения.Система,
						Перечисления.ИИА_ТипСообщения.Ошибка,
						"Ошибка при формировании сообщения со ссылками: " + ОписаниеОшибки(),
						"",
						"",
						0
					);
				КонецПопытки;
			КонецЕсли;
		КонецЕсли;
		
	Иначе
		
		// Добавляем системное сообщение об ошибке
		ТекстОшибки = "Ошибка выполнения DSL: " + РезультатDSL.Сообщение;
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Ошибка,
			ТекстОшибки,
			"",
			"",
			0
		);
		
	КонецЕсли;
	
	Возврат РезультатDSL;
	
КонецФункции

// Проверяет DSL сценарий
//
// Параметры:
//  DSLJSON - Строка - JSON с DSL командами
//
// Возвращаемое значение:
//  Структура - структура результата проверки DSL
//
Функция ПроверитьDSLСценарий(DSLJSON) Экспорт
	
	Возврат ИИА_DSL.ПроверитьDSL(DSLJSON);
	
КонецФункции

// Обновляет статус DSL в последнем сообщении диалога
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  НовыйСтатус - ПеречислениеСсылка.ИИА_СтатусDSL - новый статус DSL
//
Процедура ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, НовыйСтатус)
	
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Находим последнее сообщение с DSL (тип Код)
		Если Диалог.Сообщения.Количество() > 0 Тогда
			
			// Ищем последнее сообщение с типом "Код" (DSL), начиная с конца
			Индекс = Диалог.Сообщения.Количество() - 1;
			Пока Индекс >= 0 Цикл
				
				СтрокаСообщения = Диалог.Сообщения[Индекс];
				
				Если СтрокаСообщения.ТипСообщения = Перечисления.ИИА_ТипСообщения.Код И НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
					
					СтрокаСообщения.СтатусDSL = НовыйСтатус;
					Диалог.Записать();
					
					Прервать;
					
				КонецЕсли;
				
				Индекс = Индекс - 1;
				
			КонецЦикла;
			
		КонецЕсли;
		
	Исключение
		// Игнорируем ошибки обновления статуса
	КонецПопытки;
	
КонецПроцедуры

// Выполняет попытки исправления DSL с рекурсивной логикой
//
// Параметры:
//  DSLJSON - Строка - исходный DSL-сценарий с ошибкой
//  ТекстОшибки - Строка - текст ошибки выполнения
//  Настройки - Структура - настройки пользователя
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  НомерПопытки - Число - номер текущей попытки исправления
//  МаксимальноеКоличествоПопыток - Число - максимальное количество попыток исправления
//
Процедура ВыполнитьПопыткиИсправленияDSL(DSLJSON, ТекстОшибки, Настройки, СсылкаДиалога, НомерПопытки, МаксимальноеКоличествоПопыток)
	
	// Пытаемся исправить ошибку через ИИ
	РезультатКоррекции = ИИА_Провайдеры.ИсправитьDSLЧерезИИ(DSLJSON, ТекстОшибки, Настройки, НомерПопытки, МаксимальноеКоличествоПопыток);
	
	Если РезультатКоррекции.Успех Тогда
		
		// Обновляем статус на "Исправляется"
		ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.Исправляется);
		
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			"Получен исправленный DSL-сценарий от ИИ (попытка " + Формат(НомерПопытки, "ЧН=0") + "). Выполняю повторно...",
			"",
			"",
			0
		);
		
		// Выполняем исправленный DSL-сценарий
		РезультатИсправленногоDSL = ВыполнитьDSLСценарий(РезультатКоррекции.ИсправленныйDSL);
		
		Если РезультатИсправленногоDSL.Успех Тогда
			// Обновляем статус на "ОбработанУспешно"
			ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанУспешно);
			
			// Добавляем системное сообщение об успешном выполнении исправленного сценария
			ТекстУспеха = "Исправленный DSL-сценарий выполнен успешно (попытка " + Формат(НомерПопытки, "ЧН=0") + ").";
			
			// Добавляем информацию о результатах шагов
			Если РезультатИсправленногоDSL.Результаты.Количество() > 0 Тогда
				Для Каждого РезультатШага Из РезультатИсправленногоDSL.Результаты Цикл
					ТекстУспеха = ТекстУспеха + Символы.ПС + "- " + РезультатШага.Сообщение;
				КонецЦикла;
			КонецЕсли;
			
			ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Текст,
				ТекстУспеха,
				"",
				"",
				0
			);
			
			// Добавляем системное сообщение со ссылками на созданные/измененные объекты
			Если РезультатИсправленногоDSL.Свойство("СсылкиОбъектов") И РезультатИсправленногоDSL.СсылкиОбъектов.Количество() > 0 Тогда
				Попытка
					
					МассивСсылок = РезультатИсправленногоDSL.СсылкиОбъектов;
					ТекстСсылок = "";
					
					// Формируем текст с гиперссылками
					Если МассивСсылок.Количество() = 1 Тогда
						СсылкаОбъекта = МассивСсылок[0];
						ТекстСсылок = "Объект: " + СсылкаОбъекта;
					Иначе
						ТекстСсылок = "Создано/изменено объектов: " + Формат(МассивСсылок.Количество(), "ЧН=0");
						Для Каждого СсылкаОбъекта Из МассивСсылок Цикл
							ТекстСсылок = ТекстСсылок + Символы.ПС + "- " + СсылкаОбъекта;
						КонецЦикла;
					КонецЕсли;
					
					ДобавитьСообщениеВДиалог(
						СсылкаДиалога,
						Перечисления.ИИА_АвторСообщения.Система,
						Перечисления.ИИА_ТипСообщения.Текст,
						ТекстСсылок,
						"",
						"",
						0
					);
					
				Исключение
					// Если не удалось добавить ссылки, просто игнорируем
				КонецПопытки;
			КонецЕсли;
			
		Иначе
			// Если исправленный DSL не выполнился, проверяем, можем ли мы попробовать еще раз
			Если НомерПопытки < МаксимальноеКоличествоПопыток Тогда
				// Обновляем статус на "ОбработанСОшибкой" перед следующей попыткой
				ОбновитьСтатусDSLВПоследнемСообщении(СсылкаДиалога, Перечисления.ИИА_СтатусDSL.ОбработанСОшибкой);
				// Рекурсивно вызываем функцию для следующей попытки
				ВыполнитьПопыткиИсправленияDSL(РезультатКоррекции.ИсправленныйDSL, РезультатИсправленногоDSL.Сообщение, Настройки, СсылкаДиалога, НомерПопытки + 1, МаксимальноеКоличествоПопыток);
			Иначе
				// Достигнут лимит попыток
				ДобавитьСообщениеВДиалог(
					СсылкаДиалога,
					Перечисления.ИИА_АвторСообщения.Система,
					Перечисления.ИИА_ТипСообщения.Ошибка,
					"Исправленный DSL-сценарий (попытка " + Формат(НомерПопытки, "ЧН=0") + ") также завершился с ошибкой: " + РезультатИсправленногоDSL.Сообщение + Символы.ПС + "Достигнут лимит попыток исправления (" + Формат(МаксимальноеКоличествоПопыток, "ЧН=0") + ").",
					"",
					"",
					0
				);
			КонецЕсли;
		КонецЕсли;
		
	Иначе
		// Если не удалось получить исправленный DSL от ИИ или достигнут лимит
		ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Ошибка,
			"Не удалось получить исправленный DSL от ИИ (попытка " + Формат(НомерПопытки, "ЧН=0") + "): " + РезультатКоррекции.Сообщение,
			"",
			"",
			0
		);
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти


