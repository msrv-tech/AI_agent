# Процесс работы Агента: RAG, Оркестрация и Самоисправление

В данном документе описана полная логика работы ИИ-агента 1С: от получения запроса и поиска метаданных до выполнения DSL и обработки ошибок.

## Блок-схема процесса (Полный цикл)

```mermaid
graph TD
    subgraph "1. Подготовка (RAG)"
    A[Запрос пользователя] --> B{ИИА_Промты: СформироватьКонтекстRAG}
    B --> C[ИИА_Сервер: ИзвлечьСущностиДляRAG]
    C --> D[Вызов LLM: Экстрактор]
    D --> E{Сущности найдены?}
    E -- Да --> F[Поиск по сущностям]
    E -- Нет --> G[Поиск по всему тексту]
    F --> H[ИИА_RAG_Поиск: BM25-lite]
    G --> H
    H --> K[Блок ПОДСКАЗКА ПО МЕТАДАННЫМ]
    end

    subgraph "2. Оркестрация (Двухфазная)"
    K --> L[ИИА_Сервер: СгенерироватьПродолжение]
    L --> M[ФАЗА 1: Обновление плана]
    M --> N{Все выполнено?}
    N -- Да --> O[Резюме пользователю]
    N -- Нет --> P[ФАЗА 2: Генерация шага DSL]
    end

    subgraph "3. Выполнение и Исправление"
    P --> Q[ИИА_DSL: ВыполнитьDSL]
    Q -- Успех --> M
    Q -- Ошибка --> R{Механизм исправления}
    R --> S[Discovery Push: Справка и советы]
    S --> T[ИсправитьDSLЧерезИИ: Анализ попыток]
    T --> P
    end
```

## Описание этапов

### 1. Подготовка контекста (RAG)
Система использует двухэтапный поиск для минимизации галлюцинаций в именах метаданных.
- **Экстракция сущностей:** Быстрый вызов LLM для выделения имен объектов (например, "Реализация товаров").
- **BM25-lite Поиск:** Поиск в локальном индексе с учетом весов типов (Документы > Справочники) и штрафов для технических таблиц.
- **Защита от рекурсии:** При работе RAG-экстрактора контекст RAG отключается (`БезRAG=Истина`).

### 2. Двухфазная оркестрация
Для стабильности планирование отделено от исполнения:
- **Фаза 1 (Updater):** Анализирует историю и обновляет статусы пунктов плана (`Выполнена`, `Результат`). Если всё готово — вызывает генерацию финального резюме.
- **Фаза 2 (Executor):** Генерирует DSL-код **только для одного** следующего невыполненного шага.

### 3. Механизм самоисправления (Self-Healing)
Если DSL-команда завершилась ошибкой, агент не останавливается, а пробует исправиться:

#### Discovery Push (Активные подсказки)
- **Ошибки запросов:** В промпт автоматически подмешивается полная справка по синтаксису запросов 1С.
- **Поле не найдено:** Система советует агенту выполнить `GetObjectFields` для уточнения структуры.
- **Детектор циклов:** Если агент более 2-х раз запрашивает одни и те же метаданные, он получает жесткое предупреждение о необходимости перейти к действиям.

#### Исправление через контекст попыток
Функция `ИсправитьDSLЧерезИИ` выполняет:
- **Анализ истории:** Собирает все неудачные имена объектов, которые агент уже пробовал.
- **Подбор альтернатив:** Использует нечеткий поиск (`НайтиПохожиеОбъекты`) для предложения правильных имен.
- **Запрет повторов:** Прямо указывает модели: *"Ты уже пробовал X, Y, Z — они не существуют. Используй A или B"*.

## Преимущества архитектуры
1. **Надежность:** Разделение фаз исключает бесконечные циклы "одного действия".
2. **Автономность:** Агент способен сам исправить синтаксические ошибки или неверные имена полей без участия пользователя.
3. **Прозрачность:** Каждый этап (RAG, обновление плана, выполнение DSL) логируется в `run_log.txt` и историю диалога.
