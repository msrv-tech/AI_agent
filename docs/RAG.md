# RAG (Retrieval-Augmented Generation)

RAG-система обеспечивает семантический поиск по метаданным конфигурации 1С. Найденные объекты и поля подставляются в промпт как подсказка для LLM.

## Модули

| Модуль | Назначение |
|--------|------------|
| **ИИА_RAG_Индексатор** | Построение индекса метаданных (чанки, токены, статистика) |
| **ИИА_RAG_Поиск** | Выполнение поиска по запросу пользователя |
| **ИИА_RAG_Текст** | Нормализация, токенизация текста |
| **ИИА_RAG_Настройки** | Стоп-слова, синонимы, расширяющие ключи |

## Регистры сведений

| Регистр | Назначение |
|---------|------------|
| **ИИА_Чанки** | Текстовые чанки метаданных (тип, имя, синоним, путь, вид, текст) |
| **ИИА_ТокенИндекс** | Связь токенов с чанками (для TF-IDF) |
| **ИИА_ТокенСтатистика** | Document Frequency (DF) для расчёта IDF |
| **ИИА_СтатусИндексаRAG** | Дата сборки, версия конфигурации |

## Индексация

`ИИА_RAG_Индексатор.ПерестроитьИндекс()`:

1. Очистка старых данных
2. Обход метаданных: Документы, Справочники, Регистры накопления, Регистры сведений, Перечисления
3. Для каждого объекта создаются чанки:
   - **header** — тип, имя, синоним, расширяющие ключи
   - **attrs** — реквизиты (имя, синоним)
   - **tab** — табличные части и их реквизиты
4. Токенизация с учётом стоп-слов
5. Расчёт DF (Document Frequency), запись статистики
6. Обновление статуса индекса

## Поиск

`ИИА_RAG_Поиск.ВыполнитьПоиск(Запрос, Лимит, КонтекстПоиска, СсылкаДиалога)`:

1. Нормализация запроса, токенизация
2. Фильтрация стоп-слов, применение синонимов
3. Поиск кандидатов в индексе по токенам
4. Ранжирование по TF-IDF
5. Возврат топ-N результатов с ключами чанков

`ПолучитьКонтекст(КлючЧанка)` — извлечение полного текста чанка по ключу.

## Интеграция в промпт

- **Точка вызова:** `ИИА_Промты.СформироватьКонтекстRAG(ТекстЗапроса, СсылкаДиалога)`
- **Извлечение сущностей:** `ИИА_Сервер.ИзвлечьСущностиДляRAG()` — выделение имён объектов из запроса для уточнения поиска
- **Формат в промпте:** блок `ПОДСКАЗКА ПО МЕТАДАННЫМ (RAG):` с найденными объектами и полями
- **Правила для LLM:** приоритет объектам и полям из RAG; если RAG дал подсказку — не дублировать CheckObjectExists/GetObjectFields

RAG включён по умолчанию для диалогов типа «Работа с данными 1С». Используется также в `ИИА_Метаданные.НайтиПохожиеОбъекты()` вместо расстояния Левенштейна при наличии индекса.
