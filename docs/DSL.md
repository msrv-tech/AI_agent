# Domain Specific Language (DSL)

DSL — это язык команд в формате JSON, который ИИ-агент использует для выполнения действий в среде 1С:Предприятие.

## Структура сценария

Сценарий представляет собой JSON-объект с массивом шагов `steps`.

```json
{
  "steps": [
    {
      "action": "Действие1",
      "параметр": "значение"
    },
    {
      "action": "Действие2",
      "параметр": "значение"
    }
  ]
}
```

## Основные действия

### Чтение данных

| Действие | Параметры | Описание |
|----------|-----------|----------|
| **GetMetadata** | `filter` (опц.) | Получает списки объектов метаданных (справочники, документы, регистры). |
| **GetObjectFields** | `object_type`, `object_name` | Возвращает список реквизитов и табличных частей объекта. |
| **CheckObjectExists** | `object_type`, `object_name` | Проверяет существование объекта в метаданных. |
| **RunQuery** | `query` | Выполняет произвольный запрос на языке запросов 1С. |
| **FindReferenceByName**| `object_name`, `name` | Ищет ссылку в справочнике по наименованию. |
| **FindReferenceByGUID**| `guid` | Находит ссылку по уникальному идентификатору. |
| **SelectObject** | `reference` или `object_type`+`object_name`+`name` | Загружает объект в контекст для последующего изменения. |

### Изменение данных

| Действие | Параметры | Описание |
|----------|-----------|----------|
| **CreateReference** | `object_name`, `data` (опц.) | Создает новый элемент справочника. |
| **CreateDocument** | `object_name`, `data` (опц.) | Создает новый документ. |
| **SetField** | `field`, `value` | Устанавливает значение реквизита текущего объекта в контексте. |
| **Write** | — | Записывает текущий объект в базу данных. |

### Системные действия

| Действие | Параметры | Описание |
|----------|-----------|----------|
| **ShowInfo** | `message` | Выводит информационное сообщение пользователю. |
| **ForEach** | `collection`, `steps` | Цикл по коллекции (результату запроса или массиву ссылок). |
| **SaveToStorage** | `key`, `data` | Сохраняет данные во временное хранилище диалога. |
| **LoadFromStorage** | `key` | Загружает данные из хранилища. |

## Контекст и переменные

Результаты выполнения шагов сохраняются в контексте. Можно использовать значения из контекста в последующих шагах с помощью шаблона `#(ИмяПеременной)`.

Пример:
```json
{
  "steps": [
    {
      "action": "FindReferenceByName",
      "object_name": "Контрагенты",
      "name": "ООО Ромашка"
    },
    {
      "action": "CreateDocument",
      "object_name": "РеализацияТоваровУслуг",
      "data": {
        "Контрагент": "#(LastResult)"
      }
    }
  ]
}
```

## Особенности реализации

- **Нормализация:** Модуль `ИИА_DSL` автоматически исправляет типичные ошибки LLM (умные кавычки, `истина`/`ложь` вместо `true`/`false`, вложенные `args`/`params`).
- **Безопасность:** В режиме «Запрос1С» или при ограничении прав пользователя действия изменения (Write, SetField и др.) блокируются.
- **Автозапись:** Если объект был создан или изменен, но шаг `Write` не был вызван явно, оркестратор попытается выполнить запись автоматически в конце сценария.
