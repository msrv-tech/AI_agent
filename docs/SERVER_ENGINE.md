# Серверный движок

Серверный движок обеспечивает асинхронное выполнение агента в фоновом режиме с доставкой обновлений клиенту в реальном времени.

## Фоновые задания

Оркестратор запускается как фоновое задание платформы 1С:

- **Точка входа:** `ИИА_Оркестратор.Запустить(СсылкаДиалога)`
- **Реализация:** вызов `ФоновыеЗадания.Выполнить("ИИА_Оркестратор.ВыполнитьЦикл", Параметры, , ИмяЗадания)`
- **Имя задания:** `ИИ_Оркестратор_` + УникальныйИдентификатор диалога

Цикл `ВыполнитьЦикл` выполняет: планирование шагов через ИИ, выполнение DSL-сценария, проверку результата, генерацию summary. Защита от бесконечного цикла — лимит итераций (50) и лимит токенов на запуск.

## Механизм серверных уведомлений

Уведомления идут от сервера на клиент. Обновления из фонового задания доставляются клиенту через серверные уведомления (1С 8.3.26+):

- **Отправка:** `ИИА_Сервер.ОтправитьУведомлениеОбновленияДиалога()` — вызывается после каждой записи диалога
- **Из фонового задания:** уведомление передаётся родительскому сеансу для надёжной доставки
- **Подписка:** форма агента подключает обработчик уведомлений при открытии, отключает при закрытии
- **Типы уведомлений:** `НовоеСообщение`, `ПланЗавершен`, `ОстановленПользователем`, `ПревышенЛимитТокенов` и др.

## Общий модуль ИИА_Оркестратор

| Процедура/Функция | Назначение |
|-------------------|------------|
| `Запустить(СсылкаДиалога)` | Запуск серверного оркестратора (фоновое задание) |
| `ОтправитьИЗапустить(СсылкаДиалога, Текст, ТипДиалога)` | Добавление сообщения и запуск оркестратора |
| `Остановить(СсылкаДиалога)` | Мягкая остановка оркестратора |
| `ВыполнитьЦикл(СсылкаДиалога, НачальныеТокены)` | Основной цикл — планирование, выполнение DSL, проверка, summary |

Оркестратор не использует обработчики ожидания на клиенте — вся оркестрация идёт через серверные уведомления.
