#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Устанавливаем начальные значения
	ТекущийТипДиалога = Перечисления.ИИА_ТипДиалога.Агент;
	СтрокаСтатуса = "Готов к работе";
	ОркестраторРаботает = Ложь;
	Элементы.Отправить.Заголовок = "Отправить";
	Элементы.Отправить.ЦветФона = WebЦвета.СветлоЗеленый;
	ЛогСсылка = "Лог";
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Проверяем наличие настроек
	Если НЕ ЕстьНастройкиНаСервере() Тогда
		// Если настроек нет, открываем форму регистрации
		ОткрытьФорму("ОбщаяФорма.ИИА_РегистрацияGitsell");
		// Закрываем текущую форму агента, так как без настроек работать нельзя
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли;
	
	// Получаем или создаем диалог текущего пользователя
	ТекущийДиалог = ИИА_Клиент.НайтиИлиСоздатьДиалогПользователя();
	
	// Обновляем все элементы интерфейса
	ОбновитьОтображениеДиалога();
	ОбновитьОтображениеПлана();
	ОбновитьОтображениеРеквизитов();
	
	// Подключаем обработчик уведомлений (1С 8.3.26+)
	Обработчик = Новый ОписаниеОповещения("ПриПриемеСообщения", ЭтотОбъект);
	УведомленияКлиента.ПодключитьОбработчик("СообщениеПереписки", Обработчик);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	// Отключаем обработчик уведомлений
	УведомленияКлиента.ОтключитьОбработчик("СообщениеПереписки");
	
КонецПроцедуры

&НаСервере
Функция ЕстьНастройкиНаСервере()
	Возврат ИИА_GitsellСервер.ЕстьНастройкиПользователя();
КонецФункции

#КонецОбласти
&НаКлиенте
Процедура ЛогСсылкаНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		Сообщить("Диалог не выбран.");
		Возврат;
	КонецЕсли;
	
	// Принудительно загружаем актуальный лог из справочника
	ТекстЛога = ИИА_ВызовСервера.ПолучитьЛогДиалога(ТекущийДиалог);
	
	// Если лог пустой, проверим, может это новый диалог без лога или ошибка
	Если ПустаяСтрока(ТекстЛога) Тогда
		ОписаниеДиалога = ИИА_ВызовСервера.ПолучитьОписаниеДиалога(ТекущийДиалог);
		Сообщить("Лог диалога пуст. Текущий диалог: " + Строка(ТекущийДиалог.УникальныйИдентификатор()) + " | " + ОписаниеДиалога);
		Возврат;
	КонецЕсли;
	
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.УстановитьТекст(ТекстЛога);
	ТекстовыйДокумент.Показать("Лог диалога: " + Строка(ТекущийДиалог));
	
КонецПроцедуры

&НаКлиенте
Процедура ТекущийДиалогПриИзменении(Элемент)
	
	// Если диалог пустой, очищаем все
	Если ТекущийДиалог.Пустая() Тогда
		СтрокаСтатуса = "Выберите диалог";
		// Обновляем с пустым диалогом (очистит чат)
		ОбновитьОтображениеДиалога();
		ОбновитьОтображениеПлана();
		ОбновитьОтображениеРеквизитов();
		Возврат;
	КонецЕсли;
	
	// Останавливаем оркестратор при смене диалога, чтобы не смешивать контексты
	Если ОркестраторРаботает Тогда
		ОстановитьОркестратор();
	КонецЕсли;
	
	// Обновляем все элементы интерфейса
	ОбновитьОтображениеДиалога();
	ОбновитьОтображениеПлана();
	ОбновитьОтображениеРеквизитов();
	
	СтрокаСтатуса = "Диалог загружен";
	
КонецПроцедуры


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаОтправить(Команда)
	
	// Если оркестратор работает, останавливаем его
	Если ОркестраторРаботает Тогда
		Если ЗначениеЗаполнено(ТекущийДиалог) Тогда
			ИИА_ВызовСервера.ОркестраторОстановить(ТекущийДиалог);
		КонецЕсли;
		ОстановитьОркестратор();
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ТекущийТекст) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Запускаем оркестратор
	ЗапуститьОркестратор();
	
	// Устанавливаем статус "Отправка..."
	СтрокаСтатуса = "Отправка сообщения...";
	
	Попытка
		
		// Отправляем сообщение и запускаем оркестратор на сервере
		ИИА_ВызовСервера.ОркестраторОтправитьИЗапустить(
			ТекущийДиалог,
			ТекущийТекст,
			ТекущийТипДиалога
		);
		
		// Обновляем интерфейс
		ОбновитьОтображениеДиалога();
		ОбновитьОтображениеРеквизитов();
		
		// Очищаем поле ввода
		ТекущийТекст = "";
		
	Исключение
		
		СтрокаСтатуса = "Ошибка: " + ОписаниеОшибки();
		ОстановитьОркестратор();
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура НовыйДиалог(Команда)
	
	// Деактивируем текущий диалог (если есть)
	Если ТекущийДиалог <> Неопределено Тогда
		ИИА_ВызовСервера.ДеактивироватьДиалог(ТекущийДиалог);
	КонецЕсли;
	
	// Создаем новый диалог
	ТекущийДиалог = ИИА_Клиент.СоздатьНовыйДиалог();
	
	// Очищаем форму
	ТекущийТекст = "";
	
	// Обновляем интерфейс
	ОбновитьОтображениеДиалога();
	ОбновитьОтображениеПлана();
	
	// Устанавливаем начальные значения
	СтрокаСтатуса = "Создан новый диалог. Готов к работе";
	ОркестраторРаботает = Ложь;
	ОбновитьОтображениеРеквизитов();
	
КонецПроцедуры
#КонецОбласти

#Область ПроцедурыИФункцииКлиентскогоМодуля

&НаКлиенте
// Запускает оркестратор и обновляет интерфейс
Процедура ЗапуститьОркестратор()
	
	ОркестраторРаботает = Истина;
	ОбновитьОтображениеРеквизитов();
	
КонецПроцедуры

&НаКлиенте
// Останавливает оркестратор и обновляет интерфейс
Процедура ОстановитьОркестратор()
	
	ОркестраторРаботает = Ложь;
	ОтключитьОбработчикОжидания("СпланироватьСледующиеШаги");
	СтрокаСтатуса = "Оркестратор остановлен";
	ОбновитьОтображениеРеквизитов();
	
КонецПроцедуры

&НаКлиенте
// Подключает обработчик ожидания для планирования следующих шагов
Процедура ПодключитьОбработчикПланирования()
	ПодключитьОбработчикОжидания("СпланироватьСледующиеШаги", 2, Истина); // Выполнить один раз через 2 сек
КонецПроцедуры

&НаКлиенте
// Оркестратор процесса выполнения задачи с использованием планирования
Процедура СпланироватьСледующиеШаги()
	// Оркестрация перенесена на сервер, здесь шаги не выполняются
	Возврат;

КонецПроцедуры

&НаКлиенте
Процедура ПриПриемеСообщения(ДанныеСообщения, ДополнительныеПараметры = Неопределено) Экспорт
	
	// Проверяем, что уведомление относится к нашему диалогу
	Если ДанныеСообщения.Свойство("Диалог") И ДанныеСообщения.Диалог = ТекущийДиалог Тогда
		
		// 1. Обновляем диалог
		ОбновитьОтображениеДиалога();
		
		// 2. Обновляем план
		ОбновитьОтображениеПлана();
		
		// 3. Обновляем реквизиты
		ОбновитьОтображениеРеквизитов();
		
		// Обработка завершения или остановки
		Если ДанныеСообщения.Свойство("ТипСобытия") Тогда
			
			ТипСобытия = ДанныеСообщения.ТипСобытия;
			
			Если ТипСобытия = "ЗадачаЗавершена" ИЛИ ТипСобытия = "ОстановленПользователем" 
				ИЛИ ТипСобытия = "ОшибкаПлана" ИЛИ ТипСобытия = "ПревышенЛимитТокенов" Тогда
				
				ОстановитьОркестратор();
				
				ТекстСобытия = "Событие";
				Если ТипСобытия = "ЗадачаЗавершена" Тогда
					ТекстСобытия = ?(ДанныеСообщения.Свойство("Успех") И ДанныеСообщения.Успех, "Задача выполнена успешно", "Задача завершена с ошибкой");
				ИначеЕсли ТипСобытия = "ОстановленПользователем" Тогда
					ТекстСобытия = "Оркестратор остановлен";
				ИначеЕсли ТипСобытия = "ОшибкаПлана" Тогда
					ТекстСобытия = "Ошибка создания плана";
				ИначеЕсли ТипСобытия = "ПревышенЛимитТокенов" Тогда
					ТекстСобытия = "Превышен лимит токенов на запуск";
				КонецЕсли;
				
				СтрокаСтатуса = ТекстСобытия;
				Состояние("ИИ Агент: " + ТекстСобытия,, ТекстСобытия);
				
			Иначе
				
				// Оповещаем пользователя о прогрессе (опционально)
				ТекстПрогресса = "";
				Если ТипСобытия = "ПланИнициализирован" Тогда
					ТекстПрогресса = "План создан";
				ИначеЕсли ТипСобытия = "ШагВыполнен" Тогда
					ТекстПрогресса = "Шаг выполнен";
				ИначеЕсли ТипСобытия = "ЗапросПринят" Тогда
					ТекстПрогресса = "Запрос принят";
				КонецЕсли;
				
				Если НЕ ПустаяСтрока(ТекстПрогресса) Тогда
					СтрокаСтатуса = ТекстПрогресса + "...";
					Состояние("ИИ Агент: " + ТекстПрогресса,, ТекстПрогресса);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		// Если в процессе был выполнен RunQuery — покажем ТабличныйДокумент
		ПопытатьсяПоказатьТабличныйДокумент();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПопытатьсяПоказатьТабличныйДокумент(ЛогироватьПропуск = Ложь)
	
	Если ТекущийДиалог = Неопределено Или ТекущийДиалог.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		ДанныеДляТаблицы = ИИА_ВызовСервера.ПолучитьНепоказанныеДанныеЗапроса(ТекущийДиалог);
		Если ДанныеДляТаблицы = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		СоздатьИОткрытьТабличныйДокумент(ДанныеДляТаблицы);
	Исключение
		// Не скрываем ошибку: выводим пользователю
		Сообщить("Ошибка при получении данных запроса для ТабличногоДокумента: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеДиалога()
	ОбновитьСообщения();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеПлана()
	ОбновитьПланНаФорме();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеРеквизитов()
	
	ОбновитьПотреченоТокеновНаФорме();
	
	Если ОркестраторРаботает Тогда
		Элементы.Отправить.Заголовок = "Остановить";
		Элементы.Отправить.ЦветФона = WebЦвета.Кирпичный;
	Иначе
		Элементы.Отправить.Заголовок = "Отправить";
		Элементы.Отправить.ЦветФона = WebЦвета.СветлоЗеленый;
	КонецЕсли;
	
	Элементы.Отправить.Доступность = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПланНаФорме()
	ОбновитьПланНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОбновитьПланНаСервере()
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		ЭтотОбъект.ПланЗадач.Очистить();
		Возврат;
	КонецЕсли;
	
	ПланДанные = ИИА_Сервер.ПолучитьПланДиалога(ТекущийДиалог);
	
	// Предполагаем, что на форме есть таблица ПланЗадач, 
	// связанная с реквизитом типа ТаблицаЗначений (или ТабличнаяЧасть)
	ЭтотОбъект.ПланЗадач.Очистить();
	Для Каждого СтрокаПлана Из ПланДанные Цикл
		НоваяСтрока = ЭтотОбъект.ПланЗадач.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаПлана);
	КонецЦикла;
	
КонецПроцедуры

&НаКлиенте
// Обновляет список сообщений на форме
Процедура ОбновитьСообщения()
	
	НовыеСообщения = ИИА_Клиент.ЗагрузитьСообщенияДиалога(ТекущийДиалог);
	
	// Обновляем визуальный интерфейс чата (программно создаем элементы)
	ОбновитьИнтерфейсЧатаНаСервере(НовыеСообщения);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьИнтерфейсЧатаНаСервере(Сообщения)
	
	// 1. Очистка старых элементов и реквизитов
	ОчиститьЧат();
	РезюмеТекст = "";
	
	// 2. Подготовка новых реквизитов
	МассивДобавляемыхРеквизитов = Новый Массив;
	МассивТипаСтрока = Новый Массив;
	МассивТипаСтрока.Добавить(Тип("Строка"));
	ОписаниеТипаСтрока = Новый ОписаниеТипов(МассивТипаСтрока);
	
	Для Индекс = 0 По Сообщения.Количество() - 1 Цикл
		СтрокаСообщения = Сообщения[Индекс];
		
		// Пропускаем технические JSON-сообщения и системные результаты в интерфейсе агента
		ТекстСообщения = СтрокаСообщения.Текст;
		
		Если (СтрНайти(ТекстСообщения, """updated_plan"":") > 0 И СтрНайти(ТекстСообщения, """next_step_dsl"":") > 0)
			ИЛИ СтрНайти(ТекстСообщения, """kind"": ""dsl_system_result""") > 0 Тогда
			Продолжить;
		КонецЕсли;
		
		// Пропускаем служебные сообщения оркестратора
		Если СтрНайти(ТекстСообщения, "Следующий шаг выполнения по плану") > 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Префикс = "дин_msg_" + Формат(Индекс, "ЧГ=0");
		
		// Реквизит для текста сообщения
		МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Text", ОписаниеТипаСтрока, "", "Текст сообщения"));
		
		// Если есть код, реквизит для кода
		Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Code", ОписаниеТипаСтрока, "", "Код сообщения"));
		КонецЕсли;
		
		// Реквизит для статуса/заголовка
		МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Header", ОписаниеТипаСтрока, "", "Заголовок"));
	КонецЦикла;
	
	// Изменяем реквизиты формы
	ИзменитьРеквизиты(МассивДобавляемыхРеквизитов);
	
	// 3. Создание элементов и заполнение данными
	ГруппаЧат = Элементы.ГруппаИсторияЧата;
	
	// Выводим сообщения в обратном порядке (последние вверху)
	Для Индекс = 0 По Сообщения.Количество() - 1 Цикл
		// Используем обратный индекс для получения данных сообщения
		ОбратныйИндекс = Сообщения.Количество() - 1 - Индекс;
		СтрокаСообщения = Сообщения[ОбратныйИндекс];
		
		// Пропускаем те же сообщения, что и при создании реквизитов
		ТекстСообщения = СтрокаСообщения.Текст;
		Если (СтрНайти(ТекстСообщения, """updated_plan"":") > 0 И СтрНайти(ТекстСообщения, """next_step_dsl"":") > 0)
			ИЛИ СтрНайти(ТекстСообщения, """kind"": ""dsl_system_result""") > 0 Тогда
			Продолжить;
		ИначеЕсли СтрНайти(ТекстСообщения, "Следующий шаг выполнения по плану") > 0 Тогда
			Продолжить;
		КонецЕсли;
		
		ЭтоРезюме = СтрНачинаетсяС(ТекстСообщения, "=== РЕЗЮМЕ");
		
		Префикс = "дин_msg_" + Формат(ОбратныйИндекс, "ЧГ=0");
		ИмяГруппыСообщения = Префикс + "_Group";
		
		// Данные для реквизитов
		ЭтотОбъект[Префикс + "_Text"] = СтрокаСообщения.Текст;
		Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			ЭтотОбъект[Префикс + "_Code"] = СтрокаСообщения.ТекстКода;
		КонецЕсли;
		ЭтотОбъект[Префикс + "_Header"] = ПолучитьЗаголовокСообщения(СтрокаСообщения);
		
		ЭтоПользователь = (СтрокаСообщения.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Пользователь"));
		
		// Создаем контейнер для всей строки сообщения
		ИмяСтроки = Префикс + "_Row";
		ГруппаСтрока = Элементы.Добавить(ИмяСтроки, Тип("ГруппаФормы"), ГруппаЧат);
		ГруппаСтрока.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаСтрока.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ГруппаСтрока.Отображение = ОтображениеОбычнойГруппы.Нет;
		ГруппаСтрока.РастягиватьПоГоризонтали = Истина;
		
		// Настраиваем родительский контейнер
		ГруппаЧат.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ГруппаЧат.РастягиватьПоВертикали = Истина;
		ГруппаЧат.РастягиватьПоГоризонтали = Истина;
		
		// --- Группа самого сообщения (пузырь) ---
		ГруппаПузырь = Элементы.Добавить(ИмяГруппыСообщения, Тип("ГруппаФормы"), ГруппаСтрока);
		ГруппаПузырь.Вид = ВидГруппыФормы.ОбычнаяГруппа;
		ГруппаПузырь.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
		ГруппаПузырь.РастягиватьПоГоризонтали = Истина;
		
		Попытка
			ГруппаПузырь.АвтоМаксимальнаяШирина = Ложь;
		Исключение
		КонецПопытки;
		
		// Оформление пузыря
		ГруппаПузырь.Отображение = ОтображениеОбычнойГруппы.СлабоеВыделение; // Рамка
		
		// Цвет фона в зависимости от автора
		Если ЭтоРезюме Тогда
			ГруппаПузырь.ЦветФона = WebЦвета.СветлоЖелтый;
		ИначеЕсли ЭтоПользователь Тогда
			ГруппаПузырь.ЦветФона = WebЦвета.Белый;
		ИначеЕсли СтрокаСообщения.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система") Тогда
			ГруппаПузырь.ЦветФона = WebЦвета.Белоснежный;
		Иначе // ИИ
			ГруппаПузырь.ЦветФона = WebЦвета.СветлоСерый;
		КонецЕсли;
		
		// --- Заголовок (Автор, Время) ---
		ЗаголовокЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Header", Тип("ПолеФормы"), ГруппаПузырь);
		ЗаголовокЭлемент.Вид = ВидПоляФормы.ПолеНадписи;
		ЗаголовокЭлемент.ПутьКДанным = Префикс + "_Header";
		ЗаголовокЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
		ЗаголовокЭлемент.Шрифт = Новый Шрифт(,, Истина); // Жирный
		ЗаголовокЭлемент.ЦветТекста = WebЦвета.Серый;
		ЗаголовокЭлемент.РастягиватьПоГоризонтали = Истина;
		ЗаголовокЭлемент.АвтоМаксимальнаяШирина = Ложь;
		
		// Для пользователя выравниваем заголовок вправо
		Если ЭтоПользователь Тогда
			ЗаголовокЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Право;
		ИначеЕсли ЭтоРезюме Тогда
			ЗаголовокЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Центр;
		КонецЕсли;
		
		// --- Текст сообщения ---
		Если ЭтоРезюме Тогда
			// Для резюме используем Декорацию (Надпись), она лучше всего подходит для вывода 
			// произвольного объема текста без прокрутки и ограничений по высоте.
			ТекстЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Text", Тип("ДекорацияФормы"), ГруппаПузырь);
			ТекстЭлемент.Вид = ВидДекорацииФормы.Надпись;
			
			// Извлекаем человекочитаемый текст через общий модуль
			ЧистыйТекст = ИИА_Сервер.ИзвлечьSummaryИзТекста(СтрокаСообщения.Текст);
			
			ТекстЭлемент.Заголовок = ЧистыйТекст;
			ТекстЭлемент.АвтоМаксимальнаяШирина = Ложь;
			ТекстЭлемент.РастягиватьПоГоризонтали = Истина;
			ТекстЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Центр;
			ТекстЭлемент.Шрифт = Новый Шрифт(,, Истина); // Жирный
			ТекстЭлемент.ЦветТекста = WebЦвета.Черный;
		Иначе
			ТекстЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Text", Тип("ПолеФормы"), ГруппаПузырь);
			ТекстЭлемент.Вид = ВидПоляФормы.ПолеВвода;
			ТекстЭлемент.ПутьКДанным = Префикс + "_Text";
			ТекстЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
			ТекстЭлемент.МногострочныйРежим = Истина;
			ТекстЭлемент.ТолькоПросмотр = Истина;
			ТекстЭлемент.РастягиватьПоГоризонтали = Истина;
			ТекстЭлемент.АвтоМаксимальнаяШирина = Ложь;
			ТекстЭлемент.Высота = 3; 
			ТекстЭлемент.ЦветРамки = WebЦвета.Белый;
			ТекстЭлемент.ЦветФона = WebЦвета.Белый;
			
			// Для пользователя выравниваем текст вправо
			Если ЭтоПользователь Тогда
				ТекстЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Право;
			КонецЕсли;
		КонецЕсли;
		
		// --- Блок кода (если есть) ---
		Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			КодЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Code", Тип("ПолеФормы"), ГруппаПузырь);
			КодЭлемент.Вид = ВидПоляФормы.ПолеВвода;
			КодЭлемент.ПутьКДанным = Префикс + "_Code";
			КодЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
			КодЭлемент.МногострочныйРежим = Истина;
			КодЭлемент.ТолькоПросмотр = Истина;
			КодЭлемент.Шрифт = Новый Шрифт("Courier New", 10);
			КодЭлемент.ЦветФона = Новый Цвет(245, 245, 245);
			КодЭлемент.РастягиватьПоГоризонтали = Истина;
		КонецЕсли;
		
	КонецЦикла;
	
	// Прокручиваем к последнему сообщению
	Количество = Сообщения.Количество();
	Если Количество > 0 Тогда
		ПоследнийИндекс = Количество - 1;
		ИмяЭлемента = "дин_msg_" + Формат(ПоследнийИндекс, "ЧГ=0") + "_Group";
		Элемент = Элементы.Найти(ИмяЭлемента);
		Если Элемент <> Неопределено Тогда
			ТекущийЭлемент = Элемент;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура ОчиститьЧат()
	
	// 1. Удаление элементов из каркаса
	ГруппаЧат = Элементы.ГруппаИсторияЧата;
	МассивДляУдаления = Новый Массив;
	Для Каждого ПодчиненныйЭлемент Из ГруппаЧат.ПодчиненныеЭлементы Цикл
		Если СтрНачинаетсяС(ПодчиненныйЭлемент.Имя, "дин_") Тогда
			МассивДляУдаления.Добавить(ПодчиненныйЭлемент);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого ЭлементУдаления Из МассивДляУдаления Цикл
		Элементы.Удалить(ЭлементУдаления);
	КонецЦикла;
	
	// 2. Удаление динамических реквизитов (дин_...)
	МассивУдаляемыхРеквизитов = Новый Массив;
	ВсеРеквизиты = ПолучитьРеквизиты();
	
	Для Каждого Реквизит Из ВсеРеквизиты Цикл
		Если Лев(Реквизит.Имя, 4) = "дин_" Тогда
			МассивУдаляемыхРеквизитов.Добавить(Реквизит.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Если МассивУдаляемыхРеквизитов.Количество() > 0 Тогда
		ИзменитьРеквизиты(, МассивУдаляемыхРеквизитов);
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ПолучитьЗаголовокСообщения(СтрокаСообщения)
	
	Заголовок = Строка(СтрокаСообщения.Автор);
	
	Если ЗначениеЗаполнено(СтрокаСообщения.Время) Тогда
		Заголовок = Заголовок + " [" + Формат(СтрокаСообщения.Время, "ДФ=HH:mm") + "]";
	КонецЕсли;
	
	Если СтрокаСообщения.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка") Тогда
		Заголовок = Заголовок + " (Ошибка)";
	КонецЕсли;
	
	Возврат Заголовок;
	
КонецФункции

&НаКлиенте
Процедура КомандаВверх(Команда)
	
	// Прокрутка к ВЕРХУ формы (к последним сообщениям)
	СообщенияЧат = ИИА_Клиент.ЗагрузитьСообщенияДиалога(ТекущийДиалог);
	Количество = СообщенияЧат.Количество();

	Если Количество > 0 Тогда
		Индекс = Количество - 1;
		ИмяЭлемента = "дин_msg_" + Формат(Индекс, "ЧГ=0") + "_Group";
		Элемент = Элементы.Найти(ИмяЭлемента);
		Если Элемент <> Неопределено Тогда
			ТекущийЭлемент = Элемент;
		КонецЕсли;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура КомандаВниз(Команда)
	
	Элемент = Элементы.Найти("дин_msg_0_Group");
	Если Элемент <> Неопределено Тогда
		ТекущийЭлемент = Элемент;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПотреченоТокеновНаФорме()
	
	Если ТекущийДиалог = Неопределено Или ТекущийДиалог.Пустая() Тогда
		ЭтотОбъект.ПотраченоТокенов = 0;
		Возврат;
	КонецЕсли;
	
	Попытка
		ЭтотОбъект.ПотраченоТокенов = ИИА_ВызовСервера.ПолучитьОбщееКоличествоТокенов(ТекущийДиалог);
	Исключение
		// Ошибка обновления токенов
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьИОткрытьТабличныйДокумент(ДанныеЗапроса)
	
	Если ДанныеЗапроса = Неопределено Или ТипЗнч(ДанныеЗапроса) <> Тип("Массив") Или ДанныеЗапроса.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		ТабличныйДокумент = ИИА_ВызовСервера.СоздатьТабличныйДокументИзДанных(ДанныеЗапроса);
		
		Если ТабличныйДокумент <> Неопределено Тогда
			ТабличныйДокумент.Показать();
			
			// Сообщаем серверу, что таблица была показана
			Если ЗначениеЗаполнено(ТекущийДиалог) Тогда
				ИИА_ВызовСервера.УстановитьФлагТаблицыВХранилище(ТекущийДиалог, Истина);
			КонецЕсли;
		КонецЕсли;
		
	Исключение
		Сообщить("Ошибка при создании табличного документа: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура Настройка(Команда)
	
	ОткрытьФорму("ОбщаяФорма.ИИА_Настройки");
	
КонецПроцедуры

#КонецОбласти
