Перем ОтрисованныеУИД;
Перем УИДТекущегоДиалогаДляЧата;
Перем ПоследняяВерсияДиалога;

#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Устанавливаем начальные значения
	ТекущийТипДиалога = Перечисления.ИИА_ТипДиалога.Агент;
	СтрокаСтатуса = "Готов к работе";
	Заголовок = "Агент ИИ";
	ОркестраторРаботает = Ложь;
	Элементы.Отправить.Заголовок = "Отправить";
	Элементы.Отправить.ЦветФона = WebЦвета.СветлоЗеленый;
	ЛогСсылка = "Лог";
	ОтрисованныеУИД = Новый Соответствие;
	УИДТекущегоДиалогаДляЧата = "";
	ПоследняяВерсияДиалога = "";
	
КонецПроцедуры

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	
	// Проверяем наличие настроек
	Если НЕ ЕстьНастройкиНаСервере() Тогда
		// Если настроек нет, открываем форму регистрации
		ОткрытьФорму("ОбщаяФорма.ИИА_РегистрацияGitsell");
		// Закрываем текущую форму агента, так как без настроек работать нельзя
		ЭтаФорма.Закрыть();
		Возврат;
	КонецЕсли;
	
	// Получаем или создаем диалог текущего пользователя
	ТекущийДиалог = ИИА_Клиент.НайтиИлиСоздатьДиалогПользователя();
	ПоследняяВерсияДиалога = "";
	СброситьСостояниеЧатаНаСервере();
	
	// Синхронизируем состояние оркестратора с регистром (на случай переоткрытия формы)
	ОбновитьСостояниеОркестратораНаСервере();
	
	// Обновляем все элементы интерфейса
	ОбновитьОтображениеДиалога();
	ОбновитьОтображениеПлана();
	ОбновитьОтображениеРеквизитов();
	
	// Подключаем обработчик уведомлений (1С 8.3.26+)
	Обработчик = Новый ОписаниеОповещения("ПриПриемеСообщения", ЭтотОбъект);
	УведомленияКлиента.ПодключитьОбработчик("СообщениеПереписки", Обработчик);
	
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии(ЗавершениеРаботы)
	
	// Отключаем обработчик уведомлений
	УведомленияКлиента.ОтключитьОбработчик("СообщениеПереписки");
	
КонецПроцедуры

&НаСервере
Функция ЕстьНастройкиНаСервере()
	Возврат ИИА_GitsellСервер.ЕстьНастройкиПользователя();
КонецФункции

&НаСервере
Процедура ОбновитьСостояниеОркестратораНаСервере()
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		ОркестраторРаботает = Ложь;
		Возврат;
	КонецЕсли;
	
	ОркестраторРаботает = ИИА_ВызовСервера.ОркестраторВключенДляДиалога(ТекущийДиалог);
	
КонецПроцедуры

#КонецОбласти
&НаКлиенте
Процедура ЛогСсылкаНажатие(Элемент, СтандартнаяОбработка)
	
	СтандартнаяОбработка = Ложь;
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		Сообщить("Диалог не выбран.");
		Возврат;
	КонецЕсли;
	
	// Принудительно загружаем актуальный лог из справочника
	ТекстЛога = ИИА_ВызовСервера.ПолучитьЛогДиалога(ТекущийДиалог);
	
	// Если лог пустой, проверим, может это новый диалог без лога или ошибка
	Если ПустаяСтрока(ТекстЛога) Тогда
		ОписаниеДиалога = ИИА_ВызовСервера.ПолучитьОписаниеДиалога(ТекущийДиалог);
		Сообщить("Лог диалога пуст. Текущий диалог: " + Строка(ТекущийДиалог.УникальныйИдентификатор()) + " | " + ОписаниеДиалога);
		Возврат;
	КонецЕсли;
	
	ТекстовыйДокумент = Новый ТекстовыйДокумент;
	ТекстовыйДокумент.УстановитьТекст(ТекстЛога);
	ТекстовыйДокумент.Показать("Лог диалога: " + Строка(ТекущийДиалог));
	
КонецПроцедуры

&НаКлиенте
Процедура ТекущийДиалогПриИзменении(Элемент)
	
	// Если диалог пустой, очищаем все
	Если ТекущийДиалог.Пустая() Тогда
		СтрокаСтатуса = "Выберите диалог";
		ПоследняяВерсияДиалога = "";
		СброситьСостояниеЧатаНаСервере();
		// Обновляем с пустым диалогом (очистит чат)
		ОбновитьОтображениеДиалога();
		ОбновитьОтображениеПлана();
		ОбновитьОтображениеРеквизитов();
		Возврат;
	КонецЕсли;
	
	// Останавливаем оркестратор при смене диалога, чтобы не смешивать контексты
	Если ОркестраторРаботает Тогда
		ОстановитьОркестратор();
	КонецЕсли;
	
	// Синхронизируем состояние оркестратора с регистром для выбранного диалога
	ОбновитьСостояниеОркестратораНаСервере();
	ПоследняяВерсияДиалога = "";
	СброситьСостояниеЧатаНаСервере();
	
	// Обновляем все элементы интерфейса
	ОбновитьОтображениеДиалога();
	ОбновитьОтображениеПлана();
	ОбновитьОтображениеРеквизитов();
	
	СтрокаСтатуса = "Диалог загружен";
	
КонецПроцедуры


#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура КомандаОтправить(Команда)
	
	// Если оркестратор работает, останавливаем его
	Если ОркестраторРаботает Тогда
		Если ЗначениеЗаполнено(ТекущийДиалог) Тогда
			ИИА_ВызовСервера.ОркестраторОстановить(ТекущийДиалог);
		КонецЕсли;
		ОстановитьОркестратор();
		Возврат;
	КонецЕсли;
	
	Если ПустаяСтрока(ТекущийТекст) Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущийДиалог = Неопределено Тогда
		Сообщить("Диалог не создан. Попробуйте перезапустить форму.");
		Возврат;
	КонецЕсли;
	
	// Запускаем оркестратор
	ЗапуститьОркестратор();
	
	// Устанавливаем статус "Отправка..."
	СтрокаСтатуса = "Отправка сообщения...";
	
	Попытка
		
		// Отправляем сообщение и запускаем оркестратор на сервере
		ИИА_ВызовСервера.ОркестраторОтправитьИЗапустить(
			ТекущийДиалог,
			ТекущийТекст,
			ТекущийТипДиалога
		);
		
		// Обновляем интерфейс
		ОбновитьОтображениеДиалога();
		ОбновитьОтображениеРеквизитов();
		
		// Очищаем поле ввода
		ТекущийТекст = "";
		
	Исключение
		
		ТекстОшибки = "Ошибка: " + ОписаниеОшибки();
		ОстановитьОркестратор(ТекстОшибки);
		Сообщить(ТекстОшибки);
		
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура НовыйДиалог(Команда)
	
	// Создаем новый диалог
	ТекущийДиалог = ИИА_Клиент.СоздатьНовыйДиалог();
	ПоследняяВерсияДиалога = "";
	СброситьСостояниеЧатаНаСервере();
	
	// Очищаем форму
	ТекущийТекст = "";
	
	// Обновляем интерфейс
	ОбновитьОтображениеДиалога();
	ОбновитьОтображениеПлана();
	
	// Устанавливаем начальные значения
	СтрокаСтатуса = "Создан новый диалог. Готов к работе";
	ОркестраторРаботает = Ложь;
	ОбновитьОтображениеРеквизитов();
	
КонецПроцедуры
#КонецОбласти

#Область ПроцедурыИФункцииКлиентскогоМодуля

&НаКлиенте
// Запускает оркестратор и обновляет интерфейс
Процедура ЗапуститьОркестратор()
	
	ОркестраторРаботает = Истина;
	ОбновитьОтображениеРеквизитов();
	
КонецПроцедуры

&НаКлиенте
// Останавливает оркестратор и обновляет интерфейс
Процедура ОстановитьОркестратор(ТекстСтатуса = "")
	
	ОркестраторРаботает = Ложь;
	Если ПустаяСтрока(ТекстСтатуса) Тогда
		СтрокаСтатуса = "Оркестратор остановлен";
	Иначе
		СтрокаСтатуса = ТекстСтатуса;
	КонецЕсли;
	ОбновитьОтображениеРеквизитов();
	
КонецПроцедуры

&НаКлиенте
// Подключает обработчик ожидания для планирования следующих шагов
Процедура ПодключитьОбработчикПланирования()
	// Обработчики ожидания не используются: оркестрация работает через серверные уведомления.
	Возврат;
КонецПроцедуры

&НаКлиенте
// Оркестратор процесса выполнения задачи с использованием планирования
Процедура СпланироватьСледующиеШаги()
	// Оркестрация перенесена на сервер, здесь шаги не выполняются
	Возврат;

КонецПроцедуры

&НаКлиенте
Процедура ПриПриемеСообщения(ДанныеСообщения, ДополнительныеПараметры = Неопределено) Экспорт
	
	// Проверяем, что уведомление относится к нашему диалогу
	Если ДанныеСообщения.Свойство("Диалог") И ДанныеСообщения.Диалог = ТекущийДиалог Тогда
		
		Если ДанныеСообщения.Свойство("ВерсияДиалога") Тогда
			ПоследняяВерсияДиалога = Строка(ДанныеСообщения.ВерсияДиалога);
		КонецЕсли;
		
		// 1. Обновляем диалог
		ОбновитьОтображениеДиалога();
		
		// 2. Обновляем план
		ОбновитьОтображениеПлана();
		
		// 3. Обновляем реквизиты
		ОбновитьОтображениеРеквизитов();
		
		// Обработка завершения или остановки
		Если ДанныеСообщения.Свойство("ТипСобытия") Тогда
			
			ТипСобытия = ДанныеСообщения.ТипСобытия;
			
			Если ТипСобытия = "ЗадачаЗавершена" ИЛИ ТипСобытия = "ОстановленПользователем" 
				ИЛИ ТипСобытия = "ОшибкаПлана" ИЛИ ТипСобытия = "ПревышенЛимитТокенов" Тогда
				
				ОстановитьОркестратор();
				
				ТекстСобытия = "Событие";
				Если ТипСобытия = "ЗадачаЗавершена" Тогда
					ТекстСобытия = ?(ДанныеСообщения.Свойство("Успех") И ДанныеСообщения.Успех, "Задача выполнена успешно", "Задача завершена с ошибкой");
				ИначеЕсли ТипСобытия = "ОстановленПользователем" Тогда
					ТекстСобытия = "Оркестратор остановлен";
				ИначеЕсли ТипСобытия = "ОшибкаПлана" Тогда
					ТекстСобытия = "Ошибка создания плана";
				ИначеЕсли ТипСобытия = "ПревышенЛимитТокенов" Тогда
					ТекстСобытия = "Превышен лимит токенов на запуск";
				КонецЕсли;
				
				СтрокаСтатуса = ТекстСобытия;
				Состояние("ИИ Агент: " + ТекстСобытия,, ТекстСобытия);
				
				// Повторное обновление по финальному событию без обработчиков ожидания:
				// помогает подтянуть резюме, если первое чтение было раньше фиксации записи.
				ОбновитьОтображениеДиалога();
				
			Иначе
				
				// Оповещаем пользователя о прогрессе (опционально)
				ТекстПрогресса = "";
				Если ТипСобытия = "ПланИнициализирован" Тогда
					ТекстПрогресса = "План создан";
				ИначеЕсли ТипСобытия = "ШагВыполнен" Тогда
					ТекстПрогресса = "Шаг выполнен";
				ИначеЕсли ТипСобытия = "ЗапросПринят" Тогда
					ТекстПрогресса = "Запрос принят";
				КонецЕсли;
				
				Если НЕ ПустаяСтрока(ТекстПрогресса) Тогда
					СтрокаСтатуса = ТекстПрогресса + "...";
					Состояние("ИИ Агент: " + ТекстПрогресса,, ТекстПрогресса);
				КонецЕсли;
				
			КонецЕсли;
			
			Если ТипСобытия = "РезюмеДобавлено" Тогда
				// Явная подгрузка резюме по отдельному уведомлению.
				ОбновитьОтображениеДиалога();
			КонецЕсли;
			
		КонецЕсли;
		
		// Если в процессе был выполнен RunQuery - покажем ТабличныйДокумент
		ПопытатьсяПоказатьТабличныйДокумент();
		
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ПопытатьсяПоказатьТабличныйДокумент(ЛогироватьПропуск = Ложь)
	
	Если ТекущийДиалог = Неопределено Или ТекущийДиалог.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		ДанныеДляТаблицы = ИИА_ВызовСервера.ПолучитьНепоказанныеДанныеЗапроса(ТекущийДиалог);
		Если ДанныеДляТаблицы = Неопределено Тогда
			Возврат;
		КонецЕсли;
		
		СоздатьИОткрытьТабличныйДокумент(ДанныеДляТаблицы);
	Исключение
		// Не скрываем ошибку: выводим пользователю
		Сообщить("Ошибка при получении данных запроса для ТабличногоДокумента: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеДиалога()
	ОбновитьСообщения();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеПлана()
	ОбновитьПланНаФорме();
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьОтображениеРеквизитов()
	
	ОбновитьПотреченоТокеновНаФорме();
	
	Если ОркестраторРаботает Тогда
		Элементы.Отправить.Заголовок = "Остановить";
		Элементы.Отправить.ЦветФона = WebЦвета.Коралловый;
		Элементы.ДекорацияДлительнаяОперация.Видимость = Истина;
	Иначе
		Элементы.Отправить.Заголовок = "Отправить";
		Элементы.Отправить.ЦветФона = WebЦвета.СветлоЗеленый;
		Элементы.ДекорацияДлительнаяОперация.Видимость = Ложь;
	КонецЕсли;
	
	Элементы.Отправить.Доступность = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ОбновитьПланНаФорме()
	ОбновитьПланНаСервере();
КонецПроцедуры

&НаСервере
Процедура ОбновитьПланНаСервере()
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		ЭтотОбъект.ПланЗадач.Очистить();
		ЭтотОбъект.ИзмененныеОбъекты.Очистить();
		Возврат;
	КонецЕсли;
	
	ПланДанные = ИИА_Оркестратор.ПолучитьПланДиалога(ТекущийДиалог);
	
	// Предполагаем, что на форме есть таблица ПланЗадач, 
	// связанная с реквизитом типа ТаблицаЗначений (или ТабличнаяЧасть)
	ЭтотОбъект.ПланЗадач.Очистить();
	Для Каждого СтрокаПлана Из ПланДанные Цикл
		НоваяСтрока = ЭтотОбъект.ПланЗадач.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока, СтрокаПлана);
	КонецЦикла;
	
	// Загружаем ИзмененныеОбъекты из диалога
	Диалог = ТекущийДиалог.ПолучитьОбъект();
	Если Диалог <> Неопределено Тогда
		ЭтотОбъект.ИзмененныеОбъекты.Очистить();
		Для Каждого СтрокаИзмененных Из Диалог.ИзмененныеОбъекты Цикл
			Если ЗначениеЗаполнено(СтрокаИзмененных.СсылкаНаОбъект) Тогда
				НоваяСтрока = ЭтотОбъект.ИзмененныеОбъекты.Добавить();
				НоваяСтрока.СсылкаНаОбъект = СтрокаИзмененных.СсылкаНаОбъект;
			КонецЕсли;
		КонецЦикла;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
// Обновляет список сообщений на форме
Процедура ОбновитьСообщения()
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		СброситьСостояниеЧатаНаСервере();
		Возврат;
	КонецЕсли;
	
	НовыеСообщения = ИИА_Клиент.ЗагрузитьСообщенияДиалога(ТекущийДиалог);
	
	// Инкрементально добавляем только новые сообщения по УИД
	ОбновитьИнтерфейсЧатаНаСервере(НовыеСообщения);
	
КонецПроцедуры

&НаСервере
Процедура ОбновитьИнтерфейсЧатаНаСервере(Сообщения)
	
	// Устанавливаем заголовок формы по наименованию диалога
	Заголовок = ИИА_ВызовСервера.ПолучитьНаименованиеДиалога(ТекущийДиалог);
	
	Если ТекущийДиалог = Неопределено ИЛИ ТекущийДиалог.Пустая() Тогда
		СброситьСостояниеЧатаНаСервере();
		Возврат;
	КонецЕсли;
	
	ТекущийУИДДиалога = Строка(ТекущийДиалог.УникальныйИдентификатор());
	Если УИДТекущегоДиалогаДляЧата <> ТекущийУИДДиалога Тогда
		СброситьСостояниеЧатаНаСервере();
		УИДТекущегоДиалогаДляЧата = ТекущийУИДДиалога;
	КонецЕсли;
	
	// Для гарантированного отображения в обратной хронологии
	// пересобираем визуальную часть чата по текущему снимку сообщений.
	СброситьСостояниеЧатаНаСервере();
	УИДТекущегоДиалогаДляЧата = ТекущийУИДДиалога;
	
	НовыеСообщенияДляОтрисовки = Новый Массив;
	МассивДобавляемыхРеквизитов = Новый Массив;
	МассивТипаСтрока = Новый Массив;
	МассивТипаСтрока.Добавить(Тип("Строка"));
	ОписаниеТипаСтрока = Новый ОписаниеТипов(МассивТипаСтрока);
	
	Если Сообщения.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Индекс = Сообщения.Количество() - 1;
	Пока Индекс >= 0 Цикл
		СтрокаСообщения = Сообщения[Индекс];
		
		ПроверитьУИДСообщения(СтрокаСообщения);
		
		Если НЕ ЭтоСообщениеДляЧата(СтрокаСообщения) Тогда
			Индекс = Индекс - 1;
			Продолжить;
		КонецЕсли;
		
		УИДСообщения = Строка(СтрокаСообщения.УИД);
		Если ОтрисованныеУИД.Получить(УИДСообщения) <> Неопределено Тогда
			Продолжить;
		КонецЕсли;
		
		НовыеСообщенияДляОтрисовки.Добавить(СтрокаСообщения);
		ОтрисованныеУИД.Вставить(УИДСообщения, Истина);
		ДобавитьРеквизитыСообщения(СтрокаСообщения, МассивДобавляемыхРеквизитов, ОписаниеТипаСтрока);
		
		Индекс = Индекс - 1;
	КонецЦикла;
	
	Если НовыеСообщенияДляОтрисовки.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Если МассивДобавляемыхРеквизитов.Количество() > 0 Тогда
		ИзменитьРеквизиты(МассивДобавляемыхРеквизитов);
	КонецЕсли;
	
	ГруппаЧат = Элементы.ГруппаИсторияЧата;
	// Настраиваем родительский контейнер
	ГруппаЧат.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	ГруппаЧат.РастягиватьПоВертикали = Истина;
	ГруппаЧат.РастягиватьПоГоризонтали = Истина;
	
	ЭлементДляПрокруткиКНовейшему = Неопределено;
	Для Каждого СтрокаСообщения Из НовыеСообщенияДляОтрисовки Цикл
		ЭлементДляПрокруткиКНовейшему = ДобавитьСообщениеВЧатНаСервере(СтрокаСообщения, ГруппаЧат);
	КонецЦикла;
	
	// Прокручиваем к последнему отображаемому сообщению (не по индексу - он может быть пропущен)
	Если ЭлементДляПрокруткиКНовейшему <> Неопределено Тогда
		ТекущийЭлемент = ЭлементДляПрокруткиКНовейшему;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Процедура СброситьСостояниеЧатаНаСервере()
	ОчиститьЧат();
	ОтрисованныеУИД = Новый Соответствие;
	УИДТекущегоДиалогаДляЧата = "";
КонецПроцедуры

&НаСервере
Процедура ПроверитьУИДСообщения(СтрокаСообщения)
	Если НЕ СтрокаСообщения.Свойство("УИД") Тогда
		ВызватьИсключение "Ошибка синхронизации чата: у сообщения отсутствует поле УИД.";
	КонецЕсли;
	
	Если ПустаяСтрока(СтрокаСообщения.УИД) Тогда
		ВызватьИсключение "Ошибка синхронизации чата: пустой УИД сообщения.";
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ЭтоСообщениеДляЧата(СтрокаСообщения)
	
	Если СтрокаСообщения.Свойство("СкрытоеСлужебное") И СтрокаСообщения.СкрытоеСлужебное Тогда
		Возврат Ложь;
	КонецЕсли;
	Возврат Истина;
КонецФункции

&НаСервере
Процедура ДобавитьРеквизитыСообщения(СтрокаСообщения, МассивДобавляемыхРеквизитов, ОписаниеТипаСтрока)
	Префикс = ПолучитьПрефиксСообщенияПоУИД(СтрокаСообщения.УИД);
	МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Text", ОписаниеТипаСтрока, "", "Текст сообщения"));
	Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
		МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Code", ОписаниеТипаСтрока, "", "Код сообщения"));
	КонецЕсли;
	МассивДобавляемыхРеквизитов.Добавить(Новый РеквизитФормы(Префикс + "_Header", ОписаниеТипаСтрока, "", "Заголовок"));
КонецПроцедуры

&НаСервере
Функция ПолучитьПрефиксСообщенияПоУИД(УИДСообщения)
	БезопасныйУИД = СтрЗаменить(Строка(УИДСообщения), "-", "_");
	БезопасныйУИД = СтрЗаменить(БезопасныйУИД, "{", "");
	БезопасныйУИД = СтрЗаменить(БезопасныйУИД, "}", "");
	Возврат "дин_msg_" + БезопасныйУИД;
КонецФункции

&НаСервере
Функция ДобавитьСообщениеВЧатНаСервере(СтрокаСообщения, ГруппаЧат)
	
	Префикс = ПолучитьПрефиксСообщенияПоУИД(СтрокаСообщения.УИД);
	ИмяГруппыСообщения = Префикс + "_Group";
	
	// Данные для реквизитов
	ЭтотОбъект[Префикс + "_Text"] = СтрокаСообщения.Текст;
	Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
		ЭтотОбъект[Префикс + "_Code"] = СтрокаСообщения.ТекстКода;
	КонецЕсли;
	ЭтотОбъект[Префикс + "_Header"] = ПолучитьЗаголовокСообщения(СтрокаСообщения);
	
	ЭтоРезюме = СтрНачинаетсяС(СтрокаСообщения.Текст, "=== РЕЗЮМЕ");
	ЭтоПользователь = (СтрокаСообщения.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Пользователь"));
	
	ИмяСтроки = Префикс + "_Row";
	ГруппаСтрока = Элементы.Добавить(ИмяСтроки, Тип("ГруппаФормы"), ГруппаЧат);
	ГруппаСтрока.Вид = ВидГруппыФормы.ОбычнаяГруппа;
	ГруппаСтрока.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	ГруппаСтрока.Отображение = ОтображениеОбычнойГруппы.Нет;
	ГруппаСтрока.РастягиватьПоГоризонтали = Истина;
	
	ГруппаПузырь = Элементы.Добавить(ИмяГруппыСообщения, Тип("ГруппаФормы"), ГруппаСтрока);
	ГруппаПузырь.Вид = ВидГруппыФормы.ОбычнаяГруппа;
	ГруппаПузырь.Группировка = ГруппировкаПодчиненныхЭлементовФормы.Вертикальная;
	ГруппаПузырь.РастягиватьПоГоризонтали = Истина;
	
	Попытка
		ГруппаПузырь.АвтоМаксимальнаяШирина = Ложь;
	Исключение
		// Свойство может отсутствовать в некоторых версиях платформы.
		// Это не должно останавливать отрисовку чата.
		ТекстОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	ГруппаПузырь.Отображение = ОтображениеОбычнойГруппы.СлабоеВыделение;
	
	Если ЭтоРезюме Тогда
		ГруппаПузырь.ЦветФона = WebЦвета.СветлоЖелтый;
	ИначеЕсли ЭтоПользователь Тогда
		ГруппаПузырь.ЦветФона = WebЦвета.Белый;
	ИначеЕсли СтрокаСообщения.Автор = ПредопределенноеЗначение("Перечисление.ИИА_АвторСообщения.Система") Тогда
		ГруппаПузырь.ЦветФона = WebЦвета.Белоснежный;
	Иначе
		ГруппаПузырь.ЦветФона = WebЦвета.СветлоСерый;
	КонецЕсли;
	
	ЗаголовокЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Header", Тип("ПолеФормы"), ГруппаПузырь);
	ЗаголовокЭлемент.Вид = ВидПоляФормы.ПолеНадписи;
	ЗаголовокЭлемент.ПутьКДанным = Префикс + "_Header";
	ЗаголовокЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
	// BSLLS:StyleElementConstructors-off
	ЗаголовокЭлемент.Шрифт = Новый Шрифт(,, Истина);
	ЗаголовокЭлемент.ЦветТекста = WebЦвета.Серый;
	// BSLLS:StyleElementConstructors-on
	ЗаголовокЭлемент.РастягиватьПоГоризонтали = Истина;
	ЗаголовокЭлемент.АвтоМаксимальнаяШирина = Ложь;
	
	Если ЭтоПользователь Тогда
		ЗаголовокЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Право;
	ИначеЕсли ЭтоРезюме Тогда
		ЗаголовокЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Центр;
	КонецЕсли;
	
	Если ЭтоРезюме Тогда
		ТекстЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Text", Тип("ДекорацияФормы"), ГруппаПузырь);
		ТекстЭлемент.Вид = ВидДекорацииФормы.Надпись;
		ЧистыйТекст = ИИА_Оркестратор.ИзвлечьSummaryИзТекста(СтрокаСообщения.Текст);
		ТекстЭлемент.Заголовок = ЧистыйТекст;
		ТекстЭлемент.АвтоМаксимальнаяШирина = Ложь;
		ТекстЭлемент.РастягиватьПоГоризонтали = Истина;
		ТекстЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Центр;
		// BSLLS:StyleElementConstructors-off
		ТекстЭлемент.Шрифт = Новый Шрифт(,, Истина);
		ТекстЭлемент.ЦветТекста = WebЦвета.Черный;
		// BSLLS:StyleElementConstructors-on
	Иначе
		ТекстЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Text", Тип("ПолеФормы"), ГруппаПузырь);
		ТекстЭлемент.Вид = ВидПоляФормы.ПолеВвода;
		ТекстЭлемент.ПутьКДанным = Префикс + "_Text";
		ТекстЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
		ТекстЭлемент.МногострочныйРежим = Истина;
		ТекстЭлемент.ТолькоПросмотр = Истина;
		ТекстЭлемент.РастягиватьПоГоризонтали = Истина;
		ТекстЭлемент.АвтоМаксимальнаяШирина = Ложь;
		ТекстЭлемент.Высота = 3;
		ТекстЭлемент.ЦветРамки = WebЦвета.Белый;
		ТекстЭлемент.ЦветФона = WebЦвета.Белый;
		
		Если ЭтоПользователь Тогда
			ТекстЭлемент.ГоризонтальноеПоложение = ГоризонтальноеПоложениеЭлемента.Право;
		КонецЕсли;
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
		КодЭлемент = Элементы.Добавить(ИмяГруппыСообщения + "_Code", Тип("ПолеФормы"), ГруппаПузырь);
		КодЭлемент.Вид = ВидПоляФормы.ПолеВвода;
		КодЭлемент.ПутьКДанным = Префикс + "_Code";
		КодЭлемент.ПоложениеЗаголовка = ПоложениеЗаголовкаЭлементаФормы.Нет;
		КодЭлемент.МногострочныйРежим = Истина;
		КодЭлемент.ТолькоПросмотр = Истина;
		// BSLLS:StyleElementConstructors-off
		КодЭлемент.Шрифт = Новый Шрифт("Courier New", 10);
		КодЭлемент.ЦветФона = Новый Цвет(245, 245, 245);
		// BSLLS:StyleElementConstructors-on
		КодЭлемент.РастягиватьПоГоризонтали = Истина;
	КонецЕсли;
	
	Возврат ГруппаПузырь;
	
КонецФункции

&НаСервере
Процедура ОчиститьЧат()
	
	// 1. Удаление элементов из каркаса
	ГруппаЧат = Элементы.ГруппаИсторияЧата;
	МассивДляУдаления = Новый Массив;
	Для Каждого ПодчиненныйЭлемент Из ГруппаЧат.ПодчиненныеЭлементы Цикл
		Если СтрНачинаетсяС(ПодчиненныйЭлемент.Имя, "дин_") Тогда
			МассивДляУдаления.Добавить(ПодчиненныйЭлемент);
		КонецЕсли;
	КонецЦикла;
	
	Для Каждого ЭлементУдаления Из МассивДляУдаления Цикл
		Элементы.Удалить(ЭлементУдаления);
	КонецЦикла;
	
	// 2. Удаление динамических реквизитов (дин_...)
	МассивУдаляемыхРеквизитов = Новый Массив;
	ВсеРеквизиты = ПолучитьРеквизиты();
	
	Для Каждого Реквизит Из ВсеРеквизиты Цикл
		Если Лев(Реквизит.Имя, 4) = "дин_" Тогда
			МассивУдаляемыхРеквизитов.Добавить(Реквизит.Имя);
		КонецЕсли;
	КонецЦикла;
	
	Если МассивУдаляемыхРеквизитов.Количество() > 0 Тогда
		ИзменитьРеквизиты(, МассивУдаляемыхРеквизитов);
	КонецЕсли;

КонецПроцедуры

&НаСервере
Функция ПолучитьЗаголовокСообщения(СтрокаСообщения)
	
	ЗаголовокСообщения = Строка(СтрокаСообщения.Автор);
	
	Если ЗначениеЗаполнено(СтрокаСообщения.Время) Тогда
		ЗаголовокСообщения = ЗаголовокСообщения + " [" + Формат(СтрокаСообщения.Время, "ДФ=HH:mm") + "]";
	КонецЕсли;
	
	Если СтрокаСообщения.ТипСообщения = ПредопределенноеЗначение("Перечисление.ИИА_ТипСообщения.Ошибка") Тогда
		ЗаголовокСообщения = ЗаголовокСообщения + " (Ошибка)";
	КонецЕсли;
	
	Возврат ЗаголовокСообщения;
	
КонецФункции

&НаКлиенте
Процедура ОбновитьПотреченоТокеновНаФорме()
	
	Если ТекущийДиалог = Неопределено Или ТекущийДиалог.Пустая() Тогда
		ЭтотОбъект.ПотраченоТокенов = 0;
		Возврат;
	КонецЕсли;
	
	Попытка
		ЭтотОбъект.ПотраченоТокенов = ИИА_ВызовСервера.ПолучитьОбщееКоличествоТокенов(ТекущийДиалог);
	Исключение
		// Ошибка обновления токенов - не критично для отображения
		ТекстОшибки = ОписаниеОшибки();
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьИОткрытьТабличныйДокумент(ДанныеЗапроса)
	
	Если ДанныеЗапроса = Неопределено Или ТипЗнч(ДанныеЗапроса) <> Тип("Массив") Или ДанныеЗапроса.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	Попытка
		ТабличныйДокумент = ИИА_ВызовСервера.СоздатьТабличныйДокументИзДанных(ДанныеЗапроса);
		
		Если ТабличныйДокумент <> Неопределено Тогда
			ТабличныйДокумент.Показать();
			
			// Сообщаем серверу, что таблица была показана
			Если ЗначениеЗаполнено(ТекущийДиалог) Тогда
				ИИА_ВызовСервера.УстановитьФлагТаблицыВХранилище(ТекущийДиалог, Истина);
			КонецЕсли;
		КонецЕсли;
		
	Исключение
		Сообщить("Ошибка при создании табличного документа: " + ОписаниеОшибки());
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура Настройка(Команда)
	
	ОткрытьФорму("ОбщаяФорма.ИИА_Настройки");
	
КонецПроцедуры

#КонецОбласти
