&НаКлиенте
Процедура Регистрация(Команда)
	
	НачатьDeviceFlow();
	
КонецПроцедуры

&НаКлиенте
Процедура НачатьDeviceFlow()
	
	СтрокаСтатуса = "Запрос авторизации...";
	
	Результат = Gitsell_НачатьDeviceFlowНаСервере();
	
	Если Результат.Успех Тогда
		DeviceCode = Результат.device_code;
		UserCode = Результат.user_code;
		VerificationUri = Результат.verification_uri_complete;
		AuthInterval = Результат.interval;
		// Дата окончания = Текущая + expires_in
		AuthExpiresAt = ТекущаяДатаСеанса() + Результат.expires_in; 
		СтатусАвторизации = "Pending";
		
		ОткрытьСсылкуВБраузере(VerificationUri);
		
		// Показываем пользователю код и ссылку (можно вывести в лог или спец поля)
		// В этой форме мы выводим это в реквизиты формы, которые видит пользователь
		
		// Запускаем поллинг
		ПодключитьОбработчикPolling();
		
	Иначе
		СтрокаСтатуса = "Ошибка авторизации: " + Результат.Ошибка;
	КонецЕсли;
	
КонецПроцедуры

&НаКлиенте
Процедура ДекорацияСсылкаGitsellНажатие(Элемент)
	ОткрытьСсылкуВБраузере("https://gitsell.ru/account");
КонецПроцедуры

&НаКлиенте
Процедура VerificationUriНажатие(Элемент)
	ОткрытьСсылкуВБраузере(VerificationUri);
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьСсылкуВБраузере(Ссылка)
	
	Если НЕ ЗначениеЗаполнено(Ссылка) Тогда
		СтрокаСтатуса = "Ссылка не заполнена.";
		Возврат;
	КонецЕсли;
	
	Попытка
		ПерейтиПоНавигационнойСсылке(Ссылка);
		СтрокаСтатуса = "Открыт браузер. Подтвердите вход.";
	Исключение
		СтрокаСтатуса = "Не удалось открыть ссылку. Перейдите по ней вручную. Ошибка: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецПроцедуры

&НаКлиенте
Процедура ПодключитьОбработчикPolling()
	
	Если СтатусАвторизации <> "Pending" Тогда
		Возврат;
	КонецЕсли;
	
	ПодключитьОбработчикОжидания("ОпросТокена", AuthInterval, Истина);
	
КонецПроцедуры

&НаКлиенте
Процедура ОпросТокена()
	
	Если СтатусАвторизации <> "Pending" Тогда
		Возврат;
	КонецЕсли;
	
	Если ТекущаяДатаСеанса() > AuthExpiresAt Тогда
		СтатусАвторизации = "Expired";
		СтрокаСтатуса = "Время авторизации истекло. Попробуйте снова.";
		Возврат;
	КонецЕсли;
	
	Результат = Gitsell_ОпросТокенаНаСервере(DeviceCode);
	
	Если Результат.Статус = "success" Тогда
		СтатусАвторизации = "Authorized";
		СтрокаСтатуса = "Авторизация успешна!";
		
		Email = "";
		Если Результат.Свойство("Email") Тогда
			Email = Результат.Email;
			// Отображаем Email на форме
			EmailПользователя = Email;
		КонецЕсли;
		
		// Сохраняем токен
		Gitsell_СохранитьТокенНаСервере(Результат.Токен, Email);
		
		// Проверяем доступ к моделям
		Проверка = Gitsell_ПроверитьModelsНаСервере();
		Если Проверка.Успех Тогда
			СтрокаСтатуса = "Готов к работе (Gitsell AI Proxy)";
			// Закрываем форму, чтобы форма настроек перечиталась через обработчик закрытия
			Закрыть();
		Иначе
			СтрокаСтатуса = "Ошибка проверки токена: " + Проверка.Ошибка;
		КонецЕсли;
		
	ИначеЕсли Результат.Статус = "pending" Тогда
		// Продолжаем опрос
		ПодключитьОбработчикPolling();
		
	ИначеЕсли Результат.Статус = "slow_down" Тогда
		// Увеличиваем интервал
		AuthInterval = AuthInterval + 2;
		ПодключитьОбработчикPolling();
		
	Иначе
		СтатусАвторизации = "Error";
		СтрокаСтатуса = "Ошибка авторизации: " + Результат.Ошибка;
	КонецЕсли;
	
КонецПроцедуры

&НаСервере
Функция Gitsell_НачатьDeviceFlowНаСервере()
	Возврат ИИА_GitsellСервер.Gitsell_НачатьDeviceFlow();
КонецФункции

&НаСервере
Функция Gitsell_ОпросТокенаНаСервере(DeviceCode)
	Возврат ИИА_GitsellСервер.Gitsell_ОпросТокена(DeviceCode);
КонецФункции

&НаСервере
Процедура Gitsell_СохранитьТокенНаСервере(Токен, Email)
	ИИА_GitsellСервер.Gitsell_СохранитьAiProxyToken(Токен, Email);
КонецПроцедуры

&НаСервере
Функция Gitsell_ПроверитьModelsНаСервере()
	Возврат ИИА_GitsellСервер.Gitsell_ПроверитьModels();
КонецФункции