#Область ПрограммныйИнтерфейс

// Запускает серверный оркестратор (фоновый цикл)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Процедура Запустить(СсылкаДиалога) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если Диалог.ОркестраторВключен Тогда
		Возврат;
	КонецЕсли;
	
	Диалог.ОркестраторВключен = Истина;
	Диалог.Записать();
	
	ИмяЗадания = "ИИ_Оркестратор_" + Строка(СсылкаДиалога.УникальныйИдентификатор());
	Параметры = Новый Массив;
	Параметры.Добавить(СсылкаДиалога);
	
	// Получаем начальное количество токенов перед запуском
	НачальныеТокены = ИИА_Сервер.ПолучитьОбщееКоличествоТокенов(СсылкаДиалога);
	Параметры.Добавить(НачальныеТокены);
	
	ФоновыеЗадания.Выполнить("ИИА_Оркестратор.ВыполнитьЦикл", Параметры, , ИмяЗадания);
	
КонецПроцедуры

// Добавляет сообщение пользователя и запускает оркестратор
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Текст - Строка - текст сообщения
//  ТипДиалога - ПеречислениеСсылка.ИИА_ТипДиалога - тип диалога
//
Процедура ОтправитьИЗапустить(СсылкаДиалога, Текст, ТипДиалога) Экспорт
	
	// 1. Добавляем сообщение пользователя через серверный модуль
	ИИА_Сервер.ОтправитьСообщениеСервера(СсылкаДиалога, ТипДиалога, Текст);
	
	// 2. Запускаем оркестратор
	Запустить(СсылкаДиалога);
	
КонецПроцедуры

// Останавливает серверный оркестратор (мягкая остановка)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Процедура Остановить(СсылкаДиалога) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если НЕ Диалог.ОркестраторВключен Тогда
		Возврат;
	КонецЕсли;
	
	Диалог.ОркестраторВключен = Ложь;
	Диалог.Записать();
	
	ОтправитьУведомление(СсылкаДиалога, "ОстановленПользователем");
	
КонецПроцедуры

// Основной цикл серверного оркестратора
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  НачальныеТокены - Число - количество токенов на момент старта
//
Процедура ВыполнитьЦикл(СсылкаДиалога, НачальныеТокены = 0) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	ДиалогОбъект = СсылкаДиалога.ПолучитьОбъект();
	Настройки = ИИА_Сервер.ПолучитьНастройкиПользователя(ДиалогОбъект.Пользователь);
	ЛимитНаЗапуск = Настройки.ЛимитТокеновНаЗапуск;
	
	Пока Истина Цикл
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		Если НЕ Диалог.ОркестраторВключен Тогда
			Прервать;
		КонецЕсли;
		
		// Проверка лимита токенов на запуск
		Если ЛимитНаЗапуск > 0 Тогда
			ТекущиеТокены = ИИА_Сервер.ПолучитьОбщееКоличествоТокенов(СсылкаДиалога);
			ПотраченоВЭтомЗапуске = ТекущиеТокены - НачальныеТокены;
			
			Если ПотраченоВЭтомЗапуске >= ЛимитНаЗапуск Тогда
				Диалог.ОркестраторВключен = Ложь;
				Диалог.Записать();
				
				ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Остановка: превышен лимит токенов на запуск (" + Строка(ЛимитНаЗапуск) + ")");
				ОтправитьУведомление(СсылкаДиалога, "ПревышенЛимитТокенов");
				Прервать;
			КонецЕсли;
		КонецЕсли;
		
		// 1. Планирование, если плана нет
		ПланДанные = ИИА_Сервер.ПолучитьПланДиалога(СсылкаДиалога);
		Если ПланДанные.Количество() = 0 Тогда
			Если НЕ ИИА_Сервер.ИнициализироватьПлан(СсылкаДиалога) Тогда
				Диалог = СсылкаДиалога.ПолучитьОбъект();
				Диалог.ОркестраторВключен = Ложь;
				Диалог.Записать();
				ОтправитьУведомление(СсылкаДиалога, "ОшибкаПлана");
				Прервать;
			КонецЕсли;
			
			Продолжить;
		КонецЕсли;
		
		// 2. Завершение, если план выполнен
		Если ИИА_Сервер.ПланЗавершен(СсылкаДиалога) Тогда
			ИИА_Сервер.ВыполнитьФинальнуюПроверкуИSummary(СсылкаДиалога);
			Диалог = СсылкаДиалога.ПолучитьОбъект();
			Диалог.ОркестраторВключен = Ложь;
			Диалог.Записать();
			Прервать;
		КонецЕсли;
		
		// 3. Генерация следующего шага
		ИИА_Сервер.СгенерироватьПродолжениеВыполнения(СсылкаДиалога);
		
	КонецЦикла;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедуры

Процедура ОтправитьУведомление(СсылкаДиалога, ТипСобытия)
	
	ДанныеУведомления = Новый Структура;
	ДанныеУведомления.Вставить("Диалог", СсылкаДиалога);
	ДанныеУведомления.Вставить("ТипСобытия", ТипСобытия);
	УведомленияКлиента.ОтправитьУведомление("СообщениеПереписки", ДанныеУведомления);
	
КонецПроцедуры

#КонецОбласти
