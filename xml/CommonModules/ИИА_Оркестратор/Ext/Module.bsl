
// Запускает серверный оркестратор (фоновый цикл)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Процедура Запустить(СсылкаДиалога) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) ИЛИ СсылкаДиалога.Пустая() Тогда
		Возврат;
	КонецЕсли;
	
	Если ИИА_Сервер.ОркестраторВключенДляДиалога(СсылкаДиалога) Тогда
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Оркестратор] Уже работает, повторный запуск пропущен");
		Возврат;
	КонецЕсли;
	
	ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Истина);
	
	ИмяЗадания = "ИИ_Оркестратор_" + Строка(СсылкаДиалога.УникальныйИдентификатор());
	Параметры = Новый Массив;
	Параметры.Добавить(СсылкаДиалога);
	
	// Получаем начальное количество токенов перед запуском
	НачальныеТокены = ИИА_Сервер.ПолучитьОбщееКоличествоТокенов(СсылкаДиалога);
	Параметры.Добавить(НачальныеТокены);
	
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Оркестратор] Запуск серверного движка...");
	
	ФоновыеЗадания.Выполнить("ИИА_Оркестратор.ВыполнитьЦикл", Параметры, , ИмяЗадания);
	
КонецПроцедуры

// Добавляет сообщение пользователя и запускает оркестратор
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  Текст - Строка - текст сообщения
//  ТипДиалога - ПеречислениеСсылка.ИИА_ТипДиалога - тип диалога
//
Процедура ОтправитьИЗапустить(СсылкаДиалога, Текст, ТипДиалога) Экспорт
	
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Пользователь] " + Текст);
	
	// 1. Добавляем сообщение пользователя через серверный модуль
	ИИА_Сервер.ОтправитьСообщениеСервера(СсылкаДиалога, ТипДиалога, Текст);
	
	// 2. Запускаем оркестратор
	Запустить(СсылкаДиалога);
	
КонецПроцедуры

// Останавливает серверный оркестратор (мягкая остановка)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
Процедура Остановить(СсылкаДиалога) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	Если НЕ ИИА_Сервер.ОркестраторВключенДляДиалога(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Ложь);
	
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Оркестратор] Остановка пользователем.");
	
	ОтправитьУведомление(СсылкаДиалога, "ОстановленПользователем");
	
КонецПроцедуры

// Основной цикл серверного оркестратора
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//  НачальныеТокены - Число - количество токенов на момент старта
//
Процедура ВыполнитьЦикл(СсылкаДиалога, НачальныеТокены = 0) Экспорт
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	ДиалогОбъект = СсылкаДиалога.ПолучитьОбъект();
	Настройки = ИИА_Сервер.ПолучитьНастройкиПользователя(ДиалогОбъект.Пользователь);
	ЛимитНаЗапуск = Настройки.ЛимитТокеновНаЗапуск;
	
	// Очищаем файл лога отладки при каждом запуске (Запустить / Отправить из формы агента)
	ИИА_Сервер.ОчиститьФайлЛогаОтладки(СсылкаДиалога);
	ИИА_Сервер.ИнициализироватьКонтекстАрхитектуры(СсылкаДиалога);
	АрхКонтекст = ИИА_Сервер.ПолучитьКонтекстАрхитектуры(СсылкаДиалога);
	Если НЕ ПустаяСтрока(АрхКонтекст.trace_id) Тогда
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[TRACE] trace_id=" + АрхКонтекст.trace_id + ", prompt_version=" + АрхКонтекст.prompt_version);
	КонецЕсли;
	
	СчетчикИтераций = 0;
	МаксимумИтераций = 50; // защита от бесконечного цикла
	ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Intent", "cycle_start", Ложь);
	
	Пока Истина Цикл
		
		Попытка
			Если НЕ ИИА_Сервер.ОркестраторВключенДляДиалога(СсылкаДиалога) Тогда
				Прервать;
			КонецЕсли;
			
			Если ЛимитНаЗапуск > 0 Тогда
				ТекущиеТокены = ИИА_Сервер.ПолучитьОбщееКоличествоТокенов(СсылкаДиалога);
				ПотраченоВЭтомЗапуске = ТекущиеТокены - НачальныеТокены;
				Если ПотраченоВЭтомЗапуске >= ЛимитНаЗапуск Тогда
					ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Ложь);
					ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Остановка: превышен лимит токенов на запуск (" + Строка(ЛимитНаЗапуск) + ")");
					ОбновитьСтатусПоследнегоСообщения(СсылкаДиалога, "Остановлено: превышен лимит токенов на запуск (" + Строка(ЛимитНаЗапуск) + ")");
					ОтправитьУведомление(СсылкаДиалога, "ПревышенЛимитТокенов");
					Прервать;
				КонецЕсли;
			КонецЕсли;
			
			СчетчикИтераций = СчетчикИтераций + 1;
			Если СчетчикИтераций >= МаксимумИтераций Тогда
				ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Остановка: достигнут лимит итераций (" + Строка(МаксимумИтераций) + "). Пропускаем невыполненные шаги.");
				ПропуститьНевыполненныеШагиПлана(СсылкаДиалога);
				ВыполнитьФинальнуюПроверкуИSummary(СсылкаДиалога);
				ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Ложь);
				Прервать;
			КонецЕсли;
			
			СостояниеОркестратора = ИИА_Сервер.ПолучитьСостояниеОркестратора(СсылкаДиалога);
			ТекущаяСтадия = СостояниеОркестратора.ТекущаяСтадия;
			
			Если ТекущаяСтадия = "Intent" Тогда
				НачалоIntent = ТекущаяДатаСеанса();
				ВыполнитьСтадиюIntent(СсылкаДиалога);
				ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Intent", НачалоIntent, Истина, "", "Intent->Plan");
				ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Plan", "intent_done", Ложь);
				Продолжить;
			ИначеЕсли ТекущаяСтадия = "Plan" Тогда
				Если ПланЗавершен(СсылкаДиалога) Тогда
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Summarize", "plan_done", Ложь);
					Продолжить;
				КонецЕсли;
				Если ВыполнитьСтадиюPlan(СсылкаДиалога) Тогда
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Execute", "plan_ready", Ложь);
				Иначе
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Recover", "plan_failed", Истина);
				КонецЕсли;
				Продолжить;
			ИначеЕсли ТекущаяСтадия = "Execute" Тогда
				Если ВыполнитьСтадиюExecute(СсылкаДиалога) Тогда
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Validate", "execute_done", Ложь);
				Иначе
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Recover", "execute_failed", Истина);
				КонецЕсли;
				Продолжить;
			ИначеЕсли ТекущаяСтадия = "Validate" Тогда
				РезультатValidate = ВыполнитьСтадиюValidate(СсылкаДиалога);
				Если РезультатValidate.Свойство("СледующаяСтадия") Тогда
					СледующаяСтадия = РезультатValidate.СледующаяСтадия;
					ПричинаПерехода = ?(РезультатValidate.Свойство("Причина"), РезультатValidate.Причина, "");
					УвеличитьПопытку = (СледующаяСтадия = "Recover");
					Если СледующаяСтадия = "Plan" Тогда
						ПричинаПерехода = "reset_attempt";
					КонецЕсли;
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, СледующаяСтадия, ПричинаПерехода, УвеличитьПопытку);
				Иначе
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Plan", "validate_default", Ложь);
				КонецЕсли;
				Продолжить;
			ИначеЕсли ТекущаяСтадия = "Recover" Тогда
				Если ВыполнитьСтадиюRecover(СсылкаДиалога) Тогда
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Plan", "reset_attempt", Ложь);
				Иначе
					ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Summarize", "recover_failed", Ложь);
				КонецЕсли;
				Продолжить;
			ИначеЕсли ТекущаяСтадия = "Summarize" Тогда
				ВыполнитьФинальнуюПроверкуИSummary(СсылкаДиалога);
				ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Ложь);
				Прервать;
			Иначе
				ИИА_Сервер.УстановитьСостояниеОркестратора(СсылкаДиалога, "Intent", "unknown_stage", Ложь);
			КонецЕсли;
			
		Исключение
			ТекстОшибки = ОписаниеОшибки();
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Оркестратор] КРИТИЧЕСКАЯ ОШИБКА: " + ТекстОшибки);
			ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Ложь);
			ОбновитьСтатусПоследнегоСообщения(СсылкаДиалога, "Остановлено: внутренняя ошибка");
			ОтправитьУведомление(СсылкаДиалога, "ОшибкаОркестратора");
			Прервать;
		КонецПопытки;
		
	КонецЦикла;
	
КонецПроцедуры

#Область ПланированиеИУправление

Функция ОпределитьRAGДляПлана(ТекстЗадачи, ТипДиалога) Экспорт
	
	Результат = Новый Структура("ИспользоватьRAG,Причина", Ложь, "");
	
	Если ПустаяСтрока(ТекстЗадачи) Тогда
		Результат.Причина = "Пустой текст задачи";
		Возврат Результат;
	КонецЕсли;
	
	// RAG всегда включён - пользователь работает с данными базы, подсказки по метаданным полезны
	Результат.ИспользоватьRAG = Истина;
	Результат.Причина = "RAG включён по умолчанию для работы с данными 1С";
	Возврат Результат;
	
КонецФункции

Функция ЭтоЗапросПодсчета(ТекстЗадачи) Экспорт
	
	Если ПустаяСтрока(ТекстЗадачи) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ТекстВРег = ВРег(ТекстЗадачи);
	Если СтрНайти(ТекстВРег, "СКОЛЬКО") > 0 Тогда
		Возврат Истина;
	КонецЕсли;
	Если СтрНайти(ТекстВРег, "КОЛИЧЕСТВ") > 0 Тогда
		Возврат Истина;
	КонецЕсли;
	
	Возврат Ложь;
	
КонецФункции

Функция КлючДействияИзDSL(DSL_JSON)
	
	Если ПустаяСтрока(DSL_JSON) Тогда
		Возврат "";
	КонецЕсли;
	
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(DSL_JSON);
		Сценарий = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		Шаг = Неопределено;
		Если ТипЗнч(Сценарий) = Тип("Структура") Тогда
			Если Сценарий.Свойство("steps") И ТипЗнч(Сценарий.steps) = Тип("Массив") И Сценарий.steps.Количество() > 0 Тогда
				Шаг = Сценарий.steps[0];
			ИначеЕсли Сценарий.Свойство("action") Тогда
				Шаг = Сценарий;
			КонецЕсли;
		КонецЕсли;
		
		Если Шаг = Неопределено Или НЕ Шаг.Свойство("action") Тогда
			Возврат "";
		КонецЕсли;
		
		Ключ = ВРег(Строка(Шаг.action));
		Если Шаг.Свойство("object_type") И Шаг.Свойство("object_name") Тогда
			Ключ = Ключ + ":" + Строка(Шаг.object_type) + "." + Строка(Шаг.object_name);
		ИначеЕсли Шаг.Свойство("query") Тогда
			Ключ = Ключ + ":" + Лев(ВРег(Строка(Шаг.query)), 80);
		КонецЕсли;
		
		Возврат Ключ;
	Исключение
		ТекстОшибки = ОписаниеОшибки();
	КонецПопытки;
	
	Возврат "";
	
КонецФункции

Функция ЭтоПовторДействия(СсылкаДиалога, DSL_JSON, Порог = 2) Экспорт
	
	КлючНового = КлючДействияИзDSL(DSL_JSON);
	Если ПустаяСтрока(КлючНового) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	КоличествоСообщений = Диалог.Сообщения.Количество();
	Если КоличествоСообщений = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Счетчик = 0;
	Индекс = КоличествоСообщений - 1;
	Пока Индекс >= 0 Цикл
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		Если СтрокаСообщения.Автор <> Перечисления.ИИА_АвторСообщения.ИИ Тогда
			Индекс = Индекс - 1;
			Продолжить;
		КонецЕсли;
		Если ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			Индекс = Индекс - 1;
			Продолжить;
		КонецЕсли;
		
		КлючПрошлого = КлючДействияИзDSL(СтрокаСообщения.ТекстКода);
		Если ПустаяСтрока(КлючПрошлого) Тогда
			Индекс = Индекс - 1;
			Продолжить;
		КонецЕсли;
		
		Если КлючПрошлого = КлючНового Тогда
			Счетчик = Счетчик + 1;
			Если Счетчик >= Порог Тогда
				Возврат Истина;
			КонецЕсли;
		ИначеЕсли Счетчик > 0 Тогда
			Прервать;
		КонецЕсли;
		
		Индекс = Индекс - 1;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция ИнициализироватьПлан(СсылкаДиалога) Экспорт
	
	// Получаем последнюю задачу пользователя (для последующих команд в диалоге)
	РезультатЗадачи = ИИА_Сервер.ПолучитьПоследнееСообщениеПользователя(СсылкаДиалога);
	Если НЕ РезультатЗадачи.Найдено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ТекстЗадачи = РезультатЗадачи.Текст;
	
	// Формируем промпт для создания плана
	ПромптПлана = ИИА_Промты.ПолучитьПромптСозданияПлана(ТекстЗадачи, СсылкаДиалога);
	Если ЭтоЗапросПодсчета(ТекстЗадачи) Тогда
		ПромптПлана = ПромптПлана + Символы.ПС +
		"Дополнительно: если задача содержит 'сколько/количество', план должен включать RunQuery с КОЛИЧЕСТВО(...) и ShowInfo.";
	КонецЕсли;
	
	// Вызываем ИИ (через системное сообщение)
	ПараметрыRAG = ОпределитьRAGДляПлана(ТекстЗадачи, СсылкаДиалога.ТипДиалога);
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[RAG_DECISION] План: " + ?(ПараметрыRAG.ИспользоватьRAG, "включен", "выключен") + ". " + ПараметрыRAG.Причина);
	ОтветИИ = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптПлана, ИИА_Промты.ПолучитьТекстПромптаПланировщика(), "plan_json_array", , ПараметрыRAG.ИспользоватьRAG);
	
	Если ПустаяСтрока(ОтветИИ.Текст) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Парсим JSON массив строк
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ОтветИИ.Текст);
		МассивПланов = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		Если ТипЗнч(МассивПланов) <> Тип("Массив") Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// Сохраняем план в диалог
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		Диалог.План.Очистить();
		
		Для Каждого Пункт Из МассивПланов Цикл
			НоваяСтрока = Диалог.План.Добавить();
			НоваяСтрока.Задача = Пункт;
			НоваяСтрока.Выполнена = Ложь;
		КонецЦикла;
		
		Диалог.Записать();
		
		// Отправляем уведомление клиенту о завершении планирования
		ИИА_Сервер.УведомитьОбОбновленииДиалога(СсылкаДиалога, "ПланИнициализирован");
		
		Возврат Истина;
		
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

// Дополняет план новыми задачами для последующей команды пользователя (режим продолжения диалога)
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Булево - Истина при успехе, Ложь при ошибке (вызывающий код может очистить план и использовать ИнициализироватьПлан)
//
Функция ДополнитьПлан(СсылкаДиалога) Экспорт
	
	// Получаем последнюю задачу пользователя
	РезультатЗадачи = ИИА_Сервер.ПолучитьПоследнееСообщениеПользователя(СсылкаДиалога);
	Если НЕ РезультатЗадачи.Найдено Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ТекстЗадачи = РезультатЗадачи.Текст;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если Диалог.План.Количество() = 0 Тогда
		// План пуст - дополнять нечего, используем обычную инициализацию
		Возврат Ложь;
	КонецЕсли;
	
	// Преобразуем текущий план в JSON
	МассивПлана = Новый Массив;
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		СтруктураПункта = Новый Структура("Задача, Выполнена, Результат", СтрокаПлана.Задача, СтрокаПлана.Выполнена, СтрокаПлана.Результат);
		МассивПлана.Добавить(СтруктураПункта);
	КонецЦикла;
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, МассивПлана);
	ПланJSON = СжатьJSONДляЛога(ЗаписьJSON.Закрыть());
	
	// Формируем промпт для дополнения плана
	ПромптДополнения = ИИА_Промты.ПолучитьПромптДополненияПлана(ТекстЗадачи, ПланJSON, СсылкаДиалога);
	
	// Вызываем ИИ
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[План] Дополнение плана новой задачей...");
	ПараметрыRAG = ОпределитьRAGДляПлана(ТекстЗадачи, СсылкаДиалога.ТипДиалога);
	ОтветИИ = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптДополнения, ИИА_Промты.ПолучитьТекстПромптаПланировщика(), "plan_json_array", , ПараметрыRAG.ИспользоватьRAG);
	
	Если ПустаяСтрока(ОтветИИ.Текст) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ОтветИИ.Текст);
		МассивНовыхЗадач = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		Если ТипЗнч(МассивНовыхЗадач) <> Тип("Массив") Тогда
			Возврат Ложь;
		КонецЕсли;
		
		Если МассивНовыхЗадач.Количество() = 0 Тогда
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[План] ИИ не вернул новых задач для дополнения.");
			Возврат Ложь;
		КонецЕсли;
		
		// Добавляем новые задачи в конец плана (НЕ очищаем)
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		Для Каждого Пункт Из МассивНовыхЗадач Цикл
			НоваяСтрока = Диалог.План.Добавить();
			НоваяСтрока.Задача = Пункт;
			НоваяСтрока.Выполнена = Ложь;
		КонецЦикла;
		
		Диалог.Записать();
		
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[План] План дополнен " + Строка(МассивНовыхЗадач.Количество()) + " новыми задачами.");
		ИИА_Сервер.УведомитьОбОбновленииДиалога(СсылкаДиалога, "ПланИнициализирован");
		
		Возврат Истина;
		
	Исключение
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[План] Ошибка дополнения плана: " + ОписаниеОшибки());
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция ПолучитьПланДиалога(СсылкаДиалога) Экспорт
	
	Результат = Новый Массив;
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	План.Задача КАК Задача,
	|	План.Выполнена КАК Выполнена,
	|	План.Результат КАК Результат
	|ИЗ
	|	Справочник.ИИА_Диалоги.План КАК План
	|ГДЕ
	|	План.Ссылка = &Ссылка
	|УПОРЯДОЧИТЬ ПО
	|	План.НомерСтроки";
	
	Запрос.УстановитьПараметр("Ссылка", СсылкаДиалога);
	Выборка = Запрос.Выполнить().Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Результат.Добавить(Новый Структура("Задача, Выполнена, Результат", Выборка.Задача, Выборка.Выполнена, Выборка.Результат));
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ОбновитьПланПоРезультатам(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если Диалог.План.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Преобразуем текущий план в JSON
	МассивПлана = Новый Массив;
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		СтруктураПункта = Новый Структура("Задача, Выполнена, Результат", СтрокаПлана.Задача, СтрокаПлана.Выполнена, СтрокаПлана.Результат);
		МассивПлана.Добавить(СтруктураПункта);
	КонецЦикла;
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, МассивПлана);
	ПланJSON = СжатьJSONДляЛога(ЗаписьJSON.Закрыть());
	
	ТекстРезультатов = СобратьФактыПоследнихДействий(СсылкаДиалога);
	ПромптОбновления = ИИА_Промты.ПолучитьПромптОбновленияПлана(ПланJSON, ТекстРезультатов);
	
	// Вызываем ИИ
	ОтветИИ = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптОбновления, "", "plan_json_array", , Ложь);
	
	// Парсим ответ ИИ
	Попытка
		ЧтениеJSON = Новый ЧтениеJSON;
		ЧтениеJSON.УстановитьСтроку(ОтветИИ.Текст);
		ОбновленныйПлан = ПрочитатьJSON(ЧтениеJSON);
		ЧтениеJSON.Закрыть();
		
		Если ТипЗнч(ОбновленныйПлан) <> Тип("Массив") Тогда
			Возврат Ложь;
		КонецЕсли;
		
		// Обновляем ТЧ План в диалоге (сопоставление по индексу для поддержки подстановки объекта)
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		ИндексПлана = 0;
		ИндексПоследнегоВыполненногоРunQuery = -1;
		
		Для Каждого ПунктОбновления Из ОбновленныйПлан Цикл
			Если ИндексПлана >= Диалог.План.Количество() Тогда
				Прервать;
			КонецЕсли;
			
			СтрокаПлана = Диалог.План[ИндексПлана];
			СтрокаПлана.Выполнена = ПунктОбновления.Выполнена;
			СтрокаПлана.Результат = ПунктОбновления.Результат;
			
			Если СтрокаПлана.Выполнена И СтрНайти(ВРег(СтрокаПлана.Задача), "RUNQUERY") > 0 Тогда
				ИндексПоследнегоВыполненногоРunQuery = ИндексПлана;
			КонецЕсли;
			
			ИндексПлана = ИндексПлана + 1;
		КонецЦикла;
		
		// Подстановка: для последнего выполненного RunQuery обновляем Задача на актуальный query при отличии
		Если ИндексПоследнегоВыполненногоРunQuery >= 0 Тогда
			СтрокаПлана = Диалог.План[ИндексПоследнегоВыполненногоРunQuery];
			ВыполненныйQuery = ИзвлечьВыполненныйRunQueryИзДиалога(СсылкаДиалога);
			Если НЕ ПустаяСтрока(ВыполненныйQuery) Тогда
				QueryВПлане = ИзвлечьQueryИзЗадачиRunQuery(СтрокаПлана.Задача);
				Если НЕ ПустаяСтрока(QueryВПлане) И СокрЛП(ВыполненныйQuery) <> СокрЛП(QueryВПлане) Тогда
					QueryЭкранированный = СтрЗаменить(ВыполненныйQuery, "'", "''");
					СтрокаПлана.Задача = "RunQuery{query:'" + QueryЭкранированный + "'}";
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Диалог.Записать();
		
		// Отправляем уведомление об обновлении плана
		ИИА_Сервер.УведомитьОбОбновленииДиалога(СсылкаДиалога, "ПланОбновлен");
		
		Возврат Истина;
		
	Исключение
		Возврат Ложь;
	КонецПопытки;
	
КонецФункции

Функция ПолучитьСледующийПунктПлана(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		Если НЕ СтрокаПлана.Выполнена Тогда
			Возврат СтрокаПлана.Задача;
		КонецЕсли;
	КонецЦикла;
	
	Возврат "";
	
КонецФункции

Функция ПланЗавершен(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если Диалог.План.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		Если НЕ СтрокаПлана.Выполнена Тогда
			Возврат Ложь;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Истина;
	
КонецФункции

// Помечает все невыполненные шаги плана как выполненные с результатом "Пропущено (лимит итераций)"
Процедура ПропуститьНевыполненныеШагиПлана(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		Если НЕ СтрокаПлана.Выполнена Тогда
			СтрокаПлана.Выполнена = Истина;
			СтрокаПлана.Результат = "Пропущено (лимит итераций)";
		КонецЕсли;
	КонецЦикла;
	
	Диалог.Записать();
	
КонецПроцедуры

// Пропускает шаги плана (ShowInfo об открытии формы), бессмысленные без GUI.
// SelectObject выполняется в режиме агента 1С (загрузка объекта в контекст) - НЕ пропускаем.
Функция ПропуститьПроблемныеШагиПлана(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	// Находим первый невыполненный шаг
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		Если СтрокаПлана.Выполнена Тогда
			Продолжить;
		КонецЕсли;
		
		ЗадачаВРег = ВРег(СтрокаПлана.Задача);
		
		// Для ShowInfo "открыт для просмотра" - пропускаем (нет GUI)
		Если СтрНайти(ЗадачаВРег, "SHOWINFO") > 0 И СтрНайти(ЗадачаВРег, "ОТКРЫТ") > 0 Тогда
			СтрокаПлана.Выполнена = Истина;
			СтрокаПлана.Результат = "Пропущено (режим без GUI)";
			Диалог.Записать();
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Шаг """ + СтрокаПлана.Задача + """ пропущен (нет интерфейса).");
			Возврат Истина;
		КонецЕсли;
		
		// Проверяем только первый невыполненный шаг
		Прервать;
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции

Функция ПолучитьНевыполненныеЗадачиПользователя(СсылкаДиалога) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Найдено", Ложь);
	Результат.Вставить("ТекстЗадач", "");
	Результат.Вставить("КоличествоЗадач", 0);
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	МассивЗадач = Новый Массив;
	
	Для Каждого СтрокаСообщения Из Диалог.Сообщения Цикл
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
			ТекстЗадачи = СокрЛП(СтрокаСообщения.Текст);
			Если НЕ ПустаяСтрока(ТекстЗадачи) Тогда
				МассивЗадач.Добавить(ТекстЗадачи);
			КонецЕсли;
		КонецЕсли;
	КонецЦикла;
	
	Если МассивЗадач.Количество() > 0 Тогда
		Результат.Найдено = Истина;
		Результат.КоличествоЗадач = МассивЗадач.Количество();
		
		ТекстЗадач = "";
		Для Индекс = 0 По МассивЗадач.Количество() - 1 Цикл
			Если Индекс > 0 Тогда
				ТекстЗадач = ТекстЗадач + Символы.ПС;
			КонецЕсли;
			ТекстЗадач = ТекстЗадач + МассивЗадач[Индекс];
		КонецЦикла;
		
		Результат.ТекстЗадач = ТекстЗадач;
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции

Процедура ПротоколироватьМетрикуСтадии(СсылкаДиалога, StageName, Начало, Успех, Ошибка = "", StateTransition = "", RecoveryPolicyId = "", AttemptNo = 0, SafetyGateResult = "")
	ДлительностьМС = 0;
	Попытка
		ДлительностьМС = Цел(((ТекущаяДатаСеанса() - Начало) * 1000));
	Исключение
		ДлительностьМС = 0;
	КонецПопытки;
	
	АрхКонтекст = ИИА_Сервер.ПолучитьКонтекстАрхитектуры(СсылкаДиалога);
	Trace = ?(АрхКонтекст <> Неопределено И АрхКонтекст.Свойство("trace_id"), АрхКонтекст.trace_id, "");
	Сообщение = "[OBSERVE] stage=" + StageName + ", success=" + ?(Успех, "true", "false") + ", duration_ms=" + Строка(ДлительностьМС);
	Если НЕ ПустаяСтрока(Строка(Trace)) Тогда
		Сообщение = Сообщение + ", trace_id=" + Строка(Trace);
	КонецЕсли;
	Если НЕ ПустаяСтрока(Ошибка) Тогда
		Сообщение = Сообщение + ", error=" + Ошибка;
	КонецЕсли;
	Если НЕ ПустаяСтрока(StateTransition) Тогда
		Сообщение = Сообщение + ", state_transition=" + StateTransition;
	КонецЕсли;
	Если НЕ ПустаяСтрока(RecoveryPolicyId) Тогда
		Сообщение = Сообщение + ", recovery_policy_id=" + RecoveryPolicyId;
	КонецЕсли;
	Если AttemptNo > 0 Тогда
		Сообщение = Сообщение + ", attempt_no=" + Строка(AttemptNo);
	КонецЕсли;
	Если НЕ ПустаяСтрока(SafetyGateResult) Тогда
		Сообщение = Сообщение + ", safety_gate_result=" + SafetyGateResult;
	КонецЕсли;
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, Сообщение);
КонецПроцедуры

Функция ВыполнитьСтадиюIntent(СсылкаДиалога)
	Результат = ПолучитьНевыполненныеЗадачиПользователя(СсылкаДиалога);
	Возврат Результат;
КонецФункции

Функция ВыполнитьСтадиюPlan(СсылкаДиалога) Экспорт
	НачалоPlan = ТекущаяДатаСеанса();
	
	ПланДанные = ПолучитьПланДиалога(СсылкаДиалога);
	Если ПланДанные.Количество() = 0 Тогда
		Если НЕ ИнициализироватьПлан(СсылкаДиалога) Тогда
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Ложь, "init_plan_failed", "Plan->Recover");
			Возврат Ложь;
		КонецЕсли;
		ПланДанные = ПолучитьПланДиалога(СсылкаДиалога);
	КонецЕсли;
	
	ТекстРезультатов = СобратьФактыПоследнихДействий(СсылкаДиалога);
	Если НЕ ПустаяСтрока(ТекстРезультатов) Тогда
		Если НЕ ОбновитьПланПоРезультатам(СсылкаДиалога) Тогда
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Plan] Ошибка обновления плана, продолжаем с текущим планом.");
		КонецЕсли;
	КонецЕсли;
	
	Если ПланЗавершен(СсылкаДиалога) Тогда
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Истина, "plan_completed", "Plan->Summarize");
		Возврат Истина;
	КонецЕсли;
	
	ПланДанные = ПолучитьПланДиалога(СсылкаДиалога);
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ПланДанные);
	ПланJSON = СжатьJSONДляЛога(ЗаписьJSON.Закрыть());
	
	ДоступныеПоля = ИзвлечьРеквизитыИзФактов(ТекстРезультатов);
	НеудачныеОбъекты = СобратьНеудачныеОбъектыИзФактов(ТекстРезультатов);
	ПромптСледующегоШага = ИИА_Промты.ПолучитьПромптPlannerСледующегоШага(ПланJSON, ТекстРезультатов, ДоступныеПоля, НеудачныеОбъекты);
	ОтветПланировщика = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптСледующегоШага, "", "dsl", , Истина, Ложь);
	
	Если ПустаяСтрока(ОтветПланировщика.DSL) Тогда
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Ложь, "planner_empty_dsl", "Plan->Recover");
		Возврат Ложь;
	КонецЕсли;
	
	ИИА_Сервер.СохранитьАртефактПланировщика(СсылкаДиалога, ОтветПланировщика.DSL, "planner_generated", Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddHHmmss"));
	ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Истина, "", "Plan->Execute");
	Возврат Истина;
КонецФункции

Функция ВыполнитьСтадиюExecute(СсылкаДиалога) Экспорт
	НачалоExecute = ТекущаяДатаСеанса();
	АртефактПлана = ИИА_Сервер.ПолучитьАртефактПланировщика(СсылкаДиалога);
	DSLДляИсполнения = "";
	Если АртефактПлана <> Неопределено И АртефактПлана.Свойство("PlannedDSL") Тогда
		DSLДляИсполнения = АртефактПлана.PlannedDSL;
	КонецЕсли;
	
	Если ПустаяСтрока(DSLДляИсполнения) Тогда
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Execute", НачалоExecute, Ложь, "empty_planned_dsl", "Execute->Recover");
		Возврат Ложь;
	КонецЕсли;
	
	Если ЭтоПовторДействия(СсылкаДиалога, DSLДляИсполнения, 2) Тогда
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[LOOP_GUARD] Повтор шага DSL обнаружен, выполнение пропущено.");
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Execute", НачалоExecute, Ложь, "loop_guard", "Execute->Recover");
		Возврат Ложь;
	КонецЕсли;
	
	Если ЭтоРанняяСдачаShowInfo(СсылкаДиалога, DSLДляИсполнения) Тогда
		РезультатБлокировки = Новый Структура("Успех,Сообщение,error_code,error_context", Ложь, "Блокировка anti-giveup: ранний ShowInfo с отказом до исчерпания recovery-попыток.", "premature_giveup_blocked", Новый Структура("stage,reason", "Execute", "anti_giveup_guard"));
		ИИА_Сервер.СохранитьРезультатExecutor(СсылкаДиалога, РезультатБлокировки);
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Execute", НачалоExecute, Ложь, "premature_giveup_blocked", "Execute->Recover");
		Возврат Ложь;
	КонецЕсли;
	
	РезультатАвтоDSL = ИИА_Сервер.ВыполнитьDSLСценарийССообщениями(СсылкаДиалога, DSLДляИсполнения);
	ИИА_Сервер.СохранитьРезультатExecutor(СсылкаДиалога, РезультатАвтоDSL);
	
	ПротоколироватьМетрикуСтадии(
		СсылкаДиалога,
		"Execute",
		НачалоExecute,
		?(РезультатАвтоDSL <> Неопределено И РезультатАвтоDSL.Успех, Истина, Ложь),
		?(РезультатАвтоDSL <> Неопределено И РезультатАвтоDSL.Свойство("Сообщение"), РезультатАвтоDSL.Сообщение, ""),
		"Execute->Validate"
	);
	
	Возврат Истина;
КонецФункции

Функция ВыполнитьСтадиюValidate(СсылкаДиалога) Экспорт
	НачалоValidate = ТекущаяДатаСеанса();
	Результат = Новый Структура("СледующаяСтадия,Причина", "Plan", "validate_ok");
	
	РезультатExecutor = ИИА_Сервер.ПолучитьРезультатExecutor(СсылкаДиалога);
	Если РезультатExecutor = Неопределено Тогда
		Результат.СледующаяСтадия = "Recover";
		Результат.Причина = "no_executor_result";
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", НачалоValidate, Ложь, "no_executor_result", "Validate->Recover");
		Возврат Результат;
	КонецЕсли;
	
	Если РезультатExecutor.Свойство("Успех") И РезультатExecutor.Успех Тогда
		Если ПланЗавершен(СсылкаДиалога) Тогда
			Результат.СледующаяСтадия = "Summarize";
			Результат.Причина = "plan_completed";
		Иначе
			Результат.СледующаяСтадия = "Plan";
			Результат.Причина = "next_step";
		КонецЕсли;
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", НачалоValidate, Истина, "", "Validate->" + Результат.СледующаяСтадия);
		Возврат Результат;
	КонецЕсли;
	
	КодОшибки = ИзвлечьКодОшибки(РезультатExecutor);
	СообщениеОшибки = ?(РезультатExecutor.Свойство("Сообщение"), РезультатExecutor.Сообщение, "");
	Состояние = ИИА_Сервер.ПолучитьСостояниеОркестратора(СсылкаДиалога);
	ПопыткаНомер = ?(Состояние <> Неопределено И Состояние.Свойство("НомерПопытки"), Состояние.НомерПопытки, 0);
	
	Если ЭтоВосстановимаяОшибка(КодОшибки) Тогда
		МаксПопыток = ПолучитьМаксПопытокДляОшибки(КодОшибки);
		Если ПопыткаНомер >= МаксПопыток Тогда
			Результат.СледующаяСтадия = "Summarize";
			Результат.Причина = "recovery_exhausted";
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[RECOVERY_EXHAUSTED] error_code=" + КодОшибки + ", attempts=" + Строка(ПопыткаНомер) + ", max_attempts=" + Строка(МаксПопыток));
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", НачалоValidate, Ложь, СообщениеОшибки, "Validate->Summarize", "exhausted_" + КодОшибки, ПопыткаНомер, "");
		Иначе
			Результат.СледующаяСтадия = "Recover";
			Результат.Причина = "recoverable_error";
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", НачалоValidate, Ложь, СообщениеОшибки, "Validate->Recover", КодОшибки, ПопыткаНомер + 1, "");
		КонецЕсли;
		Возврат Результат;
	КонецЕсли;
	
	Результат.СледующаяСтадия = "Recover";
	Результат.Причина = "non_recoverable_error";
	ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", НачалоValidate, Ложь, СообщениеОшибки, "Validate->Recover", КодОшибки, ПопыткаНомер + 1, "");
	
	Возврат Результат;
КонецФункции

Функция ВыполнитьСтадиюRecover(СсылкаДиалога) Экспорт
	РезультатExecutor = ИИА_Сервер.ПолучитьРезультатExecutor(СсылкаДиалога);
	КодОшибки = ?(РезультатExecutor <> Неопределено И РезультатExecutor.Свойство("error_code"), Строка(РезультатExecutor.error_code), "");
	СообщениеОшибки = ?(РезультатExecutor <> Неопределено И РезультатExecutor.Свойство("Сообщение"), РезультатExecutor.Сообщение, "");
	Политика = ПрименитьПолитикуВосстановления(СсылкаДиалога, КодОшибки, СообщениеОшибки);
	Возврат Политика.Обработано;
КонецФункции

Функция ПолучитьРеестрПолитикВосстановления() Экспорт
	Реестр = Новый Соответствие;
	Реестр.Вставить("table_not_found", Новый Структура("id,actions,max_attempts", "table_not_found_policy", "GetMetadata->GetObjectFields->RunQuery", 3));
	Реестр.Вставить("field_not_found", Новый Структура("id,actions,max_attempts", "field_not_found_policy", "RepairDSL|SwitchObject", 3));
	Реестр.Вставить("query_syntax_error", Новый Структура("id,actions,max_attempts", "query_syntax_policy", "RepairDSL", 2));
	Реестр.Вставить("query_execution_error", Новый Структура("id,actions,max_attempts", "query_execution_policy", "RepairDSL|GetObjectFields", 2));
	Реестр.Вставить("parameter_missing", Новый Структура("id,actions,max_attempts", "parameter_missing_policy", "RepairDSL", 2));
	Реестр.Вставить("query_safety_violation", Новый Структура("id,actions,max_attempts", "query_safety_policy", "GetObjectFields|RepairDSL", 3));
	Реестр.Вставить("capability_violation", Новый Структура("id,actions,max_attempts", "capability_violation_policy", "AbortWithExplanation", 1));
	Возврат Реестр;
КонецФункции

Функция ИзвлечьКодОшибки(РезультатExecutor) Экспорт
	КодОшибки = "";
	Если РезультатExecutor = Неопределено Тогда
		Возврат КодОшибки;
	КонецЕсли;
	Если РезультатExecutor.Свойство("error_code") Тогда
		КодОшибки = Строка(РезультатExecutor.error_code);
	КонецЕсли;
	Если ПустаяСтрока(КодОшибки) И РезультатExecutor.Свойство("КодОшибки") Тогда
		КодОшибки = Строка(РезультатExecutor.КодОшибки);
	КонецЕсли;
	Возврат НормализоватьКодОшибки(КодОшибки);
КонецФункции

Функция ЭтоВосстановимаяОшибка(КодОшибки) Экспорт
	Код = НормализоватьКодОшибки(КодОшибки);
	Возврат Код = "field_not_found"
		Или Код = "table_not_found"
		Или Код = "query_syntax_error"
		Или Код = "query_execution_error"
		Или Код = "parameter_missing"
		Или Код = "query_safety_violation";
КонецФункции

Функция ПолучитьМаксПопытокДляОшибки(КодОшибки) Экспорт
	Код = НормализоватьКодОшибки(КодОшибки);
	Реестр = ПолучитьРеестрПолитикВосстановления();
	Политика = Реестр.Получить(Код);
	Если Политика <> Неопределено И Политика.Свойство("max_attempts") Тогда
		Возврат Политика.max_attempts;
	КонецЕсли;
	Возврат 1;
КонецФункции

Функция НормализоватьКодОшибки(КодОшибки) Экспорт
	КодВРег = ВРег(СокрЛП(КодОшибки));
	Если КодВРег = "FIELD_NOT_FOUND" Тогда
		Возврат "field_not_found";
	ИначеЕсли КодВРег = "TABLE_NOT_FOUND" Тогда
		Возврат "table_not_found";
	ИначеЕсли КодВРег = "QUERY_SYNTAX_ERROR" Тогда
		Возврат "query_syntax_error";
	ИначеЕсли КодВРег = "QUERY_EXECUTION_ERROR" Тогда
		Возврат "query_execution_error";
	ИначеЕсли КодВРег = "PARAMETER_MISSING" Тогда
		Возврат "parameter_missing";
	ИначеЕсли КодВРег = "QUERY_SAFETY_VIOLATION" Тогда
		Возврат "query_safety_violation";
	ИначеЕсли КодВРег = "CAPABILITY_VIOLATION" Тогда
		Возврат "capability_violation";
	КонецЕсли;
	Возврат СокрЛП(КодОшибки);
КонецФункции

Функция ЭтоРанняяСдачаShowInfo(СсылкаДиалога, DSLСценарий) Экспорт
	Если ПустаяСтрока(DSLСценарий) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	ТекстDSLВРег = ВРег(DSLСценарий);
	ПохожеНаСдачуПоТексту = СтрНайти(ТекстDSLВРег, "SHOWINFO") > 0
		И (СтрНайти(ТекстDSLВРег, "ЗАДАЧА НЕ ВЫПОЛНЕНА") > 0 ИЛИ СтрНайти(ТекстDSLВРег, "НЕТ:") > 0);
	
	Попытка
		Чтение = Новый ЧтениеJSON;
		Чтение.УстановитьСтроку(DSLСценарий);
		Данные = ПрочитатьJSON(Чтение);
		Чтение.Закрыть();
		ЕстьSteps = Ложь;
		Шаги = Неопределено;
		Если ТипЗнч(Данные) = Тип("Структура") И Данные.Свойство("steps") Тогда
			ЕстьSteps = Истина;
			Шаги = Данные.steps;
		ИначеЕсли ТипЗнч(Данные) = Тип("Соответствие") Тогда
			Шаги = Данные.Получить("steps");
			ЕстьSteps = Шаги <> Неопределено;
		КонецЕсли;
		Если НЕ ЕстьSteps Тогда
			Если НЕ ПохожеНаСдачуПоТексту Тогда
				Возврат Ложь;
			КонецЕсли;
			
			ПредРезультат = ИИА_Сервер.ПолучитьРезультатExecutor(СсылкаДиалога);
			КодОшибки = ИзвлечьКодОшибки(ПредРезультат);
			Если НЕ ЭтоВосстановимаяОшибка(КодОшибки) Тогда
				Возврат Ложь;
			КонецЕсли;
			Состояние = ИИА_Сервер.ПолучитьСостояниеОркестратора(СсылкаДиалога);
			ПопыткаНомер = ?(Состояние <> Неопределено И Состояние.Свойство("НомерПопытки"), Состояние.НомерПопытки, 0);
			МаксПопыток = ПолучитьМаксПопытокДляОшибки(КодОшибки);
			Возврат ПопыткаНомер < МаксПопыток;
		КонецЕсли;
		Если НЕ ЕстьSteps Тогда
			Возврат Ложь;
		КонецЕсли;
		Если ТипЗнч(Шаги) <> Тип("Массив") Или Шаги.Количество() <> 1 Тогда
			Возврат Ложь;
		КонецЕсли;
		Шаг = Шаги[0];
		Если ТипЗнч(Шаг) <> Тип("Структура") И ТипЗнч(Шаг) <> Тип("Соответствие") Тогда
			Возврат Ложь;
		КонецЕсли;
		ЕстьAction = Ложь;
		Действие = "";
		Если ТипЗнч(Шаг) = Тип("Структура") И Шаг.Свойство("action") Тогда
			ЕстьAction = Истина;
			Действие = Шаг.action;
		ИначеЕсли ТипЗнч(Шаг) = Тип("Соответствие") Тогда
			ЗначениеAction = Шаг.Получить("action");
			Если ЗначениеAction <> Неопределено Тогда
				ЕстьAction = Истина;
				Действие = ЗначениеAction;
			КонецЕсли;
		КонецЕсли;
		Если НЕ ЕстьAction Или ВРег(СокрЛП(Действие)) <> "SHOWINFO" Тогда
			Возврат Ложь;
		КонецЕсли;
		Сообщение = "";
		Если ТипЗнч(Шаг) = Тип("Структура") И Шаг.Свойство("message") Тогда
			Сообщение = ВРег(Строка(Шаг.message));
		ИначеЕсли ТипЗнч(Шаг) = Тип("Соответствие") И Шаг.Получить("message") <> Неопределено Тогда
			Сообщение = ВРег(Строка(Шаг.Получить("message")));
		КонецЕсли;
		Если СтрНайти(Сообщение, "ЗАДАЧА НЕ ВЫПОЛНЕНА") = 0 И СтрНайти(Сообщение, "НЕТ:") = 0 Тогда
			Возврат Ложь;
		КонецЕсли;
		
		ПредРезультат = ИИА_Сервер.ПолучитьРезультатExecutor(СсылкаДиалога);
		КодОшибки = ИзвлечьКодОшибки(ПредРезультат);
		Если НЕ ЭтоВосстановимаяОшибка(КодОшибки) Тогда
			Возврат Ложь;
		КонецЕсли;
		
		Состояние = ИИА_Сервер.ПолучитьСостояниеОркестратора(СсылкаДиалога);
		ПопыткаНомер = ?(Состояние <> Неопределено И Состояние.Свойство("НомерПопытки"), Состояние.НомерПопытки, 0);
		МаксПопыток = ПолучитьМаксПопытокДляОшибки(КодОшибки);
		Возврат ПопыткаНомер < МаксПопыток;
	Исключение
		Возврат Ложь;
	КонецПопытки;
КонецФункции

Функция СформироватьRecoveryDSLGetObjectFields(ИмяТаблицы) Экспорт
	ЛокИмя = СокрЛП(ИмяТаблицы);
	Если ПустаяСтрока(ЛокИмя) Тогда
		Возврат "";
	КонецЕсли;
	
	ПозицияТочки = СтрНайти(ЛокИмя, ".");
	Если ПозицияТочки = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Префикс = ВРег(Лев(ЛокИмя, ПозицияТочки - 1));
	ИмяОбъекта = СокрЛП(Сред(ЛокИмя, ПозицияТочки + 1));
	Если ПустаяСтрока(ИмяОбъекта) Тогда
		Возврат "";
	КонецЕсли;
	
	ТипОбъекта = "";
	Если Префикс = "ДОКУМЕНТ" Тогда
		ТипОбъекта = "Документ";
	ИначеЕсли Префикс = "СПРАВОЧНИК" Тогда
		ТипОбъекта = "Справочник";
	ИначеЕсли Префикс = "РЕГИСТРНАКОПЛЕНИЯ" Тогда
		ТипОбъекта = "РегистрНакопления";
	ИначеЕсли Префикс = "РЕГИСТРСВЕДЕНИЙ" Тогда
		ТипОбъекта = "РегистрСведений";
	КонецЕсли;
	
	Если ПустаяСтрока(ТипОбъекта) Тогда
		Возврат "";
	КонецЕсли;
	
	Возврат "{""dsl_version"":2,""steps"":[{""action"":""GetObjectFields"",""object_type"":""" + ТипОбъекта + """,""object_name"":""" + ИмяОбъекта + """}]}";
КонецФункции

Функция СохранитьRecoveryАртефактЕслиВалиден(СсылкаДиалога, DSLКандидат, Причина, Действие, Результат)
	Если ПустаяСтрока(DSLКандидат) Тогда
		Возврат Ложь;
	КонецЕсли;
	Если ЭтоРанняяСдачаShowInfo(СсылкаДиалога, DSLКандидат) Тогда
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[ANTI_GIVEUP] Recovery-ответ отклонен: ранний negative ShowInfo.");
		Возврат Ложь;
	КонецЕсли;
	ИИА_Сервер.СохранитьАртефактПланировщика(СсылкаДиалога, DSLКандидат, Причина, Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddHHmmss"));
	Результат.Обработано = Истина;
	Результат.Действие = Действие;
	Возврат Истина;
КонецФункции

Функция ПрименитьПолитикуВосстановления(СсылкаДиалога, КодОшибки, СообщениеОшибки) Экспорт
	Результат = Новый Структура("Обработано,Идентификатор,Действие", Ложь, "", "");
	ЛокКод = НормализоватьКодОшибки(КодОшибки);
	Если ПустаяСтрока(ЛокКод) Тогда
		ТекстВРег = ВРег(СообщениеОшибки);
		Если СтрНайти(ТекстВРег, "ТАБЛИЦА") > 0 И СтрНайти(ТекстВРег, "НЕ НАЙД") > 0 Тогда
			ЛокКод = "table_not_found";
		ИначеЕсли СтрНайти(ТекстВРег, "ПОЛЕ НЕ НАЙД") > 0 Тогда
			ЛокКод = "field_not_found";
		ИначеЕсли СтрНайти(ТекстВРег, "СИНТАКС") > 0 Тогда
			ЛокКод = "query_syntax_error";
		КонецЕсли;
	КонецЕсли;
	
	Реестр = ПолучитьРеестрПолитикВосстановления();
	Политика = Реестр.Получить(ЛокКод);
	Если Политика = Неопределено Тогда
		Возврат Результат;
	КонецЕсли;
	
	Результат.Идентификатор = Политика.id;
	
	Если ЛокКод = "table_not_found" Тогда
		ИмяТаблицы = ИзвлечьИмяТаблицыИзОшибки(СообщениеОшибки);
		Если НЕ ПустаяСтрока(ИмяТаблицы) И ДобавитьGetMetadataВПланПриТаблицаНеНайдена(СсылкаДиалога, ИмяТаблицы) Тогда
			Результат.Обработано = Истина;
			Результат.Действие = "insert_getmetadata";
		КонецЕсли;
	ИначеЕсли ЛокКод = "field_not_found" Тогда
		АртефактПлана = ИИА_Сервер.ПолучитьАртефактПланировщика(СсылкаДиалога);
		DSLИсходный = ?(АртефактПлана <> Неопределено И АртефактПлана.Свойство("PlannedDSL"), АртефактПлана.PlannedDSL, "");
		ТекстФактов = СобратьФактыПоследнихДействий(СсылкаДиалога);
		ПоляДляRetry = ИзвлечьРеквизитыИзФактов(ТекстФактов);
		ПринятоИсправление = Ложь;
		Если НЕ ПустаяСтрока(DSLИсходный) И НЕ ПустаяСтрока(ПоляДляRetry) Тогда
			ПромптИсправления = ИИА_Промты.ПолучитьПромптИсправленияDSL(СообщениеОшибки, DSLИсходный, ПоляДляRetry);
			ОтветИсправления = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптИсправления, "", "dsl", , Ложь, Ложь);
			ПринятоИсправление = СохранитьRecoveryАртефактЕслиВалиден(СсылкаДиалога, ОтветИсправления.DSL, "recovery_field_not_found", "repair_dsl", Результат);
		КонецЕсли;
		
		Если НЕ ПринятоИсправление Тогда
			ИмяТаблицыДляПоля = ИзвлечьИмяТаблицыИзТекстаЗапроса(СообщениеОшибки);
			Если ПустаяСтрока(ИмяТаблицыДляПоля) Тогда
				ИмяТаблицыДляПоля = ИзвлечьИмяТаблицыИзТекстаЗапроса(DSLИсходный);
			КонецЕсли;
			DSLGetObjectFields = СформироватьRecoveryDSLGetObjectFields(ИмяТаблицыДляПоля);
			Если НЕ ПустаяСтрока(DSLGetObjectFields) Тогда
				ИИА_Сервер.СохранитьАртефактПланировщика(СсылкаДиалога, DSLGetObjectFields, "recovery_field_not_found_getobjectfields", Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddHHmmss"));
				Результат.Обработано = Истина;
				Результат.Действие = "insert_getobjectfields";
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ЛокКод = "query_syntax_error" ИЛИ ЛокКод = "query_execution_error" Тогда
		АртефактПлана = ИИА_Сервер.ПолучитьАртефактПланировщика(СсылкаДиалога);
		DSLИсходный = ?(АртефактПлана <> Неопределено И АртефактПлана.Свойство("PlannedDSL"), АртефактПлана.PlannedDSL, "");
		ПринятоИсправление = Ложь;
		Если НЕ ПустаяСтрока(DSLИсходный) Тогда
			ПромптИсправления = ИИА_Промты.ПолучитьПромптИсправленияDSL(СообщениеОшибки, DSLИсходный, "");
			ОтветИсправления = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптИсправления, "", "dsl", , Ложь, Ложь);
			ПринятоИсправление = СохранитьRecoveryАртефактЕслиВалиден(СсылкаДиалога, ОтветИсправления.DSL, "recovery_query_repair", "repair_syntax", Результат);
		КонецЕсли;
		Если НЕ ПринятоИсправление Тогда
			ИмяТаблицыДляПоля = ИзвлечьИмяТаблицыИзТекстаЗапроса(СообщениеОшибки);
			Если ПустаяСтрока(ИмяТаблицыДляПоля) Тогда
				ИмяТаблицыДляПоля = ИзвлечьИмяТаблицыИзТекстаЗапроса(DSLИсходный);
			КонецЕсли;
			DSLGetObjectFields = СформироватьRecoveryDSLGetObjectFields(ИмяТаблицыДляПоля);
			Если НЕ ПустаяСтрока(DSLGetObjectFields) Тогда
				СохранитьRecoveryАртефактЕслиВалиден(СсылкаДиалога, DSLGetObjectFields, "recovery_query_getobjectfields", "insert_getobjectfields", Результат);
			КонецЕсли;
		КонецЕсли;
	ИначеЕсли ЛокКод = "capability_violation" Тогда
		ИИА_Сервер.ДобавитьСообщениеВДиалог(СсылкаДиалога, Перечисления.ИИА_АвторСообщения.Система, Перечисления.ИИА_ТипСообщения.Текст, "Действие отклонено политикой доступа (capability). Уточни задачу без операций записи или запроси права.");
		Результат.Обработано = Истина;
		Результат.Действие = "abort_with_explanation";
	КонецЕсли;
	
	Если Результат.Обработано Тогда
		Состояние = ИИА_Сервер.ПолучитьСостояниеОркестратора(СсылкаДиалога);
		НомерПопытки = ?(Состояние <> Неопределено И Состояние.Свойство("НомерПопытки"), Состояние.НомерПопытки, 0);
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Recover", ТекущаяДатаСеанса(), Истина, "", "Recover->Plan", Результат.Идентификатор, НомерПопытки + 1, "");
	КонецЕсли;
	
	Возврат Результат;
КонецФункции

Функция СгенерироватьПродолжениеВыполнения(СсылкаДиалога) Экспорт
	
	НачалоIntent = ТекущаяДатаСеанса();
	IntentДанные = ВыполнитьСтадиюIntent(СсылкаДиалога);
	ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Intent", НачалоIntent, Истина, "");
	
	ТекстРезультатов = СобратьФактыПоследнихДействий(СсылкаДиалога);
	
	// Стадия Plan: Обновление плана (пропускаем при пустых фактах - нет новых результатов DSL)
	НачалоPlan = ТекущаяДатаСеанса();
	Если НЕ ПустаяСтрока(ТекстРезультатов) Тогда
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Фаза 1: Обновление статусов плана...");
		Если НЕ ОбновитьПланПоРезультатам(СсылкаДиалога) Тогда
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Ошибка при обновлении плана. Продолжаем с текущим.");
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Ложь, "update_plan_failed");
		Иначе
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] План успешно обновлен.");
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Истина, "");
		КонецЕсли;
	Иначе
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Фаза 1: пропущена (нет фактов выполнения).");
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Plan", НачалоPlan, Истина, "no_facts");
	КонецЕсли;
	
	// Проверяем, остались ли задачи
	ЕстьНевыполненные = Ложь;
	ПланДанные = ПолучитьПланДиалога(СсылкаДиалога);
	Для Каждого Пункт Из ПланДанные Цикл
		Если НЕ Пункт.Выполнена Тогда
			ЕстьНевыполненные = Истина;
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ЕстьНевыполненные Тогда
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Все задачи выполнены. Переход к резюме.");
		Возврат Ложь;
	КонецЕсли;
	
	// Стадия Execute: Генерация и выполнение следующего шага
	НачалоExecute = ТекущаяДатаСеанса();
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Фаза 2: Генерация следующего шага DSL...");
	
	ЗаписьJSON = Новый ЗаписьJSON;
	ЗаписьJSON.УстановитьСтроку();
	ЗаписатьJSON(ЗаписьJSON, ПланДанные);
	ПланJSON = СжатьJSONДляЛога(ЗаписьJSON.Закрыть());
	
	ДоступныеПоля = ИзвлечьРеквизитыИзФактов(ТекстРезультатов);
	НеудачныеОбъекты = СобратьНеудачныеОбъектыИзФактов(ТекстРезультатов);
	ПромптСледующегоШага = ИИА_Промты.ПолучитьПромптГенерацииСледующегоШага(ПланJSON, ТекстРезультатов, ДоступныеПоля, НеудачныеОбъекты);
	
	// Вызываем ИИ для генерации DSL
	ОтветИИ = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптСледующегоШага, "", "dsl", , Истина, Ложь);
	
	Если НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
		Если ЭтоПовторДействия(СсылкаДиалога, ОтветИИ.DSL, 2) Тогда
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[LOOP_GUARD] Повтор шага DSL обнаружен, выполнение пропущено.");
			ИИА_Сервер.ДобавитьСообщениеВДиалог(
				СсылкаДиалога,
				Перечисления.ИИА_АвторСообщения.Система,
				Перечисления.ИИА_ТипСообщения.Текст,
				"[LOOP_GUARD] Обнаружен повтор действия. Выбери следующий шаг плана."
			);
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Execute", НачалоExecute, Ложь, "loop_guard");
			Возврат Истина;
		КонецЕсли;
		
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[RAG_DECISION] Следующий шаг: RAG включен (по умолчанию).");
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Автовыполнение следующего шага...");
		// Сразу выполняем сгенерированный DSL на сервере
		РезультатАвтоDSL = ИИА_Сервер.ВыполнитьDSLСценарийССообщениями(СсылкаДиалога, ОтветИИ.DSL);
		ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Execute", НачалоExecute, ?(РезультатАвтоDSL <> Неопределено И РезультатАвтоDSL.Успех, Истина, Ложь), "");
		
		// Авто-GetMetadata при ошибке "таблица не найдена"
		Если РезультатАвтоDSL <> Неопределено И НЕ РезультатАвтоDSL.Успех Тогда
			ТекстОшибки = ?(РезультатАвтоDSL.Свойство("Сообщение"), РезультатАвтоDSL.Сообщение, "");
			ТекстОшибкиВРег = ВРег(ТекстОшибки);
			Если СтрНайти(ТекстОшибкиВРег, "ТАБЛИЦА") > 0 И (СтрНайти(ТекстОшибкиВРег, "НЕ НАЙДЕНА") > 0 ИЛИ СтрНайти(ТекстОшибкиВРег, "НЕ НАЙДЕН") > 0) Тогда
				ИмяТаблицы = ИзвлечьИмяТаблицыИзОшибки(ТекстОшибки);
				Если НЕ ПустаяСтрока(ИмяТаблицы) И ДобавитьGetMetadataВПланПриТаблицаНеНайдена(СсылкаДиалога, ИмяТаблицы) Тогда
					ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Авто-GetMetadata] Добавлен шаг GetMetadata перед RunQuery (таблица '" + ИмяТаблицы + "' не найдена).");
					ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", ТекущаяДатаСеанса(), Истина, "auto_getmetadata_inserted");
					Возврат Истина;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		// Retry при ошибке "Поле не найдено" - исправляем запрос с учётом полей из GetObjectFields
		Если РезультатАвтоDSL <> Неопределено И НЕ РезультатАвтоDSL.Успех Тогда
			ТекстОшибки = ?(РезультатАвтоDSL.Свойство("Сообщение"), РезультатАвтоDSL.Сообщение, "");
			ТекстОшибкиВРег = ВРег(ТекстОшибки);
			Если СтрНайти(ТекстОшибкиВРег, "ПОЛЕ НЕ НАЙДЕНО") > 0 ИЛИ СтрНайти(ТекстОшибкиВРег, "RUNQUERY") > 0 Тогда
				ИмяТаблицыСОшибкойПоля = ИзвлечьИмяТаблицыИзТекстаЗапроса(ТекстОшибки);
				СчетчикОшибокПоля = 0;
				Если НЕ ПустаяСтрока(ИмяТаблицыСОшибкойПоля) Тогда
					СчетчикОшибокПоля = УвеличитьСчетчикОшибокПоляПоТаблице(СсылкаДиалога, ИмяТаблицыСОшибкойПоля);
					ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Retry] Счетчик ошибок полей для '" + ИмяТаблицыСОшибкойПоля + "': " + Строка(СчетчикОшибокПоля));
				КонецЕсли;
				
				ТекстФактовПоОшибке = СобратьФактыПоследнихДействий(СсылкаДиалога);
				ПоляДляRetry = ИзвлечьРеквизитыИзФактов(ТекстФактовПоОшибке);
				
				// После двух ошибок по одному объекту принудительно пересматриваем выбор объекта через GetMetadata.
				Если СчетчикОшибокПоля >= 2 И НЕ ПустаяСтрока(ИмяТаблицыСОшибкойПоля) Тогда
					Если ДобавитьGetMetadataВПланПриТаблицаНеНайдена(СсылкаДиалога, ИмяТаблицыСОшибкойПоля) Тогда
						ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Recovery] Две ошибки полей по '" + ИмяТаблицыСОшибкойПоля + "'. Добавлен GetMetadata для смены объекта.");
						ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", ТекущаяДатаСеанса(), Истина, "switch_object_after_field_errors");
						Возврат Истина;
					КонецЕсли;
				КонецЕсли;
				
				Если НЕ ПустаяСтрока(ПоляДляRetry) Тогда
					ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Retry] Ошибка RunQuery (поле не найдено). Попытка исправления с полями из GetObjectFields...");
					ПромптИсправления = ИИА_Промты.ПолучитьПромптИсправленияDSL(ТекстОшибки, ОтветИИ.DSL, ПоляДляRetry);
					ОтветИсправления = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптИсправления, "", "dsl", , Ложь, Ложь);
					Если НЕ ПустаяСтрока(ОтветИсправления.DSL) Тогда
						РезультатАвтоDSL = ИИА_Сервер.ВыполнитьDSLСценарийССообщениями(СсылкаДиалога, ОтветИсправления.DSL);
						Если РезультатАвтоDSL <> Неопределено И РезультатАвтоDSL.Успех Тогда
							ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Retry] Запрос исправлен и выполнен успешно.");
							ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", ТекущаяДатаСеанса(), Истина, "retry_success");
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		
		Если РезультатАвтоDSL <> Неопределено И НЕ РезультатАвтоDSL.Успех Тогда
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", ТекущаяДатаСеанса(), Ложь, ?(РезультатАвтоDSL.Свойство("Сообщение"), РезультатАвтоDSL.Сообщение, "dsl_failed"));
		Иначе
			ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Validate", ТекущаяДатаСеанса(), Истина, "");
		КонецЕсли;
		Возврат Истина;
	КонецЕсли;
	
	ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Execute", НачалоExecute, Ложь, "empty_dsl");
	Возврат Ложь;
	
КонецФункции

#КонецОбласти

#Область ПроверкаИРезюме

Функция СгенерироватьSummary(СсылкаДиалога) Экспорт
	
	Попытка
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		
		// Получаем все сообщения диалога для контекста
		МассивИстории = ИИА_Сервер.ПолучитьСообщенияДиалога(СсылкаДиалога, 100);
		История = ИИА_Сервер.ПреобразоватьМассивСообщенийВТаблицу(МассивИстории);
		
		// Получаем информацию о созданных/измененных объектах
		ТекстИзмененныхОбъектов = "";
		Если Диалог.ИзмененныеОбъекты.Количество() > 0 Тогда
			ТекстИзмененныхОбъектов = "Созданные/измененные объекты:" + Символы.ПС;
			Для Каждого СтрокаИзмененныхОбъектов Из Диалог.ИзмененныеОбъекты Цикл
				Если ЗначениеЗаполнено(СтрокаИзмененныхОбъектов.СсылкаНаОбъект) Тогда
					ТекстИзмененныхОбъектов = ТекстИзмененныхОбъектов + "- " + СтрокаИзмененныхОбъектов.СсылкаНаОбъект + Символы.ПС;
				КонецЕсли;
			КонецЦикла;
		Иначе
			ТекстИзмененныхОбъектов = "Объекты не создавались и не изменялись.";
		КонецЕсли;
		
		// Получаем все задачи пользователя из истории диалога
		ТекстЗадач = "";
		Для Каждого СтруктураСообщения Из МассивИстории Цикл
			Если СтруктураСообщения.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
				ТекстЗадачи = СокрЛП(СтруктураСообщения.Текст);
				Если НЕ ПустаяСтрока(ТекстЗадачи) Тогда
					Если НЕ ПустаяСтрока(ТекстЗадач) Тогда
						ТекстЗадач = ТекстЗадач + Символы.ПС;
					КонецЕсли;
					ТекстЗадач = ТекстЗадач + ТекстЗадачи;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		// Извлекаем результаты выполнения DSL из системных сообщений
		ТекстРезультатовDSL = "";
		Для Индекс = 0 По МассивИстории.Количество() - 1 Цикл
			СтруктураСообщения = МассивИстории[Индекс];
			
			Если СтруктураСообщения.Автор = Перечисления.ИИА_АвторСообщения.ИИ 
				И НЕ ПустаяСтрока(СтруктураСообщения.ТекстКода) Тогда
				
				Если Индекс + 1 < МассивИстории.Количество() Тогда
					СледующееСообщение = МассивИстории[Индекс + 1];
					Если СледующееСообщение.Автор = Перечисления.ИИА_АвторСообщения.Система 
						И НЕ ПустаяСтрока(СледующееСообщение.Текст) Тогда
						
						ТекстРезультата = СокрЛП(СледующееСообщение.Текст);
						Если НЕ ПустаяСтрока(ТекстРезультата) Тогда
							Если НЕ ПустаяСтрока(ТекстРезультатовDSL) Тогда
								ТекстРезультатовDSL = ТекстРезультатовDSL + Символы.ПС;
							КонецЕсли;
							ТекстРезультатовDSL = ТекстРезультатовDSL + "DSL-сценарий: " + СокрЛП(СтруктураСообщения.ТекстКода) + Символы.ПС;
							ТекстРезультатовDSL = ТекстРезультатовDSL + "Результат: " + ТекстРезультата;
						КонецЕсли;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		КонецЦикла;
		
		// Получаем настройки ИИ для пользователя диалога
		Пользователь = Диалог.Пользователь;
		ПараметрыИИ = ИИА_Сервер.ПолучитьНастройкиПользователя(Пользователь);
		ПараметрыИИ.Вставить("Пользователь", Пользователь);
		
		// Формируем промпт для генерации summary
		ПромптSummary = ИИА_Промты.СформироватьПромптРезюме(ТекстЗадач, ТекстИзмененныхОбъектов, ТекстРезультатовDSL);
		
		// Вызываем ИИ для генерации summary
		ОтветИИ = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптSummary, "", "text");
		
		ТекстSummary = "";
		Если ОтветИИ.Свойство("Текст") И НЕ ПустаяСтрока(ОтветИИ.Текст) Тогда
			ТекстSummary = ОтветИИ.Текст;
		ИначеЕсли ОтветИИ.Свойство("DSL") И НЕ ПустаяСтрока(ОтветИИ.DSL) Тогда
			ТекстSummary = ОтветИИ.DSL;
		КонецЕсли;
		
		Если СтрНачинаетсяС(СокрЛП(ТекстSummary), "{") Тогда
			Попытка
				Чтение = Новый ЧтениеJSON;
				Чтение.УстановитьСтроку(ТекстSummary);
				ДанныеJSON = ПрочитатьJSON(Чтение);
				Чтение.Закрыть();
				
				Если ТипЗнч(ДанныеJSON) = Тип("Структура") Тогда
					Если ДанныеJSON.Свойство("summary") Тогда
						ТекстSummary = ДанныеJSON.summary;
					ИначеЕсли ДанныеJSON.Свойство("text") Тогда
						ТекстSummary = ДанныеJSON.text;
					ИначеЕсли ДанныеJSON.Свойство("резюме") Тогда
						ТекстSummary = ДанныеJSON.резюме;
					КонецЕсли;
				КонецЕсли;
			Исключение
				ТекстОшибки = ОписаниеОшибки();
			КонецПопытки;
		КонецЕсли;
		
		Возврат ТекстSummary;
		
	Исключение
		Возврат "Ошибка при генерации summary: " + ОписаниеОшибки();
	КонецПопытки;
	
КонецФункции

Функция ИзвлечьSummaryИзТекста(Знач ИсходныйТекст) Экспорт
	
	ЧистыйТекст = "";
	
	ТекстБезЗаголовка = СтрЗаменить(ИсходныйТекст, "=== РЕЗЮМЕ ВЫПОЛНЕННОЙ РАБОТЫ ===", "");
	
	ПозНачалаJSON = СтрНайти(ТекстБезЗаголовка, "```json");
	ПозКонцаJSON = СтрНайти(ТекстБезЗаголовка, "```", НаправлениеПоиска.СКонца);
	
	Если ПозНачалаJSON > 0 И ПозКонцаJSON > ПозНачалаJSON Тогда
		Префикс = Лев(ТекстБезЗаголовка, ПозНачалаJSON - 1);
		СтрокаJSON = Сред(ТекстБезЗаголовка, ПозНачалаJSON + 7, ПозКонцаJSON - (ПозНачалаJSON + 7));
		
		Попытка
			Чтение = Новый ЧтениеJSON;
			Чтение.УстановитьСтроку(СтрокаJSON);
			ДанныеJSON = ПрочитатьJSON(Чтение);
			Чтение.Закрыть();
			
			Если ТипЗнч(ДанныеJSON) = Тип("Структура") И ДанныеJSON.Свойство("summary") Тогда
				ЧистыйТекст = СокрЛП(Префикс) + Символы.ПС + Символы.ПС + ДанныеJSON.summary;
			ИначеЕсли ТипЗнч(ДанныеJSON) = Тип("Соответствие") И ДанныеJSON.Получить("summary") <> Неопределено Тогда
				ЧистыйТекст = СокрЛП(Префикс) + Символы.ПС + Символы.ПС + ДанныеJSON.Получить("summary");
			Иначе
				ЧистыйТекст = ТекстБезЗаголовка;
			КонецЕсли;
		Исключение
			ЧистыйТекст = ТекстБезЗаголовка;
		КонецПопытки;
	Иначе
		ЧистыйТекст = ТекстБезЗаголовка;
	КонецЕсли;
	
	Возврат СокрЛП(ЧистыйТекст);
	
КонецФункции

Процедура ВыполнитьФинальнуюПроверкуИSummary(СсылкаДиалога) Экспорт
	
	ИИА_Сервер.ОчиститьКонтекстDSLДиалога(СсылкаДиалога);
	
	РезультатПроверки = ПроверитьРезультатВыполненияЗадачи(СсылкаДиалога);
	ИИА_Сервер.УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, РезультатПроверки.ПроверкаВыполнена, РезультатПроверки.Причина);
	
	ТекстSummary = СгенерироватьSummary(СсылкаДиалога);
	ПротоколироватьМетрикуСтадии(СсылкаДиалога, "Summarize", ТекущаяДатаСеанса(), НЕ ПустаяСтрока(ТекстSummary), "");
	Если НЕ ПустаяСтрока(ТекстSummary) Тогда
		Дополнение = "";
		Если НЕ ПустаяСтрока(РезультатПроверки.Причина) Тогда
			Дополнение = Символы.ПС + Символы.ПС + "Проверка: " + РезультатПроверки.Причина;
		КонецЕсли;
		
		ТекстSummary = ТекстSummary + Дополнение;
		
		ИИА_Сервер.ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			"=== РЕЗЮМЕ ВЫПОЛНЕННОЙ РАБОТЫ ===" + Символы.ПС + Символы.ПС + ТекстSummary,
			"",
			"",
			0
		);
		// Явное уведомление о резюме с Сообщение в payload - на случай, если «НовоеСообщение» из фонового задания не дойдёт до клиента
		ПоследнийУИД = ИИА_Сервер.ПолучитьПоследнийУИДСообщенияДиалога(СсылкаДиалога);
		СообщениеРезюме = ИИА_Сервер.ПолучитьСообщениеПоУИД(СсылкаДиалога, ПоследнийУИД);
		ДопДанныеРезюме = ?(СообщениеРезюме <> Неопределено, Новый Структура("Сообщение", СообщениеРезюме), Неопределено);
		ОтправитьУведомление(СсылкаДиалога, "РезюмеДобавлено", ДопДанныеРезюме);
	Иначе
		// Запасное сообщение при ошибке или пустом ответе ИИ
		ИИА_Сервер.ДобавитьСообщениеВДиалог(
			СсылкаДиалога,
			Перечисления.ИИА_АвторСообщения.Система,
			Перечисления.ИИА_ТипСообщения.Текст,
			"=== РЕЗЮМЕ ВЫПОЛНЕННОЙ РАБОТЫ ===" + Символы.ПС + Символы.ПС + "Резюме не сформировано.",
			"",
			"",
			0
		);
		ПоследнийУИД = ИИА_Сервер.ПолучитьПоследнийУИДСообщенияДиалога(СсылкаДиалога);
		СообщениеРезюме = ИИА_Сервер.ПолучитьСообщениеПоУИД(СсылкаДиалога, ПоследнийУИД);
		ДопДанныеРезюме = ?(СообщениеРезюме <> Неопределено, Новый Структура("Сообщение", СообщениеРезюме), Неопределено);
		ОтправитьУведомление(СсылкаДиалога, "РезюмеДобавлено", ДопДанныеРезюме);
	КонецЕсли;
	
	// Отправляем финальное уведомление с Сообщение в payload - чтобы при перезагрузке чата резюме не исчезало
	ДопДанные = Новый Структура("Успех", РезультатПроверки.ПроверкаВыполнена);
	Если СообщениеРезюме <> Неопределено Тогда
		ДопДанные.Вставить("Сообщение", СообщениеРезюме);
	КонецЕсли;
	ИИА_Сервер.УведомитьОбОбновленииДиалога(СсылкаДиалога, "ЗадачаЗавершена", ДопДанные);
	
КонецПроцедуры

Функция ПроверитьРезультатВыполненияЗадачи(СсылкаДиалога) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("ПроверкаВыполнена", Ложь);
	Результат.Вставить("Причина", "");
	
	ПоследнееСообщение = ИИА_Сервер.ПолучитьПоследнееСообщениеПользователя(СсылкаДиалога);
	Если НЕ ПоследнееСообщение.Найдено Тогда
		Результат.Причина = "Не найдена задача пользователя";
		Возврат Результат;
	КонецЕсли;
	
	ТекстЗадачи = ПоследнееСообщение.Текст;
	Диалог = СсылкаДиалога.ПолучитьОбъект();

	// ДЕТЕРМИНИРОВАННАЯ ПРОВЕРКА
	ПоследнийСистРез = ПолучитьПоследнийDslSystemResult(СсылкаДиалога);
	Если ПоследнийСистРез.Найдено Тогда
		
		Если НЕ ПоследнийСистРез.Успех Тогда
			Результат.ПроверкаВыполнена = Ложь;
			Результат.Причина = "Последнее выполнение DSL завершилось ошибкой.";
			ИИА_Сервер.УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, Результат.ПроверкаВыполнена, Результат.Причина);
			Возврат Результат;
		КонецЕсли;
		
		Если Диалог.ТипДиалога = Перечисления.ИИА_ТипДиалога.Запрос1С Тогда
			ПроверкаВывода = ПроверитьВыводДанныхЗапроса(СсылкаДиалога);
			Если ПроверкаВывода.ЕстьТабличныйДокумент Тогда
				Результат.ПроверкаВыполнена = Истина;
				Результат.Причина = "Данные выведены: " + ПроверкаВывода.Причина;
			Иначе
				Результат.ПроверкаВыполнена = Ложь;
				Результат.Причина = "Нет подтверждения вывода данных (RunQuery или таблица).";
			КонецЕсли;
			ИИА_Сервер.УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, Результат.ПроверкаВыполнена, Результат.Причина);
			Возврат Результат;
		Иначе
			Результат.ПроверкаВыполнена = Истина;
			Результат.Причина = "Последнее выполнение DSL успешно.";
			ИИА_Сервер.УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, Результат.ПроверкаВыполнена, Результат.Причина);
			Возврат Результат;
		КонецЕсли;
		
	КонецЕсли;

	ТекстРезультатов = "";
	Для Индекс = Макс(0, Диалог.Сообщения.Количество() - 20) По Диалог.Сообщения.Количество() - 1 Цикл
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Система Тогда
			ТекстРезультатов = ТекстРезультатов + Символы.ПС + СтрокаСообщения.Текст;
		КонецЕсли;
	КонецЦикла;
	
	Если НЕ ПустаяСтрока(ТекстРезультатов) Тогда
		ТекстВРег = ВРег(ТекстРезультатов);
		ЕстьУспех = (СтрНайти(ТекстВРег, "DSL_SYSTEM_RESULT") > 0 
			И СтрНайти(ТекстВРег, "SUCCESS") > 0 
			И СтрНайти(ТекстВРег, "TRUE") > 0);
		ЕстьДанные = (СтрНайти(ТекстВРег, "RUNQUERY") > 0 ИЛИ СтрНайти(ТекстВРег, "SHOWINFO") > 0);
		
		Если ЕстьУспех И ЕстьДанные Тогда
			Результат.ПроверкаВыполнена = Истина;
			Результат.Причина = "Подтверждено по системным результатам (RunQuery/ShowInfo).";
			ИИА_Сервер.УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, Результат.ПроверкаВыполнена, Результат.Причина);
			Возврат Результат;
		КонецЕсли;
	КонецЕсли;
	
	ПромптПроверки = ИИА_Промты.СформироватьПромптПроверкиЗадачи(ТекстЗадачи, ТекстРезультатов);
	РезультатВызова = ИИА_Сервер.ВызватьИИССистемнымСообщением(СсылкаДиалога, "Чат", ПромптПроверки, "", "dsl", , Ложь, Ложь);
	
	ТекстОтвета = "";
	DSLДляРазбора = "";
	
	Если РезультатВызова.ТипОтвета = "DSL" И НЕ ПустаяСтрока(РезультатВызова.DSL) Тогда
		DSLДляРазбора = РезультатВызова.DSL;
	ИначеЕсли РезультатВызова.ТипОтвета = "ОшибкаКонтракта" 
		И РезультатВызова.Свойство("DSL") 
		И НЕ ПустаяСтрока(РезультатВызова.DSL) Тогда
		DSLДляРазбора = РезультатВызова.DSL;
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(DSLДляРазбора) Тогда
		Попытка
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(DSLДляРазбора);
			Сценарий = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если ТипЗнч(Сценарий) = Тип("Структура") Тогда
				Если Сценарий.Свойство("steps") И ТипЗнч(Сценарий.steps) = Тип("Массив") Тогда
					Для Каждого Шаг Из Сценарий.steps Цикл
						Если Шаг.action = "ShowInfo" И Шаг.Свойство("message") Тогда
							ТекстОтвета = Шаг.message;
							Прервать;
						КонецЕсли;
					КонецЦикла;
				ИначеЕсли Сценарий.Свойство("action") Тогда
					Если ВРег(Сценарий.action) = "SHOWINFO" И Сценарий.Свойство("message") Тогда
						ТекстОтвета = Сценарий.message;
					КонецЕсли;
				КонецЕсли;
			КонецЕсли;
		Исключение
			// ignored
			ТекстОшибки = ОписаниеОшибки();
		КонецПопытки;
	КонецЕсли;
	
	Если ПустаяСтрока(ТекстОтвета) Тогда
		ТекстОтвета = РезультатВызова.Текст;
	КонецЕсли;
	
	ТекстОтветаВРег = ВРег(ТекстОтвета);
	
	Если СтрНачинаетсяС(ТекстОтветаВРег, "ДА") 
		ИЛИ СтрНачинаетсяС(ТекстОтветаВРег, "'ДА") 
		ИЛИ СтрНачинаетсяС(ТекстОтветаВРег, """ДА") Тогда
		
		Диалог = СсылкаДиалога.ПолучитьОбъект();
		Если Диалог.ТипДиалога = Перечисления.ИИА_ТипДиалога.Запрос1С Тогда
			
			ТаблицаПоказана = Ложь;
			РезультатИзХранилища = ИИА_Сервер.ПолучитьРезультатПроверкиИзХранилища(СсылкаДиалога);
			Если РезультатИзХранилища <> Неопределено И РезультатИзХранилища.Свойство("ТаблицаПоказана") Тогда
				ТаблицаПоказана = РезультатИзХранилища.ТаблицаПоказана;
			КонецЕсли;
			
			Если ТаблицаПоказана Тогда
				ЕстьТабличныйДокумент = Истина;
				ПричинаЛога = "Явный флаг ТаблицаПоказана из хранилища";
			Иначе
				ЕстьТабличныйДокумент = Ложь;
				ПричинаЛога = "";
				КоличествоСообщений = Диалог.Сообщения.Количество();
				Для Индекс = Макс(0, КоличествоСообщений - 6) По КоличествоСообщений - 2 Цикл
					СтрокаСообщения = Диалог.Сообщения[Индекс];
					Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.ИИ И СтрокаСообщения.ТипСообщения = Перечисления.ИИА_ТипСообщения.Код Тогда
						Попытка
							ЧтениеJSON = Новый ЧтениеJSON;
							ЧтениеJSON.УстановитьСтроку(СтрокаСообщения.ТекстКода);
							Сценарий = ПрочитатьJSON(ЧтениеJSON);
							ЧтениеJSON.Закрыть();
							
							Если Сценарий.Свойство("steps") И ТипЗнч(Сценарий.steps) = Тип("Массив") Тогда
								Для Каждого Шаг Из Сценарий.steps Цикл
									Если Шаг.Свойство("action") И (ВРег(Шаг.action) = "RUNQUERY" ИЛИ ВРег(Шаг.action) = "SHOWINFO") Тогда
										ЕстьТабличныйДокумент = Истина;
										ПричинаЛога = "Найден шаг " + Шаг.action + " в сообщении ИИ #" + Индекс;
										Прервать;
									КонецЕсли;
								КонецЦикла;
							КонецЕсли;
						Исключение
							ТекстКодаВРег = ВРег(СтрокаСообщения.ТекстКода);
							Если СтрНайти(ТекстКодаВРег, "RUNQUERY") > 0 Тогда
								ЕстьТабличныйДокумент = Истина;
								ПричинаЛога = "Найдена подстрока RUNQUERY в сообщении ИИ #" + Индекс;
							ИначеЕсли СтрНайти(ТекстКодаВРег, "SHOWINFO") > 0 Тогда
								ЕстьТабличныйДокумент = Истина;
								ПричинаЛога = "Найдена подстрока SHOWINFO в сообщении ИИ #" + Индекс;
							КонецЕсли;
						КонецПопытки;
						
						Если ЕстьТабличныйДокумент Тогда
							Прервать;
						КонецЕсли;
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
			
			ЗаписьЛога = "Проверка наличия вывода данных: " + ?(ЕстьТабличныйДокумент, "ДА (" + ПричинаЛога + ")", "НЕТ");
			ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, ЗаписьЛога);
			
			Если НЕ ЕстьТабличныйДокумент Тогда
				Результат.ПроверкаВыполнена = Ложь;
				Результат.Причина = "ИИ считает задачу выполненной, но не был выполнен шаг RunQuery для отображения данных (ТабличныйДокумент). Обязательно выполни запрос к базе данных.";
			Иначе
				Результат.ПроверкаВыполнена = Истина;
				Результат.Причина = ТекстОтвета;
			КонецЕсли;
			
		Иначе
			Результат.ПроверкаВыполнена = Истина;
			Результат.Причина = ТекстОтвета;
		КонецЕсли;
		
	Иначе
		Результат.ПроверкаВыполнена = Ложь;
		Результат.Причина = ТекстОтвета;
	КонецЕсли;
	
	ИИА_Сервер.УстановитьРезультатПроверкиВХранилище(СсылкаДиалога, Результат.ПроверкаВыполнена, Результат.Причина);
	Возврат Результат;
	
КонецФункции

#КонецОбласти

Процедура ОтправитьУведомление(СсылкаДиалога, ТипСобытия, ДополнительныеДанные = Неопределено)
	
	ИИА_Сервер.УведомитьОбОбновленииДиалога(СсылкаДиалога, ТипСобытия, ДополнительныеДанные);
	
КонецПроцедуры

Процедура ОбновитьСтатусПоследнегоСообщения(СсылкаДиалога, НовыйСтатус)
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат;
	КонецЕсли;
	
	СтрокаСообщения = Диалог.Сообщения[Диалог.Сообщения.Количество() - 1];
	СтрокаСообщения.Статус = НовыйСтатус;
	Диалог.Записать();
	
	ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Система] Обновлен статус сообщения: " + НовыйСтатус);
	
КонецПроцедуры

Функция ПолучитьПоследнийDslSystemResult(СсылкаДиалога)
	
	Результат = Новый Структура;
	Результат.Вставить("Найдено", Ложь);
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Текст", "");
	
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если Диалог.Сообщения.Количество() = 0 Тогда
		Возврат Результат;
	КонецЕсли;
	
	Для Индекс = Диалог.Сообщения.Количество() - 1 По 0 Цикл
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.Система
			И НЕ ПустаяСтрока(СтрокаСообщения.Текст)
			И СтрНайти(СтрокаСообщения.Текст, "dsl_system_result") > 0 Тогда
			
			ТекстJSON = ИИА_DSL.НормализоватьJSONТекст(СтрокаСообщения.Текст);
			
			Результат.Найдено = Истина;
			Результат.Текст = ?(ПустаяСтрока(ТекстJSON), СтрокаСообщения.Текст, ТекстJSON);
			
			Если НЕ ПустаяСтрока(ТекстJSON) Тогда
				Попытка
					ЧтениеJSON = Новый ЧтениеJSON;
					ЧтениеJSON.УстановитьСтроку(ТекстJSON);
					Данные = ПрочитатьJSON(ЧтениеJSON);
					ЧтениеJSON.Закрыть();
					
					Если ТипЗнч(Данные) = Тип("Структура") И Данные.Свойство("success") Тогда
						Результат.Успех = Данные.success;
					КонецЕсли;
				Исключение
					ТекстОшибки = ОписаниеОшибки();
				КонецПопытки;
			КонецЕсли;
			
			Возврат Результат;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

Функция ПроверитьВыводДанныхЗапроса(СсылкаДиалога)
	
	Результат = Новый Структура("ЕстьТабличныйДокумент, Причина", Ложь, "");
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
		Возврат Результат;
	КонецЕсли;
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	
	ТаблицаПоказана = Ложь;
	РезультатИзХранилища = ИИА_Сервер.ПолучитьРезультатПроверкиИзХранилища(СсылкаДиалога);
	Если РезультатИзХранилища <> Неопределено
		И ТипЗнч(РезультатИзХранилища) = Тип("Структура")
		И РезультатИзХранилища.Свойство("ТаблицаПоказана") Тогда
		ТаблицаПоказана = РезультатИзХранилища.ТаблицаПоказана;
	КонецЕсли;
	
	Если ТаблицаПоказана Тогда
		Результат.ЕстьТабличныйДокумент = Истина;
		Результат.Причина = "Явный флаг ТаблицаПоказана из хранилища";
		Возврат Результат;
	КонецЕсли;
	
	КоличествоСообщений = Диалог.Сообщения.Количество();
	Для Индекс = Макс(0, КоличествоСообщений - 6) По КоличествоСообщений - 1 Цикл
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		Если СтрокаСообщения.Автор = Перечисления.ИИА_АвторСообщения.ИИ
			И СтрокаСообщения.ТипСообщения = Перечисления.ИИА_ТипСообщения.Код
			И НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			
			Попытка
				ЧтениеJSON = Новый ЧтениеJSON;
				ЧтениеJSON.УстановитьСтроку(ИИА_DSL.НормализоватьJSONТекст(СтрокаСообщения.ТекстКода));
				Сценарий = ПрочитатьJSON(ЧтениеJSON);
				ЧтениеJSON.Закрыть();
				
				Если ТипЗнч(Сценарий) = Тип("Структура") И Сценарий.Свойство("steps") И ТипЗнч(Сценарий.steps) = Тип("Массив") Тогда
					Для Каждого Шаг Из Сценарий.steps Цикл
						Если Шаг.Свойство("action") Тогда
							Действие = ВРег(Шаг.action);
							Если Действие = "RUNQUERY" ИЛИ Действие = "SHOWINFO" Тогда
								Результат.ЕстьТабличныйДокумент = Истина;
								Результат.Причина = "Найден шаг " + Шаг.action;
								Возврат Результат;
							КонецЕсли;
						КонецЕсли;
					КонецЦикла;
				КонецЕсли;
			Исключение
				ТекстОшибки = ОписаниеОшибки();
			КонецПопытки;
		КонецЕсли;
	КонецЦикла;
	
	Возврат Результат;
	
КонецФункции

#Область СлужебныеПроцедурыИФункции

// Сжимает JSON в одну строку для компактного вывода в лог (убирает переносы и лишние пробелы).
//
Функция СжатьJSONДляЛога(ТекстJSON)
	Если ПустаяСтрока(ТекстJSON) Тогда
		Возврат "";
	КонецЕсли;
	Результат = СтрЗаменить(ТекстJSON, Символы.ПС, " ");
	Результат = СтрЗаменить(Результат, Символы.ВТаб, " ");
	Пока СтрНайти(Результат, "  ") > 0 Цикл
		Результат = СтрЗаменить(Результат, "  ", " ");
	КонецЦикла;
	Возврат СокрЛП(Результат);
КонецФункции

// Извлекает блок "Реквизиты:" из текста фактов (результатов GetObjectFields) для передачи в промпт RunQuery
//
// Параметры:
//  ТекстФактов - Строка - текст из СобратьФактыПоследнихДействий
//
// Возвращаемое значение:
//  Строка - извлечённый список реквизитов или пустая строка
//
Функция ИзвлечьРеквизитыИзФактов(ТекстФактов) Экспорт
	
	Если ПустаяСтрока(ТекстФактов) Тогда
		Возврат "";
	КонецЕсли;
	
	ПозРеквизиты = СтрНайти(ТекстФактов, "Реквизиты:");
	Если ПозРеквизиты <= 0 Тогда
		Возврат "";
	КонецЕсли;
	
	// Берём текст после "Реквизиты:" до следующего структурного блока или конца
	Начало = ПозРеквизиты + СтрДлина("Реквизиты:");
	Остаток = Сред(ТекстФактов, Начало);
	
	// Обрезаем по "steps" или "dsl_system_result" или другому ключевому маркеру
	Маркеры = Новый Массив;
	Маркеры.Добавить("""steps""");
	Маркеры.Добавить("dsl_system_result");
	Маркеры.Добавить("Выполнен DSL");
	Маркеры.Добавить("Ошибка выполнения");
	
	КонецБлока = СтрДлина(Остаток) + 1;
	Для Каждого Маркер Из Маркеры Цикл
		Поз = СтрНайти(Остаток, Маркер);
		Если Поз > 0 И Поз < КонецБлока Тогда
			КонецБлока = Поз;
		КонецЕсли;
	КонецЦикла;
	
	БлокРеквизитов = Лев(Остаток, КонецБлока - 1);
	БлокРеквизитов = СокрЛП(БлокРеквизитов);
	
	// Ограничиваем длину (чтобы не раздувать промпт)
	Если СтрДлина(БлокРеквизитов) > 1500 Тогда
		БлокРеквизитов = Лев(БлокРеквизитов, 1500) + "...";
	КонецЕсли;
	
	Возврат БлокРеквизитов;
	
КонецФункции

// Извлекает имена объектов/таблиц, по которым уже была ошибка (таблица не найдена, поле не найдено).
// Используется для запрета возврата к ошибочным объектам в промпте генерации DSL.
//
// Параметры:
//  ТекстФактов - Строка - текст из СобратьФактыПоследнихДействий
//
// Возвращаемое значение:
//  Строка - список имён через запятую или пустая строка
//
Функция СобратьНеудачныеОбъектыИзФактов(ТекстФактов) Экспорт
	
	Если ПустаяСтрока(ТекстФактов) Тогда
		Возврат "";
	КонецЕсли;
	
	Уникальные = Новый Соответствие;
	
	// Паттерн "Таблица 'ИмяТаблицы' не найдена" или "не найдена в метаданных"
	Поз = 1;
	Пока Истина Цикл
		ПозТабл = СтрНайти(Сред(ТекстФактов, Поз), "Таблица ");
		Если ПозТабл <= 0 Тогда
			Прервать;
		КонецЕсли;
		Поз = Поз + ПозТабл + 7;
		Остаток = Сред(ТекстФактов, Поз);
		ПозКавычки = СтрНайти(Остаток, "'");
		Если ПозКавычки <= 0 Тогда
			ПозКавычки = СтрНайти(Остаток, """");
		КонецЕсли;
		Если ПозКавычки > 0 Тогда
			Остаток = Сред(Остаток, ПозКавычки + 1);
			ПозКонец = СтрНайти(Остаток, "'");
			Если ПозКонец <= 0 Тогда
				ПозКонец = СтрНайти(Остаток, """");
			КонецЕсли;
			Если ПозКонец > 0 Тогда
				ИмяТаблицы = Лев(Остаток, ПозКонец - 1);
				// Убираем префикс ДОКУМЕНТ./СПРАВОЧНИК.
				ИмяТаблицы = СтрЗаменить(ВРег(ИмяТаблицы), "ДОКУМЕНТ.", "");
				ИмяТаблицы = СтрЗаменить(ИмяТаблицы, "СПРАВОЧНИК.", "");
				ИмяТаблицы = СокрЛП(ИмяТаблицы);
				Если НЕ ПустаяСтрока(ИмяТаблицы) Тогда
					Уникальные.Вставить(ИмяТаблицы, Истина);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		Поз = Поз + 50;
		Если Поз > СтрДлина(ТекстФактов) Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	// Паттерн "Поле не найдено ""Объект.Поле"""
	Поз = 1;
	Пока Истина Цикл
		ПозПоле = СтрНайти(Сред(ТекстФактов, Поз), "Поле не найдено");
		Если ПозПоле <= 0 Тогда
			Прервать;
		КонецЕсли;
		Поз = Поз + ПозПоле + 14;
		Остаток = Сред(ТекстФактов, Поз);
		ПозКавычки = СтрНайти(Остаток, """");
		Если ПозКавычки <= 0 Тогда
			ПозКавычки = СтрНайти(Остаток, "'");
		КонецЕсли;
		Если ПозКавычки > 0 Тогда
			Остаток = Сред(Остаток, ПозКавычки + 1);
			ПозКонец = СтрНайти(Остаток, """");
			Если ПозКонец <= 0 Тогда
				ПозКонец = СтрНайти(Остаток, "'");
			КонецЕсли;
			Если ПозКонец > 0 Тогда
				ОбъектПоле = Лев(Остаток, ПозКонец - 1);
				ПозТочки = СтрНайти(ОбъектПоле, ".");
				Если ПозТочки > 0 Тогда
					ИмяОбъекта = Лев(ОбъектПоле, ПозТочки - 1);
					Если НЕ ПустаяСтрока(ИмяОбъекта) Тогда
						Уникальные.Вставить(ИмяОбъекта, Истина);
					КонецЕсли;
				Иначе
					Уникальные.Вставить(ОбъектПоле, Истина);
				КонецЕсли;
			КонецЕсли;
		КонецЕсли;
		Поз = Поз + 30;
		Если Поз > СтрДлина(ТекстФактов) Тогда
			Прервать;
		КонецЕсли;
	КонецЦикла;
	
	Если Уникальные.Количество() = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Список = "";
	Для Каждого КлючЗначение Из Уникальные Цикл
		Если НЕ ПустаяСтрока(Список) Тогда
			Список = Список + ", ";
		КонецЕсли;
		Список = Список + КлючЗначение.Ключ;
	КонецЦикла;
	Возврат Список;
	
КонецФункции

// Извлекает ключ последней ошибки DSL из фактов (для детекции повторяющихся ошибок).
// Возвращает пустую строку, если последний результат - успех.
//
// Параметры:
//  ТекстФактов - Строка - текст из СобратьФактыПоследнихДействий
//
// Возвращаемое значение:
//  Строка - ключ ошибки ("RunQuery" + первые 50 символов сообщения) или ""
//
Функция ПолучитьКлючПоследнейОшибкиИзФактов(ТекстФактов) Экспорт
	
	Если ПустаяСтрока(ТекстФактов) Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстВРег = ВРег(ТекстФактов);
	
	// Компактный формат (ФорматироватьКомпактноДляЛога): "DSL Result: err | сообщение"
	ПозErr = СтрНайти(ТекстВРег, "DSL RESULT: ERR");
	Если ПозErr > 0 Тогда
		Остаток = Сред(ТекстФактов, ПозErr);
		ПозВер = СтрНайти(Остаток, "|");
		Если ПозВер > 0 Тогда
			Сообщение = СокрЛП(Сред(Остаток, ПозВер + 1));
			Возврат "RunQuery" + Лев(Сообщение, 50);
		КонецЕсли;
		Возврат "RunQuery";
	КонецЕсли;
	
	Если СтрНайти(ТекстВРег, """SUCCESS"":FALSE") = 0 И СтрНайти(ТекстВРег, """SUCCESS"": FALSE") = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	// Берём последний фрагмент (последний dsl_system_result)
	Чанки = СтрРазделить(ТекстФактов, "dsl_system_result", Ложь);
	Если Чанки.Количество() < 2 Тогда
		Возврат "RunQuery";
	КонецЕсли;
	
	ПоследнийЧанк = Чанки[Чанки.Количество() - 1];
	ПоследнийЧанкВРег = ВРег(ПоследнийЧанк);
	Если СтрНайти(ПоследнийЧанкВРег, """SUCCESS"":FALSE") = 0 И СтрНайти(ПоследнийЧанкВРег, """SUCCESS"": FALSE") = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	ПозОшибки = СтрНайти(ПоследнийЧанк, """error"":""");
	Если ПозОшибки = 0 Тогда
		ПозОшибки = СтрНайти(ПоследнийЧанк, """error"": """);
	КонецЕсли;
	
	Если ПозОшибки > 0 Тогда
		Остаток = Сред(ПоследнийЧанк, ПозОшибки + 10);
		Ключ = "RunQuery" + Лев(Остаток, 50);
		Возврат Ключ;
	КонецЕсли;
	
	Возврат "RunQuery" + Лев(ПоследнийЧанк, 50);
	
КонецФункции

Функция ИзвлечьИмяТаблицыИзТекстаЗапроса(Текст)
	Если ПустаяСтрока(Текст) Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстВерх = ВРег(Текст);
	ПозИЗ = СтрНайти(ТекстВерх, " ИЗ ");
	Если ПозИЗ = 0 Тогда
		ПозИЗ = СтрНайти(ТекстВерх, Символы.ПС + "ИЗ ");
	КонецЕсли;
	Если ПозИЗ = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Остаток = СокрЛП(Сред(Текст, ПозИЗ + 4));
	Если ПустаяСтрока(Остаток) Тогда
		Возврат "";
	КонецЕсли;
	
	КонецИмени = СтрДлина(Остаток) + 1;
	Маркеры = Новый Массив;
	Маркеры.Добавить(" ");
	Маркеры.Добавить(Символы.ПС);
	Маркеры.Добавить(",");
	Маркеры.Добавить("ГДЕ ");
	Маркеры.Добавить("СГРУППИРОВАТЬ");
	Маркеры.Добавить("УПОРЯДОЧИТЬ");
	Для Каждого Маркер Из Маркеры Цикл
		ПозМаркер = СтрНайти(Остаток, Маркер);
		Если ПозМаркер > 0 И ПозМаркер < КонецИмени Тогда
			КонецИмени = ПозМаркер;
		КонецЕсли;
	КонецЦикла;
	
	ИмяТаблицы = СокрЛП(Лев(Остаток, КонецИмени - 1));
	Возврат ИмяТаблицы;
КонецФункции

Функция УвеличитьСчетчикОшибокПоляПоТаблице(СсылкаДиалога, ИмяТаблицы) Экспорт
	Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Или ПустаяСтрока(ИмяТаблицы) Тогда
		Возврат 0;
	КонецЕсли;
	
	СтруктураДанных = ИИА_Сервер.ПолучитьДанныеДиалогаИзРегистра(СсылкаДиалога);
	Если СтруктураДанных = Неопределено Или ТипЗнч(СтруктураДанных) <> Тип("Структура") Тогда
		СтруктураДанных = Новый Структура;
	КонецЕсли;
	
	Счетчики = Неопределено;
	Если СтруктураДанных.Свойство("СчетчикиОшибокПолейПоТаблицам") 
		И ТипЗнч(СтруктураДанных.СчетчикиОшибокПолейПоТаблицам) = Тип("Соответствие") Тогда
		Счетчики = СтруктураДанных.СчетчикиОшибокПолейПоТаблицам;
	Иначе
		Счетчики = Новый Соответствие;
	КонецЕсли;
	
	Ключ = ВРег(ИмяТаблицы);
	Текущее = Счетчики.Получить(Ключ);
	Если Текущее = Неопределено Тогда
		Текущее = 0;
	КонецЕсли;
	Текущее = Текущее + 1;
	Счетчики.Вставить(Ключ, Текущее);
	
	СтруктураДанных.Вставить("СчетчикиОшибокПолейПоТаблицам", Счетчики);
	ИИА_Сервер.ЗаписатьДанныеДиалогаВРегистр(СсылкаДиалога, СтруктураДанных);
	
	Возврат Текущее;
КонецФункции

// Извлекает имя таблицы из сообщения об ошибке "Таблица 'X' не найдена".
//
// Параметры:
//  ТекстОшибки - Строка - сообщение об ошибке
//
// Возвращаемое значение:
//  Строка - имя таблицы (например Документ.РеализацияТоваровУслуг) или ""
//
Функция ИзвлечьИмяТаблицыИзОшибки(ТекстОшибки)
	
	Если ПустаяСтрока(ТекстОшибки) Тогда
		Возврат "";
	КонецЕсли;
	
	ПозТабл = СтрНайти(ТекстОшибки, "Таблица ");
	Если ПозТабл <= 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Остаток = Сред(ТекстОшибки, ПозТабл + 8);
	ПозОдной = СтрНайти(Остаток, "'");
	ПозДвойной = СтрНайти(Остаток, """");
	
	Если ПозОдной > 0 И (ПозДвойной <= 0 ИЛИ ПозОдной < ПозДвойной) Тогда
		СимволКавычки = "'";
		ПозОткрытия = ПозОдной;
	ИначеЕсли ПозДвойной > 0 Тогда
		СимволКавычки = """";
		ПозОткрытия = ПозДвойной;
	Иначе
		Возврат "";
	КонецЕсли;
	
	Остаток = Сред(Остаток, ПозОткрытия + 1);
	ПозЗакрытия = СтрНайти(Остаток, СимволКавычки);
	Если ПозЗакрытия <= 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Возврат СокрЛП(Лев(Остаток, ПозЗакрытия - 1));
	
КонецФункции

// Определяет фильтр для GetMetadata из имени таблицы (например РеализацияТоваровУслуг → Реализация).
//
Функция ОпределитьФильтрGetMetadataИзИмениТаблицы(ИмяТаблицы)
	
	ИмяОбъекта = ИмяТаблицы;
	ПозТочки = СтрНайти(ИмяОбъекта, ".");
	Если ПозТочки > 0 Тогда
		ИмяОбъекта = Сред(ИмяОбъекта, ПозТочки + 1);
	КонецЕсли;
	
	ИмяВРег = ВРег(ИмяОбъекта);
	// Убираем типичные суффиксы: ТоваровУслуг, Товаров, Услуг
	Если СтрНайти(ИмяВРег, "ТОВАРОВУСЛУГ") > 0 Тогда
		Поз = СтрНайти(ИмяВРег, "ТОВАРОВУСЛУГ");
		ИмяОбъекта = Лев(ИмяОбъекта, Поз - 1);
	ИначеЕсли СтрНайти(ИмяВРег, "ТОВАРОВ") > 0 Тогда
		Поз = СтрНайти(ИмяВРег, "ТОВАРОВ");
		ИмяОбъекта = Лев(ИмяОбъекта, Поз - 1);
	ИначеЕсли СтрНайти(ИмяВРег, "УСЛУГ") > 0 И СтрДлина(ИмяОбъекта) > 5 Тогда
		Поз = СтрНайти(ИмяВРег, "УСЛУГ");
		ИмяОбъекта = Лев(ИмяОбъекта, Поз - 1);
	КонецЕсли;
	
	Если ПустаяСтрока(ИмяОбъекта) Тогда
		Возврат ИмяТаблицы;
	КонецЕсли;
	
	Возврат ИмяОбъекта;
	
КонецФункции

// Вставляет в план шаг GetMetadata{filter:'...'} перед первым невыполненным RunQuery.
// Возвращает Истина, если шаг добавлен.
//
Функция ДобавитьGetMetadataВПланПриТаблицаНеНайдена(СсылкаДиалога, ИмяТаблицы) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	Если Диалог.План.Количество() = 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	Фильтр = ОпределитьФильтрGetMetadataИзИмениТаблицы(ИмяТаблицы);
	Если ПустаяСтрока(Фильтр) Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Экранируем кавычки в фильтре
	ФильтрЭкранированный = СтрЗаменить(Фильтр, "'", "''");
	НоваяЗадача = "GetMetadata{filter:'" + ФильтрЭкранированный + "'}";
	
	// Собираем строки плана, вставляем GetMetadata перед первым невыполненным RunQuery
	МассивСтрок = Новый Массив;
	ИндексВставки = -1;
	Индекс = 0;
	
	Для Каждого СтрокаПлана Из Диалог.План Цикл
		Если НЕ СтрокаПлана.Выполнена И СтрНайти(ВРег(СтрокаПлана.Задача), "RUNQUERY") > 0 Тогда
			Если ИндексВставки < 0 Тогда
				ИндексВставки = Индекс;
			КонецЕсли;
		КонецЕсли;
		МассивСтрок.Добавить(Новый Структура("Задача, Выполнена, Результат", СтрокаПлана.Задача, СтрокаПлана.Выполнена, СтрокаПлана.Результат));
		Индекс = Индекс + 1;
	КонецЦикла;
	
	Если ИндексВставки < 0 Тогда
		Возврат Ложь;
	КонецЕсли;
	
	// Вставляем новую строку
	МассивСтрок.Вставить(ИндексВставки, Новый Структура("Задача, Выполнена, Результат", НоваяЗадача, Ложь, ""));
	
	Диалог.План.Очистить();
	Для Каждого Стр Из МассивСтрок Цикл
		НоваяСтрока = Диалог.План.Добавить();
		НоваяСтрока.Задача = Стр.Задача;
		НоваяСтрока.Выполнена = Стр.Выполнена;
		НоваяСтрока.Результат = Стр.Результат;
	КонецЦикла;
	
	Диалог.Записать();
	ИИА_Сервер.УведомитьОбОбновленииДиалога(СсылкаДиалога, "ПланОбновлен");
	Возврат Истина;
	
КонецФункции

// Извлекает текст query из последнего выполненного RunQuery в диалоге.
// Используется для обновления плана при подстановке объекта (например, РасходнаяНакладная вместо РеализацияТоваровУслуг).
//
// Параметры:
//  СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на диалог
//
// Возвращаемое значение:
//  Строка - текст запроса или пустая строка
//
Функция ИзвлечьВыполненныйRunQueryИзДиалога(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	КоличествоСообщений = Диалог.Сообщения.Количество();
	
	Индекс = КоличествоСообщений - 1;
	Пока Индекс >= 0 Цикл
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		Если СтрокаСообщения.Автор <> Перечисления.ИИА_АвторСообщения.ИИ ИЛИ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
			Индекс = Индекс - 1;
			Продолжить;
		КонецЕсли;
		
		ТекстКодаВРег = ВРег(СтрокаСообщения.ТекстКода);
		Если СтрНайти(ТекстКодаВРег, "RUNQUERY") = 0 Тогда
			Индекс = Индекс - 1;
			Продолжить;
		КонецЕсли;
		
		Попытка
			ТекстJSON = ИИА_DSL.НормализоватьJSONТекст(СтрокаСообщения.ТекстКода);
			ЧтениеJSON = Новый ЧтениеJSON;
			ЧтениеJSON.УстановитьСтроку(ТекстJSON);
			Сценарий = ПрочитатьJSON(ЧтениеJSON);
			ЧтениеJSON.Закрыть();
			
			Если Сценарий.Свойство("steps") И ТипЗнч(Сценарий.steps) = Тип("Массив") Тогда
				Для Каждого Шаг Из Сценарий.steps Цикл
					Если Шаг.Свойство("action") И ВРег(Шаг.action) = "RUNQUERY" И Шаг.Свойство("query") Тогда
						Возврат Строка(Шаг.query);
					КонецЕсли;
				КонецЦикла;
			КонецЕсли;
		Исключение
			ТекстОшибки = ОписаниеОшибки();
		КонецПопытки;
		
		Индекс = Индекс - 1;
	КонецЦикла;
	
	Возврат "";
	
КонецФункции

// Извлекает текст query из строки задачи плана вида RunQuery{query:'...'} или RunQuery{query:"..."}
//
// Параметры:
//  Задача - Строка - текст задачи из плана
//
// Возвращаемое значение:
//  Строка - текст запроса или пустая строка
//
Функция ИзвлечьQueryИзЗадачиRunQuery(Задача) Экспорт
	
	ЗадачаВРег = ВРег(СокрЛП(Задача));
	Если СтрНайти(ЗадачаВРег, "RUNQUERY") = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	// Ищем query:' или query:"
	ПозQuery = СтрНайти(ЗадачаВРег, "QUERY");
	Если ПозQuery = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	Остаток = Сред(Задача, ПозQuery);
	ПозДвоеточие = СтрНайти(Остаток, ":");
	Если ПозДвоеточие = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	ПозКавычки = ПозДвоеточие + 1;
	СимволКавычки = Сред(Остаток, ПозКавычки, 1);
	Если СимволКавычки <> "'" И СимволКавычки <> """" Тогда
		Возврат "";
	КонецЕсли;
	
	ПозНачалаЗначения = ПозКавычки + 1;
	СтрокаЗначения = Сред(Остаток, ПозНачалаЗначения);
	Длина = СтрДлина(СтрокаЗначения);
	ПозКонец = 1;
	
	Пока ПозКонец <= Длина Цикл
		Символ = Сред(СтрокаЗначения, ПозКонец, 1);
		Если Символ = СимволКавычки Тогда
			Если СимволКавычки = "'" И ПозКонец < Длина И Сред(СтрокаЗначения, ПозКонец + 1, 1) = "'" Тогда
				ПозКонец = ПозКонец + 2;
				Продолжить;
			ИначеЕсли СимволКавычки = """" И ПозКонец > 1 И Сред(СтрокаЗначения, ПозКонец - 1, 1) = "\" Тогда
				ПозКонец = ПозКонец + 1;
				Продолжить;
			КонецЕсли;
			Возврат Сред(СтрокаЗначения, 1, ПозКонец - 1);
		КонецЕсли;
		ПозКонец = ПозКонец + 1;
	КонецЦикла;
	
	Возврат "";
	
КонецФункции

Функция СобратьФактыПоследнихДействий(СсылкаДиалога) Экспорт
	
	Диалог = СсылкаДиалога.ПолучитьОбъект();
	КоличествоСообщений = Диалог.Сообщения.Количество();
	
	МассивФрагментов = Новый Массив;
	СчетчикСистемных = 0;
	СчетчикDSL = 0;
	РеквизитыДобавлены = Ложь;
	
	Индекс = КоличествоСообщений - 1;
	Пока Индекс >= 0 Цикл
		СтрокаСообщения = Диалог.Сообщения[Индекс];
		
		АвторСообщения = СтрокаСообщения.Автор;
		ТипСообщения   = СтрокаСообщения.ТипСообщения;
		
		Если АвторСообщения = Перечисления.ИИА_АвторСообщения.Система 
			ИЛИ АвторСообщения = Перечисления.ИИА_АвторСообщения.ИИ Тогда
			
			Если АвторСообщения = Перечисления.ИИА_АвторСообщения.ИИ И НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода) Тогда
				ТекстСообщения = СтрокаСообщения.ТекстКода;
			Иначе
				ТекстСообщения = СтрокаСообщения.Текст;
			КонецЕсли;
			ТекстСообщения = СокрЛП(ТекстСообщения);
			
			Если ПустаяСтрока(ТекстСообщения) Тогда
				Индекс = Индекс - 1;
				Продолжить;
			КонецЕсли;
			
			// Берем результаты DSL (dsl_system_result), ошибки, сообщения с Реквизитами (GetObjectFields) и DSL-команды ИИ
			ЭтоРезультат = (СтрНайти(ТекстСообщения, "dsl_system_result") > 0);
			ЭтоОшибка    = (ТипСообщения = Перечисления.ИИА_ТипСообщения.Ошибка);
			ЭтоРеквизиты = (АвторСообщения = Перечисления.ИИА_АвторСообщения.Система И СтрНайти(ТекстСообщения, "Реквизиты:") > 0);
			ЭтоDSL       = (АвторСообщения = Перечисления.ИИА_АвторСообщения.ИИ И НЕ ПустаяСтрока(СтрокаСообщения.ТекстКода));
			
			Если ЭтоРезультат ИЛИ ЭтоОшибка Тогда
				
				Если СчетчикСистемных < 5 Тогда
					СчетчикСистемных = СчетчикСистемных + 1;
					
					Если ЭтоРезультат Тогда
						ТекстДляДобавления = ИИА_Сервер.ФорматироватьКомпактноДляЛога(ТекстСообщения);
					Иначе
						ТекстДляДобавления = ТекстСообщения;
						Если СтрДлина(ТекстДляДобавления) > 3000 Тогда
							ТекстДляДобавления = Лев(ТекстДляДобавления, 3000) + "...(truncated)";
						КонецЕсли;
					КонецЕсли;
					
					МассивФрагментов.Вставить(0, ТекстДляДобавления);
				КонецЕсли;
				
			ИначеЕсли ЭтоРеквизиты И НЕ РеквизитыДобавлены Тогда
				
				// Сообщение "DSL-сценарий выполнен успешно" + блок Реквизиты - нужно для RunQuery
				РеквизитыДобавлены = Истина;
				ТекстДляДобавления = ТекстСообщения;
				Если СтрДлина(ТекстДляДобавления) > 2500 Тогда
					ТекстДляДобавления = Лев(ТекстДляДобавления, 2500) + "...(truncated)";
				КонецЕсли;
				МассивФрагментов.Вставить(0, ТекстДляДобавления);
				
			ИначеЕсли ЭтоDSL Тогда
				
				Если СчетчикDSL < 5 Тогда
					СчетчикDSL = СчетчикDSL + 1;
					
					ТекстDSL = ИИА_Сервер.ФорматироватьКомпактноДляЛога(ТекстСообщения);
					МассивФрагментов.Вставить(0, "Выполнен " + ТекстDSL);
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
		Если СчетчикСистемных >= 5 И СчетчикDSL >= 5 Тогда
			Прервать;
		КонецЕсли;
		
		Индекс = Индекс - 1;
	КонецЦикла;
	
	ТекстРезультатов = "";
	Для Каждого Фрагмент Из МассивФрагментов Цикл
		Если НЕ ПустаяСтрока(ТекстРезультатов) Тогда
			ТекстРезультатов = ТекстРезультатов + Символы.ПС;
		КонецЕсли;
		ТекстРезультатов = ТекстРезультатов + Фрагмент;
	КонецЦикла;
	
	Возврат ТекстРезультатов;
	
КонецФункции

#КонецОбласти
