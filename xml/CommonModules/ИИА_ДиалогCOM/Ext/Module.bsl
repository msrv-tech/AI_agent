#Область ПрограммныйИнтерфейс

// Создаёт диалог, отправляет сообщение и выполняет оркестратор синхронно (для COM/автотестов).
//
// Параметры:
//  Пользователь - Строка - имя пользователя (например, "Администратор")
//  ТекстЗадачи - Строка - текст задачи для агента
//  ТипДиалога - ПеречислениеСсылка.ИИА_ТипДиалога - Агент или Запрос1С (по умолчанию Агент)
//
// Возвращаемое значение:
//  Структура:
//   * СсылкаДиалога - СправочникСсылка.ИИА_Диалоги - ссылка на созданный диалог
//   * Успех - Булево - успешность выполнения
//   * Лог - Строка - полный лог диалога
//   * Сообщения - Массив - массив структур с сообщениями (Время, Автор, Текст, ТекстКода)
//
Функция СоздатьДиалогИВыполнитьАгентаСинхронно(Пользователь, ТекстЗадачи, ТипДиалога = Неопределено) Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("СсылкаДиалога", Неопределено);
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Лог", "");
	Результат.Вставить("Сообщения", Новый Массив);
	
	Попытка
		
		// По умолчанию - Агент
		Если ТипДиалога = Неопределено Тогда
			ТипДиалога = Перечисления.ИИА_ТипДиалога.Агент;
		КонецЕсли;
		
		// 1. Создаём диалог
		СсылкаДиалога = ИИА_Сервер.СоздатьНовыйДиалог(Пользователь, ТипДиалога);
		Результат.СсылкаДиалога = СсылкаДиалога;
		
		// 2. Отправляем сообщение (добавит в диалог, очистит план, для Агента/Запрос1С вернёт "Запрос принят")
		ИИА_Сервер.ОтправитьСообщениеСервера(СсылкаДиалога, ТипДиалога, ТекстЗадачи);
		
		// 3. Включаем оркестратор (как при нажатии "Отправить" в форме агента)
		ИИА_Сервер.УстановитьОркестраторВключен(СсылкаДиалога, Истина);
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, "[Оркестратор] Запуск серверного движка...");
		
		// 4. Выполняем цикл оркестратора синхронно (без ФоновыеЗадания)
		НачальныеТокены = ИИА_Сервер.ПолучитьОбщееКоличествоТокенов(СсылкаДиалога);
		ИИА_Оркестратор.ВыполнитьЦикл(СсылкаДиалога, НачальныеТокены);
		
		// 5. Собираем лог
		Результат.Лог = ИИА_Сервер.ПолучитьЛогДиалога(СсылкаДиалога);
		
		// 6. Собираем сообщения
		МассивСообщений = ИИА_Сервер.ПолучитьСообщенияДиалога(СсылкаДиалога, 0);
		Для Каждого СтруктураСообщения Из МассивСообщений Цикл
			Результат.Сообщения.Добавить(СтруктураСообщения);
		КонецЦикла;
		
		// Успех - если оркестратор дошел до конца без критической ошибки
		Результат.Успех = НЕ ИИА_Сервер.ОркестраторВключенДляДиалога(СсылкаДиалога);
		
	Исключение
		Результат.Лог = Результат.Лог + Символы.ПС + "[ОШИБКА] " + ОписаниеОшибки();
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

#КонецОбласти
