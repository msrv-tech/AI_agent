#Область СлужебныеПроцедурыИФункции

Функция СформироватьРезультатТеста(Успех, Сообщение, Детали = Неопределено)
	Результат = Новый Структура;
	Результат.Вставить("Успех", Успех);
	Результат.Вставить("Сообщение", Сообщение);
	Результат.Вставить("Детали", ?(Детали = Неопределено, Новый Массив, Детали));
	Возврат Результат;
КонецФункции

#КонецОбласти

#Область ПрограммныйИнтерфейс

// Запускает все тесты и возвращает массив результатов.
//
// Возвращаемое значение:
//  Массив из Структура - каждый элемент: Успех, Сообщение, Детали, ИмяТеста
//
Функция ЗапуститьВсеТесты() Экспорт
	Тесты = Новый Массив;
	Тесты.Добавить("ТестСохраненияИЧтенияКонтекстаDSL");
	Тесты.Добавить("ТестCreateReferenceSetFieldМеждуВызовами");
	Тесты.Добавить("ТестRunQuery");
	Тесты.Добавить("ТестВалидацииDSL");
	Тесты.Добавить("ТестSaveToStorageLoadFromStorage");
	Тесты.Добавить("ТестРежимЗапрос1С");
	Тесты.Добавить("ТестСоздатьДиалогИВыполнитьАгентаСинхронно");
	Тесты.Добавить("ТестGetMetadata");
	Тесты.Добавить("ТестFindReferenceByName");
	Тесты.Добавить("ТестЛогированияДиалога");
	Тесты.Добавить("ТестСозданияОбъекта");
	
	Результаты = Новый Массив;
	Для Каждого ИмяТеста Из Тесты Цикл
		РезультатТеста = ВыполнитьТест(ИмяТеста);
		РезультатТеста.Вставить("ИмяТеста", ИмяТеста);
		Результаты.Добавить(РезультатТеста);
	КонецЦикла;
	Возврат Результаты;
КонецФункции

Функция ВыполнитьТест(ИмяТеста)
	Попытка
		Если ИмяТеста = "ТестСохраненияИЧтенияКонтекстаDSL" Тогда
			Возврат ТестСохраненияИЧтенияКонтекстаDSL();
		ИначеЕсли ИмяТеста = "ТестCreateReferenceSetFieldМеждуВызовами" Тогда
			Возврат ТестCreateReferenceSetFieldМеждуВызовами();
		ИначеЕсли ИмяТеста = "ТестRunQuery" Тогда
			Возврат ТестRunQuery();
		ИначеЕсли ИмяТеста = "ТестВалидацииDSL" Тогда
			Возврат ТестВалидацииDSL();
		ИначеЕсли ИмяТеста = "ТестSaveToStorageLoadFromStorage" Тогда
			Возврат ТестSaveToStorageLoadFromStorage();
		ИначеЕсли ИмяТеста = "ТестРежимЗапрос1С" Тогда
			Возврат ТестРежимЗапрос1С();
		ИначеЕсли ИмяТеста = "ТестСоздатьДиалогИВыполнитьАгентаСинхронно" Тогда
			Возврат ТестСоздатьДиалогИВыполнитьАгентаСинхронно();
		ИначеЕсли ИмяТеста = "ТестGetMetadata" Тогда
			Возврат ТестGetMetadata();
		ИначеЕсли ИмяТеста = "ТестFindReferenceByName" Тогда
			Возврат ТестFindReferenceByName();
		ИначеЕсли ИмяТеста = "ТестЛогированияДиалога" Тогда
			Возврат ТестЛогированияДиалога();
		ИначеЕсли ИмяТеста = "ТестСозданияОбъекта" Тогда
			Возврат ТестСозданияОбъекта();
		Иначе
			Возврат СформироватьРезультатТеста(Ложь, "Неизвестный тест: " + ИмяТеста);
		КонецЕсли;
	Исключение
		Возврат СформироватьРезультатТеста(Ложь, "Ошибка вызова: " + ОписаниеОшибки());
	КонецПопытки;
КонецФункции

// Тест сохранения и чтения контекста DSL между шагами в рамках одного элемента справочника ИИА_Диалоги.
// Проверяет: запись в регистр ИИА_ДанныеДиалогов, чтение, восстановление ссылки и объекта, очистку контекста.
//
// Возвращаемое значение:
//  Структура:
//   * Успех - Булево - успешность теста
//   * Сообщение - Строка - краткое сообщение
//   * Детали - Массив из Строка - этапы выполнения
//
Функция ТестСохраненияИЧтенияКонтекстаDSL() Экспорт
	
	Результат = Новый Структура;
	Результат.Вставить("Успех", Ложь);
	Результат.Вставить("Сообщение", "");
	Результат.Вставить("Детали", Новый Массив);
	
	Попытка
		
		// 1. Создать диалог
		СсылкаДиалога = ИИА_Сервер.СоздатьНовыйДиалог("Администратор", Перечисления.ИИА_ТипДиалога.Агент);
		Результат.Детали.Добавить("Создан диалог: " + СсылкаДиалога);
		
		Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
			Результат.Сообщение = "Не удалось создать диалог";
			Возврат Результат;
		КонецЕсли;
		
		// 2. Подготовить контекст DSL
		СтруктураДанных = Новый Структура;
		СтруктураДанных.Вставить("DSL_СсылкаОбъекта", СсылкаДиалога);
		СтруктураДанных.Вставить("DSL_ТипОбъекта", "Справочник");
		СтруктураДанных.Вставить("DSL_ИмяОбъекта", "ИИА_Диалоги");
		Результат.Детали.Добавить("Подготовлен контекст: DSL_СсылкаОбъекта, DSL_ТипОбъекта, DSL_ИмяОбъекта");
		
		// 3. Сохранить в регистр
		ИИА_Сервер.ЗаписатьДанныеДиалогаВРегистр(СсылкаДиалога, СтруктураДанных);
		Результат.Детали.Добавить("Контекст записан в регистр ИИА_ДанныеДиалогов");
		
		// 4. Прочитать из регистра
		Прочитан = ИИА_Сервер.ПолучитьДанныеДиалогаИзРегистра(СсылкаДиалога);
		Результат.Детали.Добавить("Контекст прочитан из регистра");
		
		// 5. Проверки
		Если Прочитан = Неопределено ИЛИ ТипЗнч(Прочитан) <> Тип("Структура") Тогда
			Результат.Сообщение = "Прочитанные данные не являются структурой";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Прочитан.Свойство("DSL_СсылкаОбъекта") Тогда
			Результат.Сообщение = "Ключ DSL_СсылкаОбъекта отсутствует в прочитанных данных";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ ЗначениеЗаполнено(Прочитан.DSL_СсылкаОбъекта) Тогда
			Результат.Сообщение = "DSL_СсылкаОбъекта пустой";
			Возврат Результат;
		КонецЕсли;
		
		Если Прочитан.DSL_СсылкаОбъекта <> СсылкаДиалога Тогда
			Результат.Сообщение = "DSL_СсылкаОбъекта не совпадает с сохранённой ссылкой";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Прочитан.Свойство("DSL_ТипОбъекта") ИЛИ Прочитан.DSL_ТипОбъекта <> "Справочник" Тогда
			Результат.Сообщение = "DSL_ТипОбъекта не совпадает (ожидается 'Справочник')";
			Возврат Результат;
		КонецЕсли;
		
		Если НЕ Прочитан.Свойство("DSL_ИмяОбъекта") ИЛИ Прочитан.DSL_ИмяОбъекта <> "ИИА_Диалоги" Тогда
			Результат.Сообщение = "DSL_ИмяОбъекта не совпадает (ожидается 'ИИА_Диалоги')";
			Возврат Результат;
		КонецЕсли;
		
		Объект = Прочитан.DSL_СсылкаОбъекта.ПолучитьОбъект();
		Если Объект = Неопределено Тогда
			Результат.Сообщение = "Не удалось получить объект по DSL_СсылкаОбъекта";
			Возврат Результат;
		КонецЕсли;
		Результат.Детали.Добавить("Проверки пройдены: ссылка, тип, имя, объект восстановлен");
		
		// 6. Очистить контекст
		ИИА_Сервер.ОчиститьКонтекстDSLДиалога(СсылкаДиалога);
		Результат.Детали.Добавить("Контекст DSL очищен");
		
		// 7. Проверить очистку
		ПослеОчистки = ИИА_Сервер.ПолучитьДанныеДиалогаИзРегистра(СсылкаДиалога);
		Если ПослеОчистки <> Неопределено И ТипЗнч(ПослеОчистки) = Тип("Структура") И ПослеОчистки.Свойство("DSL_СсылкаОбъекта") Тогда
			Результат.Сообщение = "DSL_СсылкаОбъекта остался после очистки";
			Возврат Результат;
		КонецЕсли;
		Результат.Детали.Добавить("Очистка проверена: DSL_СсылкаОбъекта отсутствует");
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден успешно";
		
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	
	Возврат Результат;
	
КонецФункции

// Тест цепочки CreateReference → SetField между двумя вызовами DSL (контекст передаётся через регистр).
//
Функция ТестCreateReferenceSetFieldМеждуВызовами() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		СсылкаДиалога = ИИА_Сервер.СоздатьНовыйДиалог("Администратор", Перечисления.ИИА_ТипДиалога.Агент);
		Результат.Детали.Добавить("Создан диалог: " + СсылкаДиалога);
		Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
			Результат.Сообщение = "Не удалось создать диалог";
			Возврат Результат;
		КонецЕсли;
		
		// Вызов 1: CreateReference
		DSL1 = "{""steps"":[{""action"":""CreateReference"",""object_name"":""ИИА_Настройки""}]}";
		Рез1 = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSL1, СсылкаДиалога);
		Результат.Детали.Добавить("Вызов 1 CreateReference: Успех=" + Рез1.Успех);
		Если НЕ Рез1.Успех Тогда
			Результат.Сообщение = "CreateReference не выполнен: " + Рез1.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		// Вызов 2: SetField (контекст должен восстановиться из регистра)
		DSL2 = "{""steps"":[{""action"":""SetField"",""field_name"":""Description"",""value"":""Тест_Обновлено""}]}";
		Рез2 = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSL2, СсылкаДиалога);
		Результат.Детали.Добавить("Вызов 2 SetField: Успех=" + Рез2.Успех);
		Если НЕ Рез2.Успех Тогда
			Результат.Сообщение = "SetField не выполнен (контекст не восстановился?): " + Рез2.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		// Вызов 3: Write для сохранения
		DSL3 = "{""steps"":[{""action"":""Write""}]}";
		Рез3 = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSL3, СсылкаДиалога);
		Результат.Детали.Добавить("Вызов 3 Write: Успех=" + Рез3.Успех);
		Если НЕ Рез3.Успех Тогда
			Результат.Сообщение = "Write не выполнен: " + Рез3.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		ИИА_Сервер.ОчиститьКонтекстDSLДиалога(СсылкаДиалога);
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: CreateReference → SetField → Write между вызовами";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест выполнения простого запроса RunQuery.
//
Функция ТестRunQuery() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		DSL = "{""steps"":[{""action"":""RunQuery"",""query"":""ВЫБРАТЬ 1 КАК Н""}]}";
		Рез = ИИА_DSL.ВыполнитьDSL(DSL, Неопределено, Ложь);
		Результат.Детали.Добавить("Выполнен RunQuery ВЫБРАТЬ 1 КАК Н");
		Если НЕ Рез.Успех Тогда
			Результат.Сообщение = "RunQuery не выполнен: " + Рез.Сообщение;
			Возврат Результат;
		КонецЕсли;
		Если Рез.Результаты.Количество() = 0 Тогда
			Результат.Сообщение = "Нет результатов шага";
			Возврат Результат;
		КонецЕсли;
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: RunQuery выполнен";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест валидации DSL (ПроверитьDSLСценарий).
//
Функция ТестВалидацииDSL() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		// Корректный DSL
		ВалидныйDSL = "{""steps"":[{""action"":""RunQuery"",""query"":""ВЫБРАТЬ 1""}]}";
		РезВалид = ИИА_Сервер.ПроверитьDSLСценарий(ВалидныйDSL);
		Результат.Детали.Добавить("Валидный DSL: Успех=" + РезВалид.Успех);
		Если НЕ РезВалид.Успех Тогда
			Результат.Сообщение = "Валидный DSL не прошёл: " + РезВалид.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		// CreateReference без object_name
		НевалидныйDSL = "{""steps"":[{""action"":""CreateReference""}]}";
		РезНевалид = ИИА_Сервер.ПроверитьDSLСценарий(НевалидныйDSL);
		Результат.Детали.Добавить("CreateReference без object_name: Успех=" + РезНевалид.Успех + " (ожидается Ложь)");
		Если РезНевалид.Успех Тогда
			Результат.Сообщение = "Невалидный DSL прошёл валидацию";
			Возврат Результат;
		КонецЕсли;
		
		// Неизвестное действие
		НеизвестныйDSL = "{""steps"":[{""action"":""UnknownAction""}]}";
		РезНеизв = ИИА_Сервер.ПроверитьDSLСценарий(НеизвестныйDSL);
		Результат.Детали.Добавить("Неизвестное действие: Успех=" + РезНеизв.Успех + " (ожидается Ложь)");
		Если РезНеизв.Успех Тогда
			Результат.Сообщение = "Неизвестное действие прошло валидацию";
			Возврат Результат;
		КонецЕсли;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: валидация DSL работает";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест SaveToStorage и LoadFromStorage через DSL.
//
Функция ТестSaveToStorageLoadFromStorage() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		СсылкаДиалога = ИИА_Сервер.СоздатьНовыйДиалог("Администратор", Перечисления.ИИА_ТипДиалога.Агент);
		Результат.Детали.Добавить("Создан диалог");
		Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
			Результат.Сообщение = "Не удалось создать диалог";
			Возврат Результат;
		КонецЕсли;
		
		КлючТест = "ТестКлюч_" + Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddHHmmss");
		ЗначениеТест = "Значение_" + КлючТест;
		
		ЗначениеЭкранир = СтрЗаменить(ЗначениеТест, "\", "\\");
		ЗначениеЭкранир = СтрЗаменить(ЗначениеЭкранир, """", "\""");
		DSLЗапись = "{""steps"":[{""action"":""SaveToStorage"",""key"":""" + КлючТест + """,""data"":""" + ЗначениеЭкранир + """}]}";
		РезЗапись = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSLЗапись, СсылкаДиалога);
		Результат.Детали.Добавить("SaveToStorage: Успех=" + РезЗапись.Успех);
		Если НЕ РезЗапись.Успех Тогда
			Результат.Сообщение = "SaveToStorage не выполнен: " + РезЗапись.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		DSLЧтение = "{""steps"":[{""action"":""LoadFromStorage"",""key"":""" + КлючТест + """}]}";
		РезЧтение = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSLЧтение, СсылкаДиалога);
		Результат.Детали.Добавить("LoadFromStorage: Успех=" + РезЧтение.Успех);
		Если НЕ РезЧтение.Успех Тогда
			Результат.Сообщение = "LoadFromStorage не выполнен: " + РезЧтение.Сообщение;
			Возврат Результат;
		КонецЕсли;
		Если РезЧтение.Результаты.Количество() > 0 Тогда
			РезШага = РезЧтение.Результаты[0];
			Если РезШага.Свойство("Данные") И Строка(РезШага.Данные) = ЗначениеТест Тогда
				Результат.Детали.Добавить("Прочитанное значение совпадает");
			КонецЕсли;
		КонецЕсли;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: SaveToStorage/LoadFromStorage";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест режима «только чтение» (Запрос1С): SetField должен быть запрещён.
//
Функция ТестРежимЗапрос1С() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		СсылкаДиалога = ИИА_Сервер.СоздатьНовыйДиалог("Администратор", Перечисления.ИИА_ТипДиалога.Запрос1С);
		Результат.Детали.Добавить("Создан диалог типа Запрос1С");
		Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
			Результат.Сообщение = "Не удалось создать диалог";
			Возврат Результат;
		КонецЕсли;
		
		// RunQuery разрешён
		DSLЗапрос = "{""steps"":[{""action"":""RunQuery"",""query"":""ВЫБРАТЬ 1 КАК Н""}]}";
		РезЗапрос = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSLЗапрос, СсылкаДиалога);
		Результат.Детали.Добавить("RunQuery в Запрос1С: Успех=" + РезЗапрос.Успех);
		Если НЕ РезЗапрос.Успех Тогда
			Результат.Сообщение = "RunQuery должен быть разрешён: " + РезЗапрос.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		// CreateReference/SetField запрещены в Запрос1С
		DSLИзменение = "{""steps"":[{""action"":""CreateReference"",""object_name"":""ИИА_Настройки""},{""action"":""SetField"",""field_name"":""Description"",""value"":""X""}]}";
		РезИзменение = ИИА_Сервер.ВыполнитьDSLСценарийБезСообщений(DSLИзменение, СсылкаДиалога);
		Результат.Детали.Добавить("CreateReference+SetField в Запрос1С: Успех=" + РезИзменение.Успех + " (ожидается Ложь)");
		Если РезИзменение.Успех Тогда
			Результат.Сообщение = "Действия изменения должны быть запрещены в режиме Запрос1С";
			Возврат Результат;
		КонецЕсли;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: режим Запрос1С корректен";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест СоздатьДиалогИВыполнитьАгентаСинхронно через COM.
//
Функция ТестСоздатьДиалогИВыполнитьАгентаСинхронно() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		Рез = ИИА_ДиалогCOM.СоздатьДиалогИВыполнитьАгентаСинхронно("Администратор", "Покажи версию DSL", Перечисления.ИИА_ТипДиалога.Агент);
		Результат.Детали.Добавить("Диалог: " + Рез.СсылкаДиалога);
		Результат.Детали.Добавить("Успех: " + Рез.Успех);
		Если НЕ ЗначениеЗаполнено(Рез.СсылкаДиалога) Тогда
			Результат.Сообщение = "Диалог не создан";
			Возврат Результат;
		КонецЕсли;
		Если СтрДлина(Рез.Лог) = 0 Тогда
			Результат.Детали.Добавить("Лог пуст (возможно оркестратор не отработал)");
		КонецЕсли;
		Результат.Успех = Рез.Успех;
		Результат.Сообщение = ?(Рез.Успех, "Тест пройден: агент выполнен", "Агент не завершился успешно (проверьте лог)");
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест GetMetadata через DSL.
//
Функция ТестGetMetadata() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		DSL = "{""steps"":[{""action"":""GetMetadata""}]}";
		Рез = ИИА_DSL.ВыполнитьDSL(DSL, Неопределено, Ложь);
		Результат.Детали.Добавить("Выполнен GetMetadata");
		Если НЕ Рез.Успех Тогда
			Результат.Сообщение = "GetMetadata не выполнен: " + Рез.Сообщение;
			Возврат Результат;
		КонецЕсли;
		Если Рез.Результаты.Количество() = 0 Тогда
			Результат.Сообщение = "Нет результатов GetMetadata";
			Возврат Результат;
		КонецЕсли;
		РезШага = Рез.Результаты[0];
		Если НЕ РезШага.Свойство("Данные") ИЛИ РезШага.Данные = Неопределено Тогда
			Результат.Сообщение = "GetMetadata не вернул данные";
			Возврат Результат;
		КонецЕсли;
		Данные = РезШага.Данные;
		Если ТипЗнч(Данные) = Тип("Структура") И (Данные.Свойство("Справочники") ИЛИ Данные.Свойство("Документы")) Тогда
			Результат.Детали.Добавить("Получены Справочники/Документы");
		КонецЕсли;
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: GetMetadata";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест FindReferenceByName: создаём элемент, ищем по имени.
//
Функция ТестFindReferenceByName() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		УникальноеИмя = "Тест_FindRef_" + Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddHHmmss");
		// Создаём элемент
		DSLСоздать = "{""steps"":[{""action"":""CreateReference"",""object_name"":""ИИА_Настройки""},{""action"":""SetField"",""field_name"":""Description"",""value"":""" + УникальноеИмя + """},{""action"":""Write""}]}";
		РезСоздать = ИИА_DSL.ВыполнитьDSL(DSLСоздать, Неопределено, Ложь);
		Результат.Детали.Добавить("Создан элемент ИИА_Настройки с именем " + УникальноеИмя + ": Успех=" + РезСоздать.Успех);
		Если НЕ РезСоздать.Успех Тогда
			Результат.Сообщение = "Не удалось создать элемент: " + РезСоздать.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		// Ищем по имени
		DSLНайти = "{""steps"":[{""action"":""FindReferenceByName"",""object_name"":""ИИА_Настройки"",""name"":""" + УникальноеИмя + """}]}";
		РезНайти = ИИА_DSL.ВыполнитьDSL(DSLНайти, Неопределено, Ложь);
		Результат.Детали.Добавить("FindReferenceByName: Успех=" + РезНайти.Успех);
		Если НЕ РезНайти.Успех Тогда
			Результат.Сообщение = "FindReferenceByName не выполнен: " + РезНайти.Сообщение;
			Возврат Результат;
		КонецЕсли;
		Если РезНайти.Результаты.Количество() = 0 Тогда
			Результат.Сообщение = "FindReferenceByName не вернул результат";
			Возврат Результат;
		КонецЕсли;
		РезШага = РезНайти.Результаты[0];
		Если НЕ РезШага.Свойство("Данные") ИЛИ НЕ ЗначениеЗаполнено(РезШага.Данные) Тогда
			Результат.Сообщение = "FindReferenceByName не вернул ссылку (Данные)";
			Возврат Результат;
		КонецЕсли;
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: FindReferenceByName";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест создания объекта: передаётся имя/наименование, создаётся элемент, проверяется что создан ровно 1 объект с таким именем.
//
Функция ТестСозданияОбъекта() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		Наименование = "Тест_Создание_Объекта_" + Формат(ТекущаяДатаСеанса(), "ДФ=yyyyMMddHHmmss");
		Результат.Детали.Добавить("Наименование для создания: " + Наименование);
		
		// Создаём объект через DSL
		НаименованиеЭкранир = СтрЗаменить(Наименование, "\", "\\");
		НаименованиеЭкранир = СтрЗаменить(НаименованиеЭкранир, """", "\""");
		DSL = "{""steps"":[{""action"":""CreateReference"",""object_name"":""ИИА_Настройки""},{""action"":""SetField"",""field_name"":""Description"",""value"":""" + НаименованиеЭкранир + """},{""action"":""Write""}]}";
		Рез = ИИА_DSL.ВыполнитьDSL(DSL, Неопределено, Ложь);
		Результат.Детали.Добавить("DSL CreateReference+SetField+Write: Успех=" + Рез.Успех);
		Если НЕ Рез.Успех Тогда
			Результат.Сообщение = "Не удалось создать объект: " + Рез.Сообщение;
			Возврат Результат;
		КонецЕсли;
		
		// Проверяем, что создан ровно 1 объект с таким наименованием
		Запрос = Новый Запрос;
		Запрос.Текст =
		"ВЫБРАТЬ
		|	КОЛИЧЕСТВО(*) КАК Количество
		|ИЗ
		|	Справочник.ИИА_Настройки КАК Элементы
		|ГДЕ
		|	Элементы.Наименование = &Наименование";
		Запрос.УстановитьПараметр("Наименование", Наименование);
		Выборка = Запрос.Выполнить().Выбрать();
		Выборка.Следующий();
		Количество = Выборка.Количество;
		Результат.Детали.Добавить("Найдено объектов с именем '" + Наименование + "': " + Количество);
		
		Если Количество <> 1 Тогда
			Результат.Сообщение = "Ожидался 1 объект с именем '" + Наименование + "', найдено: " + Количество;
			Возврат Результат;
		КонецЕсли;
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: создан 1 объект с именем '" + Наименование + "'";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

// Тест логирования диалога: ДобавитьЗаписьВЛогДиалога, ПолучитьЛогДиалога.
//
Функция ТестЛогированияДиалога() Экспорт
	Результат = СформироватьРезультатТеста(Ложь, "", Новый Массив);
	Попытка
		СсылкаДиалога = ИИА_Сервер.СоздатьНовыйДиалог("Администратор", Перечисления.ИИА_ТипДиалога.Агент);
		Результат.Детали.Добавить("Создан диалог");
		Если НЕ ЗначениеЗаполнено(СсылкаДиалога) Тогда
			Результат.Сообщение = "Не удалось создать диалог";
			Возврат Результат;
		КонецЕсли;
		
		ЗаписьТест = "[Тест] Запись от " + Формат(ТекущаяДатаСеанса(), "ДФ=dd.MM.yyyy HH:mm:ss");
		ИИА_Сервер.ДобавитьЗаписьВЛогДиалога(СсылкаДиалога, ЗаписьТест);
		Результат.Детали.Добавить("Добавлена запись в лог");
		
		Лог = ИИА_Сервер.ПолучитьЛогДиалога(СсылкаДиалога);
		Если СтрНайти(Лог, ЗаписьТест) = 0 Тогда
			Результат.Сообщение = "Добавленная запись не найдена в логе";
			Возврат Результат;
		КонецЕсли;
		Результат.Детали.Добавить("Запись найдена в логе");
		
		Результат.Успех = Истина;
		Результат.Сообщение = "Тест пройден: логирование диалога";
	Исключение
		Результат.Сообщение = "Ошибка: " + ОписаниеОшибки();
		Результат.Детали.Добавить(Результат.Сообщение);
	КонецПопытки;
	Возврат Результат;
КонецФункции

#КонецОбласти
