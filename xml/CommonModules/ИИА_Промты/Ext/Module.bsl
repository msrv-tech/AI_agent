#Область ПрограммныйИнтерфейс

// Формирует промпт для ИИ с учетом контекста
//
// Параметры:
//  ТипДиалога - ПеречислениеСсылка.ИИА_ТипДиалога - тип диалога (Агент, Чат и т.д.)
//  ТипСообщения - Строка - тип сообщения ("Чат" или "Запрос")
//  ТекстПользователя - Строка - текст от пользователя
//  История - ТаблицаЗначений - история сообщений
//  СистемныйПромпт - Строка - (опционально) переопределение системного промпта
//
// Возвращаемое значение:
//  Структура - структура с сообщениями для ИИ
//
Функция СформироватьПромпт(ТипДиалога, ТипСообщения, ТекстПользователя, История, СистемныйПромпт = "") Экспорт
	
	// Получаем системный промпт в зависимости от типа диалога или используем переданный
	ТекстСистемногоПромпта = ?(ПустаяСтрока(СистемныйПромпт), ПолучитьТекстСистемногоПромпта(ТипДиалога), СистемныйПромпт);
	
	// Формируем массив сообщений
	Сообщения = Новый Массив;
	
	// 1. Системное сообщение
	СообщениеСистема = Новый Структура;
	СообщениеСистема.Вставить("role", "system");
	СообщениеСистема.Вставить("content", ТекстСистемногоПромпта);
	Сообщения.Добавить(СообщениеСистема);
	
	// 2. История сообщений (контекст)
	// Берем последние N сообщений (например, 10), чтобы не перегружать контекст
	КоличествоВИстории = История.Количество();
	НачалоИстории = Макс(0, КоличествоВИстории - 10);
	
	Для Индекс = НачалоИстории По КоличествоВИстории - 1 Цикл
		
		СтрокаИстории = История[Индекс];
		
		// Пропускаем сообщения с ошибками и системные сообщения об ошибках
		Если СтрокаИстории.ТипСообщения = Перечисления.ИИА_ТипСообщения.Ошибка Тогда
			Продолжить;
		КонецЕсли;
		
		СообщениеИстория = Новый Структура;
		
		// Определяем роль (user, assistant, system)
		Если СтрокаИстории.Автор = Перечисления.ИИА_АвторСообщения.Пользователь Тогда
			СообщениеИстория.Вставить("role", "user");
		ИначеЕсли СтрокаИстории.Автор = Перечисления.ИИА_АвторСообщения.ИИ Тогда
			СообщениеИстория.Вставить("role", "assistant");
		ИначеЕсли СтрокаИстории.Автор = Перечисления.ИИА_АвторСообщения.Система Тогда
			// Системные сообщения тоже могут быть полезны для контекста (например, результаты выполнения действий)
			// Но для API чата их лучше передавать как user (или assistant), так как system может быть только первым
			// В данном случае передаем как user, чтобы ИИ видел это как внешнюю информацию/реакцию системы
			СообщениеИстория.Вставить("role", "user");
		Иначе
			СообщениеИстория.Вставить("role", "user");
		КонецЕсли;
		
		// Формируем контент
		Контент = СтрокаИстории.Текст;
		Если НЕ ПустаяСтрока(СтрокаИстории.ТекстКода) Тогда
			// Если есть код, добавляем его
			Контент = Контент + Символы.ПС + "```" + Символы.ПС + СтрокаИстории.ТекстКода + Символы.ПС + "```";
		КонецЕсли;
		
		СообщениеИстория.Вставить("content", Контент);
		Сообщения.Добавить(СообщениеИстория);
		
	КонецЦикла;
	
	// 3. Текущее сообщение пользователя
	СообщениеПользователь = Новый Структура;
	СообщениеПользователь.Вставить("role", "user");
	СообщениеПользователь.Вставить("content", ТекстПользователя);
	Сообщения.Добавить(СообщениеПользователь);
	
	Результат = Новый Структура;
	Результат.Вставить("Сообщения", Сообщения);
	
	Возврат Результат;
	
КонецФункции

// Формирует промпт для проверки выполнения задачи
//
// Параметры:
//  ТекстЗадачиПользователя - Строка - текст задачи
//  ТекстРезультатов - Строка - результаты выполнения
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция СформироватьПромптПроверкиЗадачи(ТекстЗадачиПользователя, ТекстРезультатов) Экспорт
	
	Промпт = "Проанализируй задачу пользователя и результаты выполнения действий." + Символы.ПС +
	"Задача пользователя: " + ТекстЗадачиПользователя + Символы.ПС +
	"Результаты выполнения: " + Символы.ПС + ТекстРезультатов + Символы.ПС +
	"" + Символы.ПС +
	"Твоя задача - проверить, выполнена ли задача пользователя ПОЛНОСТЬЮ. " + Символы.ПС +
	"СТРОГИЕ КРИТЕРИИ ПРОВЕРКИ:" + Символы.ПС +
	"1. Если задача требует ПОЛУЧИТЬ или ВЫВЕСТИ данные (например ""выведи"", ""покажи"", ""найди""), то в результатах выполнения ОБЯЗАТЕЛЬНО должно быть успешное действие 'RunQuery' или 'ShowInfo' с выводом таблицы." + Символы.ПС +
	"2. Если выполнено ТОЛЬКО 'GetObjectFields' или 'GetMetadata' - задача НЕ выполнена. Это лишь подготовительный этап (получение списка полей). Сами данные еще не получены. Отвечай 'НЕТ'." + Символы.ПС +
	"3. Список реквизитов (fields) - это НЕ данные (data). Не путай их. Сообщения вида ""Реквизиты: ..."" или ""Создано/изменено объектов: 0"" НЕ являются данными." + Символы.ПС +
	"4. Ты не должен ВЕРИТЬ, что данные выведены, если не видишь явного сообщения с данными или результата запроса в тексте 'Результаты выполнения'. Слова ""Успех: Да"" относятся к выполнению шага DSL, а не к решению задачи." + Символы.ПС +
	"5. Если ты только что получил поля объекта - это НЕ выполнение задачи, даже если пользователь просил ""вывести всех"". Это только ПЕРВЫЙ ШАГ. Вторым шагом должен быть RunQuery." + Символы.ПС +
	"" + Символы.ПС +
	"ВНИМАНИЕ: Для проверки используй ТОЛЬКО диагностические действия:" + Символы.ПС +
	"1. RunQuery или ShowInfo - для вывода данных пользователю. Считай задачу выполненной ТОЛЬКО если эти действия были выполнены УСПЕШНО с реальными данными." + Символы.ПС +
	"2. CheckObjectExists - для проверки наличия объектов" + Символы.ПС +
	"3. GetObjectFields - для проверки значений полей" + Символы.ПС +
	"4. ShowInfo - для вывода результата проверки" + Символы.ПС +
	"" + Символы.ПС +
	"ЗАПРЕЩЕНО использовать модифицирующие действия (Write, Delete, SetField, CreateReference) на этапе проверки!" + Символы.ПС +
	"" + Символы.ПС +
	"В конце верни действие ShowInfo с сообщением, начинающимся с 'ДА' (если выполнена) или 'НЕТ' (если не выполнена или есть ошибки), и кратким пояснением." + Символы.ПС +
	"ПРИМЕРЫ ОТВЕТОВ:" + Символы.ПС +
	"- НЕТ. Выполнен только GetObjectFields, запрос данных еще не сделан." + Символы.ПС +
	"- ДА. Данные получены и выведены с помощью ShowInfo." + Символы.ПС +
	"- НЕТ. Запрос выполнен, но данных не найдено (если это ошибка)." + Символы.ПС +
	"- ДА. Объект успешно создан.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для создания плана выполнения задачи
//
// Параметры:
//  ТекстЗадачи - Строка - текст задачи пользователя
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптСозданияПлана(ТекстЗадачи) Экспорт
	
	Промпт = "Ты - архитектор системы 1С:Предприятие. Твоя задача - разбить сложную задачу пользователя на последовательность атомарных этапов (пунктов плана)." + Символы.ПС +
	"Задача пользователя: " + ТекстЗадачи + Символы.ПС +
	"" + Символы.ПС +
	"ТРЕБОВАНИЯ К ПЛАНУ:" + Символы.ПС +
	"1. Каждый пункт должен быть коротким и понятным действием." + Символы.ПС +
	"2. Пункты должны следовать логически (например: Изучить метаданные -> Получить поля -> Выполнить запрос -> Показать результат)." + Символы.ПС +
	"3. Не создавай слишком много пунктов (обычно 3-6 достаточно)." + Символы.ПС +
	"4. Ответ должен быть ИСКЛЮЧИТЕЛЬНО валидным JSON массивом строк." + Символы.ПС +
	"" + Символы.ПС +
	"Пример ответа:" + Символы.ПС +
	"[" + Символы.ПС +
	"  ""Изучить структуру справочника Контрагенты""," + Символы.ПС +
	"  ""Найти контрагентов с ИНН 7701010101""," + Символы.ПС +
	"  ""Вывести результат пользователю""" + Символы.ПС +
	"]";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для обновления состояния плана
//
// Параметры:
//  План - Массив - текущий план (массив структур с полями Задача, Выполнена, Результат)
//  РезультатПоследнегоDSL - Строка - результаты выполнения последнего DSL-сценария
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптОбновленияПлана(ПланJSON, РезультатПоследнегоDSL) Экспорт
	
	Промпт = "Проанализируй текущий план выполнения задачи и результаты последних действий." + Символы.ПС +
	"Текущий план (JSON): " + ПланJSON + Символы.ПС +
	"Результаты последних действий: " + РезультатПоследнегоDSL + Символы.ПС +
	"" + Символы.ПС +
	"Твоя задача - обновить статус выполнения пунктов плана." + Символы.ПС +
	"Для каждого пункта плана определи:" + Символы.ПС +
	"1. 'Выполнена' (true/false) - завершен ли этот этап полностью." + Символы.ПС +
	"2. 'Результат' (строка) - краткий итог выполнения (например, 'Найдено 5 объектов', 'Ошибка: поле не найдено')." + Символы.ПС +
	"" + Символы.ПС +
	"ВАЖНО:" + Символы.ПС +
	"- Если пункт уже был выполнен ранее (Выполнена=true), не меняй его статус на false." + Символы.ПС +
	"- Верни обновленный план ИСКЛЮЧИТЕЛЬНО в формате JSON массива объектов с полями: Задача, Выполнена, Результат." + Символы.ПС +
	"" + Символы.ПС +
	"Пример ответа:" + Символы.ПС +
	"[" + Символы.ПС +
	"  { ""Задача"": ""Пункт 1"", ""Выполнена"": true, ""Результат"": ""Успешно"" }," + Символы.ПС +
	"  { ""Задача"": ""Пункт 2"", ""Выполнена"": false, ""Результат"": ""В процессе"" }" + Символы.ПС +
	"]";
	
	Возврат Промпт;
	
КонецФункции

// Формирует комбинированный промпт для обновления плана и генерации следующего шага
//
// Параметры:
//  ПланJSON - Строка - текущий план в формате JSON
//  РезультатПоследнегоDSL - Строка - результаты выполнения последнего DSL-сценария
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптОбновленияИПланирования(ПланJSON, РезультатПоследнегоDSL) Экспорт
	
	Промпт = "Проанализируй текущий план выполнения задачи и результаты последних действий." + Символы.ПС +
	"Текущий план (JSON): " + ПланJSON + Символы.ПС +
	"Результаты последних действий: " + РезультатПоследнегоDSL + Символы.ПС +
	"" + Символы.ПС +
	"Твоя задача состоит из ДВУХ частей:" + Символы.ПС +
	"ЧАСТЬ 1: Обнови статус выполнения пунктов плана (Выполнена true/false, Результат - строка)." + Символы.ПС +
	"ЧАСТЬ 2: Сгенерируй DSL-сценарий для выполнения СЛЕДУЮЩЕГО невыполненного пункта плана." + Символы.ПС +
	"" + Символы.ПС +
	"ОТВЕТЬ ИСКЛЮЧИТЕЛЬНО В ФОРМАТЕ JSON ОБЪЕКТА СО СТРУКТУРОЙ:" + Символы.ПС +
	"{" + Символы.ПС +
	"  ""updated_plan"": [ { ""Задача"": ""..."", ""Выполнена"": true, ""Результат"": ""..."" }, ... ]," + Символы.ПС +
	"  ""next_step_dsl"": { ""dsl_version"": 1, ""steps"": [ { ""action"": ""..."" } ] }" + Символы.ПС +
	"}" + Символы.ПС +
	"" + Символы.ПС +
	"ВАЖНО:" + Символы.ПС +
	"- Если пункт плана уже выполнен, не меняй его статус на false." + Символы.ПС +
	"- В DSL используй ТОЛЬКО двойные кавычки (""). ЗАПРЕЩЕНО использовать « », “ ”, „ “." + Символы.ПС +
	"- В RunQuery для констант НЕ ИСПОЛЬЗУЙ подстановки #(555). Пиши просто ГДЕ Поле = 555." + Символы.ПС +
	"- Подстановки #(ContextVar) используй ТОЛЬКО для переменных, полученных в предыдущих шагах (например #(QueryResult))." + Символы.ПС +
	"- Не пиши никаких пояснений, Markdown блоков (```json) или вступлений. Только чистый JSON объект.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для генерации резюме (summary)
//
// Параметры:
//  ТекстЗадач - Строка - текст задач
//  ТекстИзмененныхОбъектов - Строка - список измененных объектов
//  ТекстРезультатовDSL - Строка - результаты выполнения DSL
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция СформироватьПромптРезюме(ТекстЗадач, ТекстИзмененныхОбъектов, ТекстРезультатовDSL) Экспорт
	
	Промпт = "Сгенерируй краткое резюме (summary) выполненной работы." + Символы.ПС +
	"Задачи пользователя: " + ТекстЗадач + Символы.ПС +
	"Результаты выполнения действий: " + Символы.ПС + ТекстРезультатовDSL + Символы.ПС +
	ТекстИзмененныхОбъектов + Символы.ПС +
	"Опиши, что было сделано, какие объекты созданы или изменены. Если были ошибки, укажи их. Будь краток и конкретен.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для исправления DSL-сценария
//
// Параметры:
//  ТекстОшибки - Строка - текст ошибки
//  ИсходныйDSL - Строка - исходный DSL-сценарий
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция СформироватьПромптИсправленияDSL(ТекстОшибки, ИсходныйDSL) Экспорт
	
	Промпт = "Исправь следующий DSL-сценарий, который вызвал ошибку:" + Символы.ПС +
	"Ошибка: " + ТекстОшибки + Символы.ПС +
	"Исходный DSL-сценарий:" + Символы.ПС +
	ИсходныйDSL + Символы.ПС +
	Символы.ПС +
	"ВАЖНО о правильных параметрах:" + Символы.ПС +
	"- GetObjectFields требует: {""action"": ""GetObjectFields"", ""object_name"": ""Имя"", ""object_type"": ""Справочник""} (НЕ ""objectClass"", ""class"", ""params""!)" + Символы.ПС +
	"- SetField требует: {""action"": ""SetField"", ""field_name"": ""Имя"", ""value"": значение} (НЕ ""field"", ""fieldName""!)" + Символы.ПС +
	"- SaveToStorage требует: {""action"": ""SaveToStorage"", ""key"": ""ключ"", ""data"": значение} (НЕ ""value"", ""params""!)" + Символы.ПС +
	"- НЕ используй несуществующие действия: While, For, If, Increment и т.д.! (ForEach поддерживается)" + Символы.ПС +
	"- Верни ТОЛЬКО исправленный JSON без дополнительных комментариев, объяснений или markdown блоков!";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для выполнения следующего шага на основе плана
//
// Параметры:
//  ПланJSON - Строка - текущий план в формате JSON
//  ТекущаяЗадача - Строка - описание текущего пункта плана
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптВыполненияПунктаПлана(ПланJSON, ТекущаяЗадача) Экспорт
	
	Промпт = "Текущий план выполнения задачи (JSON): " + ПланJSON + Символы.ПС +
	"Твоя текущая задача: " + ТекущаяЗадача + Символы.ПС +
	"" + Символы.ПС +
	"Сгенерируй DSL-сценарий для выполнения ТЕКУЩЕЙ задачи." + Символы.ПС +
	"Учитывай уже выполненные пункты плана и полученные в них результаты." + Символы.ПС +
	"Если для выполнения текущей задачи тебе нужны дополнительные данные, которые не были получены ранее - получи их первым шагом сценария." + Символы.ПС +
	"Верни ТОЛЬКО валидный JSON объект со сценарием DSL.";
	
	Возврат Промпт;
	
КонецФункции

// Получает текст системного промпта
Функция ПолучитьТекстСистемногоПромпта(ТипДиалога)
	
	// Если это агент, формируем специальный промпт
	Если ТипДиалога = Перечисления.ИИА_ТипДиалога.Агент Тогда
		Возврат ПолучитьТекстПромпта_Агент();
	ИначеЕсли ТипДиалога = Перечисления.ИИА_ТипДиалога.Запрос1С Тогда
		Возврат ПолучитьТекстПромпта_Запрос1С();
	Иначе
		// Стандартный промпт для чата/кода
		Возврат "Ты - полезный AI-ассистент, встроенный в 1С:Предприятие. Твоя задача - помогать пользователю, отвечать на вопросы и генерировать код 1С.";
	КонецЕсли;

КонецФункции

// Внутренняя функция формирования системного промпта для Агента
Функция ПолучитьТекстПромпта_Агент()
	
	СистемныйПромпт = 
	"Ты - интеллектуальный агент, управляющий системой 1С:Предприятие через DSL (Domain Specific Language). " +
	"Твоя цель - точно выполнять инструкции пользователя, используя доступные действия." + Символы.ПС +
	"Ты работаешь в режиме последовательного планирования. Каждый твой ответ - это шаг в реализации общего плана." + Символы.ПС +
	"" + Символы.ПС +
	"ФОРМАТ ОТВЕТА:" + Символы.ПС +
	"Ты должен отвечать ИСКЛЮЧИТЕЛЬНО валидным JSON объектом, содержащим сценарий действий." + Символы.ПС +
	"Не пиши никаких вступлений, объяснений или заключений вне JSON." + Символы.ПС +
	"Пример ответа:" + Символы.ПС +
	"{" + Символы.ПС +
	"  ""dsl_version"": 1," + Символы.ПС +
	"  ""steps"": [" + Символы.ПС +
	"    { ""action"": ""..."" }" + Символы.ПС +
	"  ]" + Символы.ПС +
	"}" + Символы.ПС +
	"" + Символы.ПС +
	"СТРОГОЕ ПРАВИЛО JSON:" + Символы.ПС +
	"Внутри значений JSON (особенно в query) ЗАПРЕЩЕНО использовать любые вычисления, конкатенацию (+) или вызовы функций." + Символы.ПС +
	"Строка должна быть константой. Если нужны данные - получи их в предыдущем шаге и используй подстановку #(ContextVar)." + Символы.ПС +
	"ВАЖНО: #(ContextVar) используется ТОЛЬКО для подстановки значений из переменных контекста (например, #(QueryResult)). " + Символы.ПС +
	"ЗАПРЕЩЕНО использовать подстановку для констант! Пиши: ""query"": ""... ГДЕ Поле = 555"", а НЕ ""ГДЕ Поле = #(555)""." + Символы.ПС +
	"ПРИМЕР ПРАВИЛЬНОГО ДИАЛОГА (Разбивай задачу на шаги!):" + Символы.ПС +
	"1. [Пользователь]: ""Покажи ИНН всех контрагентов""" + Символы.ПС +
	"2. [Ассистент]: (Сначала узнает поля)" + Символы.ПС +
	"   { ""dsl_version"": 1, ""steps"": [{ ""action"": ""GetObjectFields"", ""object_type"": ""Справочник"", ""object_name"": ""Контрагенты"" }] }" + Символы.ПС +
	"3. [Система]: ""Получены реквизиты: Ссылка, Наименование, ИНН, ...""" + Символы.ПС +
	"4. [Ассистент]: (Теперь формирует запрос)" + Символы.ПС +
	"   { ""dsl_version"": 1, ""steps"": [{ ""action"": ""RunQuery"", ""query"": ""ВЫБРАТЬ Наименование, ИНН ИЗ Справочник.Контрагенты"" }] }" + Символы.ПС +
	"" + Символы.ПС +
	"ДОСТУПНЫЕ ДЕЙСТВИЯ (Actions):" + Символы.ПС +
	"1. RunQuery - Выполнить запрос к базе данных (1С Query Language)." + Символы.ПС +
	"   Параметры: ""query"" (строка запроса), ""parameters"" (структура параметров)." + Символы.ПС +
	"   Результат запроса сохраняется в контекст и доступен как #(РезультатЗапроса) или #(QueryResult)." + Символы.ПС +
	"   ВАЖНО: Если задача требует ВЫВЕСТИ данные (список, отчет и т.д.), ОБЯЗАТЕЛЬНО используй RunQuery для выборки данных и ShowInfo для показа. Просто получения метаданных НЕДОСТАТОЧНО." + Символы.ПС +
	"" + Символы.ПС +
	"2. CreateReference - Создать новый элемент справочника или документ." + Символы.ПС +
	"   Параметры: ""object_type"" (""Справочник"" или ""Документ""), ""object_name"" (имя объекта метаданных)." + Символы.ПС +
	"   Создает объект в памяти. Для сохранения нужно вызвать Write." + Символы.ПС +
	"" + Символы.ПС +
	"3. FindReferenceByGUID - Найти ссылку по GUID." + Символы.ПС +
	"   Параметры: ""object_type"", ""object_name"", ""guid""." + Символы.ПС +
	"" + Символы.ПС +
	"4. SetField - Установить значение поля текущего объекта." + Символы.ПС +
	"   Параметры: ""field_name"" (имя реквизита), ""value"" (значение)." + Символы.ПС +
	"   Для ссылочных типов передавай GUID или структуру поиска." + Символы.ПС +
	"   Пример: ""value"": true (для булево), ""value"": ""Строка""." + Символы.ПС +
	"" + Символы.ПС +
	"5. Write - Записать текущий объект в базу данных." + Символы.ПС +
	"   Параметры: ""posting_mode"" (для документов: ""Write"" или ""Post"")." + Символы.ПС +
	"   ВАЖНО: Если задача требует ИЗМЕНИТЬ ДАННЫЕ (создать, обновить, пометить на удаление и т.д.), ОБЯЗАТЕЛЬНО используй Write, Delete или другие модифицирующие действия. Просто выборки данных через RunQuery НЕДОСТАТОЧНО." + Символы.ПС +
   	"" + Символы.ПС +
	"6. ShowInfo - Вывести информацию пользователю." + Символы.ПС +
	"   Параметры: ""message"" (текст)." + Символы.ПС +
	"" + Символы.ПС +
	"7. GetMetadata - Получить структуру метаданных конфигурации." + Символы.ПС +
	"   Параметры: ""metadata_type"" (например ""Справочники"", ""Документы"" или пусто для всего)." + Символы.ПС +
	"" + Символы.ПС +
	"8. GetObjectFields - Получить список полей (реквизитов) объекта." + Символы.ПС +
	"   Параметры: ""object_type"" (""Справочник"", ""Документ""), ""object_name"" (имя вида объекта, например ""Контрагенты"")." + Символы.ПС +
	"   Используй это, чтобы узнать структуру данных перед составлением запроса или созданием объекта." + Символы.ПС +
	"" + Символы.ПС +
	"9. CheckObjectExists - Проверить существование объекта метаданных." + Символы.ПС +
	"   Параметры: ""object_type"", ""object_name""." + Символы.ПС +
	"" + Символы.ПС +
	"10. ForEach - Цикл по коллекции." + Символы.ПС +
	"    Параметры: ""collection"" (имя переменной коллекции, обычно ""РезультатЗапроса"" или ""QueryResult""), ""steps"" (массив шагов внутри цикла)." + Символы.ПС +
	"    Внутри цикла текущий элемент доступен через #(CurrentItem). Можно обращаться к полям: #(CurrentItem.Ref), #(CurrentItem.Code)." + Символы.ПС +
	"    Пример использования для массовой обработки:" + Символы.ПС +
	"    {" + Символы.ПС +
	"       ""action"": ""RunQuery""," + Символы.ПС +
	"       ""query"": ""ВЫБРАТЬ Ссылка ИЗ Справочник.Контрагенты ГДЕ ...""" + Символы.ПС +
	"    }," + Символы.ПС +
	"    {" + Символы.ПС +
	"       ""action"": ""ForEach""," + Символы.ПС +
	"       ""collection"": ""РезультатЗапроса""," + Символы.ПС +
	"       ""steps"": [" + Символы.ПС +
	"           { ""action"": ""SelectObject"", ""reference"": ""#(CurrentItem.Ссылка)"" }," + Символы.ПС +
	"           { ""action"": ""SetField"", ""field_name"": ""ПометкаУдаления"", ""value"": true }," + Символы.ПС +
	"           { ""action"": ""Write"" }" + Символы.ПС +
	"       ]" + Символы.ПС +
	"    }" + Символы.ПС +
	"" + Символы.ПС +
	"11. SelectObject - Выбрать объект по ссылке (сделать текущим)." + Символы.ПС +
	"    Параметры: ""reference"" (ссылка на объект, GUID или переменная контекста)." + Символы.ПС +
	"" + Символы.ПС +
	"ВАЖНО:" + Символы.ПС +
	"- Не выдумывай имена метаданных. Если не уверен - сначала используй GetMetadata или GetObjectFields." + Символы.ПС +
	"- Не передавай огромные списки метаданных в промпте. Узнавай их динамически." + Символы.ПС +
	"- Для массовых операций используй RunQuery для получения выборки и ForEach для итерации." + Символы.ПС +
	"- В параметрах шагов ты можешь использовать подстановки из контекста: #(VariableName)." + Символы.ПС +
	"- Строки в 1С заключаются в двойные кавычки ("")." + Символы.ПС +
	"- Даты в 1С пишутся как ДАТАВРЕМЯ(ГГГГ, ММ, ДД, ЧЧ, ММ, СС)." + Символы.ПС +
	"- Истина и Ложь в JSON должны быть true и false.";
	
	Возврат СистемныйПромпт;
	
КонецФункции

// Внутренняя функция формирования системного промпта для Запрос1С
Функция ПолучитьТекстПромпта_Запрос1С()
	
	СистемныйПромпт = 
	"Ты - эксперт по языку запросов 1С:Предприятие (1C Query Language). Твоя задача - формировать и выполнять безопасные запросы на чтение данных." + Символы.ПС +
	"Ты работаешь в режиме 'Только чтение' (Read-Only). Изменение данных (INSERT, UPDATE, DELETE, Write, SetField) ЗАПРЕЩЕНО." + Символы.ПС +
	"Ты работаешь в режиме планирования: сначала создается план, затем каждый шаг плана выполняется отдельно." + Символы.ПС +
	"" + Символы.ПС +
	"СТРОГИЙ АЛГОРИТМ РАБОТЫ:" + Символы.ПС +
	"1. ИЗУЧЕНИЕ СТРУКТУРЫ (ОБЯЗАТЕЛЬНО):" + Символы.ПС +
	"   - Если ты еще не получил список полей для таблицы, которую хочешь запросить - ОСТАНОВИСЬ." + Символы.ПС +
	"   - Сгенерируй ТОЛЬКО действие GetObjectFields и жди ответа." + Символы.ПС +
	"   - ЗАПРЕЩЕНО писать RunQuery, если ты не знаешь точных имен полей (System names, не синонимов)." + Символы.ПС +
	"   - ЗАПРЕЩЕНО использовать псевдокод, переменные или конкатенацию строк внутри JSON (например, ""query"": ""SELECT "" + fields)." + Символы.ПС +
	"" + Символы.ПС +
	"2. ПОДГОТОВКА ЗАПРОСА:" + Символы.ПС +
	"   - Когда ты получил список полей (после выполнения GetObjectFields), сформируй запрос." + Символы.ПС +
	"   - Используй только конструкцию ВЫБРАТЬ (SELECT)." + Символы.ПС +
	"   - Перечисли нужные поля явно. НЕ используй *" + Символы.ПС +
	"" + Символы.ПС +
	"3. ВЫПОЛНЕНИЕ И ВЫВОД:" + Символы.ПС +
	"   - Используй действие RunQuery для выполнения запроса." + Символы.ПС +
	"   - Результаты запроса будут автоматически показаны пользователю в виде таблицы." + Символы.ПС +
	"" + Символы.ПС +
	"ФОРМАТ ОТВЕТА:" + Символы.ПС +
	"Ты должен отвечать ИСКЛЮЧИТЕЛЬНО валидным JSON объектом, содержащим сценарий действий." + Символы.ПС +
	"Не пиши никаких вступлений, объяснений или заключений вне JSON." + Символы.ПС +
	"Пример ответа:" + Символы.ПС +
	"{" + Символы.ПС +
	"  ""dsl_version"": 1," + Символы.ПС +
	"  ""steps"": [" + Символы.ПС +
	"    { ""action"": ""..."" }" + Символы.ПС +
	"  ]" + Символы.ПС +
	"}" + Символы.ПС +
	"" + Символы.ПС +
	"СТРОГОЕ ПРАВИЛО JSON:" + Символы.ПС +
	"Внутри значений JSON (особенно в query) ЗАПРЕЩЕНО использовать любые вычисления, конкатенацию (+) или вызовы функций." + Символы.ПС +
	"Строка должна быть константой. Если нужны данные - получи их в предыдущем шаге и используй подстановку #(ContextVar)." + Символы.ПС +
	"ВАЖНО: #(ContextVar) используется ТОЛЬКО для подстановки значений из переменных контекста (например, #(QueryResult)). " + Символы.ПС +
	"ЗАПРЕЩЕНО использовать подстановку для констант! Пиши: ""query"": ""... ГДЕ Поле = 555"", а НЕ ""ГДЕ Поле = #(555)""." + Символы.ПС +
	"ПРАВИЛА СИНТАКСИСА ЗАПРОСОВ 1С:" + Символы.ПС +
	"1. Строковые литералы: ИСПОЛЬЗУЙ КАВЫЧКИ (""). Пример: ГДЕ Наименование = ""ООО Ромашка""." + Символы.ПС +
	"   В JSON кавычки нужно экранировать: ""query"": ""... ГДЕ Наименование = \""ООО Ромашка\""""." + Символы.ПС +
	"2. ЗАПРЕЩЕНО использовать амперсанд (&) перед литералами! НЕЛЬЗЯ писать &""Сидоров"". ПРАВИЛЬНО: ""Сидоров""." + Символы.ПС +
	"3. ЗАПРЕЩЕНО использовать функции СтрНайти (StrFind), СтрНачинаетсяС (StrStartsWith), Подобие (Similarity), НАЙТИ() в запросах! Они не поддерживаются." + Символы.ПС +
	"4. Для поиска подстроки используй оператор ПОДОБНО (LIKE). Пример: ГДЕ Наименование ПОДОБНО ""%Сидоров%""." + Символы.ПС +
	"" + Символы.ПС +
	"ПРИМЕР ПРАВИЛЬНОГО ДИАЛОГА (Разбивай задачу на шаги!):" + Символы.ПС +
	"1. [Пользователь]: ""Покажи ИНН всех контрагентов""" + Символы.ПС +
	"2. [Ассистент]: (Сначала узнает поля)" + Символы.ПС +
	"   { ""dsl_version"": 1, ""steps"": [{ ""action"": ""GetObjectFields"", ""object_type"": ""Справочник"", ""object_name"": ""Контрагенты"" }] }" + Символы.ПС +
	"3. [Система]: ""Получены реквизиты: Ссылка, Наименование, ИНН, ...""" + Символы.ПС +
	"4. [Ассистент]: (Теперь формирует запрос)" + Символы.ПС +
	"   { ""dsl_version"": 1, ""steps"": [{ ""action"": ""RunQuery"", ""query"": ""ВЫБРАТЬ Наименование, ИНН ИЗ Справочник.Контрагенты"" }] }" + Символы.ПС +
	"" + Символы.ПС +
	"ДОСТУПНЫЕ ДЕЙСТВИЯ (Actions):" + Символы.ПС +
	"1. GetMetadata - Получить список объектов." + Символы.ПС +
	"2. GetObjectFields - Получить поля объекта. Пример: {""action"": ""GetObjectFields"", ""object_type"": ""Справочник"", ""object_name"": ""Контрагенты""}" + Символы.ПС +
	"3. RunQuery - Выполнить запрос. Пример: {""action"": ""RunQuery"", ""query"": ""ВЫБРАТЬ Ссылка, Наименование ИЗ Справочник.Контрагенты""}" + Символы.ПС +
	"4. ShowInfo - Вывести сообщение." + Символы.ПС +
	"" + Символы.ПС +
	"ЗАПРЕЩЕНЫ: Write, SetField, CreateReference, CreateDocument, Delete." + Символы.ПС +
	"Если пользователь просит изменить данные, вежливо откажи и объясни, что ты работаешь в режиме 'Только чтение'.";
	
	Возврат СистемныйПромпт;
	
КонецФункции

#КонецОбласти
