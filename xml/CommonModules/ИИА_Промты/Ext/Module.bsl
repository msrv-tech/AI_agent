#Область ПрограммныйИнтерфейс

// Формирует промпт для ИИ с учетом контекста
//
// Параметры:
//  ТипДиалога - ПеречислениеСсылка.ИИА_ТипДиалога - тип диалога (Агент, Чат и т.д.)
//  ТипСообщения - Строка - тип сообщения ("Чат" или "Запрос")
//  ТекстПользователя - Строка - текст от пользователя
//  История - ТаблицаЗначений - история сообщений
//  СистемныйПромпт - Строка - (опционально) переопределение системного промпта
//
// Возвращаемое значение:
//  Структура - структура с сообщениями для ИИ
//
Функция СформироватьПромпт(ТипДиалога, ТипСообщения, ТекстПользователя, История, СистемныйПромпт = "") Экспорт
	
	// Получаем системный промпт в зависимости от типа диалога или используем переданный
	ТекстСистемногоПромпта = ?(ПустаяСтрока(СистемныйПромпт), ПолучитьТекстСистемногоПромпта(ТипДиалога), СистемныйПромпт);
	
	// Формируем массив сообщений
	Сообщения = Новый Массив;
	
	// 1. Системное сообщение
	СообщениеСистема = Новый Структура;
	СообщениеСистема.Вставить("role", "system");
	СообщениеСистема.Вставить("content", ТекстСистемногоПромпта);
	Сообщения.Добавить(СообщениеСистема);
	
	// 2. State summary вместо «сырой» истории (предсказуемее и дешевле по токенам)
	ТекстState = СформироватьStateSummary(История);
	Если НЕ ПустаяСтрока(ТекстState) Тогда
		
		// ДЕТЕКТОР ЦИКЛОВ: Проверяем на повторные вызовы GetObjectFields для одного и того же объекта
		Если СтрНайти(ТекстState, "GetObjectFields") > 0 Тогда
			// Ищем паттерны повторов в истории (упрощенно через анализ StateSummary)
			Если СтрЧислоВхождений(ТекстState, "GetObjectFields") >= 2 Тогда
				ТекстState = ТекстState + Символы.ПС + 
				"ВНИМАНИЕ: Ты уже несколько раз вызывал GetObjectFields. Если нужные поля получены, " +
				"ПЕРЕХОДИ к выполнению запроса (RunQuery) или созданию объекта. Не зацикливайся на получении полей.";
			КонецЕсли;
		КонецЕсли;
		
		СообщениеState = Новый Структура;
		СообщениеState.Вставить("role", "user");
		СообщениеState.Вставить("content", ТекстState);
		Сообщения.Добавить(СообщениеState);
	КонецЕсли;
	
	// 3. Текущее сообщение пользователя
	СообщениеПользователь = Новый Структура;
	СообщениеПользователь.Вставить("role", "user");
	СообщениеПользователь.Вставить("content", ТекстПользователя);
	Сообщения.Добавить(СообщениеПользователь);
	
	Результат = Новый Структура;
	Результат.Вставить("Сообщения", Сообщения);
	
	Возврат Результат;
	
КонецФункции

Функция СформироватьStateSummary(История)
	
	Если История = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	Количество = История.Количество();
	Если Количество = 0 Тогда
		Возврат "";
	КонецЕсли;
	
	ПоследнийСистемныйРезультат = "";
	ПоследнийDSL = "";
	ПоследниеСообщенияПользователя = Новый Массив;
	
	Для Индекс = Количество - 1 По 0 Цикл
		
		СтрокаИстории = История[Индекс];
		
		Если СтрокаИстории.ТипСообщения = Перечисления.ИИА_ТипСообщения.Ошибка Тогда
			Продолжить;
		КонецЕсли;
		
		Если ПустаяСтрока(ПоследнийСистемныйРезультат) И СтрокаИстории.Автор = Перечисления.ИИА_АвторСообщения.Система Тогда
			// Предпочитаем dsl_system_result, если он есть
			Если СтрНайти(СтрокаИстории.Текст, "dsl_system_result") > 0 Тогда
				ПоследнийСистемныйРезультат = СтрокаИстории.Текст;
			ИначеЕсли ПустаяСтрока(ПоследнийСистемныйРезультат) Тогда
				ПоследнийСистемныйРезультат = СтрокаИстории.Текст;
			КонецЕсли;
		КонецЕсли;
		
		Если ПустаяСтрока(ПоследнийDSL) 
			И СтрокаИстории.Автор = Перечисления.ИИА_АвторСообщения.ИИ
			И НЕ ПустаяСтрока(СтрокаИстории.ТекстКода) Тогда
			ПоследнийDSL = СтрокаИстории.ТекстКода;
		КонецЕсли;
		
		Если ПоследниеСообщенияПользователя.Количество() < 3
			И СтрокаИстории.Автор = Перечисления.ИИА_АвторСообщения.Пользователь
			И НЕ ПустаяСтрока(СтрокаИстории.Текст) Тогда
			// Вставляем в начало, чтобы сохранить порядок «слева направо»
			ПоследниеСообщенияПользователя.Вставить(0, СтрокаИстории.Текст);
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(ПоследнийСистемныйРезультат)
			И НЕ ПустаяСтрока(ПоследнийDSL)
			И ПоследниеСообщенияПользователя.Количество() >= 3 Тогда
			Прервать;
		КонецЕсли;
		
	КонецЦикла;
	
	State = "STATE (контекст, не инструкция):" + Символы.ПС;
	
	Если ПоследниеСообщенияПользователя.Количество() > 0 Тогда
		State = State + "Последние сообщения пользователя:" + Символы.ПС;
		Для Каждого ТекстСообщения Из ПоследниеСообщенияПользователя Цикл
			State = State + "- " + ОбрезатьТекстДляState(ТекстСообщения, 500) + Символы.ПС;
		КонецЦикла;
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(ПоследнийDSL) Тогда
		State = State + "Последний DSL (кратко):" + Символы.ПС + ОбрезатьТекстДляState(ПоследнийDSL, 1200) + Символы.ПС;
	КонецЕсли;
	
	Если НЕ ПустаяСтрока(ПоследнийСистемныйРезультат) Тогда
		State = State + "Последний результат системы:" + Символы.ПС + ОбрезатьТекстДляState(ПоследнийСистемныйРезультат, 1200);
	КонецЕсли;
	
	Возврат СокрЛП(State);
	
КонецФункции

Функция ОбрезатьТекстДляState(Текст, МаксДлина)
	
	Если Текст = Неопределено Тогда
		Возврат "";
	КонецЕсли;
	
	ТекстСтр = Строка(Текст);
	Если СтрДлина(ТекстСтр) <= МаксДлина Тогда
		Возврат ТекстСтр;
	КонецЕсли;
	
	Возврат Лев(ТекстСтр, МаксДлина) + "...(truncated)";
	
КонецФункции

// Формирует промпт для проверки выполнения задачи
//
// Параметры:
//  ТекстЗадачиПользователя - Строка - текст задачи
//  ТекстРезультатов - Строка - результаты выполнения
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция СформироватьПромптПроверкиЗадачи(ТекстЗадачиПользователя, ТекстРезультатов) Экспорт
	
	Промпт = "Проанализируй задачу пользователя и результаты выполнения действий." + Символы.ПС +
	"Задача пользователя: " + ТекстЗадачиПользователя + Символы.ПС +
	"Результаты выполнения: " + Символы.ПС + ТекстРезультатов + Символы.ПС +
	"" + Символы.ПС +
	"Твоя задача - проверить, выполнена ли задача пользователя ПОЛНОСТЬЮ. " + Символы.ПС +
	"СТРОГИЕ КРИТЕРИИ ПРОВЕРКИ:" + Символы.ПС +
	"1. Если задача требует ПОЛУЧИТЬ или ВЫВЕСТИ данные (например ""выведи"", ""покажи"", ""найди""), то в результатах выполнения ОБЯЗАТЕЛЬНО должно быть успешное действие 'RunQuery' или 'ShowInfo' с выводом таблицы." + Символы.ПС +
	"2. Если выполнено ТОЛЬКО 'GetObjectFields' или 'GetMetadata' - задача НЕ выполнена. Это лишь подготовительный этап (получение списка полей). Сами данные еще не получены. Отвечай 'НЕТ'." + Символы.ПС +
	"3. Список реквизитов (fields) - это НЕ данные (data). Не путай их. Сообщения вида ""Реквизиты: ..."" или ""Создано/изменено объектов: 0"" НЕ являются данными." + Символы.ПС +
	"4. Ты не должен ВЕРИТЬ, что данные выведены, если не видишь явного сообщения с данными или результата запроса в тексте 'Результаты выполнения'. Слова ""Успех: Да"" относятся к выполнению шага DSL, а не к решению задачи." + Символы.ПС +
	"5. Если ты только что получил поля объекта - это НЕ выполнение задачи, даже если пользователь просил ""вывести всех"". Это только ПЕРВЫЙ ШАГ. Вторым шагом должен быть RunQuery." + Символы.ПС +
	"" + Символы.ПС +
	"ВНИМАНИЕ: Для проверки используй ТОЛЬКО диагностические действия:" + Символы.ПС +
	"1. RunQuery или ShowInfo - для вывода данных пользователю. Считай задачу выполненной ТОЛЬКО если эти действия были выполнены УСПЕШНО с реальными данными." + Символы.ПС +
	"2. CheckObjectExists - для проверки наличия объектов" + Символы.ПС +
	"3. GetObjectFields - для проверки значений полей" + Символы.ПС +
	"4. ShowInfo - для вывода результата проверки" + Символы.ПС +
	"" + Символы.ПС +
	"ЗАПРЕЩЕНО использовать модифицирующие действия (Write, Delete, SetField, CreateReference) на этапе проверки!" + Символы.ПС +
	"" + Символы.ПС +
	"ФОРМАТ ОТВЕТА (СТРОГО): верни ТОЛЬКО DSL-сценарий (JSON объект) вида {""dsl_version"":1,""steps"":[{""action"":""ShowInfo"",""message"":""...""}]}." + Символы.ПС +
	"Сообщение ShowInfo должно начинаться с 'ДА' (если выполнена) или 'НЕТ' (если не выполнена или есть ошибки) и содержать краткое пояснение." + Символы.ПС +
	"ПРИМЕРЫ ОТВЕТОВ:" + Символы.ПС +
	"- НЕТ. Выполнен только GetObjectFields, запрос данных еще не сделан." + Символы.ПС +
	"- ДА. Данные получены и выведены с помощью ShowInfo." + Символы.ПС +
	"- НЕТ. Запрос выполнен, но данных не найдено (если это ошибка)." + Символы.ПС +
	"- ДА. Объект успешно создан.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для создания плана выполнения задачи
//
// Параметры:
//  ТекстЗадачи - Строка - текст задачи пользователя
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптСозданияПлана(ТекстЗадачи) Экспорт
	
	Промпт = "Составь краткий план выполнения задачи (3-6 пунктов) в терминах DSL-действий агента 1С." + Символы.ПС +
	"Задача: " + ТекстЗадачи + Символы.ПС +
	"Требования:" + Символы.ПС +
	"- План должен описывать шаги, которые агент выполнит через DSL (например: CheckObjectExists -> GetObjectFields -> RunQuery -> ShowInfo)." + Символы.ПС +
	"- НЕ описывай действия пользователя в интерфейсе (клики, кнопки, формы, меню, отчёты)." + Символы.ПС +
	"- НЕ используй SQL (SELECT COUNT(*)); используй язык запросов 1С внутри RunQuery." + Символы.ПС +
	"Ответ: только валидный JSON массив строк. Без пояснений и без Markdown.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для обновления состояния плана
//
// Параметры:
//  План - Массив - текущий план (массив структур с полями Задача, Выполнена, Результат)
//  РезультатПоследнегоDSL - Строка - результаты выполнения последнего DSL-сценария
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптОбновленияПлана(ПланJSON, РезультатПоследнегоDSL) Экспорт
	
	Промпт = "Обнови статусы плана по последним результатам." + Символы.ПС +
	"План (JSON): " + ПланJSON + Символы.ПС +
	"Факты последних действий: " + РезультатПоследнегоDSL + Символы.ПС +
	"Правила: не меняй Выполнена=true на false; Результат — короткая строка." + Символы.ПС +
	"Ставь Выполнена=true ТОЛЬКО если в 'Факты последних действий' есть явное подтверждение выполнения (например dsl_system_result success=true или выполненный DSL с нужным действием)." + Символы.ПС +
	"Если ставишь Выполнена=true — Результат НЕ должен быть пустым (кратко укажи факт/доказательство)." + Символы.ПС +
	"Ответ: только JSON массив объектов {""Задача"":""..."",""Выполнена"":true/false,""Результат"":""...""}.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует комбинированный промпт для обновления плана и генерации следующего шага
//
// Параметры:
//  ПланJSON - Строка - текущий план в формате JSON
//  РезультатПоследнегоDSL - Строка - результаты выполнения последнего DSL-сценария
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптОбновленияИПланирования(ПланJSON, РезультатПоследнегоDSL) Экспорт
	
	Промпт = "Сделай ДВА действия в одном ответе:" + Символы.ПС +
	"1) Обнови статусы плана." + Символы.ПС +
	"2) Сгенерируй DSL для СЛЕДУЮЩЕГО невыполненного пункта." + Символы.ПС +
	"" + Символы.ПС +
	"План (JSON): " + ПланJSON + Символы.ПС +
	"Факты последних действий: " + РезультатПоследнегоDSL + Символы.ПС +
	"" + Символы.ПС +
	"Правило достоверности статусов:" + Символы.ПС +
	"- Ставь Выполнена=true ТОЛЬКО если в 'Факты последних действий' есть явное подтверждение выполнения пункта." + Символы.ПС +
	"- Если ставишь Выполнена=true — заполни Результат (кратко укажи подтверждение: какой шаг выполнен и чем подтверждено)." + Символы.ПС +
	"" + Символы.ПС +
	"Ограничения для next_step_dsl:" + Символы.ПС +
	"- steps[].action ТОЛЬКО из поддерживаемых DSL действий: RunQuery, ShowInfo, GetMetadata, GetObjectFields, CheckObjectExists, CreateReference, FindReferenceByGUID, SelectObject, SetField, Write, Delete, ForEach, SaveToStorage." + Символы.ПС +
	"- ЗАПРЕЩЕНЫ любые UI/браузерные действия и выдуманные action: click, find_element, open_form, ui_*, navigate и т.п." + Символы.ПС +
	"- ЗАПРЕЩЕНО использовать вложенные объекты params/args/parameters. Все обязательные поля должны быть на верхнем уровне шага." + Символы.ПС +
	"" + Символы.ПС +
	"СХЕМЫ (СТРОГО):" + Символы.ПС +
	"- CheckObjectExists: {""action"":""CheckObjectExists"",""object_type"":""Справочник"",""object_name"":""Контрагенты""}" + Символы.ПС +
	"- GetObjectFields: {""action"":""GetObjectFields"",""object_type"":""Справочник"",""object_name"":""Контрагенты""}" + Символы.ПС +
	"- RunQuery: {""action"":""RunQuery"",""query"":""ВЫБРАТЬ ...""}" + Символы.ПС +
	"- ShowInfo: {""action"":""ShowInfo"",""message"":""...""}" + Символы.ПС +
	"НЕЛЬЗЯ писать object_name=""Справочник.Контрагенты"" — нужно object_type=""Справочник"" и object_name=""Контрагенты""." + Символы.ПС +
	"" + Символы.ПС +
	"Ответ: только JSON объект вида {""updated_plan"":[...],""next_step_dsl"":{""dsl_version"":1,""steps"":[...]}}. " +
	"Не меняй Выполнена=true на false. Без пояснений и без Markdown.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для генерации резюме (summary)
//
// Параметры:
//  ТекстЗадач - Строка - текст задач
//  ТекстИзмененныхОбъектов - Строка - список измененных объектов
//  ТекстРезультатовDSL - Строка - результаты выполнения DSL
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция СформироватьПромптРезюме(ТекстЗадач, ТекстИзмененныхОбъектов, ТекстРезультатовDSL) Экспорт
	
	Промпт = "Сгенерируй краткое резюме (summary) выполненной работы." + Символы.ПС +
	"Задачи пользователя: " + ТекстЗадач + Символы.ПС +
	"Результаты выполнения действий: " + Символы.ПС + ТекстРезультатовDSL + Символы.ПС +
	ТекстИзмененныхОбъектов + Символы.ПС +
	"Опиши, что было сделано, какие объекты созданы или изменены. Если были ошибки, укажи их. Будь краток и конкретен.";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для исправления DSL-сценария
//
// Параметры:
//  ТекстОшибки - Строка - текст ошибки
//  ИсходныйDSL - Строка - исходный DSL-сценарий
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция СформироватьПромптИсправленияDSL(ТекстОшибки, ИсходныйDSL) Экспорт
	
	Промпт = "Исправь следующий DSL-сценарий, который вызвал ошибку:" + Символы.ПС +
	"Ошибка: " + ТекстОшибки + Символы.ПС +
	"Исходный DSL-сценарий:" + Символы.ПС +
	ИсходныйDSL + Символы.ПС +
	Символы.ПС +
	"ВАЖНО о правильных параметрах:" + Символы.ПС +
	"- GetObjectFields требует: {""action"": ""GetObjectFields"", ""object_name"": ""Имя"", ""object_type"": ""Справочник""} (НЕ ""objectClass"", ""class"", ""params""!)" + Символы.ПС +
	"- SetField требует: {""action"": ""SetField"", ""field_name"": ""Имя"", ""value"": значение} (НЕ ""field"", ""fieldName""!)" + Символы.ПС +
	"- SaveToStorage требует: {""action"": ""SaveToStorage"", ""key"": ""ключ"", ""data"": значение} (НЕ ""value"", ""params""!)" + Символы.ПС +
	"- НЕ используй несуществующие действия: While, For, If, Increment и т.д.! (ForEach поддерживается)" + Символы.ПС +
	"- Верни ТОЛЬКО исправленный JSON без дополнительных комментариев, объяснений или markdown блоков!";
	
	Возврат Промпт;
	
КонецФункции

// Формирует промпт для выполнения следующего шага на основе плана
//
// Параметры:
//  ПланJSON - Строка - текущий план в формате JSON
//  ТекущаяЗадача - Строка - описание текущего пункта плана
//
// Возвращаемое значение:
//  Строка - текст промпта
//
Функция ПолучитьПромптВыполненияПунктаПлана(ПланJSON, ТекущаяЗадача) Экспорт
	
	Промпт = "Текущий план выполнения задачи (JSON): " + ПланJSON + Символы.ПС +
	"Твоя текущая задача: " + ТекущаяЗадача + Символы.ПС +
	"" + Символы.ПС +
	"Сгенерируй DSL-сценарий для выполнения ТЕКУЩЕЙ задачи." + Символы.ПС +
	"Учитывай уже выполненные пункты плана и полученные в них результаты." + Символы.ПС +
	"Если для выполнения текущей задачи тебе нужны дополнительные данные, которые не были получены ранее - получи их первым шагом сценария." + Символы.ПС +
	"Верни ТОЛЬКО валидный JSON объект со сценарием DSL.";
	
	Возврат Промпт;
	
КонецФункции

// Получает текст системного промпта
Функция ПолучитьТекстСистемногоПромпта(ТипДиалога)
	
	// Если это агент, формируем специальный промпт
	Если ТипДиалога = Перечисления.ИИА_ТипДиалога.Агент Тогда
		Возврат ПолучитьТекстПромпта_Агент();
	ИначеЕсли ТипДиалога = Перечисления.ИИА_ТипДиалога.Запрос1С Тогда
		Возврат ПолучитьТекстПромпта_Запрос1С();
	Иначе
		// Стандартный промпт для чата/кода
		Возврат "Ты - полезный AI-ассистент, встроенный в 1С:Предприятие. Твоя задача - помогать пользователю, отвечать на вопросы и генерировать код 1С.";
	КонецЕсли;

КонецФункции

// Внутренняя функция формирования системного промпта для Агента
Функция ПолучитьТекстПромпта_Агент()
	
	СистемныйПромпт =
	"Ты - агент 1С:Предприятие, выполняющий задачи через DSL (JSON)." + Символы.ПС +
	"Формат ответа: всегда следуй ТРЕБУЕМОМУ контракту формата ответа из текущей инструкции (ожидаемый формат задаётся системой). " +
	"Никакого текста вне JSON." + Символы.ПС +
	"Правила: только двойные кавычки (""); без Markdown; строки-константы (нельзя +, функции, вычисления внутри JSON); #(Var) только для переменных контекста, не для констант." + Символы.ПС +
	"СТРАТЕГИЯ DISCOVERY (ОБЯЗАТЕЛЬНО):" + Символы.ПС +
	"- НИКОГДА не делай предположений о названиях документов или справочников. Если ты не уверен в точной структуре метаданных, СНАЧАЛА используй GetMetadata или CheckObjectExists." + Символы.ПС +
	"- ЗАПРЕЩЕНО запрашивать полные списки метаданных без фильтра. Всегда используй GetMetadata{filter: '...'} для сужения поиска." + Символы.ПС +
	"- Если твой поиск по фильтру (например, 'Реализация') ничего не нашел, ты ОБЯЗАН самостоятельно подобрать синонимы (например, 'Продажа', 'Расход', 'Отгрузка') и выполнить повторный GetMetadata с новым фильтром." + Символы.ПС +
	"- ЦЕПОЧКА ДЕЙСТВИЙ: Ошибка -> GetMetadata (поиск замены) -> ВЫБОР ОБЪЕКТА ИЗ СПИСКА -> GetObjectFields (проверка полей) -> RunQuery. НЕ перескакивай шаги и не возвращайся к неверным именам." + Символы.ПС +
	"- Если ты получил список метаданных, и в нем есть похожие объекты, ты ОБЯЗАН выбрать один из них для следующего шага. Остановка работы без попытки использовать замену считается провалом." + Символы.ПС +
	"- ЗАПРЕЩЕНО использовать плейсхолдеры {Поле} в ShowInfo, если в текущей истории нет успешного RunQuery, вернувшего это поле. Если данных нет — пиши 'Данные не найдены'." + Символы.ПС +
	"- Если RunQuery вернул ошибку, проанализируй её текст. Если ошибка в имени поля — используй GetObjectFields. Не повторяй один и тот же ошибочный запрос." + Символы.ПС +
	"- Для получения последней записи всегда используй 'ВЫБРАТЬ ПЕРВЫЕ 1 ... УПОРЯДОЧИТЬ ПО Дата УБЫВ' вместо сложных подзапросов с МАКСИМУМ в условии ГДЕ." + Символы.ПС +
	"Действия (action) и ключевые параметры:" + Символы.ПС +
	"- RunQuery{query,parameters?}; ShowInfo{message}; GetMetadata{metadata_type?}; GetObjectFields{object_type,object_name}; CheckObjectExists{object_type,object_name};" + Символы.ПС +
	"- CreateReference{object_type,object_name}; FindReferenceByGUID{object_type,object_name,guid}; SelectObject{reference}; SetField{field_name,value}; Write{posting_mode?}; Delete{};" + Символы.ПС +
	"- ForEach{collection,steps}; SaveToStorage{key,data}.";
	
	Возврат СистемныйПромпт;
	
КонецФункции

	// Внутренняя функция формирования системного промпта для Запрос1С
	Функция ПолучитьТекстПромпта_Запрос1С()
		
		СистемныйПромпт =
		"Ты - агент для запросов 1С (Read-Only). Разрешены ТОЛЬКО действия: GetMetadata, GetObjectFields, CheckObjectExists, RunQuery, ShowInfo." + Символы.ПС +
		"Запрещены любые модифицирующие действия (CreateReference, SetField, Write, Delete и т.д.)." + Символы.ПС +
		"Алгоритм: если не знаешь точных имен полей - сначала GetObjectFields; затем RunQuery." + Символы.ПС +
		"Формат ответа: всегда следуй ТРЕБУЕМОМУ контракту формата ответа из текущей инструкции (ожидаемый формат задаётся системой). Никакого текста вне JSON." + Символы.ПС +
		"Правила: только двойные кавычки (""); без Markdown; строки-константы (нельзя +/функции/вычисления в JSON); #(Var) только для переменных контекста, не для констант.";
		
		Возврат СистемныйПромпт;
		
	КонецФункции

	// Возвращает системный промпт для планировщика
	Функция ПолучитьТекстПромптаПланировщика() Экспорт
		
		Возврат "Ты - планировщик задач в 1С. Верни ТОЛЬКО валидный JSON массив строк (3-6 пунктов). " +
		"Никакого текста вне JSON. Без Markdown.";
		
	КонецФункции

	// Формирует промпт для продолжения задачи после проверки
	Функция ПолучитьПромптПродолженияЗадачи(Причина = "", ДопИнструкция = "") Экспорт
		
		Промпт = "Предыдущий шаг выполнен успешно, но задача пользователя еще не решена полностью." + Символы.ПС +
		"Проанализируй историю и результаты предыдущих действий." + Символы.ПС;
		
		Если НЕ ПустаяСтрока(Причина) Тогда
			Промпт = Промпт + "Причина остановки (из проверки): " + Причина + Символы.ПС;
		КонецЕсли;
		
		Если НЕ ПустаяСтрока(ДопИнструкция) Тогда
			Промпт = Промпт + ДопИнструкция + Символы.ПС;
		КонецЕсли;
		
		Промпт = Промпт + "Сгенерируй СЛЕДУЮЩИЙ шаг (DSL-сценарий) для выполнения задачи." + Символы.ПС +
		"Например, если ты получил поля объекта в предыдущем шаге, теперь сформируй и выполни запрос (RunQuery) или создай объект (CreateReference).";
		
		Возврат Промпт;
		
	КонецФункции

#КонецОбласти
